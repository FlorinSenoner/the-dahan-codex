pre-commit:
  parallel: true
  commands:
    check-branch:
      run: |
        BRANCH=$(git rev-parse --abbrev-ref HEAD)
        if [ "$BRANCH" = "main" ]; then
          echo "ERROR: Do not commit directly to main!"
          exit 1
        fi

    biome:
      glob: "*.{js,jsx,ts,tsx,json,css}"
      run: npx biome check --write --staged {staged_files}
      stage_fixed: true

    prettier:
      glob: "*.{md,mdx,html,yml,yaml}"
      run: npx prettier --write {staged_files}
      stage_fixed: true

    typecheck:
      glob: "*.{ts,tsx}"
      run: pnpm typecheck

commit-msg:
  commands:
    commitlint:
      run: npx commitlint --edit {1}

pre-push:
  parallel: false
  commands:
    ci-parity:
      run: |
        if command -v mise >/dev/null 2>&1; then
          echo "Using CI toolchain from mise.toml"
          mise exec -- node --version
          mise exec -- pnpm --version

          echo "Sync dependencies from lockfile"
          mise exec -- pnpm install --frozen-lockfile

          echo "Run CI parity checks"
          mise exec -- pnpm check
          mise exec -- pnpm build

          echo "Run local unit tests"
          mise exec -- pnpm test
        else
          echo "WARNING: 'mise' not found. Falling back to local Node/pnpm toolchain."

          if ! command -v node >/dev/null 2>&1 || ! command -v pnpm >/dev/null 2>&1; then
            echo "ERROR: node and pnpm are required when mise is unavailable."
            exit 1
          fi

          node --version
          pnpm --version

          echo "Sync dependencies from lockfile"
          pnpm install --frozen-lockfile

          echo "Run CI parity checks"
          pnpm check
          pnpm build

          echo "Run local unit tests"
          pnpm test
        fi
