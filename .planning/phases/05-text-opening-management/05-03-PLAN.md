---
phase: 05-text-opening-management
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - convex/spirits.ts
  - app/routes/_admin/openings/index.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can see list of all openings"
    - "Each opening row shows name, spirit name, and difficulty"
    - "Edit and Delete actions are available for each opening"
    - "New Opening button navigates to create form"
    - "Delete action requires confirmation"
  artifacts:
    - path: "convex/spirits.ts"
      provides: "listAllSpirits query for admin spirit selector"
      exports: ["listSpirits", "getSpiritWithAspects", "getSpiritBySlug", "listAllSpirits"]
    - path: "app/routes/_admin/openings/index.tsx"
      provides: "Admin openings list page"
      exports: ["Route"]
  key_links:
    - from: "app/routes/_admin/openings/index.tsx"
      to: "convex/openings.ts"
      via: "useQuery for listAll"
      pattern: "convexQuery.*openings"
---

<objective>
Create the admin openings list page with CRUD actions.

Purpose: Provide admins with an overview of all openings and quick actions to create, edit, or delete them. This is the landing page for opening management.

Output:
- listAllSpirits query for spirit selector dropdown
- listAll openings query for admin list
- Admin openings index page with table/list view
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-text-opening-management/05-RESEARCH.md
@convex/spirits.ts
@convex/openings.ts
@app/routes/_authenticated.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Convex queries for admin</name>
  <files>
    convex/spirits.ts
    convex/openings.ts
  </files>
  <action>
    1. In convex/spirits.ts, add listAllSpirits query:
       ```typescript
       // List all spirits (base + aspects) for admin dropdowns
       export const listAllSpirits = query({
         args: {},
         handler: async (ctx) => {
           const spirits = await ctx.db.query("spirits").collect();
           // Sort: base spirits first alphabetically, then aspects under their base
           spirits.sort((a, b) => {
             // Base spirits before aspects
             if (!a.baseSpirit && b.baseSpirit) return -1;
             if (a.baseSpirit && !b.baseSpirit) return 1;
             // Among base spirits: alphabetical
             if (!a.baseSpirit && !b.baseSpirit) {
               return a.name.localeCompare(b.name);
             }
             // Among aspects: group by base, then alphabetical
             if (a.baseSpirit !== b.baseSpirit) {
               return String(a.baseSpirit).localeCompare(String(b.baseSpirit));
             }
             return (a.aspectName || "").localeCompare(b.aspectName || "");
           });
           return spirits;
         },
       });
       ```

    2. In convex/openings.ts, add listAll query:
       ```typescript
       // List all openings with spirit info (for admin)
       export const listAll = query({
         args: {},
         handler: async (ctx) => {
           const openings = await ctx.db.query("openings").collect();

           // Enrich with spirit name
           const enriched = await Promise.all(
             openings.map(async (opening) => {
               const spirit = await ctx.db.get(opening.spiritId);
               return {
                 ...opening,
                 spiritName: spirit
                   ? spirit.aspectName
                     ? `${spirit.name} (${spirit.aspectName})`
                     : spirit.name
                   : "Unknown Spirit",
               };
             })
           );

           // Sort by spirit name, then opening name
           enriched.sort((a, b) => {
             const spiritCompare = a.spiritName.localeCompare(b.spiritName);
             if (spiritCompare !== 0) return spiritCompare;
             return a.name.localeCompare(b.name);
           });

           return enriched;
         },
       });
       ```

    These queries are public (no requireAdmin) because they just read data. The mutations handle authorization.
  </action>
  <verify>
    Run `npx convex dev` briefly to verify functions compile, then Ctrl+C
  </verify>
  <done>
    convex/spirits.ts has listAllSpirits, convex/openings.ts has listAll
  </done>
</task>

<task type="auto">
  <name>Task 2: Create admin openings list page</name>
  <files>
    app/routes/_admin/openings/index.tsx
  </files>
  <action>
    Create app/routes/_admin/openings/ directory and index.tsx:

    1. Imports:
       - createFileRoute, Link from "@tanstack/react-router"
       - convexQuery from "@convex-dev/react-query"
       - useQuery, useMutation from "@tanstack/react-query"
       - useConvexMutation from "@convex-dev/react-query"
       - api from "convex/_generated/api"
       - Button from "@/components/ui/button"
       - PageHeader from "@/components/ui/page-header"
       - Badge from "@/components/ui/badge"
       - Plus, Pencil, Trash2 from "lucide-react"
       - useState from "react"

    2. Create route:
       ```typescript
       export const Route = createFileRoute("/_admin/openings/")({
         component: AdminOpeningsPage,
       });
       ```

    3. AdminOpeningsPage component:
       - Query openings: useQuery(convexQuery(api.openings.listAll, {}))
       - Delete mutation: useConvexMutation(api.openings.remove)
       - State for delete confirmation: [deleteId, setDeleteId] = useState<string | null>(null)

       - PageHeader with title "Manage Openings" and action button:
         ```tsx
         <Link to="/admin/openings/new">
           <Button><Plus className="h-4 w-4 mr-2" /> New Opening</Button>
         </Link>
         ```

       - Loading state: skeleton rows
       - Empty state: "No openings yet. Create your first opening."

       - Openings list (use cards or table rows):
         For each opening:
         - Spirit name (muted text above)
         - Opening name (heading)
         - Difficulty badge (if present)
         - Turn count: "{N} turns"
         - Actions: Edit link, Delete button

       - Delete confirmation:
         When deleteId is set, show confirmation modal/inline:
         "Delete this opening? This cannot be undone."
         Cancel button: setDeleteId(null)
         Confirm button: await deleteMutation.mutateAsync({ id: deleteId }); setDeleteId(null)

    4. Style with existing UI patterns:
       - Cards: "border border-border rounded-lg p-4 bg-card"
       - Grid: "grid gap-4"
       - Flex row for header: "flex items-center justify-between"
       - Actions: "flex gap-2"
  </action>
  <verify>
    Run `pnpm typecheck` - no errors
    Run `pnpm dev` and navigate to /admin/openings (as admin user) - page loads
  </verify>
  <done>
    Admin openings list page shows all openings with edit/delete actions
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. /admin/openings route loads for admin users
3. Non-admin users are redirected (from _admin layout)
4. Delete requires confirmation before executing
</verification>

<success_criteria>
- listAllSpirits query returns sorted spirit list
- listAll openings query includes spirit name
- Admin can see all openings in a list
- Each opening shows spirit name, name, difficulty, turn count
- Delete button shows confirmation before deletion
</success_criteria>

<output>
After completion, create `.planning/phases/05-text-opening-management/05-03-SUMMARY.md`
</output>
