---
phase: 05-text-opening-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/hooks/use-admin.ts
  - app/hooks/index.ts
  - convex/schema.ts
  - convex/openings.ts
autonomous: true

must_haves:
  truths:
    - "useAdmin hook returns true only for users with isAdmin metadata"
    - "Convex mutations throw error for non-admin users"
    - "Schema has createdAt and updatedAt fields, difficulty removed"
  artifacts:
    - path: "app/hooks/use-admin.ts"
      provides: "Admin status check hook"
      exports: ["useAdmin"]
    - path: "convex/openings.ts"
      provides: "Opening CRUD mutations"
      exports: ["createOpening", "updateOpening", "deleteOpening"]
  key_links:
    - from: "app/hooks/use-admin.ts"
      to: "@clerk/clerk-react"
      via: "useUser hook"
      pattern: "useUser.*publicMetadata.*isAdmin"
    - from: "convex/openings.ts"
      to: "convex/lib/auth.ts"
      via: "requireAdmin"
      pattern: "requireAdmin\\(ctx\\)"
---

<objective>
Create admin infrastructure: useAdmin hook for frontend and protected Convex mutations for opening CRUD operations.

Purpose: Establish the permission layer that protects all admin functionality with defense-in-depth (client + server checks).
Output: useAdmin hook, opening mutations (create/update/delete), updated schema with timestamps.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-text-opening-management/05-CONTEXT.md
@.planning/phases/05-text-opening-management/05-RESEARCH.md
@convex/lib/auth.ts
@convex/schema.ts
@convex/openings.ts
@app/hooks/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useAdmin hook</name>
  <files>app/hooks/use-admin.ts, app/hooks/index.ts</files>
  <action>
Create app/hooks/use-admin.ts with a hook that:
1. Uses useUser from @clerk/clerk-react
2. Returns false if not loaded or no user
3. Returns true only if user.publicMetadata?.isAdmin === true

Pattern from RESEARCH.md:
```typescript
import { useUser } from '@clerk/clerk-react';

export function useAdmin(): boolean {
  const { user, isLoaded } = useUser();
  if (!isLoaded || !user) return false;
  return user.publicMetadata?.isAdmin === true;
}
```

Export useAdmin from app/hooks/index.ts barrel file (add to existing exports).
  </action>
  <verify>pnpm typecheck passes, hook is exported from app/hooks/index.ts</verify>
  <done>useAdmin hook exists and is properly typed</done>
</task>

<task type="auto">
  <name>Task 2: Update schema and create mutations</name>
  <files>convex/schema.ts, convex/openings.ts</files>
  <action>
1. Update convex/schema.ts openings table:
   - Remove difficulty field (make optional first for migration safety, or just remove since we control seed data)
   - Add createdAt: v.optional(v.number()) - optional for backward compatibility
   - Add updatedAt: v.optional(v.number()) - optional for backward compatibility

2. Update convex/openings.ts to add mutations:

createOpening mutation:
- Args: spiritId, name, description?, turns[], author?, sourceUrl?
- Call requireAdmin(ctx) first
- Generate slug from name (lowercase, replace spaces with dashes, remove special chars)
- Insert with createdAt: Date.now(), updatedAt: Date.now()
- Return inserted document ID

updateOpening mutation:
- Args: id (opening ID), all fields optional (name?, description?, turns?, author?, sourceUrl?)
- Call requireAdmin(ctx) first
- Patch document with ...updates, updatedAt: Date.now()
- If name changed, regenerate slug

deleteOpening mutation:
- Args: id (opening ID)
- Call requireAdmin(ctx) first
- Delete document

Helper function for slug generation:
```typescript
function generateSlug(name: string): string {
  return name
    .toLowerCase()
    .replace(/[^a-z0-9\s-]/g, '')
    .replace(/\s+/g, '-')
    .replace(/-+/g, '-')
    .trim();
}
```
  </action>
  <verify>pnpm typecheck passes, npx convex dev shows no schema errors</verify>
  <done>Schema updated with timestamps, mutations created and protected by requireAdmin</done>
</task>

</tasks>

<verification>
1. pnpm typecheck passes
2. npx convex dev accepts schema changes
3. Grep confirms requireAdmin(ctx) called in all mutations
4. useAdmin hook properly typed and exported
</verification>

<success_criteria>
- useAdmin hook returns correct admin status based on Clerk metadata
- All three mutations (create/update/delete) call requireAdmin(ctx)
- Schema has createdAt/updatedAt fields on openings table
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-text-opening-management/05-01-SUMMARY.md`
</output>
