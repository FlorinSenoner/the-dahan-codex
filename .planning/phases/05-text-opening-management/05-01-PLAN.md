---
phase: 05-text-opening-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - pnpm-lock.yaml
  - convex/openings.ts
  - app/routes/_admin.tsx
autonomous: true

must_haves:
  truths:
    - "Admin layout redirects non-admin users to home page"
    - "Admin layout shows loading state while checking auth"
    - "Convex create mutation validates admin role before insert"
    - "Convex update mutation validates admin role before patch"
    - "Convex delete mutation validates admin role before delete"
    - "Slug uniqueness is enforced in create mutation"
  artifacts:
    - path: "app/routes/_admin.tsx"
      provides: "Admin layout route with role guard"
      exports: ["Route"]
    - path: "convex/openings.ts"
      provides: "Opening CRUD operations"
      exports: ["listBySpirit", "getBySlug", "create", "update", "remove"]
  key_links:
    - from: "app/routes/_admin.tsx"
      to: "useUser from @clerk/clerk-react"
      via: "publicMetadata.isAdmin check"
      pattern: "publicMetadata.*isAdmin"
    - from: "convex/openings.ts"
      to: "convex/lib/auth.ts"
      via: "requireAdmin import"
      pattern: "requireAdmin\\(ctx\\)"
---

<objective>
Set up admin foundation with route protection and Convex CRUD mutations.

Purpose: Establish secure admin infrastructure - the _admin layout guards all admin routes client-side, while Convex mutations enforce admin role server-side. This two-layer protection ensures admin-only operations cannot be bypassed.

Output:
- react-hook-form and @hookform/resolvers installed
- _admin layout route with Clerk role check
- Convex mutations: create, update, remove (with requireAdmin guard)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-text-opening-management/05-RESEARCH.md
@app/routes/_authenticated.tsx
@convex/lib/auth.ts
@convex/openings.ts
@convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install form dependencies</name>
  <files>
    package.json
    pnpm-lock.yaml
  </files>
  <action>
    Install form management libraries:
    ```bash
    pnpm add react-hook-form @hookform/resolvers
    ```

    These enable:
    - react-hook-form: Performant form state management with minimal re-renders
    - @hookform/resolvers: Zod integration for form validation (Zod already installed)
  </action>
  <verify>
    Run `pnpm list react-hook-form @hookform/resolvers` - both packages shown
  </verify>
  <done>
    react-hook-form and @hookform/resolvers in package.json dependencies
  </done>
</task>

<task type="auto">
  <name>Task 2: Create admin layout route</name>
  <files>
    app/routes/_admin.tsx
  </files>
  <action>
    Create app/routes/_admin.tsx following the _authenticated.tsx pattern:

    1. Import useUser from @clerk/clerk-react (not useAuth - need publicMetadata)
    2. Import createFileRoute, Outlet, useNavigate from @tanstack/react-router
    3. Import useEffect from react

    4. Create route with createFileRoute("/_admin")

    5. AdminLayout component:
       - Get { isLoaded, user } from useUser()
       - Check isAdmin: user?.publicMetadata?.isAdmin === true
       - useEffect: if isLoaded && !isAdmin, navigate to "/"
       - Loading state: if !isLoaded, return div with "Loading..."
       - Access denied: if !isAdmin, return div with "Access denied"
       - Otherwise return <Outlet />

    IMPORTANT: Use useUser() not useAuth() - we need access to publicMetadata which contains the isAdmin claim from Clerk JWT.
  </action>
  <verify>
    Run `pnpm typecheck` - no errors in _admin.tsx
  </verify>
  <done>
    _admin.tsx exists with role guard checking publicMetadata.isAdmin
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Convex opening mutations</name>
  <files>
    convex/openings.ts
  </files>
  <action>
    Add three mutations to convex/openings.ts:

    1. Import mutation from "./_generated/server"
    2. Import requireAdmin from "./lib/auth"

    3. Create `create` mutation:
       - Args: spiritId (id of spirits), slug (string), name (string), description (optional string), difficulty (optional union of Beginner/Intermediate/Advanced), turns (array of turn objects), author (optional string), sourceUrl (optional string)
       - Handler:
         a. Call `await requireAdmin(ctx)` FIRST
         b. Check slug uniqueness: query openings by_slug index, throw if exists
         c. Insert opening with args
         d. Return new opening ID

    4. Create `update` mutation:
       - Args: id (id of openings), plus optional fields for name, slug, description, difficulty, turns, author, sourceUrl
       - Handler:
         a. Call `await requireAdmin(ctx)` FIRST
         b. If slug provided and changed, check uniqueness (exclude current doc)
         c. Patch document with provided fields
         d. Return void

    5. Create `remove` mutation:
       - Args: id (id of openings)
       - Handler:
         a. Call `await requireAdmin(ctx)` FIRST
         b. Delete document
         c. Return void

    Turn object shape (matches schema):
    ```typescript
    v.object({
      turn: v.number(),
      title: v.optional(v.string()),
      instructions: v.string(),
      notes: v.optional(v.string()),
    })
    ```

    CRITICAL: requireAdmin() must be the FIRST line in each mutation handler. This prevents malicious API calls that bypass the UI.
  </action>
  <verify>
    Run `npx convex dev` briefly to verify functions compile, then Ctrl+C
    Run `pnpm typecheck` - no errors
  </verify>
  <done>
    convex/openings.ts has create, update, remove mutations with requireAdmin guard
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm build` succeeds
3. convex/openings.ts exports: listBySpirit, getBySlug, create, update, remove
4. app/routes/_admin.tsx exists with admin role check
</verification>

<success_criteria>
- react-hook-form and @hookform/resolvers installed
- _admin layout route checks publicMetadata.isAdmin
- Non-admin users redirected to home page
- Convex create mutation checks slug uniqueness
- All three mutations call requireAdmin() as first line
</success_criteria>

<output>
After completion, create `.planning/phases/05-text-opening-management/05-01-SUMMARY.md`
</output>
