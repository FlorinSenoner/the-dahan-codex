---
phase: 05-text-opening-management
plan: 17
type: execute
wave: 1
depends_on: []
files_modified:
  - app/components/spirits/opening-section.tsx
  - app/components/admin/editable-opening.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Delete opening stays in edit mode (URL keeps edit=true)"
    - "Delete turn button hidden when only 1 turn exists"
    - "Can always delete the opening itself, just not the last turn"
  artifacts:
    - path: "app/components/spirits/opening-section.tsx"
      provides: "Delete handler preserves edit param"
      contains: "edit: search.edit"
    - path: "app/components/admin/editable-opening.tsx"
      provides: "Conditional delete turn button"
      contains: "turns.length > 1"
  key_links:
    - from: "handleDelete"
      to: "navigate search"
      via: "spread with edit preserved"
      pattern: "edit.*search\\.edit"
---

<objective>
Fix delete behavior: preserve edit mode after deleting opening, hide delete turn button when only one turn remains.

Purpose: Users should stay in edit mode after deleting an opening (to create a new one or edit another), and cannot accidentally delete all turns from an opening.
Output: Fixed navigation params in delete handler, conditional turn delete button.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@app/components/spirits/opening-section.tsx
@app/components/admin/editable-opening.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Preserve edit param when deleting opening</name>
  <files>app/components/spirits/opening-section.tsx</files>
  <action>
Update handleDelete (around lines 215-231) to preserve the edit param when navigating:

Change:
```typescript
const { opening: _, ...rest } = search;
navigate({
  search: rest as any,
  replace: true,
});
```

To:
```typescript
navigate({
  search: { ...search, opening: undefined } as any,
  replace: true,
});
```

This preserves all existing search params (including edit=true) while only removing the opening param.
  </action>
  <verify>`pnpm typecheck` passes</verify>
  <done>Delete opening navigation preserves edit mode</done>
</task>

<task type="auto">
  <name>Task 2: Hide delete turn button when only one turn exists</name>
  <files>app/components/admin/editable-opening.tsx</files>
  <action>
1. Add `turnsCount` prop to EditableOpeningProps:
```typescript
interface EditableOpeningProps {
  opening: Doc<"openings"> | null;
  formData: OpeningFormData;
  onChange: (data: OpeningFormData) => void;
  onDelete?: () => void;
  isNew?: boolean;
}
```

No new prop needed - we can check formData.turns.length directly.

2. Wrap the delete turn AlertDialog (lines 134-165) in a conditional:

Find the AlertDialog for delete turn inside the turns map (the one with "Delete Turn {turn.turn}?" title).

Change:
```typescript
<AlertDialog>
  <AlertDialogTrigger asChild>
    <Button
      variant="ghost"
      ...
    >
      <Trash2 className="h-4 w-4" />
    </Button>
  </AlertDialogTrigger>
  ...
</AlertDialog>
```

To:
```typescript
{formData.turns.length > 1 && (
  <AlertDialog>
    <AlertDialogTrigger asChild>
      <Button
        variant="ghost"
        ...
      >
        <Trash2 className="h-4 w-4" />
      </Button>
    </AlertDialogTrigger>
    ...
  </AlertDialog>
)}
```

This hides the entire delete turn button (including its AlertDialog) when there's only one turn.
  </action>
  <verify>
1. `pnpm typecheck` passes
2. `pnpm dev` - test delete behavior:
   - Create opening with 2+ turns - delete turn button visible on each
   - Delete turns until 1 remains - delete turn button disappears
   - Delete opening button still visible and works
   - After deleting opening, stays in edit mode
  </verify>
  <done>Delete turn button conditionally hidden, opening deletion preserves edit mode</done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes
- Delete opening keeps user in edit mode
- Delete turn button hidden when only 1 turn
- Delete opening button always available
</verification>

<success_criteria>
- Edit mode preserved after delete operations
- Cannot delete last turn (button hidden)
- Delete opening always possible
</success_criteria>

<output>
After completion, create `.planning/phases/05-text-opening-management/05-17-SUMMARY.md`
</output>
