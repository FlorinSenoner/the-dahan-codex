---
phase: 05-text-opening-management
plan: 16
type: execute
wave: 1
depends_on: []
files_modified:
  - app/components/admin/edit-fab.tsx
  - app/components/spirits/opening-section.tsx
  - app/routes/spirits.$slug.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Save button exits edit mode after successful save"
    - "Save button always visible when hasChanges is true, disabled when invalid"
    - "hasChanges is false after successful save (no false 'unsaved changes' warnings)"
    - "Navigation warning uses themed AlertDialog instead of browser confirm()"
  artifacts:
    - path: "app/components/admin/edit-fab.tsx"
      provides: "EditFab with isValid prop and always-visible save button"
      contains: "isValid"
    - path: "app/components/spirits/opening-section.tsx"
      provides: "Form state reset after save, isValid prop passed"
      contains: "setFormData(null)"
    - path: "app/routes/spirits.$slug.tsx"
      provides: "AlertDialog for navigation blocking"
      contains: "AlertDialog"
  key_links:
    - from: "EditFab"
      to: "setEditing(false)"
      via: "onSave callback"
      pattern: "setEditing.*false"
    - from: "useBlocker"
      to: "AlertDialog"
      via: "blockerState"
      pattern: "blocker.*AlertDialog"
---

<objective>
Fix save flow behavior: exit edit mode after save, always show save button (disabled when invalid), clear hasChanges after save, and use themed AlertDialog for navigation warnings.

Purpose: Users expect save to complete the editing session, see consistent button states, and get themed modals instead of browser dialogs.
Output: Improved save UX with proper state management and themed navigation blocking.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@app/components/admin/edit-fab.tsx
@app/components/spirits/opening-section.tsx
@app/routes/spirits.$slug.tsx
@app/hooks/use-edit-mode.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update EditFab for always-visible save button with isValid prop</name>
  <files>app/components/admin/edit-fab.tsx</files>
  <action>
1. Add `isValid` prop to EditFabProps interface:
```typescript
interface EditFabProps {
  onSave?: () => void;
  hasChanges?: boolean;
  isSaving?: boolean;
  isValid?: boolean;
}
```

2. Update the save button render condition from `hasChanges && onSave` to `hasChanges`:
```typescript
{isEditing && hasChanges && (
  <Button
    onClick={onSave}
    disabled={isSaving || !isValid}
    size="icon"
    className="h-14 w-14 rounded-full shadow-lg"
    aria-label="Save changes"
  >
    <Check className="h-6 w-6" />
  </Button>
)}
```

The button is now always visible when hasChanges is true, but disabled when saving or invalid.
  </action>
  <verify>`pnpm typecheck` passes</verify>
  <done>EditFab shows save button when hasChanges, disabled based on isValid and isSaving</done>
</task>

<task type="auto">
  <name>Task 2: Reset form state after save and pass isValid to parent</name>
  <files>app/components/spirits/opening-section.tsx</files>
  <action>
1. Add `onIsValidChange` prop to OpeningSectionProps:
```typescript
interface OpeningSectionProps {
  spiritId: Id<"spirits">;
  onSaveHandlerReady?: (saveHandler: (() => Promise<void>) | null) => void;
  onHasChangesChange?: (hasChanges: boolean) => void;
  onIsValidChange?: (isValid: boolean) => void;
}
```

2. Add useEffect to notify parent of isValid changes (after existing hasChanges effect):
```typescript
// Notify parent of validity changes
useEffect(() => {
  onIsValidChange?.(isValid);
}, [isValid, onIsValidChange]);
```

3. Update handleSave to reset form state after successful save:
In handleSave, after `setIsCreatingNew(false);` and before the catch block, add:
```typescript
// Reset form state to clear hasChanges
if (!isCreatingNew && selectedOpening) {
  // Re-fetch will update selectedOpening, reset form to match
  setFormData(null);
}
```

4. Always pass handleSave to onSaveHandlerReady (remove isValid condition):
Change the effect from:
```typescript
onSaveHandlerReady?.(formData && hasChanges && isValid ? handleSave : null);
```
to:
```typescript
onSaveHandlerReady?.(formData && hasChanges ? handleSave : null);
```

This allows the parent to always have access to save, while isValid controls the disabled state.
  </action>
  <verify>`pnpm typecheck` passes</verify>
  <done>Form state resets after save, isValid exposed to parent</done>
</task>

<task type="auto">
  <name>Task 3: Wire isValid and exit edit mode after save with themed AlertDialog</name>
  <files>app/routes/spirits.$slug.tsx</files>
  <action>
1. Add isValid state and handler alongside existing hasChanges:
```typescript
const [isValid, setIsValid] = useState(true);

const handleIsValidChange = useCallback((value: boolean) => {
  setIsValid(value);
}, []);
```

2. Import useEditMode hook and setEditing:
```typescript
import { useAdmin, useEditMode } from "@/hooks";
```

Then in SpiritDetailContent:
```typescript
const { setEditing } = useEditMode();
```

3. Update handleSave to exit edit mode after successful save:
```typescript
const handleSave = useCallback(async () => {
  if (!saveHandler) return;
  setIsSaving(true);
  try {
    await saveHandler();
    // Exit edit mode after successful save
    setEditing(false);
  } finally {
    setIsSaving(false);
  }
}, [saveHandler, setEditing]);
```

4. Add blocker state for AlertDialog navigation warning. Replace the useBlocker call:

First, add imports at the top:
```typescript
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";
```

Then replace the useBlocker:
```typescript
const blocker = useBlocker({
  condition: hasChanges,
});
```

Note: TanStack Router's useBlocker returns a blocker object with `status`, `proceed()`, and `reset()` methods when condition is true.

5. Add AlertDialog for navigation warning (before the closing </main> tag but inside the component):
```typescript
<AlertDialog open={blocker.status === "blocked"}>
  <AlertDialogContent>
    <AlertDialogHeader>
      <AlertDialogTitle>Unsaved Changes</AlertDialogTitle>
      <AlertDialogDescription>
        You have unsaved changes. Are you sure you want to leave? Your changes will be lost.
      </AlertDialogDescription>
    </AlertDialogHeader>
    <AlertDialogFooter>
      <AlertDialogCancel onClick={() => blocker.reset?.()}>
        Stay
      </AlertDialogCancel>
      <AlertDialogAction
        onClick={() => blocker.proceed?.()}
        className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
      >
        Leave
      </AlertDialogAction>
    </AlertDialogFooter>
  </AlertDialogContent>
</AlertDialog>
```

6. Pass isValid and onIsValidChange to OpeningSection:
```typescript
<OpeningSection
  spiritId={spirit._id}
  onSaveHandlerReady={handleSaveHandlerReady}
  onHasChangesChange={handleHasChangesChange}
  onIsValidChange={handleIsValidChange}
/>
```

7. Pass isValid to EditFab:
```typescript
<EditFab
  onSave={handleSave}
  hasChanges={hasChanges}
  isSaving={isSaving}
  isValid={isValid}
/>
```
  </action>
  <verify>
1. `pnpm typecheck` passes
2. `pnpm dev` - test save flow:
   - Make changes to opening
   - Click save - should save AND exit edit mode
   - Re-enter edit mode - no "unsaved changes" warning
3. Test navigation warning:
   - Enter edit mode, make changes
   - Click browser back or spirits tab
   - Themed AlertDialog appears (not browser confirm)
   - "Stay" keeps you on page, "Leave" navigates away
4. Test save button visibility:
   - With valid changes: save button enabled
   - With invalid form (empty name): save button visible but disabled
  </verify>
  <done>Save exits edit mode, AlertDialog for navigation, isValid controls button state</done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes
- Save button always visible when hasChanges, disabled when !isValid
- Save action exits edit mode
- No false "unsaved changes" warnings after save
- Navigation blocking uses themed AlertDialog
</verification>

<success_criteria>
- Save flow completes editing session properly
- Button states are consistent and predictable
- Themed modals replace all browser dialogs
</success_criteria>

<output>
After completion, create `.planning/phases/05-text-opening-management/05-16-SUMMARY.md`
</output>
