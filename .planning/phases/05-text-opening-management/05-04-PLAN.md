---
phase: 05-text-opening-management
plan: 04
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified:
  - app/routes/_admin/openings/new.tsx
  - app/routes/_admin/openings/$id.edit.tsx
  - convex/openings.ts
autonomous: true

must_haves:
  truths:
    - "Create page shows OpeningForm with all spirits in dropdown"
    - "Slug auto-generates from name on blur if empty"
    - "Successful create navigates to openings list"
    - "Edit page loads existing opening data into form"
    - "Edit page shows opening preview using TurnAccordion"
    - "Successful update navigates to openings list"
  artifacts:
    - path: "app/routes/_admin/openings/new.tsx"
      provides: "Create new opening page"
      exports: ["Route"]
    - path: "app/routes/_admin/openings/$id.edit.tsx"
      provides: "Edit existing opening page"
      exports: ["Route"]
    - path: "convex/openings.ts"
      provides: "getById query for edit page"
      exports: ["listBySpirit", "getBySlug", "listAll", "getById", "create", "update", "remove"]
  key_links:
    - from: "app/routes/_admin/openings/new.tsx"
      to: "app/components/admin/opening-form.tsx"
      via: "OpeningForm component"
      pattern: "<OpeningForm"
    - from: "app/routes/_admin/openings/$id.edit.tsx"
      to: "app/components/spirits/turn-accordion.tsx"
      via: "TurnAccordion for preview"
      pattern: "<TurnAccordion"
---

<objective>
Create admin routes for creating and editing openings.

Purpose: Enable admins to create new openings and edit existing ones. The create page includes slug auto-generation from name, and the edit page includes a live preview using the existing TurnAccordion component.

Output:
- getById query for loading opening in edit form
- Create opening page with OpeningForm
- Edit opening page with OpeningForm and preview
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-text-opening-management/05-RESEARCH.md
@app/components/admin/opening-form.tsx (from 05-02)
@app/components/spirits/turn-accordion.tsx
@convex/openings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getById query</name>
  <files>
    convex/openings.ts
  </files>
  <action>
    Add getById query to convex/openings.ts:

    ```typescript
    // Get opening by ID (for edit page)
    export const getById = query({
      args: { id: v.id("openings") },
      handler: async (ctx, args) => {
        return await ctx.db.get(args.id);
      },
    });
    ```

    This query is public (no requireAdmin) since it just reads data.
  </action>
  <verify>
    Run `npx convex dev` briefly to verify function compiles, then Ctrl+C
  </verify>
  <done>
    convex/openings.ts exports getById query
  </done>
</task>

<task type="auto">
  <name>Task 2: Create new opening page</name>
  <files>
    app/routes/_admin/openings/new.tsx
  </files>
  <action>
    Create app/routes/_admin/openings/new.tsx:

    1. Imports:
       - createFileRoute, useNavigate from "@tanstack/react-router"
       - convexQuery, useConvexMutation from "@convex-dev/react-query"
       - useQuery from "@tanstack/react-query"
       - api from "convex/_generated/api"
       - type Id from "convex/_generated/dataModel"
       - OpeningForm from "@/components/admin/opening-form"
       - type OpeningFormData from "@/lib/schemas/opening"
       - PageHeader from "@/components/ui/page-header"
       - useState from "react"

    2. Create route:
       ```typescript
       export const Route = createFileRoute("/_admin/openings/new")({
         component: NewOpeningPage,
       });
       ```

    3. Slug generation helper:
       ```typescript
       function generateSlug(name: string): string {
         return name
           .toLowerCase()
           .replace(/[^a-z0-9\s-]/g, "")
           .replace(/\s+/g, "-")
           .replace(/-+/g, "-")
           .slice(0, 50);
       }
       ```

    4. NewOpeningPage component:
       - Query spirits: useQuery(convexQuery(api.spirits.listAllSpirits, {}))
       - Create mutation: useConvexMutation(api.openings.create)
       - Navigate hook: useNavigate()
       - Error state: [error, setError] = useState<string | null>(null)

       - PageHeader with title "New Opening" and back link to /admin/openings

       - Loading state while spirits load

       - Form handling with slug auto-generation:
         ```typescript
         const handleSubmit = async (data: OpeningFormData) => {
           setError(null);
           try {
             await createMutation.mutateAsync({
               spiritId: data.spiritId as Id<"spirits">,
               slug: data.slug,
               name: data.name,
               description: data.description || undefined,
               difficulty: data.difficulty || undefined,
               turns: data.turns,
               author: data.author || undefined,
               sourceUrl: data.sourceUrl || undefined,
             });
             navigate({ to: "/admin/openings" });
           } catch (err) {
             setError(err instanceof Error ? err.message : "Failed to create opening");
           }
         };
         ```

       - Pass onSlugGenerate callback to OpeningForm that auto-fills slug on name blur

       - Error display if error state set

       - OpeningForm with spirits, onSubmit, isSubmitting

    5. Add onSlugGenerate prop to OpeningForm (update form component):
       - In opening-form.tsx, add optional prop: onSlugGenerate?: (name: string) => string
       - Add onBlur handler to name field that calls onSlugGenerate if slug is empty
       - Use setValue from useForm to set the slug value
  </action>
  <verify>
    Run `pnpm typecheck` - no errors
    Run `pnpm dev` and navigate to /admin/openings/new - form loads
  </verify>
  <done>
    Create opening page loads spirits, shows form, generates slug from name
  </done>
</task>

<task type="auto">
  <name>Task 3: Create edit opening page</name>
  <files>
    app/routes/_admin/openings/$id.edit.tsx
  </files>
  <action>
    Create app/routes/_admin/openings/$id.edit.tsx:

    1. Imports:
       - createFileRoute, useNavigate from "@tanstack/react-router"
       - convexQuery, useConvexMutation from "@convex-dev/react-query"
       - useQuery from "@tanstack/react-query"
       - api from "convex/_generated/api"
       - type Id from "convex/_generated/dataModel"
       - OpeningForm from "@/components/admin/opening-form"
       - type OpeningFormData from "@/lib/schemas/opening"
       - TurnAccordion from "@/components/spirits/turn-accordion"
       - PageHeader from "@/components/ui/page-header"
       - Heading from "@/components/ui/typography"
       - useState from "react"

    2. Create route with ID param:
       ```typescript
       export const Route = createFileRoute("/_admin/openings/$id/edit")({
         component: EditOpeningPage,
       });
       ```

    3. EditOpeningPage component:
       - Get id from Route.useParams()
       - Query opening: useQuery(convexQuery(api.openings.getById, { id: id as Id<"openings"> }))
       - Query spirits: useQuery(convexQuery(api.spirits.listAllSpirits, {}))
       - Update mutation: useConvexMutation(api.openings.update)
       - Navigate hook: useNavigate()
       - Error state: [error, setError] = useState<string | null>(null)

       - Loading state while opening or spirits load
       - Not found state if opening is null

       - PageHeader with title "Edit Opening" and back link

       - Two-column layout on desktop (grid md:grid-cols-2 gap-8):
         Left column: Form
         Right column: Preview

       - Form handling:
         ```typescript
         const handleSubmit = async (data: OpeningFormData) => {
           setError(null);
           try {
             await updateMutation.mutateAsync({
               id: id as Id<"openings">,
               name: data.name,
               slug: data.slug,
               description: data.description || undefined,
               difficulty: data.difficulty || undefined,
               turns: data.turns,
               author: data.author || undefined,
               sourceUrl: data.sourceUrl || undefined,
             });
             navigate({ to: "/admin/openings" });
           } catch (err) {
             setError(err instanceof Error ? err.message : "Failed to update opening");
           }
         };
         ```

       - Convert opening data to form defaultValues:
         ```typescript
         const defaultValues: Partial<OpeningFormData> = {
           spiritId: opening.spiritId,
           name: opening.name,
           slug: opening.slug,
           description: opening.description ?? "",
           difficulty: opening.difficulty,
           turns: opening.turns,
           author: opening.author ?? "",
           sourceUrl: opening.sourceUrl ?? "",
         };
         ```

       - Preview section:
         - Heading "Preview"
         - TurnAccordion with opening.turns

       - Error display above form if error set
  </action>
  <verify>
    Run `pnpm typecheck` - no errors
    Run `pnpm dev`, create an opening, then edit it - form loads with data, preview shows
  </verify>
  <done>
    Edit page loads existing opening, shows form with data, displays preview with TurnAccordion
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. /admin/openings/new loads and allows creating opening
3. /admin/openings/$id/edit loads existing opening data
4. Slug auto-generates from name if empty
5. Preview updates when turns change (via form watch if implemented)
</verification>

<success_criteria>
- getById query returns single opening by ID
- Create page shows all spirits in dropdown
- Slug auto-generates from name on blur
- Successful create redirects to list
- Edit page pre-fills form with existing data
- Edit page shows live preview with TurnAccordion
- Successful update redirects to list
</success_criteria>

<output>
After completion, create `.planning/phases/05-text-opening-management/05-04-SUMMARY.md`
</output>
