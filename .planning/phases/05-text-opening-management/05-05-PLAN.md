---
phase: 05-text-opening-management
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - pnpm-lock.yaml
  - app/hooks/use-search.ts
  - app/routes/search.tsx
  - app/components/layout/bottom-nav.tsx
autonomous: true

must_haves:
  truths:
    - "Search finds spirits by name and aspectName"
    - "Search finds openings by name and description"
    - "Results are grouped by type (Spirits, Openings)"
    - "Search works offline (uses cached TanStack Query data)"
    - "Search input has debounced query"
    - "Bottom nav shows Search tab"
  artifacts:
    - path: "app/hooks/use-search.ts"
      provides: "Fuse.js search hook"
      exports: ["useSearch"]
    - path: "app/routes/search.tsx"
      provides: "Global search page"
      exports: ["Route"]
    - path: "app/components/layout/bottom-nav.tsx"
      provides: "Updated bottom nav with Search tab"
  key_links:
    - from: "app/hooks/use-search.ts"
      to: "fuse.js"
      via: "Fuse constructor"
      pattern: "new Fuse"
    - from: "app/routes/search.tsx"
      to: "app/hooks/use-search.ts"
      via: "useSearch hook"
      pattern: "useSearch\\("
---

<objective>
Implement global client-side search with Fuse.js.

Purpose: Enable users to quickly find spirits and openings through fuzzy search. The search works offline because it searches cached TanStack Query data, fulfilling SRCH-01/02/03 requirements.

Output:
- fuse.js installed
- useSearch hook with Fuse.js
- Search page with results grouped by type
- Bottom nav updated with Search tab
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-text-opening-management/05-RESEARCH.md
@app/components/layout/bottom-nav.tsx
@convex/spirits.ts
@convex/openings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Fuse.js and create search hook</name>
  <files>
    package.json
    pnpm-lock.yaml
    app/hooks/use-search.ts
    app/hooks/index.ts
  </files>
  <action>
    1. Install fuse.js:
       ```bash
       pnpm add fuse.js
       ```

    2. Create app/hooks/use-search.ts:
       ```typescript
       import Fuse from "fuse.js";
       import { useMemo } from "react";
       import type { Doc } from "convex/_generated/dataModel";

       type Spirit = Doc<"spirits">;
       type Opening = Doc<"openings"> & { spiritName?: string };

       interface SearchResults {
         spirits: Spirit[];
         openings: Opening[];
       }

       export function useSearch(
         spirits: Spirit[] | undefined,
         openings: Opening[] | undefined,
         query: string
       ): SearchResults {
         return useMemo(() => {
           // Return empty if no query or no data
           if (!query.trim() || !spirits || !openings) {
             return { spirits: [], openings: [] };
           }

           // Create Fuse instances with weighted keys
           const spiritFuse = new Fuse(spirits, {
             keys: [
               { name: "name", weight: 2 },
               { name: "aspectName", weight: 1.5 },
               { name: "summary", weight: 1 },
             ],
             threshold: 0.3,
             includeScore: true,
           });

           const openingFuse = new Fuse(openings, {
             keys: [
               { name: "name", weight: 2 },
               { name: "description", weight: 1 },
               { name: "spiritName", weight: 1.5 },
             ],
             threshold: 0.3,
             includeScore: true,
           });

           // Search and return top 10 results per type
           const spiritResults = spiritFuse.search(query).slice(0, 10).map(r => r.item);
           const openingResults = openingFuse.search(query).slice(0, 10).map(r => r.item);

           return { spirits: spiritResults, openings: openingResults };
         }, [spirits, openings, query]);
       }
       ```

    3. Update app/hooks/index.ts to export useSearch:
       Add: export { useSearch } from "./use-search";

    IMPORTANT: Include spirits and openings in useMemo dependencies to recreate Fuse when data changes.
  </action>
  <verify>
    Run `pnpm typecheck` - no errors
  </verify>
  <done>
    fuse.js installed, useSearch hook created with weighted keys and proper dependencies
  </done>
</task>

<task type="auto">
  <name>Task 2: Create search page</name>
  <files>
    app/routes/search.tsx
  </files>
  <action>
    Create app/routes/search.tsx:

    1. Imports:
       - createFileRoute, Link from "@tanstack/react-router"
       - convexQuery from "@convex-dev/react-query"
       - useQuery from "@tanstack/react-query"
       - api from "convex/_generated/api"
       - useSearch from "@/hooks"
       - PageHeader from "@/components/ui/page-header"
       - Heading, Text from "@/components/ui/typography"
       - Badge from "@/components/ui/badge"
       - Search as SearchIcon from "lucide-react"
       - useState, useMemo from "react"

    2. Create route:
       ```typescript
       export const Route = createFileRoute("/search")({
         component: SearchPage,
       });
       ```

    3. SearchPage component:
       - Query all spirits: useQuery(convexQuery(api.spirits.listAllSpirits, {}))
       - Query all openings: useQuery(convexQuery(api.openings.listAll, {}))
       - State: [query, setQuery] = useState("")
       - Debounced query for search (simple approach):
         ```typescript
         const [debouncedQuery, setDebouncedQuery] = useState("");
         useEffect(() => {
           const timer = setTimeout(() => setDebouncedQuery(query), 200);
           return () => clearTimeout(timer);
         }, [query]);
         ```
       - Search results: useSearch(spirits, openings, debouncedQuery)

       - Layout:
         a. PageHeader with title "Search"

         b. Search input (sticky top):
            ```tsx
            <div className="sticky top-0 bg-background/95 backdrop-blur z-10 pb-4">
              <div className="relative">
                <SearchIcon className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                <input
                  type="search"
                  placeholder="Search spirits and openings..."
                  value={query}
                  onChange={(e) => setQuery(e.target.value)}
                  className="w-full pl-10 pr-4 py-2 border border-border rounded-lg bg-background text-foreground"
                  autoFocus
                />
              </div>
            </div>
            ```

         c. Results sections (only show if results exist):

            Spirits section:
            ```tsx
            {results.spirits.length > 0 && (
              <section className="space-y-3">
                <Heading variant="h3">Spirits ({results.spirits.length})</Heading>
                {results.spirits.map(spirit => (
                  <Link
                    key={spirit._id}
                    to="/spirits/$slug"
                    params={{ slug: spirit.slug }}
                    className="block border border-border rounded-lg p-3 hover:bg-muted/30"
                  >
                    <Text className="font-medium">
                      {spirit.name}
                      {spirit.aspectName && ` (${spirit.aspectName})`}
                    </Text>
                    <Text variant="muted" className="text-sm truncate">
                      {spirit.summary}
                    </Text>
                  </Link>
                ))}
              </section>
            )}
            ```

            Openings section:
            ```tsx
            {results.openings.length > 0 && (
              <section className="space-y-3">
                <Heading variant="h3">Openings ({results.openings.length})</Heading>
                {results.openings.map(opening => (
                  <Link
                    key={opening._id}
                    to="/spirits/$slug"
                    params={{ slug: opening.spiritName?.split(" (")[0].toLowerCase().replace(/\s+/g, "-") || "" }}
                    className="block border border-border rounded-lg p-3 hover:bg-muted/30"
                  >
                    <Text className="font-medium">{opening.name}</Text>
                    <Text variant="muted" className="text-sm">
                      {opening.spiritName}
                    </Text>
                    {opening.difficulty && (
                      <Badge variant="outline" className="text-xs mt-1">
                        {opening.difficulty}
                      </Badge>
                    )}
                  </Link>
                ))}
              </section>
            )}
            ```

         d. Empty state (no results and query entered):
            "No results found for '{query}'"

         e. Initial state (no query):
            "Enter a search term to find spirits and openings."

    4. Add opening link logic:
       Opening links should go to the spirit page where the opening is displayed.
       For now, link to spirit page. Future: deep link to specific opening tab.
  </action>
  <verify>
    Run `pnpm typecheck` - no errors
    Run `pnpm dev` and navigate to /search - page loads with search input
  </verify>
  <done>
    Search page shows results grouped by Spirits and Openings, debounced input
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Search tab to bottom nav</name>
  <files>
    app/components/layout/bottom-nav.tsx
  </files>
  <action>
    Update app/components/layout/bottom-nav.tsx:

    1. Add Search to imports: import { ..., Search } from "lucide-react"

    2. Update type for enabled routes:
       Current: to: "/spirits" | "/settings"
       New: to: "/spirits" | "/search" | "/settings"

    3. Add Search nav item between Spirits and Settings:
       ```typescript
       {
         label: "Search",
         icon: Search,
         to: "/search",
         enabled: true,
       },
       ```

    4. Update the order: Spirits, Search, Settings (3 tabs total)

    This makes search accessible from anywhere in the app via bottom nav.
  </action>
  <verify>
    Run `pnpm typecheck` - no errors
    Run `pnpm dev` - bottom nav shows Search tab, clicking navigates to /search
  </verify>
  <done>
    Bottom nav has Search tab between Spirits and Settings
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm build` succeeds
3. /search page loads and shows search input
4. Typing shows results grouped by Spirits and Openings
5. Bottom nav has Search tab
6. Search works offline (disable network in devtools, search still works with cached data)
</verification>

<success_criteria>
- Fuse.js installed
- useSearch hook searches spirits by name/aspectName/summary
- useSearch hook searches openings by name/description/spiritName
- Results grouped by type with counts
- Search input is debounced (200ms)
- Bottom nav shows Search between Spirits and Settings
- Search works with cached data (offline capable)
</success_criteria>

<output>
After completion, create `.planning/phases/05-text-opening-management/05-05-SUMMARY.md`
</output>
