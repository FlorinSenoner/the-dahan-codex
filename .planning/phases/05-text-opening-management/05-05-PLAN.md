---
phase: 05-text-opening-management
plan: 05
type: execute
wave: 3
depends_on: ["05-04"]
files_modified:
  - app/routes/spirits.$slug.tsx
  - app/routes/spirits.$slug.$aspect.tsx
  - app/components/spirits/opening-section.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can create new openings via inline editor"
    - "Admin can save edits with FAB save button"
    - "Admin can delete openings with confirmation"
    - "Unsaved changes trigger warning on navigation"
  artifacts:
    - path: "app/routes/spirits.$slug.tsx"
      provides: "Spirit detail with edit mode integration"
      contains: "EditFab"
    - path: "app/components/spirits/opening-section.tsx"
      provides: "Full CRUD for openings"
      contains: "createOpening.*updateOpening.*deleteOpening"
  key_links:
    - from: "app/routes/spirits.$slug.tsx"
      to: "convex/openings.ts"
      via: "useMutation"
      pattern: "useMutation.*api\\.openings"
    - from: "app/routes/spirits.$slug.tsx"
      to: "app/components/admin/edit-fab.tsx"
      via: "render with callbacks"
      pattern: "EditFab.*onSave"
---

<objective>
Wire edit mode and CRUD operations into spirit detail pages with save/delete functionality.

Purpose: Complete the admin editing experience with working save, create, and delete operations.
Output: Full opening CRUD integrated with spirit detail, navigation blocking for unsaved changes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-text-opening-management/05-CONTEXT.md
@.planning/phases/05-text-opening-management/05-RESEARCH.md
@app/routes/spirits.$slug.tsx
@app/routes/spirits.$slug.$aspect.tsx
@app/components/spirits/opening-section.tsx
@app/components/admin/edit-fab.tsx
@convex/openings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update OpeningSection with full CRUD</name>
  <files>app/components/spirits/opening-section.tsx</files>
  <action>
Complete the OpeningSection component with:

1. Add state for:
   - formData: Opening form data
   - originalData: For change detection
   - isCreatingNew: Boolean for new opening mode
   - isSaving: Loading state for save

2. Add Convex mutations via useMutation:
   ```typescript
   import { useMutation } from 'convex/react';
   import { api } from 'convex/_generated/api';

   const createOpening = useMutation(api.openings.createOpening);
   const updateOpening = useMutation(api.openings.updateOpening);
   const deleteOpeningMutation = useMutation(api.openings.deleteOpening);
   ```

3. Initialize form data when:
   - Opening loads: Copy opening to formData and originalData
   - Enter edit mode: Reset to originalData
   - Exit edit mode: Clear formData

4. hasChanges calculation:
   ```typescript
   const hasChanges = useMemo(() => {
     if (!formData || !originalData) return false;
     return JSON.stringify(formData) !== JSON.stringify(originalData);
   }, [formData, originalData]);
   ```

5. Save handler:
   ```typescript
   const handleSave = async () => {
     if (!formData) return;
     setIsSaving(true);
     try {
       if (isCreatingNew) {
         await createOpening({
           spiritId,
           name: formData.name,
           description: formData.description || undefined,
           turns: formData.turns,
           author: formData.author || undefined,
           sourceUrl: formData.sourceUrl || undefined,
         });
       } else if (opening) {
         await updateOpening({
           id: opening._id,
           name: formData.name,
           description: formData.description || undefined,
           turns: formData.turns,
           author: formData.author || undefined,
           sourceUrl: formData.sourceUrl || undefined,
         });
       }
       // Data will refresh via query invalidation
       setIsCreatingNew(false);
     } catch (error) {
       console.error('Save failed:', error);
       // Could add toast notification here
     } finally {
       setIsSaving(false);
     }
   };
   ```

6. Delete handler:
   ```typescript
   const handleDelete = async () => {
     if (!opening) return;
     try {
       await deleteOpeningMutation({ id: opening._id });
       setFormData(null);
       setOriginalData(null);
     } catch (error) {
       console.error('Delete failed:', error);
     }
   };
   ```

7. Expose save handler to parent via useImperativeHandle or callback ref pattern:
   ```typescript
   // Option A: Callback prop that receives the save function
   interface OpeningSectionProps {
     spiritId: Id<'spirits'>;
     onSaveHandlerReady?: (saveHandler: (() => Promise<void>) | null) => void;
     onHasChangesChange?: (hasChanges: boolean) => void;
   }

   // In component, call onSaveHandlerReady when handler is available
   useEffect(() => {
     onSaveHandlerReady?.(formData ? handleSave : null);
   }, [formData, handleSave, onSaveHandlerReady]);
   ```

8. Call onHasChangesChange whenever hasChanges changes (useEffect)

9. "Add Opening" button UI when no openings exist:
   ```tsx
   {isEditing && !opening && !isCreatingNew && (
     <Button onClick={() => setIsCreatingNew(true)} className="w-full">
       <Plus className="h-4 w-4 mr-2" />
       Add Opening
     </Button>
   )}
   ```
  </action>
  <verify>pnpm typecheck passes</verify>
  <done>OpeningSection has full CRUD with change tracking</done>
</task>

<task type="auto">
  <name>Task 2: Integrate EditFab and navigation blocking into spirit detail</name>
  <files>app/routes/spirits.$slug.tsx</files>
  <action>
Update spirits.$slug.tsx:

1. Import EditFab and useBlocker:
   ```typescript
   import { useBlocker } from '@tanstack/react-router';
   import { EditFab } from '@/components/admin/edit-fab';
   import { useAdmin } from '@/hooks';
   ```

2. Add validation schema for edit param (add to route definition):
   ```typescript
   import { z } from 'zod';

   // Add to Route definition
   validateSearch: z.object({
     edit: z.boolean().optional(),
   }).optional(),
   ```

3. In SpiritDetailContent, add state:
   ```typescript
   const [hasChanges, setHasChanges] = useState(false);
   const [saveHandler, setSaveHandler] = useState<(() => Promise<void>) | null>(null);
   const isAdmin = useAdmin();
   ```

4. Add navigation blocking using correct TanStack Router API:
   ```typescript
   // CORRECT API per TanStack Router docs (from RESEARCH.md):
   useBlocker({
     shouldBlockFn: () => {
       if (!hasChanges) return false;
       return !confirm('You have unsaved changes. Leave anyway?');
     },
     enableBeforeUnload: hasChanges,
   });
   ```

   Note: The API uses `shouldBlockFn` (a function that returns boolean), NOT `condition`.
   The function returns `true` to block navigation, `false` to allow.
   Returning the result of `!confirm()` means: if user clicks Cancel (doesn't want to leave), confirm returns false, !false = true, navigation blocked.

5. Update OpeningSection usage to receive callbacks:
   ```tsx
   <OpeningSection
     spiritId={spirit._id}
     onSaveHandlerReady={setSaveHandler}
     onHasChangesChange={setHasChanges}
   />
   ```

6. Add EditFab at the end of the component (before closing tag):
   ```tsx
   {isAdmin && (
     <EditFab
       onSave={saveHandler || undefined}
       hasChanges={hasChanges}
     />
   )}
   ```

7. Apply same changes to spirits.$slug.$aspect.tsx for aspect pages.
  </action>
  <verify>pnpm dev - edit mode works, save button appears with changes, navigation warns on unsaved</verify>
  <done>Spirit detail integrates EditFab with save and navigation blocking</done>
</task>

</tasks>

<verification>
1. pnpm typecheck passes
2. EditFab appears for admin users on spirit detail pages
3. Save button appears when there are unsaved changes
4. Clicking save creates/updates opening in Convex
5. Delete button removes opening with confirmation
6. Navigating away with unsaved changes shows browser confirm dialog
7. Works on both base spirit and aspect pages
</verification>

<success_criteria>
- Admin can create new opening via "Add Opening" button
- Admin can edit existing opening and save changes
- Admin can delete opening with confirmation
- Unsaved changes trigger navigation warning
- CRUD operations persist to Convex database
</success_criteria>

<output>
After completion, create `.planning/phases/05-text-opening-management/05-05-SUMMARY.md`
</output>
