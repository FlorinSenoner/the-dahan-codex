---
phase: 05-text-opening-management
plan: 10
type: execute
wave: 3
depends_on: ["05-09"]
files_modified:
  - app/components/spirits/opening-section.tsx
  - app/components/admin/editable-opening.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Save button disabled until all required fields are filled"
    - "Each turn requires both title and instructions"
    - "Visual indication when validation fails"
  artifacts:
    - path: "app/components/spirits/opening-section.tsx"
      provides: "Validation logic for save handler"
      contains: "isValid"
    - path: "app/components/admin/editable-opening.tsx"
      provides: "Visual validation indicators on required fields"
  key_links:
    - from: "app/components/spirits/opening-section.tsx"
      to: "app/routes/spirits.$slug.tsx"
      via: "save handler validity"
      pattern: "onSaveHandlerReady"
---

<objective>
Add validation to prevent saving turns without required fields (title and instructions).

Purpose: Ensure data quality by requiring complete turn information before save
Output: Save button disabled until validation passes, visual feedback on required fields
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-text-opening-management/05-VERIFICATION.md
@.planning/phases/05-text-opening-management/05-09-SUMMARY.md

GAP-03 from VERIFICATION.md:
Can save turns without required fields.
Turn requires both title and instructions before save is allowed.
Depends on GAP-02 fix (auto-save removal) being complete.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add validation logic to OpeningSection</name>
  <files>app/components/spirits/opening-section.tsx</files>
  <action>
  Add an `isValid` computed state (useMemo) that checks:
  1. Opening name is not empty (required)
  2. At least one turn exists
  3. Each turn has:
     - Non-empty title (required - update from optional)
     - Non-empty instructions (required)

  Modify the save handler exposure:
  - Only expose handleSave via onSaveHandlerReady when BOTH hasChanges AND isValid are true
  - When invalid, expose null (no save handler available)

  Update the formData structure if needed to track validation state.

  Code pattern:
  ```typescript
  const isValid = useMemo(() => {
    if (!formData) return false;
    if (!formData.name.trim()) return false;
    if (formData.turns.length === 0) return false;
    for (const turn of formData.turns) {
      if (!turn.title?.trim()) return false;
      if (!turn.instructions.trim()) return false;
    }
    return true;
  }, [formData]);

  // In the useEffect that exposes save handler:
  onSaveHandlerReady?.(formData && hasChanges && isValid ? handleSave : null);
  ```
  </action>
  <verify>
  Run `pnpm typecheck` - compiles
  </verify>
  <done>Save handler only available when form is valid</done>
</task>

<task type="auto">
  <name>Task 2: Add visual validation feedback to EditableOpening</name>
  <files>app/components/admin/editable-opening.tsx</files>
  <action>
  Add visual indicators for required field validation:

  1. Opening Name field:
     - Add red border when empty: `border-destructive` class
     - Show inline error text "Opening name is required" when empty

  2. Turn Title field:
     - Update placeholder from "Turn title (optional)" to "Turn title *"
     - Add red border when empty after user has interacted
     - Show inline error "Title is required"

  3. Turn Instructions field:
     - Add red border when empty after user has interacted
     - Show inline error "Instructions are required"

  Implementation approach:
  - Track "touched" state for fields (onBlur sets touched)
  - Only show validation errors for touched fields
  - OR simpler: always show validation state visually but don't block UX

  Simpler approach (prefer this):
  - Add `required` styling via conditional classes
  - Fields with `required={true}` already exist on EditableText
  - Add visual indicator (asterisk) to labels
  - Use destructive border color for empty required fields

  Update the label text to include asterisks:
  - "Opening Name *"
  - "Turn Title *" (remove "(optional)")
  - "Instructions *" (add required indicator)
  </action>
  <verify>
  Run `pnpm typecheck` - compiles
  Run `pnpm build` - builds successfully
  </verify>
  <done>Required fields have visual indicators and validation styling</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm build` succeeds
3. Manual test: Create opening with empty name - save button disabled
4. Manual test: Create turn with empty title - save button disabled
5. Manual test: Create turn with empty instructions - save button disabled
6. Manual test: Fill all required fields - save button enabled
</verification>

<success_criteria>
- Cannot save opening with empty name
- Cannot save turn with empty title
- Cannot save turn with empty instructions
- Visual indicators show which fields are required
- Save button state reflects validation
</success_criteria>

<output>
After completion, create `.planning/phases/05-text-opening-management/05-10-SUMMARY.md`
</output>
