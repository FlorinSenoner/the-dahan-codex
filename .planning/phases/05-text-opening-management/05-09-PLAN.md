---
phase: 05-text-opening-management
plan: 09
type: execute
wave: 2
depends_on: ["05-08"]
files_modified:
  - app/components/spirits/opening-section.tsx
  - app/components/admin/editable-opening.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Form changes only saved when user clicks FAB save button"
    - "No auto-save on keystroke"
    - "No infinite loops or flickering when typing"
    - "Form data persists locally until explicit save"
  artifacts:
    - path: "app/components/spirits/opening-section.tsx"
      provides: "Opening section with controlled form state"
    - path: "app/components/admin/editable-opening.tsx"
      provides: "Opening editor with stable onChange callbacks"
  key_links:
    - from: "app/routes/spirits.$slug.tsx"
      to: "app/components/spirits/opening-section.tsx"
      via: "saveHandler callback"
      pattern: "onSaveHandlerReady"
---

<objective>
Fix auto-save flickering by ensuring saves only happen on explicit FAB button click, not on every keystroke. This also enables navigation warnings to work properly.

Purpose: Eliminate infinite loops and UI flickering during fast typing
Output: Stable form editing with explicit save action only
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-text-opening-management/05-VERIFICATION.md

GAP-02 from VERIFICATION.md:
Text inputs trigger saves on every keystroke, causing infinite loops and UI flickering.
Root cause: Form state updates trigger parent callbacks which may cause re-renders.
Save only when user clicks FAB save button, not on every change.

This is CRITICAL - blocking GAP-03, GAP-05, and general usability.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Stabilize EditableOpening callbacks</name>
  <files>app/components/admin/editable-opening.tsx</files>
  <action>
  The issue is that onChange is called on every keystroke, which triggers parent re-renders.

  Ensure the component:
  1. Uses stable callback references (useCallback where appropriate)
  2. Does NOT trigger any side effects on onChange - it just updates local state
  3. The onChange prop should be called with debouncing or only update local refs

  Key insight: The parent (OpeningSection) should maintain form state, and EditableOpening
  should be a controlled component that receives formData and calls onChange.

  The problem is likely in how updateField and updateTurn trigger onChange on every keystroke.
  The solution is:
  - Keep the current controlled pattern but ensure no cascading effects
  - Parent already uses useState for formData which is correct
  - Verify no useEffect is running on formData changes that triggers saves
  </action>
  <verify>
  Run `pnpm typecheck` - compiles
  Manual test: Type rapidly in form fields, no flickering or lag
  </verify>
  <done>Form updates don't cause cascading re-renders</done>
</task>

<task type="auto">
  <name>Task 2: Verify opening-section has no auto-save logic</name>
  <files>app/components/spirits/opening-section.tsx</files>
  <action>
  Review and ensure:
  1. NO useEffect that triggers handleSave automatically
  2. handleSave is ONLY exposed via onSaveHandlerReady callback
  3. The save only happens when parent (spirits.$slug.tsx) calls the handler via FAB click
  4. The hasChanges state is computed but doesn't trigger any side effects

  The current code looks correct - handleSave is exposed via callback, not auto-triggered.
  However, verify there's no hidden auto-save pattern.

  Double-check:
  - useEffect on line 61-80: Only initializes form data, doesn't trigger saves - GOOD
  - useEffect on line 113-115: Only notifies parent of hasChanges - GOOD
  - useEffect on line 180-182: Only exposes save handler - GOOD

  If flickering is happening, it may be due to:
  - hasChanges computation in useMemo causing re-renders
  - onHasChangesChange being unstable (should be useCallback in parent)

  Ensure onHasChangesChange and onSaveHandlerReady are wrapped in useCallback by parent.
  </action>
  <verify>
  Run `pnpm typecheck` - compiles
  Run `pnpm build` - builds successfully
  </verify>
  <done>No auto-save behavior exists, save only on explicit button click</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm build` succeeds
3. Manual test: Enter edit mode, type rapidly in any field, no flickering
4. Manual test: Type changes, navigate away without saving - should trigger navigation warning (GAP-05)
</verification>

<success_criteria>
- Fast typing in form fields causes no lag or flicker
- Save button in FAB is the only way to persist changes
- Changes are preserved in form state until explicit save or cancel
</success_criteria>

<output>
After completion, create `.planning/phases/05-text-opening-management/05-09-SUMMARY.md`
</output>
