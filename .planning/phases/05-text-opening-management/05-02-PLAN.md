---
phase: 05-text-opening-management
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/routes/spirits.index.tsx
  - app/components/spirits/spirit-search.tsx
autonomous: true

must_haves:
  truths:
    - "User can type in search bar and spirits list filters instantly"
    - "Search term persists in URL as ?search= parameter"
    - "Search filters spirits by name and summary/description"
    - "Search works together with existing filter chips (complexity, elements)"
  artifacts:
    - path: "app/components/spirits/spirit-search.tsx"
      provides: "Search input component"
      exports: ["SpiritSearch"]
    - path: "app/routes/spirits.index.tsx"
      provides: "Updated spirits page with search"
      contains: "SpiritSearch"
  key_links:
    - from: "app/routes/spirits.index.tsx"
      to: "app/components/spirits/spirit-search.tsx"
      via: "import and render"
      pattern: "SpiritSearch"
    - from: "app/components/spirits/spirit-search.tsx"
      to: "@tanstack/react-router"
      via: "useNavigate for URL state"
      pattern: "useNavigate.*search"
---

<objective>
Add search functionality to the spirits list page with URL-persisted search state.

Purpose: Allow users to quickly find spirits by name or description, with shareable filtered URLs.
Output: SpiritSearch component, updated spirits page with client-side filtering.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-text-opening-management/05-CONTEXT.md
@.planning/phases/05-text-opening-management/05-RESEARCH.md
@app/routes/spirits.index.tsx
@app/components/spirits/spirit-list.tsx
@app/components/spirits/filter-chips.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SpiritSearch component</name>
  <files>app/components/spirits/spirit-search.tsx</files>
  <action>
Create app/components/spirits/spirit-search.tsx with:

1. Takes current search value and onChange callback as props
2. Renders a search input with:
   - type="search" for native clear button
   - placeholder="Search spirits..."
   - Styling: w-full px-3 py-2 rounded-lg border bg-background
   - Search icon (lucide-react) on the left
3. Input is controlled by parent (value/onChange pattern)

```typescript
import { Search } from 'lucide-react';

interface SpiritSearchProps {
  value: string;
  onChange: (value: string) => void;
}

export function SpiritSearch({ value, onChange }: SpiritSearchProps) {
  return (
    <div className="relative">
      <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
      <input
        type="search"
        value={value}
        onChange={(e) => onChange(e.target.value)}
        placeholder="Search spirits..."
        className="w-full pl-10 pr-4 py-2 rounded-lg border border-border bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/50"
      />
    </div>
  );
}
```
  </action>
  <verify>pnpm typecheck passes</verify>
  <done>SpiritSearch component created with proper styling</done>
</task>

<task type="auto">
  <name>Task 2: Integrate search into spirits page</name>
  <files>app/routes/spirits.index.tsx</files>
  <action>
Update app/routes/spirits.index.tsx:

1. Add search to the Zod validation schema:
   - search: z.string().optional().catch(undefined)

2. Import SpiritSearch component and useDeferredValue from React

3. In SpiritsPage component:
   - Get search from Route.useSearch()
   - Use useDeferredValue for the search term (for smooth filtering)
   - Use useNavigate to update search param
   - Create handleSearchChange callback:
     ```typescript
     const handleSearchChange = (value: string) => {
       navigate({
         search: (prev) => ({ ...prev, search: value || undefined }),
         replace: true,
       });
     };
     ```

4. **IMPORTANT: Search filters AFTER existing backend filters.** The existing complexity/elements filters are applied server-side by `api.spirits.listSpirits`. Search applies client-side on top of those results:

   ```typescript
   const filteredSpirits = useMemo(() => {
     // Start with spirits already filtered by complexity/elements from Convex
     if (!deferredSearch) return spirits;
     const lower = deferredSearch.toLowerCase();
     return spirits.filter(s =>
       s.name.toLowerCase().includes(lower) ||
       s.summary?.toLowerCase().includes(lower) ||
       s.description?.toLowerCase().includes(lower)
     );
   }, [spirits, deferredSearch]);
   ```

   This means: User sets complexity=["Low"] via FilterChips, then types "river" in search bar, result is spirits matching BOTH criteria.

5. Add SpiritSearch below PageHeader, before FilterChips:
   ```tsx
   <div className="px-4 py-2">
     <SpiritSearch value={filters.search || ''} onChange={handleSearchChange} />
   </div>
   ```

6. Pass filteredSpirits to SpiritList instead of spirits

7. Show result count when search is active:
   ```tsx
   {deferredSearch && (
     <Text variant="muted" className="px-4 text-sm">
       {filteredSpirits.length} spirit{filteredSpirits.length !== 1 ? 's' : ''} found
     </Text>
   )}
   ```
  </action>
  <verify>pnpm dev - search works, URL shows ?search=term, filtering is instant, search+filter chips work together</verify>
  <done>Search filters spirits by name/summary/description with URL persistence and integrates with existing filter system</done>
</task>

</tasks>

<verification>
1. pnpm typecheck passes
2. Search input appears on spirits page
3. Typing filters the list instantly
4. URL updates with ?search= parameter
5. Refreshing page with ?search=river shows filtered results
6. Clearing search shows all spirits
7. Search + complexity filter work together (e.g., ?complexity=Low&search=river shows only Low complexity spirits with "river" in name)
</verification>

<success_criteria>
- Search bar visible on spirits list page
- Filtering works on name, summary, and description fields
- URL state persists search term (?search=)
- Filter count shows when search is active
- Search applies on top of existing filter chip selections (both filter systems work together)
</success_criteria>

<output>
After completion, create `.planning/phases/05-text-opening-management/05-02-SUMMARY.md`
</output>
