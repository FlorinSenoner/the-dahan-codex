---
phase: 05-text-opening-management
plan: 06
type: execute
wave: 4
depends_on: ["05-01", "05-02", "05-03", "05-04", "05-05"]
files_modified:
  - e2e/admin.spec.ts
  - e2e/search.spec.ts
autonomous: false

must_haves:
  truths:
    - "Non-admin users cannot see edit FAB"
    - "Search filters spirits correctly"
    - "All E2E tests pass"
  artifacts:
    - path: "e2e/admin.spec.ts"
      provides: "Admin access control tests (non-admin perspective)"
      contains: "test.*admin"
    - path: "e2e/search.spec.ts"
      provides: "Search functionality tests"
      contains: "test.*search"
  key_links:
    - from: "e2e/admin.spec.ts"
      to: "app/routes/spirits.$slug.tsx"
      via: "page navigation and assertions"
      pattern: "page\\.goto.*spirits"
---

<objective>
Add E2E tests for admin functionality (non-admin perspective) and search, then verify complete phase integration.

Purpose: Ensure admin access control works correctly for non-admin users and all new features are testable.
Output: E2E test files for admin access control and search features, passing test suite.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-text-opening-management/05-CONTEXT.md
@e2e/spirits.spec.ts
@e2e/settings.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create search E2E tests</name>
  <files>e2e/search.spec.ts</files>
  <action>
Create e2e/search.spec.ts with tests for search functionality:

```typescript
import { test, expect } from '@playwright/test';

test.describe('Spirit Search', () => {
  test('search input is visible on spirits page', async ({ page }) => {
    await page.goto('/spirits');
    await expect(page.getByPlaceholder('Search spirits...')).toBeVisible();
  });

  test('search filters spirits by name', async ({ page }) => {
    await page.goto('/spirits');
    const searchInput = page.getByPlaceholder('Search spirits...');

    // Type search term
    await searchInput.fill('River');

    // Should show River spirit
    await expect(page.getByText('River Surges in Sunlight')).toBeVisible();

    // Should filter out non-matching spirits
    // (verify fewer results or specific spirit not visible)
  });

  test('search term persists in URL', async ({ page }) => {
    await page.goto('/spirits');
    const searchInput = page.getByPlaceholder('Search spirits...');

    await searchInput.fill('Lightning');

    // URL should contain search param
    await expect(page).toHaveURL(/search=Lightning/i);
  });

  test('search from URL shows filtered results', async ({ page }) => {
    // Navigate directly with search param
    await page.goto('/spirits?search=River');

    // Search input should have value
    const searchInput = page.getByPlaceholder('Search spirits...');
    await expect(searchInput).toHaveValue('River');

    // Results should be filtered
    await expect(page.getByText('River Surges in Sunlight')).toBeVisible();
  });

  test('clearing search shows all spirits', async ({ page }) => {
    await page.goto('/spirits?search=River');
    const searchInput = page.getByPlaceholder('Search spirits...');

    // Clear the search
    await searchInput.clear();

    // URL should not have search param
    await expect(page).not.toHaveURL(/search=/);

    // Multiple spirits should be visible
    await expect(page.getByText('River Surges in Sunlight')).toBeVisible();
    await expect(page.getByText("Lightning's Swift Strike")).toBeVisible();
  });
});
```
  </action>
  <verify>pnpm test:e2e e2e/search.spec.ts passes</verify>
  <done>Search E2E tests created and passing</done>
</task>

<task type="auto">
  <name>Task 2: Create admin access control E2E tests</name>
  <files>e2e/admin.spec.ts</files>
  <action>
Create e2e/admin.spec.ts with tests for admin access control:

**IMPORTANT:** These tests verify that NON-ADMIN users cannot access admin features. Full admin CRUD testing requires an authenticated admin user which is complex to set up in E2E tests. Admin CRUD functionality is verified via manual testing in the checkpoint task.

```typescript
import { test, expect } from '@playwright/test';

test.describe('Admin Features - Non-Admin User', () => {
  test('edit FAB is not visible for non-admin users', async ({ page }) => {
    await page.goto('/spirits/river-surges-in-sunlight');

    // Wait for page to fully load
    await expect(page.getByRole('heading', { name: 'River Surges in Sunlight' })).toBeVisible();

    // Edit FAB should not be visible (aria-label "Enter edit mode")
    await expect(page.getByRole('button', { name: 'Enter edit mode' })).not.toBeVisible();
  });

  test('edit URL param does not activate edit mode for non-admin', async ({ page }) => {
    // Try to access edit mode via URL
    await page.goto('/spirits/river-surges-in-sunlight?edit=true');

    // Page should load normally
    await expect(page.getByRole('heading', { name: 'River Surges in Sunlight' })).toBeVisible();

    // Edit FAB should still not be visible
    await expect(page.getByRole('button', { name: 'Enter edit mode' })).not.toBeVisible();

    // No edit UI should be visible (editable inputs)
    await expect(page.locator('input[placeholder="Opening Name"]')).not.toBeVisible();
  });

  test('opening section displays correctly for non-admin', async ({ page }) => {
    await page.goto('/spirits/river-surges-in-sunlight');

    // If openings exist, they should display in read-only mode
    // Look for opening content or "Openings" heading
    const openingsHeading = page.getByRole('heading', { name: 'Openings' });

    // Either openings section exists (with content) or doesn't (no openings)
    // This test just verifies no crash and expected structure
    await expect(page.getByRole('heading', { name: 'River Surges in Sunlight' })).toBeVisible();
  });
});

test.describe('Admin Features - URL State', () => {
  test('edit param is preserved across navigation within spirit', async ({ page }) => {
    // This tests URL state behavior, not admin access
    await page.goto('/spirits/river-surges-in-sunlight?edit=true');

    // URL should have edit param
    await expect(page).toHaveURL(/edit=true/);

    // Navigate back to spirits list
    await page.getByRole('button', { name: 'Back to spirits' }).click();

    // Edit param should be gone on spirits list
    await expect(page).not.toHaveURL(/edit=true/);
  });
});

// NOTE: Admin CRUD tests would require:
// 1. A test user with isAdmin=true in Clerk publicMetadata
// 2. Authentication setup in Playwright
// 3. These are verified manually in the checkpoint task below
//
// Manual test steps for admin users:
// 1. Log in as admin (user with isAdmin: true in Clerk)
// 2. Navigate to /spirits/river-surges-in-sunlight
// 3. Verify edit FAB appears (pencil button bottom-right)
// 4. Click FAB to enter edit mode, verify URL shows ?edit=true
// 5. Edit opening fields, verify save button appears
// 6. Save changes, verify persistence
// 7. Test delete with confirmation dialog
// 8. Test navigation blocking with unsaved changes
```
  </action>
  <verify>pnpm test:e2e e2e/admin.spec.ts passes</verify>
  <done>Admin access control E2E tests created and passing</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 5 implementation:
    - Search bar on spirits list page
    - Admin edit mode with FAB toggle
    - Inline opening editor (create/edit/delete)
    - URL-based edit state
    - Navigation blocking for unsaved changes
  </what-built>
  <how-to-verify>
    1. Visit /spirits - search bar should be visible
    2. Type "River" - list should filter to show only River spirit
    3. Clear search - all spirits should show again
    4. Check URL updates with ?search= param

    For admin testing (requires Clerk admin user):
    5. Log in as admin user
    6. Visit /spirits/river-surges-in-sunlight
    7. Verify edit FAB (pencil button) appears bottom-right
    8. Click FAB to enter edit mode
    9. URL should show ?edit=true
    10. Opening section should show editable fields
    11. Make a change (edit opening name)
    12. Save button should appear in FAB
    13. Try to navigate away - should show unsaved changes warning
    14. Click save - changes should persist
    15. Exit edit mode (click X) - should show read-only view

    For non-admin testing:
    16. Log out or use non-admin account
    17. Visit /spirits/river-surges-in-sunlight
    18. Edit FAB should NOT be visible
    19. Visit /spirits/river-surges-in-sunlight?edit=true
    20. Still no edit UI visible
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. pnpm test:e2e passes all tests
2. Search functionality works as expected
3. Admin FAB hidden for non-admin users
4. Edit mode activates only for admins (manual verification)
5. CRUD operations work for admin users (manual verification)
6. Navigation blocking prevents data loss (manual verification)
</verification>

<success_criteria>
- All E2E tests pass
- Search filters spirits correctly
- Non-admin users cannot access edit mode (verified by E2E tests)
- Admin users can create/edit/delete openings (verified manually in checkpoint)
- Phase 5 success criteria from ROADMAP.md are met
</success_criteria>

<output>
After completion, create `.planning/phases/05-text-opening-management/05-06-SUMMARY.md`
</output>
