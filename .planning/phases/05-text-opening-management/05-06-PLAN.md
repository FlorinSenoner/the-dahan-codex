---
phase: 05-text-opening-management
plan: 06
type: execute
wave: 4
depends_on: ["05-04", "05-05"]
files_modified:
  - e2e/admin-openings.spec.ts
  - e2e/search.spec.ts
autonomous: true

must_haves:
  truths:
    - "E2E test verifies admin can access /admin/openings"
    - "E2E test verifies non-admin is redirected from admin routes"
    - "E2E test verifies search finds spirit by name"
    - "E2E test verifies search shows grouped results"
  artifacts:
    - path: "e2e/admin-openings.spec.ts"
      provides: "Admin opening management E2E tests"
    - path: "e2e/search.spec.ts"
      provides: "Global search E2E tests"
  key_links:
    - from: "e2e/admin-openings.spec.ts"
      to: "app/routes/_admin/openings/index.tsx"
      via: "Playwright navigation"
      pattern: "goto.*admin.*openings"
    - from: "e2e/search.spec.ts"
      to: "app/routes/search.tsx"
      via: "Playwright navigation"
      pattern: "goto.*search"
---

<objective>
Add E2E tests for admin openings management and global search.

Purpose: Verify the critical user flows work end-to-end: admin route protection, opening CRUD, and search functionality.

Output:
- E2E tests for admin openings page (access control)
- E2E tests for search page (spirit and opening search)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@e2e/spirits.spec.ts
@e2e/pwa.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create search E2E tests</name>
  <files>
    e2e/search.spec.ts
  </files>
  <action>
    Create e2e/search.spec.ts:

    ```typescript
    import { test, expect } from "@playwright/test";

    test.describe("Search Page", () => {
      test.beforeEach(async ({ page }) => {
        // Navigate to search page
        await page.goto("/search");
      });

      test("shows search input on load", async ({ page }) => {
        // Search input should be visible and focused
        const searchInput = page.getByRole("searchbox");
        await expect(searchInput).toBeVisible();
        await expect(searchInput).toHaveAttribute("placeholder", /search/i);
      });

      test("shows initial empty state", async ({ page }) => {
        // Should show instruction text when no query
        await expect(page.getByText(/enter a search term/i)).toBeVisible();
      });

      test("finds spirit by name", async ({ page }) => {
        // Type spirit name
        const searchInput = page.getByRole("searchbox");
        await searchInput.fill("River");

        // Wait for debounce and results
        await page.waitForTimeout(300);

        // Should show spirits section with result
        await expect(page.getByRole("heading", { name: /spirits/i })).toBeVisible();
        await expect(page.getByText("River Surges in Sunlight")).toBeVisible();
      });

      test("shows no results for gibberish", async ({ page }) => {
        const searchInput = page.getByRole("searchbox");
        await searchInput.fill("xyznonexistent123");

        await page.waitForTimeout(300);

        // Should show no results message
        await expect(page.getByText(/no results found/i)).toBeVisible();
      });

      test("clicking result navigates to spirit", async ({ page }) => {
        const searchInput = page.getByRole("searchbox");
        await searchInput.fill("River");
        await page.waitForTimeout(300);

        // Click the result
        await page.getByText("River Surges in Sunlight").click();

        // Should navigate to spirit page
        await expect(page).toHaveURL(/\/spirits\/river/);
      });

      test("search tab in bottom nav works", async ({ page }) => {
        // Go to spirits page first
        await page.goto("/spirits");

        // Click search tab in bottom nav
        await page.getByRole("link", { name: /search/i }).click();

        // Should be on search page
        await expect(page).toHaveURL("/search");
        await expect(page.getByRole("searchbox")).toBeVisible();
      });
    });
    ```
  </action>
  <verify>
    Run `pnpm test:e2e e2e/search.spec.ts` - tests pass
  </verify>
  <done>
    Search E2E tests verify input, results, navigation
  </done>
</task>

<task type="auto">
  <name>Task 2: Create admin openings E2E tests</name>
  <files>
    e2e/admin-openings.spec.ts
  </files>
  <action>
    Create e2e/admin-openings.spec.ts:

    Note: These tests verify route protection. Full CRUD testing requires admin authentication setup which may need manual Clerk configuration.

    ```typescript
    import { test, expect } from "@playwright/test";

    test.describe("Admin Openings", () => {
      test.describe("Unauthenticated user", () => {
        test("redirects from admin route to home", async ({ page }) => {
          // Try to access admin page without auth
          await page.goto("/admin/openings");

          // Should redirect to home or show access denied
          // The _admin layout redirects non-admins to "/"
          await expect(page).toHaveURL("/");
        });

        test("redirects from admin new page to home", async ({ page }) => {
          await page.goto("/admin/openings/new");
          await expect(page).toHaveURL("/");
        });
      });

      // Note: Testing authenticated admin flows requires:
      // 1. Clerk test user with isAdmin=true in publicMetadata
      // 2. Authentication setup in Playwright
      // These tests are marked as skipped until auth setup is configured
      test.describe.skip("Authenticated admin", () => {
        // These tests would run with admin authentication
        // See Playwright auth docs: https://playwright.dev/docs/auth

        test("can access openings list", async ({ page }) => {
          await page.goto("/admin/openings");
          await expect(page.getByRole("heading", { name: /manage openings/i })).toBeVisible();
        });

        test("can navigate to new opening form", async ({ page }) => {
          await page.goto("/admin/openings");
          await page.getByRole("link", { name: /new opening/i }).click();
          await expect(page).toHaveURL("/admin/openings/new");
        });

        test("new opening form has required fields", async ({ page }) => {
          await page.goto("/admin/openings/new");
          await expect(page.getByLabel(/spirit/i)).toBeVisible();
          await expect(page.getByLabel(/name/i)).toBeVisible();
          await expect(page.getByLabel(/slug/i)).toBeVisible();
        });
      });
    });
    ```
  </action>
  <verify>
    Run `pnpm test:e2e e2e/admin-openings.spec.ts` - unauthenticated tests pass
  </verify>
  <done>
    Admin E2E tests verify route protection for unauthenticated users
  </done>
</task>

</tasks>

<verification>
1. `pnpm test:e2e` runs all tests including new ones
2. Search tests verify finding spirits
3. Admin tests verify redirect for non-admins
</verification>

<success_criteria>
- Search E2E tests pass
- Admin route protection E2E tests pass
- Tests are skipped appropriately when auth not configured
</success_criteria>

<output>
After completion, create `.planning/phases/05-text-opening-management/05-06-SUMMARY.md`
</output>
