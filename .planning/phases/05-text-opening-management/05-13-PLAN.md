---
phase: 05-text-opening-management
plan: 13
type: execute
wave: 2
depends_on: []
files_modified:
  - app/components/spirits/opening-section.tsx
  - app/routes/spirits.$slug.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Page does not scroll when toggling edit mode"
    - "Edit components appear in place of display components"
    - "Scroll position preserved during mode transitions"
  artifacts:
    - path: "app/components/spirits/opening-section.tsx"
      provides: "Smooth edit mode transition"
    - path: "app/routes/spirits.$slug.tsx"
      provides: "Stable scroll behavior on edit toggle"
  key_links:
    - from: "app/routes/spirits.$slug.tsx"
      to: "app/components/spirits/opening-section.tsx"
      via: "edit mode context"
      pattern: "useEditMode"
---

<objective>
Fix page scrolling to top when toggling edit mode. Components should swap in place.

Purpose: Better UX - user doesn't lose their position when entering/exiting edit mode
Output: Scroll position preserved during edit mode transitions
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-text-opening-management/05-VERIFICATION.md

GAP-08 from VERIFICATION.md:
Clicking edit FAB causes page to scroll to top.
Expected: No scroll change, just swap display components for edit components in place.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Investigate scroll cause in opening-section</name>
  <files>app/components/spirits/opening-section.tsx</files>
  <action>
  Potential causes of scroll jump:

  1. Component unmount/remount causing DOM reflow
  2. Conditional rendering causing layout shift
  3. Focus management moving focus to top of page
  4. Key prop changes causing full remount

  Investigation steps:
  - Check if the section uses different key props in edit vs display mode
  - Check if there's any focus() call that moves focus
  - Check if the conditional rendering pattern causes remount

  Current pattern (around line 209-254):
  ```tsx
  if (isEditing) {
    if ((opening && formData) || isCreatingNew) {
      return <section>...EditableOpening...</section>;
    }
    return <section>...Create button...</section>;
  }
  return <section>...TurnAccordion...</section>;
  ```

  This pattern causes different JSX trees to be returned, which React reconciles.
  The sections have the same structure, so React should handle this well.

  Possible fixes:
  1. Use CSS visibility/display instead of conditional rendering
  2. Ensure stable keys on the section element
  3. Add `position: relative` or stable layout to prevent reflow

  Preferred fix - render both and hide one:
  ```tsx
  return (
    <section className="space-y-4">
      <Heading>...</Heading>
      {isEditing ? (
        // Edit mode content
      ) : (
        // Display mode content
      )}
    </section>
  );
  ```

  This keeps the section mounted and only swaps content.
  </action>
  <verify>
  Run `pnpm typecheck` - compiles
  </verify>
  <done>Identified and fixed scroll cause in opening section</done>
</task>

<task type="auto">
  <name>Task 2: Fix scroll behavior in spirit detail page</name>
  <files>app/routes/spirits.$slug.tsx</files>
  <action>
  Check for scroll-triggering behavior in the parent page:

  1. Check EditFab component - does it trigger scroll on click?
  2. Check if any useEffect runs on edit mode toggle that scrolls
  3. Check if state updates cause unnecessary re-renders of parent elements

  The EditFab toggles edit mode. If the toggle causes a re-render that
  unmounts/remounts major components, that could cause scroll.

  Potential fixes:
  - Ensure edit mode toggle doesn't cause parent component remount
  - Add scroll preservation before/after toggle:
    ```tsx
    const handleToggleEdit = useCallback(() => {
      const scrollY = window.scrollY;
      toggleEdit();
      requestAnimationFrame(() => {
        window.scrollTo(0, scrollY);
      });
    }, [toggleEdit]);
    ```

  However, this is a workaround. Better to fix the root cause in components.

  Check SpiritDetailContent - it should not remount when isEditing changes
  because isEditing comes from context, not props that would cause remount.

  Most likely fix: Ensure OpeningSection uses stable rendering pattern
  as described in Task 1.
  </action>
  <verify>
  Run `pnpm typecheck` - compiles
  Run `pnpm build` - builds successfully
  </verify>
  <done>Scroll position preserved when toggling edit mode</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm build` succeeds
3. Manual test: Scroll down to openings section
4. Manual test: Click edit FAB - page should NOT scroll
5. Manual test: Make edits, click save - page should NOT scroll
6. Manual test: Click edit FAB to exit edit mode - page should NOT scroll
</verification>

<success_criteria>
- Entering edit mode does not change scroll position
- Exiting edit mode does not change scroll position
- Saving changes does not change scroll position
- Components swap smoothly without layout shift
</success_criteria>

<output>
After completion, create `.planning/phases/05-text-opening-management/05-13-SUMMARY.md`
</output>
