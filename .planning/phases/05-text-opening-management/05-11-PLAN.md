---
phase: 05-text-opening-management
plan: 11
type: execute
wave: 3
depends_on: ["05-09"]
files_modified:
  - app/routes/spirits.$slug.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User warned when navigating away with unsaved changes"
    - "Browser beforeunload event triggered on page close"
    - "In-app navigation blocked with confirmation dialog"
  artifacts:
    - path: "app/routes/spirits.$slug.tsx"
      provides: "Navigation blocking with useBlocker"
      contains: "useBlocker"
  key_links:
    - from: "app/routes/spirits.$slug.tsx"
      to: "app/components/spirits/opening-section.tsx"
      via: "hasChanges state"
      pattern: "onHasChangesChange"
---

<objective>
Verify and fix navigation warning when leaving page with unsaved changes.

Purpose: Prevent accidental loss of unsaved opening edits
Output: Users see confirmation dialog when navigating away with changes
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-text-opening-management/05-VERIFICATION.md
@.planning/phases/05-text-opening-management/05-09-SUMMARY.md

GAP-05 from VERIFICATION.md:
Navigation blocking doesn't trigger because changes are auto-saved.
With auto-save removed (GAP-02), useBlocker should work correctly.
Depends on GAP-02 fix being complete.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify and fix useBlocker configuration</name>
  <files>app/routes/spirits.$slug.tsx</files>
  <action>
  The current useBlocker implementation is on lines 214-220:
  ```typescript
  useBlocker({
    shouldBlockFn: () => {
      if (!hasChanges) return false;
      return !confirm("You have unsaved changes. Leave anyway?");
    },
    enableBeforeUnload: hasChanges,
  });
  ```

  This looks correct. Verify it works after GAP-02 (auto-save removal) is fixed.

  Potential issues to check:
  1. hasChanges might not be updating correctly when formData changes
  2. The confirm dialog might not be showing due to browser restrictions
  3. shouldBlockFn returning false when it should block

  Ensure:
  - hasChanges is set to true when form data differs from original
  - The blocker is only active in edit mode (when isEditing = true)
  - The confirm message is clear

  If needed, add defensive check for edit mode:
  ```typescript
  const { isEditing } = useEditMode(); // if available in this scope

  useBlocker({
    shouldBlockFn: () => {
      if (!hasChanges) return false;
      return !confirm("You have unsaved changes. Leave anyway?");
    },
    enableBeforeUnload: hasChanges,
  });
  ```

  The implementation looks correct. If it's not working, the issue is likely that:
  1. hasChanges is always false due to auto-save (fixed by GAP-02)
  2. Or the callback reference is stale

  Add a condition to ensure callbacks are stable using useCallback for setHasChanges if needed.
  </action>
  <verify>
  Run `pnpm typecheck` - compiles
  Run `pnpm build` - builds successfully
  </verify>
  <done>Navigation blocking works when hasChanges is true</done>
</task>

<task type="auto">
  <name>Task 2: Ensure hasChanges callback is stable</name>
  <files>app/routes/spirits.$slug.tsx</files>
  <action>
  Verify that the callback passed to OpeningSection for onHasChangesChange is stable.

  Current code uses setHasChanges directly, which is stable from useState.

  If needed, wrap in useCallback:
  ```typescript
  const handleHasChangesChange = useCallback((changes: boolean) => {
    setHasChanges(changes);
  }, []);
  ```

  And pass handleHasChangesChange to OpeningSection.

  Also verify that hasChanges state is actually being set:
  - Add console.log in development to verify hasChanges updates
  - Remove console.log before committing

  The key test is:
  1. Enter edit mode
  2. Make a change to any field
  3. Try to navigate away (click back button or browser back)
  4. Should see "You have unsaved changes. Leave anyway?" dialog
  </action>
  <verify>
  Run `pnpm typecheck` - compiles
  Manual test: Edit field, navigate away, see confirmation
  </verify>
  <done>Navigation warning displays when leaving with unsaved changes</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm build` succeeds
3. Manual test: Enter edit mode, change a field, click back button
   - Should see browser confirm dialog
4. Manual test: Enter edit mode, change a field, close browser tab
   - Should see browser beforeunload warning
5. Manual test: Save changes, navigate away - no warning
</verification>

<success_criteria>
- Browser confirm dialog appears when navigating with unsaved changes
- Browser beforeunload warning appears when closing tab with unsaved changes
- No warning when no changes or after saving
</success_criteria>

<output>
After completion, create `.planning/phases/05-text-opening-management/05-11-SUMMARY.md`
</output>
