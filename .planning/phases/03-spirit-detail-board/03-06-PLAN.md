---
phase: 03-spirit-detail-board
plan: 06
type: execute
wave: 5
depends_on: ["03-05"]
files_modified:
  - app/components/spirits/external-links.tsx
  - app/routes/spirits.$slug.tsx
  - app/routes/spirits.$slug.$aspect.tsx
  - e2e/spirits.spec.ts
autonomous: false

must_haves:
  truths:
    - "Wiki link opens in new tab"
    - "FAQ link opens in new tab"
    - "Card catalogue search link opens in new tab"
    - "External links have proper rel attributes for security"
    - "E2E tests verify spirit detail functionality"
  artifacts:
    - path: "app/components/spirits/external-links.tsx"
      provides: "External resource links component"
      min_lines: 30
    - path: "e2e/spirits.spec.ts"
      provides: "E2E tests for spirit detail"
      contains: "variant"
  key_links:
    - from: "app/components/spirits/external-links.tsx"
      to: "spirit.wikiUrl"
      via: "prop drilling"
      pattern: "wikiUrl.*href"
    - from: "app/routes/spirits.$slug.tsx"
      to: "app/components/spirits/external-links.tsx"
      via: "component import"
      pattern: "import.*ExternalLinks"
---

<objective>
Add external resource links and verify the complete Phase 3 implementation with E2E tests and human verification.

Purpose: Complete DTAIL-08 requirement and validate all Phase 3 functionality.
Output: External links component, E2E tests passing, human verification of visual/functional quality.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-spirit-detail-board/03-CONTEXT.md
@.planning/phases/03-spirit-detail-board/03-05-SUMMARY.md
@e2e/spirits.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExternalLinks component</name>
  <files>app/components/spirits/external-links.tsx</files>
  <action>
Create a component that displays external resource links for the spirit.

```typescript
import { ExternalLink, BookOpen, HelpCircle, Search } from "lucide-react";
import { Heading, Text } from "@/components/ui/typography";

interface ExternalLinksProps {
  spiritName: string;
  wikiUrl?: string;
}

function ResourceLink({
  href,
  icon: Icon,
  label,
  description,
}: {
  href: string;
  icon: React.ComponentType<{ className?: string }>;
  label: string;
  description: string;
}) {
  return (
    <a
      href={href}
      target="_blank"
      rel="noopener noreferrer"
      className="flex items-start gap-3 p-3 rounded-lg bg-muted/30 border border-border hover:border-primary/50 hover:bg-muted/50 transition-colors group"
    >
      <Icon className="h-5 w-5 text-muted-foreground group-hover:text-primary shrink-0 mt-0.5" />
      <div className="space-y-0.5 min-w-0">
        <div className="flex items-center gap-1">
          <span className="font-medium text-sm group-hover:text-primary">
            {label}
          </span>
          <ExternalLink className="h-3 w-3 text-muted-foreground" />
        </div>
        <Text variant="small" className="text-muted-foreground">
          {description}
        </Text>
      </div>
    </a>
  );
}

export function ExternalLinks({ spiritName, wikiUrl }: ExternalLinksProps) {
  // Build search URLs
  const faqSearchUrl = `https://querki.net/u/darker/spirit-island-faq/#!spirit-island-faq?search=${encodeURIComponent(spiritName)}`;
  const cardSearchUrl = `https://sick.oberien.de/?query=${encodeURIComponent(spiritName)}`;

  return (
    <section className="space-y-3 pt-4 border-t border-border">
      <Heading variant="h3" as="h2">Resources</Heading>

      <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
        {wikiUrl && (
          <ResourceLink
            href={wikiUrl}
            icon={BookOpen}
            label="Spirit Island Wiki"
            description="Official wiki with detailed strategy guides"
          />
        )}

        <ResourceLink
          href={faqSearchUrl}
          icon={HelpCircle}
          label="FAQ & Rulings"
          description="Search official rulings and clarifications"
        />

        <ResourceLink
          href={cardSearchUrl}
          icon={Search}
          label="Card Catalogue"
          description="View full card images and artwork"
        />
      </div>

      <Text variant="small" className="text-muted-foreground text-center pt-2">
        Links open in a new tab
      </Text>
    </section>
  );
}
```

Key implementation details:
- target="_blank" rel="noopener noreferrer" for security
- External link icon indicates new tab
- FAQ search pre-fills spirit name
- Card catalogue search pre-fills spirit name
- Grid layout (2 columns on sm+)
- Hover effects for discoverability
  </action>
  <verify>Run `pnpm typecheck` - no errors</verify>
  <done>ExternalLinks component created with wiki, FAQ, and card catalogue links</done>
</task>

<task type="auto">
  <name>Task 2: Integrate ExternalLinks and add E2E tests</name>
  <files>app/routes/spirits.$slug.tsx, app/routes/spirits.$slug.$aspect.tsx, e2e/spirits.spec.ts</files>
  <action>
Add ExternalLinks to the bottom of the spirit detail page:

```tsx
// At the end of the main content, after CardHand
<ExternalLinks
  spiritName={spirit.name}
  wikiUrl={spirit.wikiUrl}
/>
```

Add E2E tests for Phase 3 functionality in e2e/spirits.spec.ts:

```typescript
// Add these tests to the existing spirits.spec.ts file

test('spirit detail shows variant tabs', async ({ page }) => {
  await page.goto('/spirits/river-surges-in-sunlight');

  // Wait for tabs to load
  await expect(page.getByRole('tab', { name: /River/ })).toBeVisible();
  await expect(page.getByRole('tab', { name: 'Sunshine' })).toBeVisible();
  await expect(page.getByRole('tab', { name: 'Travel' })).toBeVisible();
  await expect(page.getByRole('tab', { name: 'Haven' })).toBeVisible();
});

test('variant tabs navigate to correct URL', async ({ page }) => {
  await page.goto('/spirits/river-surges-in-sunlight');

  // Click on Sunshine tab
  await page.getByRole('tab', { name: 'Sunshine' }).click();

  // URL should update
  await expect(page).toHaveURL(/river-surges-in-sunlight\/sunshine/);

  // Content should update (subtitle shows "Aspect of")
  await expect(page.getByText('Aspect of River Surges in Sunlight')).toBeVisible();
});

test('spirit detail shows overview section', async ({ page }) => {
  await page.goto('/spirits/river-surges-in-sunlight');

  // Check for power ratings (radar chart presence)
  // Check for strengths and weaknesses headings
  await expect(page.getByRole('heading', { name: 'Strengths' })).toBeVisible();
  await expect(page.getByRole('heading', { name: 'Weaknesses' })).toBeVisible();
});

test('spirit detail shows board sections', async ({ page }) => {
  await page.goto('/spirits/river-surges-in-sunlight');

  // Check for board section headings
  await expect(page.getByRole('heading', { name: 'Growth' })).toBeVisible();
  await expect(page.getByRole('heading', { name: 'Presence Tracks' })).toBeVisible();
  await expect(page.getByRole('heading', { name: 'Innate Powers' })).toBeVisible();
  await expect(page.getByRole('heading', { name: 'Starting Cards' })).toBeVisible();
});

test('spirit detail shows external links', async ({ page }) => {
  await page.goto('/spirits/river-surges-in-sunlight');

  // Check for Resources section
  await expect(page.getByRole('heading', { name: 'Resources' })).toBeVisible();

  // Check for external link to wiki
  const wikiLink = page.getByRole('link', { name: /Spirit Island Wiki/i });
  await expect(wikiLink).toBeVisible();
  await expect(wikiLink).toHaveAttribute('target', '_blank');
});
```
  </action>
  <verify>Run `pnpm test:e2e` - all tests pass</verify>
  <done>E2E tests verify variant tabs, overview, board sections, and external links</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 3 spirit detail page with:
- Variant tabs (base + aspects) with URL sync
- Overview section (radar chart, strengths, weaknesses)
- Growth panel with growth options
- Presence tracks with tooltips
- Innate powers accordion
- Starting cards display
- External resource links
  </what-built>
  <how-to-verify>
1. Start dev server: `pnpm dev`
2. Navigate to http://localhost:3000/spirits/river-surges-in-sunlight

**Variant Tabs:**
- [ ] See tabs below header: "River Surges", "Haven", "Sunshine", "Travel"
- [ ] Click "Sunshine" - URL changes to /spirits/river-surges-in-sunlight/sunshine
- [ ] Content updates, shows "Aspect of River Surges in Sunlight"
- [ ] Browser back button returns to base spirit

**Overview Section:**
- [ ] See radar chart with 5 axes (Offense, Defense, Control, Fear, Utility)
- [ ] Chart uses dark theme colors (visible against dark background)
- [ ] See "Strengths" heading with green color and bullet list
- [ ] See "Weaknesses" heading with red color and bullet list

**Board Visualization:**
- [ ] See "Growth" section with growth option cards
- [ ] See "Presence Tracks" with Energy and Card Plays rows
- [ ] Tap/hover on presence slot - tooltip shows what it grants
- [ ] See "Innate Powers" - click to expand
- [ ] Innate shows element thresholds as badges
- [ ] See "Starting Cards" with 4 cards (River's Bounty, etc.)

**External Links:**
- [ ] See "Resources" section at bottom
- [ ] Wiki link visible (opens new tab)
- [ ] FAQ link visible (opens new tab)
- [ ] Card Catalogue link visible (opens new tab)

**Mobile:**
- [ ] Shrink viewport to mobile width
- [ ] Tabs scroll horizontally
- [ ] Cards scroll horizontally
- [ ] Presence tracks wrap nicely

**Lightning Test:**
- [ ] Navigate to /spirits/lightnings-swift-strike
- [ ] Similar structure works for Lightning
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm test:e2e` passes (all existing + new tests)
3. Manual verification checklist completed
4. Both River and Lightning spirits have complete board visualization
</verification>

<success_criteria>
- External links section at bottom of spirit detail
- Wiki link uses spirit's wikiUrl
- FAQ and card catalogue links pre-fill spirit name search
- All links open in new tab with security attributes
- E2E tests pass for:
  - Variant tabs visibility
  - Tab navigation and URL sync
  - Overview section presence
  - Board section presence
  - External links presence
- Human verification confirms visual quality and UX
</success_criteria>

<output>
After completion, create `.planning/phases/03-spirit-detail-board/03-06-SUMMARY.md`
</output>
