---
phase: 03-spirit-detail-board
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/seed.ts
  - convex/spirits.ts
autonomous: true

must_haves:
  truths:
    - "Spirit schema includes fields for strengths, weaknesses, and powerRatings"
    - "Spirit schema includes fields for growth, presenceTracks, innates, and specialRules"
    - "Seed data includes complete board data for River and Lightning"
    - "API returns new fields when querying spirits"
  artifacts:
    - path: "convex/schema.ts"
      provides: "Extended spirit schema with board data fields"
      contains: "powerRatings"
    - path: "convex/seed.ts"
      provides: "Complete seed data for River and Lightning"
      contains: "presenceTracks"
  key_links:
    - from: "convex/seed.ts"
      to: "convex/schema.ts"
      via: "schema type conformance"
      pattern: "presenceTracks.*energy.*cardPlays"
---

<objective>
Extend the Convex schema with spirit board data fields and populate seed data for River and Lightning.

Purpose: Foundation for Phase 3 - all UI components depend on this data structure being in place.
Output: Extended schema with strengths, weaknesses, powerRatings, growth, presenceTracks, innates, specialRules, and wikiUrl fields. Complete seed data for both base spirits.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-spirit-detail-board/03-CONTEXT.md
@.planning/phases/03-spirit-detail-board/03-RESEARCH.md
@convex/schema.ts
@convex/seed.ts
@convex/spirits.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend spirit schema with board data fields</name>
  <files>convex/schema.ts</files>
  <action>
Add new optional fields to the spirits table schema. All fields must be v.optional() to avoid breaking existing data:

```typescript
// Add after description field:
strengths: v.optional(v.array(v.string())),
weaknesses: v.optional(v.array(v.string())),
powerRatings: v.optional(v.object({
  offense: v.number(),
  defense: v.number(),
  control: v.number(),
  fear: v.number(),
  utility: v.number(),
})),
specialRules: v.optional(v.array(v.object({
  name: v.string(),
  description: v.string(),
}))),
growth: v.optional(v.array(v.object({
  title: v.string(),
  options: v.array(v.object({
    actions: v.array(v.string()),
  })),
}))),
presenceTracks: v.optional(v.object({
  energy: v.array(v.object({
    value: v.union(v.number(), v.string()),
    elements: v.optional(v.array(v.string())),
  })),
  cardPlays: v.array(v.object({
    value: v.union(v.number(), v.string()),
    elements: v.optional(v.array(v.string())),
    reclaim: v.optional(v.boolean()),
  })),
})),
innates: v.optional(v.array(v.object({
  name: v.string(),
  speed: v.union(v.literal("Fast"), v.literal("Slow")),
  range: v.optional(v.string()),
  target: v.optional(v.string()),
  thresholds: v.array(v.object({
    elements: v.object({
      Sun: v.optional(v.number()),
      Moon: v.optional(v.number()),
      Fire: v.optional(v.number()),
      Air: v.optional(v.number()),
      Water: v.optional(v.number()),
      Earth: v.optional(v.number()),
      Plant: v.optional(v.number()),
      Animal: v.optional(v.number()),
    }),
    effect: v.string(),
  })),
}))),
uniquePowers: v.optional(v.array(v.object({
  name: v.string(),
  cost: v.number(),
  speed: v.union(v.literal("Fast"), v.literal("Slow")),
  elements: v.array(v.string()),
  description: v.optional(v.string()),
}))),
wikiUrl: v.optional(v.string()),
```

Note: Using numbers 0-5 for power ratings (0=None, 1=Low, 2=Medium, 3=High, 4=Very High, 5=Extreme).
  </action>
  <verify>Run `pnpm typecheck` - should pass with no errors</verify>
  <done>Schema includes all new optional fields for board data</done>
</task>

<task type="auto">
  <name>Task 2: Add complete board data to seed file</name>
  <files>convex/seed.ts</files>
  <action>
Update both seedSpirits and reseedSpirits mutations to include complete board data for River Surges in Sunlight and Lightning's Swift Strike.

For River Surges in Sunlight (base spirit):
- strengths: ["Excellent energy generation", "Strong at moving Invaders and Dahan", "Can heal Blight from the land", "Flexible and supportive", "Good reach with Water presence"]
- weaknesses: ["Low damage output", "Relies on Dahan for offense", "Needs time to set up", "Vulnerable to fast aggression"]
- powerRatings: { offense: 2, defense: 3, control: 4, fear: 2, utility: 4 }
- specialRules: [] (River has no special rules)
- growth: Two growth options per turn, details from wiki
- presenceTracks: Energy track (1,2,2,3,3,4,5) and Card Plays track (1,2,2,3,3,4,Reclaim)
- innates: "Massive Flooding" (Fast) and "Boon of Vigor" (Slow)
- uniquePowers: ["River's Bounty", "Wash Away", "Flash Floods", "Boon of Vigor"]
- wikiUrl: "https://spiritislandwiki.com/index.php?title=River_Surges_in_Sunlight"

For Lightning's Swift Strike (base spirit):
- strengths: ["Excellent fast damage", "Strong Fear generation", "Simple and straightforward", "Great at destroying explorers", "Good energy when aggressive"]
- weaknesses: ["Minimal defense", "Struggles against built-up areas", "Low card plays", "Fragile board position"]
- powerRatings: { offense: 5, defense: 1, control: 2, fear: 4, utility: 2 }
- specialRules: [] (Lightning has no special rules)
- growth: Two growth options per turn
- presenceTracks: Energy track (1,2,3,4,4,5,6) and Card Plays track (1,2,2,3,4)
- innates: "Thundering Destruction" (Fast)
- uniquePowers: ["Harbingers of the Lightning", "Lightning's Boon", "Shatter Homesteads", "Raging Storm"]
- wikiUrl: "https://spiritislandwiki.com/index.php?title=Lightning%27s_Swift_Strike"

Aspects should NOT have board data - they inherit from base spirit. Only add wikiUrl to aspects if they have separate wiki pages.

IMPORTANT: The seed data structure must exactly match the schema. Use the wiki for accurate game data.
  </action>
  <verify>Run `npx convex dev --once` to validate schema, then `npx convex run seed:reseedSpirits` to test seeding</verify>
  <done>Seed data includes complete board information for both spirits</done>
</task>

<task type="auto">
  <name>Task 3: Add query for spirit with aspects</name>
  <files>convex/spirits.ts</files>
  <action>
Add a new query `getSpiritWithAspects` that returns a base spirit along with all its aspects in a single call. This is needed for the variant tabs component.

```typescript
// Get base spirit with all aspects for variant selector
export const getSpiritWithAspects = query({
  args: {
    slug: v.string(),
  },
  handler: async (ctx, args) => {
    // Find the base spirit
    const baseSpirit = await ctx.db
      .query("spirits")
      .withIndex("by_slug", (q) => q.eq("slug", args.slug))
      .filter((q) => q.eq(q.field("baseSpirit"), undefined))
      .first();

    if (!baseSpirit) return null;

    // Get all aspects
    const aspects = await ctx.db
      .query("spirits")
      .withIndex("by_base_spirit", (q) => q.eq("baseSpirit", baseSpirit._id))
      .collect();

    // Sort aspects alphabetically by aspectName
    aspects.sort((a, b) =>
      (a.aspectName || "").localeCompare(b.aspectName || ""),
    );

    return {
      base: baseSpirit,
      aspects,
    };
  },
});
```

This query returns the base spirit and all aspects in one call, which is more efficient than making separate queries for the variant tabs.
  </action>
  <verify>Run `pnpm typecheck` - should pass</verify>
  <done>New query returns spirit with all aspects in single call</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `npx convex dev --once` succeeds (schema valid)
3. `npx convex run seed:reseedSpirits` returns success message
4. Query the spirits via Convex dashboard or test query - new fields appear
</verification>

<success_criteria>
- Schema extended with all board data fields
- River and Lightning have complete board data in seed
- New getSpiritWithAspects query available
- All type checks pass
- Database can be seeded without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-spirit-detail-board/03-01-SUMMARY.md`
</output>
