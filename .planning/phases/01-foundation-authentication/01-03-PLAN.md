---
phase: 01-foundation-authentication
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - package.json
  - convex/schema.ts
  - convex/auth.config.ts
  - convex/_generated/
  - app/routes/__root.tsx
  - app/lib/convex.ts
  - .env.local
autonomous: true
user_setup:
  - service: convex
    why: "Real-time backend database"
    env_vars:
      - name: VITE_CONVEX_URL
        source: "Created automatically when running npx convex dev"
    dashboard_config:
      - task: "Convex project created automatically via CLI"
        location: "https://dashboard.convex.dev"

must_haves:
  truths:
    - "Convex dev server connects successfully"
    - "Home page displays data from Convex query"
    - "Real-time updates work (modify data in dashboard, see change in app)"
  artifacts:
    - path: "convex/schema.ts"
      provides: "Database schema definition"
      exports: ["default"]
    - path: "convex/_generated/api.ts"
      provides: "Generated Convex API types"
      contains: "api"
    - path: "app/lib/convex.ts"
      provides: "Convex client configuration"
      exports: ["convex", "convexQueryClient"]
    - path: "app/routes/__root.tsx"
      provides: "Root layout with Convex provider"
      contains: "ConvexProvider"
  key_links:
    - from: "app/routes/__root.tsx"
      to: "ConvexProvider"
      via: "provider wrapping"
      pattern: "ConvexProvider"
    - from: "app/lib/convex.ts"
      to: "VITE_CONVEX_URL"
      via: "environment variable"
      pattern: "import\\.meta\\.env\\.VITE_CONVEX_URL"
---

<objective>
Integrate Convex real-time backend with TanStack Query

Purpose: Enable real-time data synchronization between the app and Convex backend
Output: Working Convex integration with generated types, TanStack Query adapter, and a basic test query
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Convex and initialize project</name>
  <files>package.json, convex/</files>
  <action>
1. Install Convex dependencies:
```bash
pnpm add convex @convex-dev/react-query
```

2. Initialize Convex project:
```bash
pnpm convex dev --once
```

This will:
- Create the convex/ directory with configuration
- Generate convex/_generated/ types
- Create a new Convex project (will prompt for login if needed)
- Create .env.local with VITE_CONVEX_URL

Note: If the user is not logged in to Convex, the CLI will open a browser for authentication. After auth, re-run `pnpm convex dev --once`.

3. Verify .env.local was created with VITE_CONVEX_URL
  </action>
  <verify>
Run: cat .env.local | grep VITE_CONVEX_URL
Should show VITE_CONVEX_URL with a convex.cloud URL
Run: ls convex/_generated/
Should show api.ts, dataModel.ts, and server.ts
  </verify>
  <done>Convex project initialized, environment variable set, generated types created</done>
</task>

<task type="auto">
  <name>Task 2: Create Convex schema and test query</name>
  <files>convex/schema.ts, convex/health.ts</files>
  <action>
1. Create convex/schema.ts with a minimal schema for testing:
```typescript
import { defineSchema, defineTable } from 'convex/server';
import { v } from 'convex/values';

export default defineSchema({
  // Minimal table for health check / connectivity test
  // Will be expanded in future phases
  healthCheck: defineTable({
    message: v.string(),
    timestamp: v.number(),
  }),
});
```

2. Create convex/health.ts with a test query:
```typescript
import { query } from './_generated/server';

export const ping = query({
  args: {},
  handler: async () => {
    return {
      status: 'connected',
      timestamp: Date.now(),
    };
  },
});
```

3. Push the schema:
```bash
pnpm convex dev --once
```

This regenerates types and syncs the schema.
  </action>
  <verify>
Run: pnpm convex dev --once
Should complete without errors
Check: ls convex/_generated/api.ts
File should include the health query
  </verify>
  <done>Convex schema created, health check query available</done>
</task>

<task type="auto">
  <name>Task 3: Set up Convex client and integrate with app</name>
  <files>app/lib/convex.ts, app/routes/__root.tsx, app/routes/index.tsx</files>
  <action>
1. Create app/lib/convex.ts:
```typescript
import { ConvexReactClient } from 'convex/react';
import { ConvexQueryClient } from '@convex-dev/react-query';
import { QueryClient } from '@tanstack/react-query';

export const convex = new ConvexReactClient(
  import.meta.env.VITE_CONVEX_URL as string
);

export const convexQueryClient = new ConvexQueryClient(convex);

export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      queryKeyHashFn: convexQueryClient.hashFn(),
      queryFn: convexQueryClient.queryFn(),
    },
  },
});
```

2. Update app/routes/__root.tsx to add Convex and Query providers:
```typescript
import { createRootRoute, Outlet } from '@tanstack/react-router';
import { ConvexProvider } from 'convex/react';
import { QueryClientProvider } from '@tanstack/react-query';
import { convex, queryClient } from '../lib/convex';

export const Route = createRootRoute({
  component: RootLayout,
});

function RootLayout() {
  return (
    <html lang="en">
      <head>
        <meta charSet="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>The Dahan Codex</title>
      </head>
      <body>
        <ConvexProvider client={convex}>
          <QueryClientProvider client={queryClient}>
            <Outlet />
          </QueryClientProvider>
        </ConvexProvider>
      </body>
    </html>
  );
}
```

3. Update app/routes/index.tsx to use the health query:
```typescript
import { createFileRoute } from '@tanstack/react-router';
import { useQuery } from 'convex/react';
import { api } from '../../convex/_generated/api';

export const Route = createFileRoute('/')({
  component: HomePage,
});

function HomePage() {
  const health = useQuery(api.health.ping);

  return (
    <main>
      <h1>The Dahan Codex</h1>
      <p>Spirit Island companion app</p>
      <div>
        <p>
          Convex status:{' '}
          {health ? (
            <span style={{ color: 'green' }}>{health.status}</span>
          ) : (
            <span style={{ color: 'gray' }}>connecting...</span>
          )}
        </p>
      </div>
    </main>
  );
}
```
  </action>
  <verify>
1. Start Convex in one terminal:
   pnpm convex dev

2. In another terminal, start the app:
   pnpm dev

3. Visit http://localhost:3000
   Should see "Convex status: connected" in green

4. Check browser console for WebSocket connection to convex.cloud
  </verify>
  <done>Convex integrated with app, real-time connection established, health query working</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Convex dev server runs: `pnpm convex dev`
2. App dev server runs: `pnpm dev`
3. Home page shows "Convex status: connected"
4. Browser DevTools Network tab shows WebSocket connection to convex.cloud
5. Run `pnpm build` - should build successfully with Convex types
</verification>

<success_criteria>
- Convex project created and connected
- VITE_CONVEX_URL environment variable set
- convex/_generated/ contains generated types
- ConvexProvider wraps the app in __root.tsx
- Health query returns "connected" status on home page
- Real-time WebSocket connection visible in DevTools
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-03-SUMMARY.md`
</output>
