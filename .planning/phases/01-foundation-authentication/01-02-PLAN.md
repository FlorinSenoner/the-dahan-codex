---
phase: 01-foundation-authentication
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - wrangler.jsonc
  - app.config.ts
autonomous: true

must_haves:
  truths:
    - "pnpm build completes without errors"
    - "wrangler dev serves the built application locally"
    - "Build output contains proper server entry for Workers"
  artifacts:
    - path: "wrangler.jsonc"
      provides: "Cloudflare Workers configuration"
      contains: "the-dahan-codex"
    - path: "app.config.ts"
      provides: "TanStack Start configuration with Cloudflare preset"
      contains: "cloudflare"
  key_links:
    - from: "wrangler.jsonc"
      to: "@tanstack/react-start/server-entry"
      via: "main entry point"
      pattern: "server-entry"
    - from: "app.config.ts"
      to: "cloudflare()"
      via: "preset configuration"
      pattern: "cloudflare"
---

<objective>
Configure Cloudflare Workers deployment for TanStack Start

Purpose: Enable the application to deploy to Cloudflare Workers edge runtime
Output: Working wrangler configuration that can build and preview the app locally via wrangler dev
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Cloudflare deployment dependencies</name>
  <files>package.json</files>
  <action>
Install Cloudflare Workers dependencies:

```bash
pnpm add -D @cloudflare/vite-plugin wrangler
```

These are:
- @cloudflare/vite-plugin: Official Vite plugin for Cloudflare Workers integration
- wrangler: Cloudflare Workers CLI for deployment and local preview
  </action>
  <verify>
Run: pnpm wrangler --version
Should output wrangler version number
  </verify>
  <done>Cloudflare dependencies installed</done>
</task>

<task type="auto">
  <name>Task 2: Configure TanStack Start for Cloudflare Workers</name>
  <files>app.config.ts, wrangler.jsonc</files>
  <action>
1. Update app.config.ts to use Cloudflare preset:
```typescript
import { cloudflare } from '@cloudflare/vite-plugin';
import { defineConfig } from '@tanstack/react-start/config';
import tsConfigPaths from 'vite-tsconfig-paths';

export default defineConfig({
  server: {
    preset: 'cloudflare-module',
  },
  vite: {
    plugins: [
      cloudflare({
        viteEnvironment: { name: 'ssr' },
      }),
      tsConfigPaths(),
    ],
  },
});
```

2. Create wrangler.jsonc:
```jsonc
{
  "$schema": "node_modules/wrangler/config-schema.json",
  "name": "the-dahan-codex",
  "compatibility_date": "2025-01-01",
  "compatibility_flags": ["nodejs_compat"],
  "main": ".output/server/index.mjs",
  "assets": {
    "directory": ".output/public",
    "binding": "ASSETS"
  },
  "observability": {
    "enabled": true
  }
}
```

Note: The main entry points to .output/server/index.mjs which is where TanStack Start with cloudflare-module preset outputs the server bundle.
  </action>
  <verify>
Run: pnpm build
Build should complete without errors
Check: ls .output/server/index.mjs
Server entry file should exist
  </verify>
  <done>TanStack Start configured for Cloudflare Workers with proper entry points</done>
</task>

<task type="auto">
  <name>Task 3: Add deployment scripts and verify local preview</name>
  <files>package.json</files>
  <action>
1. Add deployment scripts to package.json:
```json
{
  "scripts": {
    "preview": "wrangler dev",
    "deploy": "pnpm build && wrangler deploy"
  }
}
```

2. Verify the build and local preview workflow:
- Run `pnpm build` to create the production build
- Run `pnpm preview` to start wrangler dev server
- This simulates the Cloudflare Workers environment locally

Note: Actual deployment to Cloudflare will require CLOUDFLARE_API_TOKEN and CLOUDFLARE_ACCOUNT_ID environment variables, which will be set up in the CI/CD plan (01-06).
  </action>
  <verify>
Run: pnpm build && pnpm preview
Wrangler should start a local server (default port 8787)
Visit http://localhost:8787 - should see "The Dahan Codex" page
Press Ctrl+C to stop
  </verify>
  <done>Build produces valid Cloudflare Workers output, wrangler preview works locally</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Run `pnpm build` - should complete without errors
2. Check `.output/server/index.mjs` exists
3. Check `.output/public/` directory exists with static assets
4. Run `pnpm preview` (wrangler dev) - should start without errors
5. Visit http://localhost:8787 - should display the home page
</verification>

<success_criteria>
- Production build completes successfully
- .output/server/index.mjs server entry exists
- .output/public/ contains static assets
- wrangler dev serves the application locally on port 8787
- Home page loads and displays correctly in wrangler preview
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-02-SUMMARY.md`
</output>
