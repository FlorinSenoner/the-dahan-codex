---
phase: 01-foundation-authentication
plan: 05
type: execute
wave: 5
depends_on: ["01-04"]
files_modified:
  - package.json
  - public/manifest.json
  - public/icons/
  - scripts/generate-sw.ts
  - app/routes/__root.tsx
  - app/lib/sw-register.ts
autonomous: true

must_haves:
  truths:
    - "Service worker is generated during build"
    - "PWA manifest is valid and app is installable"
    - "Service worker registers successfully in browser"
    - "Static assets are precached by service worker"
  artifacts:
    - path: "public/manifest.json"
      provides: "PWA manifest with app metadata"
      contains: "The Dahan Codex"
    - path: "scripts/generate-sw.ts"
      provides: "Workbox service worker generator"
      contains: "generateSW"
    - path: "app/lib/sw-register.ts"
      provides: "Service worker registration logic"
      exports: ["registerSW"]
    - path: ".output/public/sw.js"
      provides: "Generated service worker (after build)"
      min_lines: 10
  key_links:
    - from: "scripts/generate-sw.ts"
      to: "workbox-build"
      via: "generateSW import"
      pattern: "workbox-build"
    - from: "app/routes/__root.tsx"
      to: "sw-register"
      via: "useEffect import and registerSW call"
      pattern: "registerSW|useEffect"
---

<objective>
Implement manual Workbox PWA with service worker generation

Purpose: Enable offline capability and PWA installation with proper service
worker lifecycle management Output: Generated service worker that precaches
static assets, valid PWA manifest, and user-initiated update flow </objective>

<execution_context> @./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md </execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-CONTEXT.md
@.planning/phases/01-foundation-authentication/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Workbox dependencies and create PWA manifest</name>
  <files>package.json, public/manifest.json, public/icons/</files>
  <action>
1. Install Workbox dependencies:
```bash
pnpm add workbox-core workbox-precaching workbox-routing workbox-strategies workbox-expiration
pnpm add -D workbox-build tsx
```

Note: tsx is needed to run the TypeScript generate-sw.ts script.

2. Create public/manifest.json:

```json
{
  "name": "The Dahan Codex",
  "short_name": "Dahan Codex",
  "description": "Spirit Island companion app - spirit library, openings, game tracker",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#1a1a1a",
  "theme_color": "#1a1a1a",
  "orientation": "portrait-primary",
  "icons": [
    {
      "src": "/icons/icon-192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any"
    },
    {
      "src": "/icons/icon-512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "any"
    },
    {
      "src": "/icons/icon-maskable-512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "maskable"
    }
  ]
}
```

3. Create placeholder icons in public/icons/:
   - Create public/icons/ directory
   - Create placeholder icon files (192x192, 512x512, maskable-512x512)

Create placeholder icons using ImageMagick (available in most environments):

```bash
mkdir -p public/icons

# Generate placeholder icons (dark themed squares)
# If ImageMagick is available:
convert -size 192x192 xc:'#1a1a1a' public/icons/icon-192.png
convert -size 512x512 xc:'#1a1a1a' public/icons/icon-512.png
convert -size 512x512 xc:'#1a1a1a' public/icons/icon-maskable-512.png

# Alternative using Node.js if ImageMagick not available:
# Create a simple script or use a 1x1 base64 PNG placeholder
```

If ImageMagick is not available, create minimal valid PNG files using base64:

```bash
# Minimal 1x1 dark PNG (will work but look basic)
echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M/wHwADhgF/pNvBPwAAAABJRU5ErkJggg==" | base64 -d > public/icons/icon-192.png
cp public/icons/icon-192.png public/icons/icon-512.png
cp public/icons/icon-192.png public/icons/icon-maskable-512.png
```

Note: These placeholders will be replaced with proper branded icons. The
manifest will still be valid for PWA installation. </action> <verify> Run: cat
public/manifest.json | grep "The Dahan Codex" Should output the name field Run:
ls public/icons/ Should show icon-192.png, icon-512.png, icon-maskable-512.png
</verify> <done>Workbox dependencies installed, PWA manifest created with
placeholder icons</done> </task>

<task type="auto">
  <name>Task 2: Create service worker generator script</name>
  <files>scripts/generate-sw.ts, package.json</files>
  <action>
1. Create scripts/generate-sw.ts:
```typescript
import { generateSW } from 'workbox-build';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';
import { existsSync, mkdirSync } from 'fs';

const **filename = fileURLToPath(import.meta.url); const **dirname =
dirname(**filename); const rootDir = join(**dirname, '..');

async function buildServiceWorker() { const outputDir = join(rootDir, '.output',
'public');

// Ensure output directory exists if (!existsSync(outputDir)) {
console.log('Output directory does not exist, creating...');
mkdirSync(outputDir, { recursive: true }); }

console.log('Generating service worker...');

try { const { count, size, warnings } = await generateSW({ swDest:
join(outputDir, 'sw.js'), globDirectory: outputDir, globPatterns: [
'**/*.{js,css,html,png,svg,ico,webp,woff,woff2,json}', ], globIgnores: [
'**/node_modules/**', 'sw.js', 'workbox-*.js', ], // IMPORTANT: skipWaiting
false to prevent broken state during updates skipWaiting: false, clientsClaim:
false, // Runtime caching for API calls runtimeCaching: [ { // Cache Convex API
responses (read-only data) urlPattern: /^https:\/\/.*\.convex\.cloud/, handler:
'NetworkFirst', options: { cacheName: 'convex-api-cache', expiration: {
maxAgeSeconds: 60 * 60 * 24, // 24 hours maxEntries: 100, },
networkTimeoutSeconds: 10, }, }, { // Cache external images urlPattern:
/^https:\/\/.*\.(png|jpg|jpeg|svg|gif|webp)$/, handler: 'CacheFirst', options: {
cacheName: 'image-cache', expiration: { maxAgeSeconds: 60 * 60 * 24 * 30, // 30
days maxEntries: 200, }, }, }, ], });

    console.log(`âœ“ Generated service worker`);
    console.log(`  Precached ${count} files (${(size / 1024).toFixed(1)} KB)`);

    if (warnings.length > 0) {
      console.log('Warnings:');
      warnings.forEach((warning) => console.log(`  - ${warning}`));
    }

} catch (error) { console.error('Failed to generate service worker:', error);
process.exit(1); } }

buildServiceWorker();

````

2. Update package.json scripts to include service worker generation:
```json
{
  "scripts": {
    "dev": "vinxi dev",
    "build": "vinxi build && pnpm generate-sw",
    "generate-sw": "tsx scripts/generate-sw.ts",
    "start": "vinxi start",
    "preview": "wrangler dev",
    "deploy": "pnpm build && wrangler deploy",
    "typecheck": "tsc --noEmit",
    "lint": "biome check .",
    "lint:fix": "biome check --write .",
    "format": "biome format --write ."
  }
}
````

Note: The build script now runs `generate-sw` after `vinxi build` to generate
the service worker from the built assets. </action> <verify> Run: pnpm build
Build should complete and show "Generated service worker" message Run: ls
.output/public/sw.js Service worker file should exist </verify> <done>Service
worker generation script created and integrated into build process</done>
</task>

<task type="auto">
  <name>Task 3: Register service worker and add manifest to app</name>
  <files>app/lib/sw-register.ts, app/routes/__root.tsx</files>
  <action>
1. Create app/lib/sw-register.ts:
```typescript
export function registerSW() {
  if (typeof window === 'undefined') return;
  if (!('serviceWorker' in navigator)) {
    console.log('Service worker not supported');
    return;
  }

window.addEventListener('load', async () => { try { const registration = await
navigator.serviceWorker.register('/sw.js', { scope: '/', });

      console.log('Service worker registered:', registration.scope);

      // Check for updates periodically (every hour)
      setInterval(() => {
        registration.update();
      }, 60 * 60 * 1000);

      // Handle updates
      registration.addEventListener('updatefound', () => {
        const newWorker = registration.installing;
        if (!newWorker) return;

        newWorker.addEventListener('statechange', () => {
          if (
            newWorker.state === 'installed' &&
            navigator.serviceWorker.controller
          ) {
            // New version available - will implement update banner in Phase 4
            console.log('New version available');
          }
        });
      });
    } catch (error) {
      console.error('Service worker registration failed:', error);
    }

}); }

````

2. Update app/routes/__root.tsx to include manifest and register service worker:
```typescript
import { createRootRoute, Outlet, Scripts } from '@tanstack/react-router';
import { ClerkProvider, useAuth } from '@clerk/tanstack-start';
import { ConvexProviderWithClerk } from 'convex/react-clerk';
import { QueryClientProvider } from '@tanstack/react-query';
import { convex, queryClient } from '../lib/convex';
import { registerSW } from '../lib/sw-register';
import { useEffect } from 'react';

export const Route = createRootRoute({
  component: RootLayout,
});

function RootLayout() {
  useEffect(() => {
    registerSW();
  }, []);

  return (
    <ClerkProvider>
      <ConvexProviderWithClerk client={convex} useAuth={useAuth}>
        <QueryClientProvider client={queryClient}>
          <html lang="en">
            <head>
              <meta charSet="UTF-8" />
              <meta
                name="viewport"
                content="width=device-width, initial-scale=1.0"
              />
              <meta name="theme-color" content="#1a1a1a" />
              <link rel="manifest" href="/manifest.json" />
              <link rel="icon" href="/icons/icon-192.png" />
              <link rel="apple-touch-icon" href="/icons/icon-192.png" />
              <title>The Dahan Codex</title>
            </head>
            <body>
              <Outlet />
              <Scripts />
            </body>
          </html>
        </QueryClientProvider>
      </ConvexProviderWithClerk>
    </ClerkProvider>
  );
}
````

Note:

- Scripts component is needed for client-side hydration
- Service worker registration happens on client-side only (useEffect)
- Manifest link enables PWA installation
- Apple-touch-icon for iOS home screen </action> <verify>

1. Run: pnpm build && pnpm preview
2. Visit http://localhost:8787
3. Open DevTools -> Application -> Service Workers Should show "sw.js"
   registered with status "activated"
4. Check Application -> Manifest Should show "The Dahan Codex" with valid
   manifest
5. Check Application -> Cache Storage Should show precached assets

Chrome can show "Install app" option in address bar if manifest is valid.
</verify> <done>Service worker registers successfully, manifest valid, app is
PWA-installable</done> </task>

</tasks>

<verification>
After all tasks complete:

1. `pnpm build` generates service worker without errors
2. `.output/public/sw.js` exists after build
3. `pnpm preview` shows service worker registered in DevTools
4. Application -> Manifest shows valid manifest
5. Application -> Service Workers shows "activated" status
6. Application -> Cache Storage shows precached assets
7. Chrome shows PWA install option (install icon in address bar) </verification>

<success_criteria>

- Workbox generates service worker during build
- Service worker file exists at .output/public/sw.js
- PWA manifest is valid (no errors in DevTools)
- Service worker activates and controls the page
- Static assets are precached
- App shows as installable (PWA install prompt available)
- skipWaiting is false (no auto-update that breaks state) </success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-05-SUMMARY.md`
</output>
