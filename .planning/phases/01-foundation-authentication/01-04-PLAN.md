---
phase: 01-foundation-authentication
plan: 04
type: execute
wave: 4
depends_on: ["01-03"]
files_modified:
  - package.json
  - convex/auth.config.ts
  - convex/lib/auth.ts
  - app/routes/__root.tsx
  - app/routes/sign-in.$.tsx
  - app/routes/(authenticated).tsx
  - app/routes/(authenticated)/profile.tsx
  - app/lib/auth.ts
  - .env.local
autonomous: true
user_setup:
  - service: clerk
    why: "Authentication provider"
    env_vars:
      - name: VITE_CLERK_PUBLISHABLE_KEY
        source: "Clerk Dashboard -> API Keys -> Publishable key"
      - name: CLERK_SECRET_KEY
        source: "Clerk Dashboard -> API Keys -> Secret keys"
    dashboard_config:
      - task: "Create a Clerk application"
        location: "https://dashboard.clerk.com -> Create Application"
      - task: "Enable Email/Password and Google OAuth sign-in"
        location:
          "Clerk Dashboard -> User & Authentication -> Email, phone, username"
      - task: "Create JWT template for Convex"
        location: "Clerk Dashboard -> JWT Templates -> New template -> Convex"
      - task: "Copy JWT Issuer Domain to Convex"
        location:
          "Clerk Dashboard -> JWT Templates -> Convex template -> Issuer"
      - task: "Add admin role claim to JWT template"
        location:
          "Clerk Dashboard -> JWT Templates -> Convex template -> Claims -> Add:
          isAdmin = user.public_metadata.isAdmin"

must_haves:
  truths:
    - "User can sign in with Clerk and see authenticated state"
    - "Authenticated state persists across browser refresh"
    - "Public routes are accessible without login"
    - "Protected routes redirect to sign-in when not authenticated"
    - "Sign-out works and clears authenticated state"
    - "Admin role claim is available in Convex functions via JWT"
  artifacts:
    - path: "app/routes/sign-in.$.tsx"
      provides: "Sign-in page with Clerk component"
      exports: ["Route"]
    - path: "app/routes/(authenticated).tsx"
      provides: "Protected route layout with auth check"
      exports: ["Route"]
    - path: "convex/auth.config.ts"
      provides: "Clerk JWT configuration for Convex"
      contains: "providers"
    - path: "app/lib/auth.ts"
      provides: "Auth utility functions"
      exports: ["getAuthData"]
    - path: "convex/lib/auth.ts"
      provides: "Convex auth helpers including admin check"
      exports: ["isAdmin", "requireAuth"]
  key_links:
    - from: "app/routes/__root.tsx"
      to: "ClerkProvider"
      via: "provider wrapping"
      pattern: "ClerkProvider"
    - from: "app/routes/__root.tsx"
      to: "ConvexProviderWithClerk"
      via: "auth coordination"
      pattern: "ConvexProviderWithClerk"
    - from: "app/routes/(authenticated).tsx"
      to: "getAuthData"
      via: "beforeLoad check"
      pattern: "beforeLoad.*getAuthData"
---

<objective>
Implement Clerk authentication with SSR token handling for Convex

Purpose: Enable user authentication with session persistence, public/protected
route separation, and SSR-compatible auth flow Output: Working sign-in flow,
protected routes that redirect unauthenticated users, SSR auth token handling
</objective>

<execution_context> @./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md </execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-CONTEXT.md
@.planning/phases/01-foundation-authentication/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Clerk and configure environment</name>
  <files>package.json, .env.local, convex/auth.config.ts</files>
  <action>
1. Install Clerk dependencies:
```bash
pnpm add @clerk/tanstack-start
```

2. Add Clerk environment variables to .env.local:

```
# Clerk Authentication (user must fill these from Clerk dashboard)
VITE_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...

# Clerk routing
CLERK_SIGN_IN_URL=/sign-in
CLERK_SIGN_UP_URL=/sign-in
CLERK_SIGN_IN_FALLBACK_REDIRECT_URL=/
CLERK_SIGN_UP_FALLBACK_REDIRECT_URL=/
```

Note: The user needs to:

1. Create a Clerk application at https://dashboard.clerk.com
2. Enable Email/Password and Google OAuth in User & Authentication settings
3. Copy the API keys from the Dashboard

4. Create convex/auth.config.ts for Clerk JWT validation:

```typescript
export default {
  providers: [
    {
      domain: process.env.CLERK_JWT_ISSUER_DOMAIN,
      applicationID: "convex",
    },
  ],
};
```

Note: CLERK_JWT_ISSUER_DOMAIN comes from Clerk Dashboard -> JWT Templates ->
Convex template. User needs to create this template first. </action> <verify>
Run: grep VITE_CLERK_PUBLISHABLE_KEY .env.local Should show the environment
variable (even if placeholder) Run: cat convex/auth.config.ts Should show the
providers configuration </verify> <done>Clerk dependencies installed,
environment variables configured, Convex auth config created</done> </task>

<task type="auto">
  <name>Task 2: Update root layout with Clerk and Convex auth providers</name>
  <files>app/routes/__root.tsx, app/lib/convex.ts, app/lib/auth.ts</files>
  <action>
1. Create app/lib/auth.ts with SSR auth helper:
```typescript
import { createServerFn } from '@tanstack/react-start/server';
import { getAuth } from '@clerk/tanstack-start/server';
import { getWebRequest } from '@tanstack/react-start/server';

export const getAuthData = createServerFn({ method: 'GET' }).handler( async ()
=> { const request = getWebRequest(); const auth = await getAuth(request);

    return {
      userId: auth.userId,
      sessionId: auth.sessionId,
    };

} );

````

2. Update app/routes/__root.tsx to use ClerkProvider and ConvexProviderWithClerk:
```typescript
import { createRootRoute, Outlet } from '@tanstack/react-router';
import { ClerkProvider, useAuth } from '@clerk/tanstack-start';
import { ConvexProviderWithClerk } from 'convex/react-clerk';
import { QueryClientProvider } from '@tanstack/react-query';
import { convex, queryClient } from '../lib/convex';

export const Route = createRootRoute({
  component: RootLayout,
});

function RootLayout() {
  return (
    <ClerkProvider>
      <ConvexProviderWithClerk client={convex} useAuth={useAuth}>
        <QueryClientProvider client={queryClient}>
          <html lang="en">
            <head>
              <meta charSet="UTF-8" />
              <meta
                name="viewport"
                content="width=device-width, initial-scale=1.0"
              />
              <title>The Dahan Codex</title>
            </head>
            <body>
              <Outlet />
            </body>
          </html>
        </QueryClientProvider>
      </ConvexProviderWithClerk>
    </ClerkProvider>
  );
}
````

Note: Provider order matters:

1. ClerkProvider (outermost) - provides auth context
2. ConvexProviderWithClerk - bridges Clerk tokens to Convex
3. QueryClientProvider - TanStack Query caching </action> <verify> Run: pnpm
   typecheck Should pass without TypeScript errors Run: pnpm dev App should
   start (may show Clerk errors if keys not configured - that's expected)
   </verify> <done>Root layout updated with auth providers in correct
   hierarchy</done> </task>

<task type="auto">
  <name>Task 3: Set up admin role detection in Convex</name>
  <files>convex/lib/auth.ts</files>
  <action>
Create convex/lib/auth.ts with admin role detection helpers:

```typescript
import { QueryCtx, MutationCtx } from "../_generated/server";

/**
 * Get the current user's identity from Convex auth
 * Returns null if not authenticated
 */
export async function getIdentity(ctx: QueryCtx | MutationCtx) {
  return await ctx.auth.getUserIdentity();
}

/**
 * Require authentication - throws if not authenticated
 */
export async function requireAuth(ctx: QueryCtx | MutationCtx) {
  const identity = await ctx.auth.getUserIdentity();
  if (!identity) {
    throw new Error("Not authenticated");
  }
  return identity;
}

/**
 * Check if the current user has admin role
 * Admin claim comes from Clerk JWT template: user.public_metadata.isAdmin
 */
export async function isAdmin(ctx: QueryCtx | MutationCtx): Promise<boolean> {
  const identity = await ctx.auth.getUserIdentity();
  if (!identity) {
    return false;
  }
  // The isAdmin claim is set in Clerk JWT template from user.public_metadata.isAdmin
  return identity.isAdmin === true;
}

/**
 * Require admin role - throws if not admin
 */
export async function requireAdmin(ctx: QueryCtx | MutationCtx) {
  const identity = await requireAuth(ctx);
  const admin = await isAdmin(ctx);
  if (!admin) {
    throw new Error("Admin access required");
  }
  return identity;
}
```

Note: The isAdmin claim must be configured in Clerk's JWT template:

1. Go to Clerk Dashboard -> JWT Templates -> Convex template
2. Add claim: `isAdmin` with value `{{user.public_metadata.isAdmin}}`
3. To make a user admin, set their public_metadata.isAdmin to true in Clerk
   Dashboard

This sets up the foundation for AUTH-02 (Admin role detection). Admin-only
features will use `requireAdmin()` in their Convex functions. </action> <verify>
Run: pnpm convex dev --once Should regenerate types without errors Run: cat
convex/lib/auth.ts | grep "isAdmin" Should show the isAdmin function </verify>
<done>Admin role detection helpers created for use in Convex functions</done>
</task>

<task type="auto">
  <name>Task 4: Create sign-in page and protected route layout</name>
  <files>app/routes/sign-in.$.tsx, app/routes/(authenticated).tsx, app/routes/(authenticated)/profile.tsx, app/routes/index.tsx</files>
  <action>
1. Create app/routes/sign-in.$.tsx (dedicated sign-in page):
```typescript
import { SignIn } from '@clerk/tanstack-start';
import { createFileRoute } from '@tanstack/react-router';

export const Route = createFileRoute('/sign-in/$')({ component: SignInPage, });

function SignInPage() { return ( <div style={{
        minHeight: '100vh',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        padding: '1rem',
      }} > <SignIn /> </div> ); }

````

2. Create app/routes/(authenticated).tsx (protected layout):
```typescript
import { createFileRoute, Outlet, redirect } from '@tanstack/react-router';
import { getAuthData } from '../lib/auth';

export const Route = createFileRoute('/(authenticated)')({
  beforeLoad: async () => {
    const auth = await getAuthData();

    if (!auth.userId) {
      throw redirect({
        to: '/sign-in/$',
        params: { _splat: '' },
      });
    }

    return { userId: auth.userId };
  },
  component: AuthenticatedLayout,
});

function AuthenticatedLayout() {
  return <Outlet />;
}
````

3. Create app/routes/(authenticated)/profile.tsx (test protected route):

```typescript
import { createFileRoute } from '@tanstack/react-router';
import { UserButton } from '@clerk/tanstack-start';

export const Route = createFileRoute('/(authenticated)/profile')({
  component: ProfilePage,
});

function ProfilePage() {
  return (
    <div style={{ padding: '2rem' }}>
      <h1>Profile</h1>
      <p>This is a protected page. You are signed in.</p>
      <div style={{ marginTop: '1rem' }}>
        <UserButton afterSignOutUrl="/" />
      </div>
    </div>
  );
}
```

4. Update app/routes/index.tsx to show auth state and navigation:

```typescript
import { createFileRoute, Link } from '@tanstack/react-router';
import { useQuery } from 'convex/react';
import { useConvexAuth } from 'convex/react';
import { UserButton } from '@clerk/tanstack-start';
import { api } from '../../convex/_generated/api';

export const Route = createFileRoute('/')({
  component: HomePage,
});

function HomePage() {
  const health = useQuery(api.health.ping);
  const { isAuthenticated, isLoading } = useConvexAuth();

  return (
    <main style={{ padding: '2rem' }}>
      <h1>The Dahan Codex</h1>
      <p>Spirit Island companion app</p>

      <div style={{ marginTop: '2rem' }}>
        <p>
          Convex status:{' '}
          {health ? (
            <span style={{ color: 'green' }}>{health.status}</span>
          ) : (
            <span style={{ color: 'gray' }}>connecting...</span>
          )}
        </p>
      </div>

      <div style={{ marginTop: '2rem' }}>
        {isLoading ? (
          <p>Loading auth...</p>
        ) : isAuthenticated ? (
          <div>
            <p>You are signed in!</p>
            <UserButton afterSignOutUrl="/" />
            <div style={{ marginTop: '1rem' }}>
              <Link to="/profile">Go to Profile (protected)</Link>
            </div>
          </div>
        ) : (
          <div>
            <p>You are not signed in.</p>
            <Link to="/sign-in/$" params={{ _splat: '' }}>
              Sign In
            </Link>
          </div>
        )}
      </div>
    </main>
  );
}
```

Note: We use `useConvexAuth()` instead of Clerk's hooks because it properly
syncs with Convex's auth state. </action> <verify> With Clerk keys configured in
.env.local:

1. Run: pnpm dev
2. Visit http://localhost:3000 - should see "You are not signed in" with Sign In
   link
3. Click Sign In - should go to Clerk sign-in component
4. Sign in - should redirect back to home, showing "You are signed in!"
5. Click "Go to Profile" - should navigate to protected profile page
6. Click sign out - should return to unauthenticated state
7. Visit http://localhost:3000/profile directly when signed out - should
   redirect to sign-in </verify> <done>Sign-in page working, protected routes
   redirect unauthenticated users, auth state persists</done> </task>

</tasks>

<verification>
After all tasks complete:

1. Public route (/) accessible without login
2. Protected route (/profile) redirects to /sign-in when not authenticated
3. Sign-in with Clerk works (Google or Email/Password)
4. After sign-in, redirects back to intended page
5. Auth state shows correctly on home page
6. Auth state persists across browser refresh
7. Sign-out clears auth state
8. Convex connection works for both authenticated and unauthenticated users
   </verification>

<success_criteria>

- ClerkProvider and ConvexProviderWithClerk properly configured
- Sign-in page renders Clerk's SignIn component
- Protected routes check auth in beforeLoad and redirect
- useConvexAuth() correctly reports authentication state
- Session persists across page refresh
- Sign-out works and clears state
- TypeScript compilation succeeds </success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-04-SUMMARY.md`
</output>
