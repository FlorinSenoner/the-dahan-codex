---
phase: 01-foundation-authentication
plan: 06
type: execute
wave: 5
depends_on: ["01-05"]
files_modified:
  - .github/workflows/ci.yml
  - playwright.config.ts
  - e2e/smoke.spec.ts
  - package.json
autonomous: true
user_setup:
  - service: github
    why: "CI/CD pipeline and secrets management"
    env_vars:
      - name: VITE_CONVEX_URL
        source: "Copy from local .env.local (Convex deployment URL)"
      - name: VITE_CLERK_PUBLISHABLE_KEY
        source: "Clerk Dashboard -> API Keys -> Publishable key"
      - name: CLERK_SECRET_KEY
        source: "Clerk Dashboard -> API Keys -> Secret keys"
      - name: CLOUDFLARE_API_TOKEN
        source: "Cloudflare Dashboard -> My Profile -> API Tokens -> Create Token"
      - name: CLOUDFLARE_ACCOUNT_ID
        source: "Cloudflare Dashboard -> Workers & Pages -> Account ID (right sidebar)"
    dashboard_config:
      - task: "Add all secrets to GitHub repository"
        location: "GitHub Repository -> Settings -> Secrets and variables -> Actions -> New repository secret"

must_haves:
  truths:
    - "CI pipeline runs on push to main and PRs"
    - "CI runs biome, typecheck, build, and Playwright tests"
    - "Service worker generation is validated in CI"
    - "Deployment to Cloudflare Workers succeeds from main branch"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "GitHub Actions CI/CD workflow"
      contains: "biome"
    - path: "playwright.config.ts"
      provides: "Playwright test configuration"
      contains: "chromium"
    - path: "e2e/smoke.spec.ts"
      provides: "Smoke test for basic functionality"
      contains: "test"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "pnpm build"
      via: "build step"
      pattern: "pnpm build"
    - from: ".github/workflows/ci.yml"
      to: "wrangler deploy"
      via: "deploy step"
      pattern: "wrangler deploy"
    - from: ".github/workflows/ci.yml"
      to: "playwright"
      via: "test step"
      pattern: "playwright"
---

<objective>
Set up GitHub Actions CI/CD with Playwright testing and Cloudflare deployment

Purpose: Automate quality checks and deployment with every push, ensuring code quality and reliable releases
Output: Working CI pipeline that runs linting, type checking, builds, tests, and deploys to Cloudflare
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-CONTEXT.md
@.planning/phases/01-foundation-authentication/01-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Playwright and create smoke test</name>
  <files>package.json, playwright.config.ts, e2e/smoke.spec.ts</files>
  <action>
1. Install Playwright:
```bash
pnpm add -D @playwright/test
pnpm exec playwright install chromium
```

2. Create playwright.config.ts:
```typescript
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
  ],
  webServer: {
    command: 'pnpm dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
    timeout: 120 * 1000,
  },
});
```

3. Create e2e/smoke.spec.ts:
```typescript
import { test, expect } from '@playwright/test';

test.describe('Smoke Tests', () => {
  test('home page loads', async ({ page }) => {
    await page.goto('/');
    await expect(page.locator('h1')).toContainText('The Dahan Codex');
  });

  test('home page shows Convex connection status', async ({ page }) => {
    await page.goto('/');
    // Wait for Convex to connect (may take a moment)
    await expect(page.locator('text=connected')).toBeVisible({ timeout: 10000 });
  });

  test('sign-in page loads', async ({ page }) => {
    await page.goto('/sign-in');
    // Clerk sign-in component should render
    await expect(page.locator('[data-clerk-component="sign-in"]')).toBeVisible({
      timeout: 10000,
    });
  });

  test('protected route redirects to sign-in when not authenticated', async ({
    page,
  }) => {
    await page.goto('/profile');
    // Should redirect to sign-in
    await expect(page).toHaveURL(/\/sign-in/);
  });
});
```

4. Add test scripts to package.json:
```json
{
  "scripts": {
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui"
  }
}
```
  </action>
  <verify>
Run: pnpm test:e2e
Tests should run (may need Convex dev server running for full pass)
At minimum, verify Playwright is configured correctly
  </verify>
  <done>Playwright installed, smoke tests created covering home page, auth, and protected routes</done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions CI workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
1. Create .github/workflows/ci.yml:
```yaml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  VITE_CONVEX_URL: ${{ secrets.VITE_CONVEX_URL }}
  VITE_CLERK_PUBLISHABLE_KEY: ${{ secrets.VITE_CLERK_PUBLISHABLE_KEY }}
  CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}

jobs:
  ci:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Biome checks
        run: pnpm lint

      - name: Type check
        run: pnpm typecheck

      - name: Build
        run: pnpm build

      - name: Verify service worker generated
        run: |
          if [ ! -f ".output/public/sw.js" ]; then
            echo "Error: Service worker not generated!"
            exit 1
          fi
          echo "Service worker generated successfully"

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Run Playwright tests
        run: pnpm test:e2e

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  deploy:
    needs: ci
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build
        env:
          VITE_CONVEX_URL: ${{ secrets.VITE_CONVEX_URL }}
          VITE_CLERK_PUBLISHABLE_KEY: ${{ secrets.VITE_CLERK_PUBLISHABLE_KEY }}

      - name: Deploy to Cloudflare Workers
        run: pnpm exec wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
```

Note:
- CI job runs on all pushes and PRs to main
- Deploy job only runs on pushes to main (not PRs)
- Service worker generation is explicitly verified
- Playwright report is uploaded as artifact for debugging
  </action>
  <verify>
Run: cat .github/workflows/ci.yml | grep "biome"
Should show the biome lint step
Run: cat .github/workflows/ci.yml | grep "wrangler deploy"
Should show the deploy step
  </verify>
  <done>GitHub Actions workflow created with CI checks and Cloudflare deployment</done>
</task>

<task type="auto">
  <name>Task 3: Document required secrets and verify local CI simulation</name>
  <files>package.json</files>
  <action>
1. Add a CI simulation script to package.json for local testing:
```json
{
  "scripts": {
    "ci": "pnpm lint && pnpm typecheck && pnpm build && test -f .output/public/sw.js && pnpm test:e2e"
  }
}
```

2. Verify the CI pipeline can be run locally:
```bash
pnpm ci
```

This runs the same checks that will run in GitHub Actions:
- Biome lint
- TypeScript type check
- Build (with service worker generation)
- Service worker existence check
- Playwright tests

3. Document the required GitHub secrets (for user reference):

Required secrets to add to GitHub repository (Settings -> Secrets -> Actions):

| Secret Name | Source |
|-------------|--------|
| VITE_CONVEX_URL | From .env.local (Convex deployment URL) |
| VITE_CLERK_PUBLISHABLE_KEY | Clerk Dashboard -> API Keys |
| CLERK_SECRET_KEY | Clerk Dashboard -> API Keys |
| CLOUDFLARE_API_TOKEN | Cloudflare Dashboard -> API Tokens -> Create Token (Workers:Edit permission) |
| CLOUDFLARE_ACCOUNT_ID | Cloudflare Dashboard -> Workers & Pages -> Account ID |
  </action>
  <verify>
Run: pnpm ci
All checks should pass locally (with Convex dev server running)
This simulates what GitHub Actions will run
  </verify>
  <done>CI workflow complete, can be simulated locally, secrets documented</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. `pnpm ci` runs all checks locally without errors
2. Playwright tests pass (home page, auth redirect)
3. Service worker verification passes
4. `.github/workflows/ci.yml` exists with correct structure
5. Push to GitHub triggers CI workflow (after secrets are configured)
6. CI passes and deployment succeeds (after secrets configured)
</verification>

<success_criteria>
- GitHub Actions workflow file exists at .github/workflows/ci.yml
- CI runs: biome, typecheck, build, SW verification, Playwright tests
- Deploy runs only on main branch pushes
- Playwright tests cover: home page, Convex status, sign-in page, protected route redirect
- Local CI simulation (`pnpm ci`) passes
- Service worker generation is explicitly verified in CI
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-06-SUMMARY.md`
</output>
