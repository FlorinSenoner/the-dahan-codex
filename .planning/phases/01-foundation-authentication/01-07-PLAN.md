---
phase: 01-foundation-authentication
plan: 07
type: gap-closure
source: 01-UAT.md
gaps_addressed: [9, 10]
---

# Plan 01-07: Fix Service Worker Registration Timing

**Objective:** Fix the race condition where service worker registration never occurs
because the `load` event has already fired by the time React hydrates.

## Root Cause

`registerSW()` is called from a `useEffect` in `__root.tsx`. Inside, it attaches a
`window.addEventListener("load", ...)` listener. But by the time React hydrates and
the effect runs, the window `load` event has already fired, so the callback never
executes.

## Solution

Check `document.readyState` before adding the load listener. If the document is
already loaded (`complete`), register the service worker immediately.

## Tasks

### Task 1: Fix registration timing in sw-register.ts

**File:** `app/lib/sw-register.ts`

**Change:** Replace the unconditional `window.addEventListener("load", ...)` with a
check for `document.readyState`:

```typescript
export function registerSW() {
  if (typeof window === "undefined") return;
  if (!("serviceWorker" in navigator)) {
    console.log("Service worker not supported");
    return;
  }

  const register = async () => {
    try {
      const registration = await navigator.serviceWorker.register("/sw.js", {
        scope: "/",
      });

      console.log("Service worker registered:", registration.scope);

      // Check for updates periodically (every hour)
      setInterval(
        () => {
          registration.update();
        },
        60 * 60 * 1000,
      );

      // Handle updates
      registration.addEventListener("updatefound", () => {
        const newWorker = registration.installing;
        if (!newWorker) return;

        newWorker.addEventListener("statechange", () => {
          if (
            newWorker.state === "installed" &&
            navigator.serviceWorker.controller
          ) {
            // New version available - will implement update banner in Phase 4
            console.log("New version available");
          }
        });
      });
    } catch (error) {
      console.error("Service worker registration failed:", error);
    }
  };

  // If already loaded, register immediately; otherwise wait for load
  if (document.readyState === "complete") {
    register();
  } else {
    window.addEventListener("load", register);
  }
}
```

**Verification:**
1. `pnpm build && pnpm preview`
2. Open http://localhost:8787 in browser
3. Open DevTools > Application > Service Workers
4. Verify sw.js is registered and active
5. Console should show "Service worker registered: /"

### Task 2: Verify fix in production build

**Commands:**
```bash
pnpm build
pnpm preview
```

**Manual verification:**
- Service worker appears in DevTools > Application > Service Workers
- Console shows "Service worker registered" message

## Success Criteria

- [ ] Service worker registers successfully on page load
- [ ] Console shows "Service worker registered: /" message
- [ ] DevTools > Application > Service Workers shows sw.js as active
- [ ] Works in both preview mode and after deployment
