---
phase: 06-user-data
plan: 05
type: execute
wave: 3
depends_on: ["06-03", "06-04"]
files_modified:
  - app/routes/_authenticated/games.new.tsx
autonomous: true

must_haves:
  truths:
    - "User can create a new game via the form"
    - "Successful save navigates back to games list"
    - "New game appears in the games list"
  artifacts:
    - path: "app/routes/_authenticated/games.new.tsx"
      provides: "New game creation page"
      contains: "createGame"
  key_links:
    - from: "app/routes/_authenticated/games.new.tsx"
      to: "convex/games.ts"
      via: "useMutation for createGame"
      pattern: "api.games.createGame"
    - from: "app/routes/_authenticated/games.new.tsx"
      to: "app/components/games/game-form.tsx"
      via: "GameForm component"
      pattern: "GameForm"
---

<objective>
Create the new game page that uses the shared GameForm component.

Purpose: Users can log a new Spirit Island game by filling out the form and saving.
Output: New game route at /games/new with GameForm integration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-user-data/06-CONTEXT.md
@app/components/games/game-form.tsx
@convex/games.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create new game route</name>
  <files>app/routes/_authenticated/games.new.tsx</files>
  <action>
Create `app/routes/_authenticated/games.new.tsx`:

```typescript
import { createFileRoute, useNavigate } from "@tanstack/react-router";
import { useMutation } from "@tanstack/react-query";
import { useConvexMutation } from "@convex-dev/react-query";
import { api } from "convex/_generated/api";
import { toast } from "sonner";
import { GameForm, type GameFormData } from "@/components/games/game-form";

export const Route = createFileRoute("/_authenticated/games/new")({
  component: NewGamePage,
});

function NewGamePage() {
  const navigate = useNavigate();

  const createGame = useMutation({
    mutationFn: useConvexMutation(api.games.createGame),
    onSuccess: () => {
      toast.success("Game saved!");
      navigate({ to: "/games" });
    },
    onError: (error) => {
      toast.error(`Failed to save game: ${error.message}`);
    },
  });

  const handleSubmit = async (data: GameFormData) => {
    // Transform form data to mutation args
    // Filter out spirits without a spiritId selected
    const validSpirits = data.spirits.filter(s => s.spiritId !== null);

    if (validSpirits.length === 0) {
      toast.error("Please select at least one spirit");
      return;
    }

    await createGame.mutateAsync({
      date: data.date,
      result: data.result,
      spirits: validSpirits.map(s => ({
        spiritId: s.spiritId!,
        name: s.name,
        variant: s.variant,
        player: s.player,
      })),
      adversary: data.adversary ?? undefined,
      secondaryAdversary: data.secondaryAdversary ?? undefined,
      notes: data.notes || undefined,
    });
  };

  return (
    <div>
      <GameForm
        onSubmit={handleSubmit}
        submitLabel="Log Game"
        isSubmitting={createGame.isPending}
      />
    </div>
  );
}
```

The route uses the shared GameForm component and wires it to the createGame mutation. On success, it shows a toast and navigates back to the games list.
  </action>
  <verify>Run `pnpm dev`. Navigate to /games/new. Fill out the form with at least one spirit and click "Log Game". Verify toast appears and you're redirected to /games.</verify>
  <done>New game page exists at /games/new. Form submission creates a game via Convex mutation and navigates to list on success.</done>
</task>

<task type="auto">
  <name>Task 2: Wire up "New Game" button from list</name>
  <files>app/routes/_authenticated/games.index.tsx</files>
  <action>
Verify the games index route already has a working "New Game" button linking to /games/new. The button should already exist from Plan 03.

If needed, ensure:
1. The Link to="/games/new" is correct
2. The button in the action bar works for non-empty state
3. The "Log Your First Game" button works for empty state

Both buttons should navigate to /games/new.
  </action>
  <verify>Click "New Game" button on games list. Verify it navigates to /games/new form.</verify>
  <done>"New Game" button navigates to /games/new. Empty state "Log Your First Game" also works.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. /games/new route renders GameForm
3. Submitting form creates game and shows success toast
4. After save, user is navigated to /games
5. New game appears in the list
</verification>

<success_criteria>
- New game route at /games/new uses GameForm
- Form submission calls createGame mutation
- Success shows toast and navigates to list
- Error shows toast with message
- Build and typecheck pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-user-data/06-05-SUMMARY.md`
</output>
