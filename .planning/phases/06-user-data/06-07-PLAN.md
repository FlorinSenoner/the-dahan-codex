---
phase: 06-user-data
plan: 07
type: execute
wave: 4
depends_on: ["06-05", "06-06"]
files_modified:
  - app/lib/csv-export.ts
  - app/routes/_authenticated/games.index.tsx
autonomous: true

must_haves:
  truths:
    - "User can export all games to CSV file"
    - "CSV includes all game fields in fixed column format"
    - "CSV is Excel-friendly with proper quoting"
    - "CSV includes game ID for sync purposes"
  artifacts:
    - path: "app/lib/csv-export.ts"
      provides: "CSV export utility function"
      exports: ["exportGamesToCSV"]
  key_links:
    - from: "app/lib/csv-export.ts"
      to: "papaparse"
      via: "Papa.unparse for CSV generation"
      pattern: "Papa.unparse"
    - from: "app/routes/_authenticated/games.index.tsx"
      to: "app/lib/csv-export.ts"
      via: "Export button calls exportGamesToCSV"
      pattern: "exportGamesToCSV"
---

<objective>
Implement CSV export functionality for game data.

Purpose: Users can export all their games to a CSV file for backup, analysis in Excel, or import into other tools.
Output: CSV export utility and Export button on games list page.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-user-data/06-CONTEXT.md
@.planning/phases/06-user-data/06-RESEARCH.md
@convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CSV export utility</name>
  <files>app/lib/csv-export.ts</files>
  <action>
Create `app/lib/csv-export.ts` with PapaParse:

```typescript
import Papa from "papaparse";
import type { Doc } from "convex/_generated/dataModel";

/**
 * CSV column structure for game export
 * Fixed columns for Excel compatibility - spirits 1-6 have dedicated columns
 */
interface GameCSVRow {
  id: string;
  date: string;
  result: "win" | "loss";
  spirit1: string;
  spirit1_variant: string;
  spirit1_player: string;
  spirit2: string;
  spirit2_variant: string;
  spirit2_player: string;
  spirit3: string;
  spirit3_variant: string;
  spirit3_player: string;
  spirit4: string;
  spirit4_variant: string;
  spirit4_player: string;
  spirit5: string;
  spirit5_variant: string;
  spirit5_player: string;
  spirit6: string;
  spirit6_variant: string;
  spirit6_player: string;
  adversary: string;
  adversary_level: string;
  secondary_adversary: string;
  secondary_adversary_level: string;
  scenario: string;
  scenario_difficulty: string;
  win_type: string;
  invader_stage: string;
  blight_count: string;
  dahan_count: string;
  cards_remaining: string;
  score: string;
  notes: string;
}

/**
 * Convert games to CSV rows with fixed column structure
 */
function gamesToCSVRows(games: Doc<"games">[]): GameCSVRow[] {
  return games.map(game => {
    const getSpiritInfo = (index: number) => {
      const spirit = game.spirits[index];
      return {
        name: spirit?.name ?? "",
        variant: spirit?.variant ?? "",
        player: spirit?.player ?? "",
      };
    };

    const s1 = getSpiritInfo(0);
    const s2 = getSpiritInfo(1);
    const s3 = getSpiritInfo(2);
    const s4 = getSpiritInfo(3);
    const s5 = getSpiritInfo(4);
    const s6 = getSpiritInfo(5);

    return {
      id: game._id,
      date: game.date,
      result: game.result,
      spirit1: s1.name,
      spirit1_variant: s1.variant,
      spirit1_player: s1.player,
      spirit2: s2.name,
      spirit2_variant: s2.variant,
      spirit2_player: s2.player,
      spirit3: s3.name,
      spirit3_variant: s3.variant,
      spirit3_player: s3.player,
      spirit4: s4.name,
      spirit4_variant: s4.variant,
      spirit4_player: s4.player,
      spirit5: s5.name,
      spirit5_variant: s5.variant,
      spirit5_player: s5.player,
      spirit6: s6.name,
      spirit6_variant: s6.variant,
      spirit6_player: s6.player,
      adversary: game.adversary?.name ?? "",
      adversary_level: game.adversary?.level?.toString() ?? "",
      secondary_adversary: game.secondaryAdversary?.name ?? "",
      secondary_adversary_level: game.secondaryAdversary?.level?.toString() ?? "",
      scenario: game.scenario?.name ?? "",
      scenario_difficulty: game.scenario?.difficulty?.toString() ?? "",
      win_type: game.winType ?? "",
      invader_stage: game.invaderStage?.toString() ?? "",
      blight_count: game.blightCount?.toString() ?? "",
      dahan_count: game.dahanCount?.toString() ?? "",
      cards_remaining: game.cardsRemaining?.toString() ?? "",
      score: game.score?.toString() ?? "",
      notes: game.notes ?? "",
    };
  });
}

/**
 * Trigger browser download of a CSV file
 */
function downloadCSV(csvContent: string, filename: string): void {
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const link = document.createElement("a");
  link.href = url;
  link.download = filename;
  link.style.display = "none";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);

  URL.revokeObjectURL(url);
}

/**
 * Export games to CSV and trigger browser download
 */
export function exportGamesToCSV(games: Doc<"games">[]): void {
  const rows = gamesToCSVRows(games);

  const csv = Papa.unparse(rows, {
    quotes: true, // Quote all fields for Excel compatibility
    header: true,
  });

  const today = new Date().toISOString().split("T")[0];
  downloadCSV(csv, `spirit-island-games-${today}.csv`);
}
```
  </action>
  <verify>Run `pnpm typecheck` - file should compile without errors.</verify>
  <done>CSV export utility exists with exportGamesToCSV function that generates Excel-friendly CSV with fixed columns.</done>
</task>

<task type="auto">
  <name>Task 2: Add Export button to games list</name>
  <files>app/routes/_authenticated/games.index.tsx</files>
  <action>
Update `app/routes/_authenticated/games.index.tsx` to add an Export button:

1. Import the export function:
```typescript
import { exportGamesToCSV } from "@/lib/csv-export";
import { Download } from "lucide-react";
```

2. Add Export button next to New Game in the action bar:
```typescript
{/* Action bar */}
<div className="flex justify-end gap-2 p-3 border-b border-border">
  {games.length > 0 && (
    <Button
      variant="outline"
      size="sm"
      onClick={() => exportGamesToCSV(games)}
    >
      <Download className="h-4 w-4 mr-2" />
      Export CSV
    </Button>
  )}
  <Button asChild size="sm">
    <Link to="/games/new">
      <Plus className="h-4 w-4 mr-2" />
      New Game
    </Link>
  </Button>
</div>
```

The Export button only shows when there are games to export.
  </action>
  <verify>Run `pnpm dev`. Create a few games. Click Export CSV. Verify a file downloads with the game data.</verify>
  <done>Export CSV button appears on games list when games exist. Clicking triggers download of CSV file.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. Export button visible on games list (when games exist)
3. Clicking Export downloads a CSV file
4. CSV opens in Excel with proper column headers
5. CSV includes all game fields including ID
6. CSV has fixed spirit1-spirit6 columns (empty if unused)
</verification>

<success_criteria>
- exportGamesToCSV utility uses PapaParse
- CSV has fixed column structure (spirit1-spirit6, not variable)
- All game fields included in export
- Export button on games list page
- CSV is Excel-friendly (quoted fields, proper headers)
- Build and typecheck pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-user-data/06-07-SUMMARY.md`
</output>
