---
phase: 06-user-data
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - package.json
  - pnpm-lock.yaml
  - app/components/ui/sonner.tsx
  - app/components/ui/command.tsx
  - app/routes/__root.tsx
autonomous: true

must_haves:
  truths:
    - "Games table exists in Convex schema with all required fields"
    - "Sonner toast provider is mounted in app root"
    - "Command component from cmdk is available for use"
  artifacts:
    - path: "convex/schema.ts"
      provides: "games table definition with indexes"
      contains: "games: defineTable"
    - path: "app/components/ui/sonner.tsx"
      provides: "Toast provider component"
      contains: "Toaster"
    - path: "app/components/ui/command.tsx"
      provides: "Command menu component"
      contains: "Command"
  key_links:
    - from: "app/routes/__root.tsx"
      to: "app/components/ui/sonner.tsx"
      via: "Toaster import and render"
      pattern: "Toaster"
---

<objective>
Add games table schema and install UI dependencies for Phase 6.

Purpose: Establish foundation for game tracking - schema defines data structure, sonner enables undo toasts, cmdk enables searchable spirit dropdowns.
Output: Games table in Convex schema, sonner Toaster component, cmdk Command component.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-user-data/06-CONTEXT.md
@.planning/phases/06-user-data/06-RESEARCH.md
@convex/schema.ts
@app/routes/__root.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add games table to Convex schema</name>
  <files>convex/schema.ts</files>
  <action>
Add a `games` table to the schema with the following fields:

```typescript
games: defineTable({
  // User ownership
  userId: v.string(), // Clerk tokenIdentifier

  // Core game info
  date: v.string(), // ISO 8601 date string "2026-01-31"
  result: v.union(v.literal("win"), v.literal("loss")),

  // Spirits (1-6, stored as array)
  spirits: v.array(v.object({
    spiritId: v.id("spirits"),
    name: v.string(), // Denormalized for CSV export
    variant: v.optional(v.string()), // Aspect name if applicable
    player: v.optional(v.string()), // Player name
  })),

  // Optional adversary
  adversary: v.optional(v.object({
    name: v.string(),
    level: v.number(), // 0-6
  })),

  // Optional secondary adversary
  secondaryAdversary: v.optional(v.object({
    name: v.string(),
    level: v.number(),
  })),

  // Optional scenario
  scenario: v.optional(v.object({
    name: v.string(),
    difficulty: v.optional(v.number()),
  })),

  // Detailed outcome (all optional per CONTEXT.md)
  winType: v.optional(v.string()), // "fear", "blighted", etc.
  invaderStage: v.optional(v.number()),
  blightCount: v.optional(v.number()),
  dahanCount: v.optional(v.number()),
  cardsRemaining: v.optional(v.number()),

  // Calculated score (optional, can be recalculated)
  score: v.optional(v.number()),

  // Notes
  notes: v.optional(v.string()),

  // Timestamps
  createdAt: v.number(),
  updatedAt: v.number(),
  deletedAt: v.optional(v.number()), // For soft delete
})
  .index("by_user", ["userId"])
  .index("by_user_date", ["userId", "date"])
  .index("by_user_deleted", ["userId", "deletedAt"]),
```

Place after the `openings` table definition. Follow existing schema patterns with proper indentation.
  </action>
  <verify>Run `pnpm typecheck` - should pass with no errors.</verify>
  <done>Games table defined in schema with userId, date, result, spirits array, optional adversary/scenario/outcome fields, timestamps, and deletedAt for soft delete. Three indexes: by_user, by_user_date, by_user_deleted.</done>
</task>

<task type="auto">
  <name>Task 2: Install dependencies and create sonner/cmdk components</name>
  <files>package.json, pnpm-lock.yaml, app/components/ui/sonner.tsx, app/components/ui/command.tsx</files>
  <action>
1. Install dependencies:
```bash
pnpm add papaparse sonner cmdk
pnpm add -D @types/papaparse
```

2. Create `app/components/ui/sonner.tsx`:
```typescript
import { Toaster as SonnerToaster } from "sonner";

export function Toaster() {
  return (
    <SonnerToaster
      position="bottom-center"
      toastOptions={{
        classNames: {
          toast: "bg-background border-border",
          title: "text-foreground",
          description: "text-muted-foreground",
          actionButton: "bg-primary text-primary-foreground",
          cancelButton: "bg-muted text-muted-foreground",
        },
      }}
    />
  );
}
```

3. Create `app/components/ui/command.tsx` using shadcn/ui Command pattern:
```typescript
import * as React from "react";
import { Command as CommandPrimitive } from "cmdk";
import { Search } from "lucide-react";
import { cn } from "@/lib/utils";

const Command = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive>
>(({ className, ...props }, ref) => (
  <CommandPrimitive
    ref={ref}
    className={cn(
      "flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",
      className
    )}
    {...props}
  />
));
Command.displayName = CommandPrimitive.displayName;

// ... Add CommandInput, CommandList, CommandEmpty, CommandGroup, CommandItem, CommandSeparator
// Follow shadcn/ui Command component pattern
```

Note: If `@/lib/utils` doesn't exist with a `cn` function, create a simple one:
```typescript
import { clsx, type ClassValue } from "clsx";
import { twMerge } from "tailwind-merge";

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}
```
  </action>
  <verify>Run `pnpm typecheck` and verify papaparse, sonner, cmdk are in package.json dependencies.</verify>
  <done>papaparse, sonner, cmdk installed. Toaster component and Command component exist and export properly.</done>
</task>

<task type="auto">
  <name>Task 3: Mount Toaster in app root</name>
  <files>app/routes/__root.tsx</files>
  <action>
Import and add the Toaster component to the root layout:

1. Add import at top:
```typescript
import { Toaster } from "@/components/ui/sonner";
```

2. Add `<Toaster />` inside the root component, after `<Outlet />` but before the closing tags. It should be a sibling to other global components like PWA components.

Position it near the bottom of the component tree but still inside all providers (ConvexProvider, ClerkProvider, etc.).
  </action>
  <verify>Run `pnpm dev`, open browser console, confirm no errors. Toaster will be invisible until a toast is triggered.</verify>
  <done>Toaster component mounted in root layout. Toast notifications will now appear when triggered via `toast()` from sonner.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm build` succeeds
3. Convex schema shows games table when running `npx convex dev`
4. Dependencies papaparse, sonner, cmdk appear in package.json
</verification>

<success_criteria>
- Games table exists in Convex schema with all required fields and indexes
- papaparse, sonner, cmdk are installed
- Toaster component is mounted in root and ready for use
- Command component is available for spirit picker
- Build and typecheck pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-user-data/06-01-SUMMARY.md`
</output>
