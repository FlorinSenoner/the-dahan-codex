---
phase: 06-user-data
plan: 06
type: execute
wave: 3
depends_on: ["06-03", "06-04"]
files_modified:
  - app/routes/_authenticated/games.$id.tsx
autonomous: true

must_haves:
  truths:
    - "User can view game details on dedicated page"
    - "User can edit game inline by clicking Edit button"
    - "User can delete game with undo toast"
    - "Changes save and update the display"
  artifacts:
    - path: "app/routes/_authenticated/games.$id.tsx"
      provides: "Game detail page with inline edit"
      contains: "getGame"
  key_links:
    - from: "app/routes/_authenticated/games.$id.tsx"
      to: "convex/games.ts"
      via: "useSuspenseQuery for getGame, useMutation for updateGame/deleteGame"
      pattern: "api.games.getGame"
    - from: "app/routes/_authenticated/games.$id.tsx"
      to: "app/components/games/game-form.tsx"
      via: "GameForm for inline editing"
      pattern: "GameForm"
---

<objective>
Create game detail page with view mode and inline edit functionality.

Purpose: Users can view all game details, edit the game inline, and delete with undo capability.
Output: Game detail route at /games/$id with view/edit modes and delete functionality.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-user-data/06-CONTEXT.md
@app/components/games/game-form.tsx
@convex/games.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create game detail route with view mode</name>
  <files>app/routes/_authenticated/games.$id.tsx</files>
  <action>
Create `app/routes/_authenticated/games.$id.tsx`:

```typescript
import * as React from "react";
import { createFileRoute, useNavigate } from "@tanstack/react-router";
import { useSuspenseQuery, useMutation } from "@tanstack/react-query";
import { convexQuery, useConvexMutation } from "@convex-dev/react-query";
import { api } from "convex/_generated/api";
import type { Id } from "convex/_generated/dataModel";
import { toast } from "sonner";
import { format } from "date-fns";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { GameForm, type GameFormData } from "@/components/games/game-form";
import { Pencil, Trash2, X } from "lucide-react";

export const Route = createFileRoute("/_authenticated/games/$id")({
  component: GameDetailPage,
});

function GameDetailPage() {
  const { id } = Route.useParams();
  const navigate = useNavigate();
  const [isEditing, setIsEditing] = React.useState(false);

  const { data: game } = useSuspenseQuery(
    convexQuery(api.games.getGame, { id: id as Id<"games"> })
  );

  const updateGame = useMutation({
    mutationFn: useConvexMutation(api.games.updateGame),
    onSuccess: () => {
      toast.success("Game updated!");
      setIsEditing(false);
    },
    onError: (error) => {
      toast.error(`Failed to update: ${error.message}`);
    },
  });

  const deleteGame = useMutation({
    mutationFn: useConvexMutation(api.games.deleteGame),
  });

  const restoreGame = useMutation({
    mutationFn: useConvexMutation(api.games.restoreGame),
  });

  if (!game) {
    return (
      <div className="p-4 text-center">
        <p className="text-muted-foreground">Game not found</p>
        <Button variant="link" onClick={() => navigate({ to: "/games" })}>
          Back to Games
        </Button>
      </div>
    );
  }

  const handleDelete = async () => {
    await deleteGame.mutateAsync({ id: game._id });
    navigate({ to: "/games" });
    toast("Game deleted", {
      action: {
        label: "Undo",
        onClick: async () => {
          await restoreGame.mutateAsync({ id: game._id });
          toast.success("Game restored!");
        },
      },
      duration: 5000,
    });
  };

  const handleSubmit = async (data: GameFormData) => {
    const validSpirits = data.spirits.filter(s => s.spiritId !== null);

    await updateGame.mutateAsync({
      id: game._id,
      date: data.date,
      result: data.result,
      spirits: validSpirits.map(s => ({
        spiritId: s.spiritId!,
        name: s.name,
        variant: s.variant,
        player: s.player,
      })),
      adversary: data.adversary ?? undefined,
      secondaryAdversary: data.secondaryAdversary ?? undefined,
      notes: data.notes || undefined,
    });
  };

  // Transform game data to form data for editing
  const formInitialData: Partial<GameFormData> = {
    date: game.date,
    result: game.result,
    spirits: game.spirits.map(s => ({
      spiritId: s.spiritId,
      name: s.name,
      variant: s.variant,
      player: s.player,
    })),
    adversary: game.adversary ?? null,
    secondaryAdversary: game.secondaryAdversary ?? null,
    notes: game.notes ?? "",
  };

  if (isEditing) {
    return (
      <div>
        <div className="flex justify-between items-center p-4 border-b border-border">
          <h2 className="font-semibold">Edit Game</h2>
          <Button variant="ghost" size="icon" onClick={() => setIsEditing(false)}>
            <X className="h-4 w-4" />
          </Button>
        </div>
        <GameForm
          initialData={formInitialData}
          onSubmit={handleSubmit}
          submitLabel="Save Changes"
          isSubmitting={updateGame.isPending}
        />
      </div>
    );
  }

  // View mode
  const dateStr = format(new Date(game.date), "MMMM d, yyyy");

  return (
    <div className="p-4 space-y-6">
      {/* Action buttons */}
      <div className="flex justify-end gap-2">
        <Button variant="outline" size="sm" onClick={() => setIsEditing(true)}>
          <Pencil className="h-4 w-4 mr-2" />
          Edit
        </Button>
        <Button variant="destructive" size="sm" onClick={handleDelete}>
          <Trash2 className="h-4 w-4 mr-2" />
          Delete
        </Button>
      </div>

      {/* Date and Result */}
      <div className="flex items-center justify-between">
        <span className="text-lg">{dateStr}</span>
        <Badge variant={game.result === "win" ? "default" : "secondary"} className="text-base px-3 py-1">
          {game.result === "win" ? "Victory" : "Defeat"}
        </Badge>
      </div>

      {/* Spirits */}
      <div className="space-y-2">
        <h3 className="font-semibold text-sm text-muted-foreground uppercase tracking-wide">Spirits</h3>
        <div className="space-y-2">
          {game.spirits.map((spirit, i) => (
            <div key={i} className="flex items-center gap-2">
              <span className="font-medium">
                {spirit.variant ? `${spirit.name} (${spirit.variant})` : spirit.name}
              </span>
              {spirit.player && (
                <span className="text-muted-foreground">â€” {spirit.player}</span>
              )}
            </div>
          ))}
        </div>
      </div>

      {/* Adversary */}
      {game.adversary && (
        <div className="space-y-2">
          <h3 className="font-semibold text-sm text-muted-foreground uppercase tracking-wide">Adversary</h3>
          <p>{game.adversary.name} Level {game.adversary.level}</p>
        </div>
      )}

      {/* Secondary Adversary */}
      {game.secondaryAdversary && (
        <div className="space-y-2">
          <h3 className="font-semibold text-sm text-muted-foreground uppercase tracking-wide">Secondary Adversary</h3>
          <p>{game.secondaryAdversary.name} Level {game.secondaryAdversary.level}</p>
        </div>
      )}

      {/* Score */}
      {game.score !== undefined && (
        <div className="space-y-2">
          <h3 className="font-semibold text-sm text-muted-foreground uppercase tracking-wide">Score</h3>
          <p className="text-2xl font-bold">{game.score}</p>
        </div>
      )}

      {/* Notes */}
      {game.notes && (
        <div className="space-y-2">
          <h3 className="font-semibold text-sm text-muted-foreground uppercase tracking-wide">Notes</h3>
          <p className="whitespace-pre-wrap">{game.notes}</p>
        </div>
      )}
    </div>
  );
}
```
  </action>
  <verify>Run `pnpm dev`. Navigate to a game from the list (or create one first). Verify all details display. Click Edit, make a change, save. Click Delete, verify toast with undo appears.</verify>
  <done>Game detail page shows all game info. Edit button toggles to inline form. Delete soft-deletes with undo toast.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. /games/$id route displays game details
3. Edit button switches to inline form
4. Save updates game and shows success toast
5. Delete removes game from list but allows undo within 5 seconds
6. Undo restores the game
</verification>

<success_criteria>
- Game detail page shows date, result, spirits, adversary, notes
- Edit mode uses same GameForm with pre-filled data
- Delete triggers soft delete and navigates to list
- Undo toast allows restoring within 5 seconds
- Build and typecheck pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-user-data/06-06-SUMMARY.md`
</output>
