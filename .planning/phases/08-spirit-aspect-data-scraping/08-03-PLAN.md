---
phase: 08-spirit-aspect-data-scraping
plan: 03
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - scripts/download-images.ts
  - public/spirits/*.png
autonomous: true

must_haves:
  truths:
    - "All 37 base spirit images downloaded to public/spirits/"
    - "All aspect images with unique art downloaded"
    - "Images are PNG format at appropriate resolution (600px width)"
  artifacts:
    - path: "scripts/download-images.ts"
      provides: "Image download script"
      contains: "downloadImage"
    - path: "public/spirits/"
      provides: "Spirit and aspect images"
  key_links:
    - from: "scripts/download-images.ts"
      to: "scripts/data/spirits.json"
      via: "JSON.parse(fs.readFileSync)"
      pattern: "spirits\\.json"
---

<objective>
Download all spirit and aspect images from the wiki to local storage.

Purpose: Bundle spirit images with the app for offline-first PWA support.
Output: All spirit and aspect images in public/spirits/ directory.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-spirit-aspect-data-scraping/08-RESEARCH.md
@scripts/scrape-spirits.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create image download script</name>
  <files>scripts/download-images.ts</files>
  <action>
Create scripts/download-images.ts that:

1. Reads scripts/data/spirits.json and scripts/data/aspects.json
2. For each spirit/aspect, downloads the image from wiki

Copy the existing downloadImage function from scrape-spirits.ts that handles:
- Relative URL resolution
- Redirect following (301/302)
- Error handling with cleanup of partial files

Add features:
- Skip download if image already exists locally (idempotent)
- Log progress: "Downloading [name]... done" or "Skipping [name] (exists)"
- Handle missing images gracefully (log warning, continue)

Image naming convention:
- Base spirits: `{slug}.png` (e.g., `river-surges-in-sunlight.png`)
- Aspects: `{spirit-slug}-{aspect-name}.png` (e.g., `river-surges-in-sunlight-sunshine.png`)

Rate limiting: 500ms between downloads to be kind to wiki servers.
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit scripts/download-images.ts</verify>
  <done>Image download script created with redirect handling and idempotent downloads</done>
</task>

<task type="auto">
  <name>Task 2: Download all base spirit images</name>
  <files>scripts/download-images.ts, public/spirits/*.png</files>
  <action>
1. Add logic to download base spirit images:
   - Read spirit image URLs from spirits.json (scraped in 08-01)
   - For each spirit, scrape the wiki page to find the panel art image
   - Use srcset parsing to get full-resolution image (not thumbnail)
   - Download to public/spirits/{slug}.png

2. Wiki image finding strategy (from existing scrape-spirits.ts):
   - Find img with alt text containing spirit name
   - Prefer srcset URL without /thumb/ path
   - Handle both relative and absolute URLs

3. Run download for all 37 spirits:
   ```bash
   npx tsx scripts/download-images.ts --spirits-only
   ```

4. Verify:
   - 37 PNG files in public/spirits/
   - Each file > 100KB (not broken/partial)
   - No existing images were overwritten unless --force flag used
  </action>
  <verify>
Run: npx tsx scripts/download-images.ts --spirits-only
Check: ls public/spirits/*.png | wc -l should be >= 37
Check: All files are > 100KB (no broken downloads)
  </verify>
  <done>All 37 base spirit images downloaded to public/spirits/</done>
</task>

<task type="auto">
  <name>Task 3: Download aspect images with fallback</name>
  <files>scripts/download-images.ts, public/spirits/*.png</files>
  <action>
1. Add logic to download aspect images:
   - Read aspects.json
   - For each aspect with hasUniqueImage: true, download the image
   - For aspects without unique images, skip (will use base spirit image as fallback)

2. Aspect image finding:
   - Check aspect's wiki page for unique art
   - If no unique art found, set hasUniqueImage: false in output

3. Run download for aspects:
   ```bash
   npx tsx scripts/download-images.ts --aspects-only
   ```

4. Full download (spirits + aspects):
   ```bash
   npx tsx scripts/download-images.ts
   ```

5. Add summary logging at end:
   - Total images downloaded
   - Images skipped (already exist)
   - Aspects using base spirit fallback
   - Any errors encountered
  </action>
  <verify>
Run: npx tsx scripts/download-images.ts
Check: No download errors in output
Check: Aspect images that should have unique art are present
  </verify>
  <done>All spirit and aspect images downloaded, fallback strategy documented</done>
</task>

</tasks>

<verification>
1. scripts/download-images.ts compiles without errors
2. public/spirits/ contains 37+ PNG files (base spirits + aspects with unique art)
3. All image files are > 100KB (valid, not broken)
4. Existing images preserved (no River/Lightning images corrupted)
5. Script is idempotent (re-running doesn't re-download existing)
</verification>

<success_criteria>
- All base spirit images downloaded
- Aspect images downloaded where available
- Fallback handling for aspects without unique art
- Images bundled with app for offline support
</success_criteria>

<output>
After completion, create `.planning/phases/08-spirit-aspect-data-scraping/08-03-SUMMARY.md`
</output>
