---
phase: 08-spirit-aspect-data-scraping
plan: 04
type: execute
wave: 3
depends_on: ["08-01", "08-02", "08-03"]
files_modified:
  - convex/seed.ts
  - convex/seed-data/spirits.ts
autonomous: true

must_haves:
  truths:
    - "Seed data contains all 37 spirits with complete metadata"
    - "Seed data contains all 31 aspects linked to base spirits"
    - "All expansions are defined (Base, Branch&Claw, Jagged Earth, Feather&Flame, Horizons, Nature Incarnate, Promo Pack 2)"
    - "insertSeedData returns spiritIdsBySlug map for opening preservation"
  artifacts:
    - path: "convex/seed-data/spirits.ts"
      provides: "Spirit and aspect data definitions"
      exports: ["SPIRITS", "ASPECTS", "EXPANSIONS"]
    - path: "convex/seed.ts"
      provides: "Updated seeding logic"
      contains: "seedSpiritsData"
  key_links:
    - from: "convex/seed.ts"
      to: "convex/seed-data/spirits.ts"
      via: "import { SPIRITS, ASPECTS }"
      pattern: "from.*seed-data/spirits"
    - from: "convex/seed.ts:insertSeedData"
      to: "convex/seed.ts:reseedSpirits"
      via: "returns Map<string, Id<'spirits'>>"
      pattern: "spiritIdsBySlug.*Map"
---

<objective>
Update Convex seed data with all scraped spirit and aspect information.

Purpose: Populate the database with complete spirit library data.
Output: convex/seed.ts and convex/seed-data/spirits.ts with all 37 spirits and 31 aspects.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-spirit-aspect-data-scraping/08-RESEARCH.md
@convex/seed.ts
@convex/schema.ts
@scripts/data/spirits.json
@scripts/data/aspects.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create seed-data module with spirit definitions</name>
  <files>convex/seed-data/spirits.ts</files>
  <action>
Create convex/seed-data/spirits.ts to hold all spirit and aspect data:

1. Create the directory and file:
   ```bash
   mkdir -p convex/seed-data
   ```

2. Write a script to transform scripts/data/spirits.json to TypeScript:
   - Read the JSON file
   - Generate a TypeScript file with typed constants
   - Use prettier/biome to format

   Transformation approach (run locally, not committed as script):
   ```typescript
   // Read JSON
   const spiritsJson = JSON.parse(fs.readFileSync('scripts/data/spirits.json', 'utf8'));

   // Generate TypeScript
   const output = `
   export const EXPANSIONS = [
     { name: "Base Game", slug: "base-game", releaseYear: 2017 },
     // ... rest of expansions
   ] as const;

   export interface SpiritData {
     name: string;
     slug: string;
     complexity: "Low" | "Moderate" | "High" | "Very High";
     // ... rest of interface
   }

   export const SPIRITS: SpiritData[] = ${JSON.stringify(spiritsJson, null, 2)};
   `;

   fs.writeFileSync('convex/seed-data/spirits.ts', output);
   ```

3. Define all expansions:
```typescript
export const EXPANSIONS = [
  { name: "Base Game", slug: "base-game", releaseYear: 2017 },
  { name: "Branch & Claw", slug: "branch-and-claw", releaseYear: 2017 },
  { name: "Jagged Earth", slug: "jagged-earth", releaseYear: 2020 },
  { name: "Feather and Flame", slug: "feather-and-flame", releaseYear: 2022 },
  { name: "Horizons of Spirit Island", slug: "horizons", releaseYear: 2022 },
  { name: "Nature Incarnate", slug: "nature-incarnate", releaseYear: 2023 },
  { name: "Promo Pack 2", slug: "promo-pack-2", releaseYear: 2021 },
] as const;
```

4. Define SpiritData interface matching schema fields:
```typescript
export interface SpiritData {
  name: string;
  slug: string;
  complexity: "Low" | "Moderate" | "High" | "Very High";
  summary: string;
  description?: string;
  imageUrl?: string;
  expansion: string; // slug
  elements: string[];
  strengths?: string[];
  weaknesses?: string[];
  powerRatings?: {
    offense: number;
    defense: number;
    control: number;
    fear: number;
    utility: number;
  };
  wikiUrl?: string;
}
```

5. Export SPIRITS array with all 37 spirits (generated from JSON)
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit convex/seed-data/spirits.ts</verify>
  <done>convex/seed-data/spirits.ts exports EXPANSIONS and SPIRITS with all 37 spirits</done>
</task>

<task type="auto">
  <name>Task 2: Add aspect definitions to seed-data</name>
  <files>convex/seed-data/spirits.ts</files>
  <action>
Add aspect definitions to convex/seed-data/spirits.ts:

1. Define AspectData interface:
```typescript
export interface AspectData {
  name: string;           // "Sunshine"
  baseSpiritSlug: string; // "river-surges-in-sunlight"
  summary: string;
  expansion: string;      // slug
  complexityModifier: "easier" | "same" | "harder";
  imageUrl?: string;      // undefined means use base spirit image
}
```

2. Transform scripts/data/aspects.json to TypeScript ASPECTS constant
   (Same transformation approach as Task 1)

3. Group aspects by base spirit for readability:
```typescript
export const ASPECTS: AspectData[] = [
  // River Surges in Sunlight aspects
  { name: "Sunshine", baseSpiritSlug: "river-surges-in-sunlight", ... },
  { name: "Travel", baseSpiritSlug: "river-surges-in-sunlight", ... },
  // Lightning's Swift Strike aspects
  { name: "Pandemonium", baseSpiritSlug: "lightnings-swift-strike", ... },
  // ...
];
```

4. Ensure imageUrl is set only for aspects with unique art
   - Otherwise leave undefined (will inherit base spirit image)
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit convex/seed-data/spirits.ts</verify>
  <done>convex/seed-data/spirits.ts exports ASPECTS with all 31 aspects</done>
</task>

<task type="auto">
  <name>Task 3: Update seed.ts to use new seed-data module</name>
  <files>convex/seed.ts</files>
  <action>
Refactor convex/seed.ts to use the new seed-data module:

1. Import from seed-data/spirits.ts:
```typescript
import { EXPANSIONS, SPIRITS, ASPECTS } from "./seed-data/spirits";
```

2. Update seedExpansions to use imported EXPANSIONS
   - Keep the existing function structure
   - Just reference the imported constant

3. Update seedSpiritsData to:
   - Create all base spirits from SPIRITS array
   - Track created spirit IDs in a Map<string, Id<"spirits">>
   - Create all aspects from ASPECTS array, looking up baseSpirit ID from map

4. **CRITICAL: Update insertSeedData return type:**
   The function must return the spiritIdsBySlug map for opening preservation.
   ```typescript
   async function insertSeedData(ctx: MutationCtx): Promise<{
     spiritIdsBySlug: Map<string, Id<"spirits">>;
     stats: { expansions: number; spirits: number; aspects: number };
   }> {
     // ... existing seeding logic ...

     // Build the map as spirits are created
     const spiritIdsBySlug = new Map<string, Id<"spirits">>();

     for (const spirit of SPIRITS) {
       const spiritId = await ctx.db.insert("spirits", { /* ... */ });
       spiritIdsBySlug.set(spirit.slug, spiritId);
     }

     // ... create aspects ...

     return {
       spiritIdsBySlug,
       stats: { expansions: EXPANSIONS.length, spirits: SPIRITS.length, aspects: ASPECTS.length }
     };
   }
   ```

5. Keep existing helper functions:
   - clearExistingData (unchanged)
   - seedOpenings (keep existing River opening)
   - insertSeedData (update to return spiritIdsBySlug map)

6. Remove hardcoded spirit data from seed.ts (now in seed-data module)

7. Update return messages to reflect actual counts:
   - "Created X expansions, Y base spirits, Z aspects, 1 opening"
  </action>
  <verify>
Run: npx convex dev --once (compile check)
TypeScript compiles without errors
  </verify>
  <done>seed.ts imports from seed-data module, seeds all spirits/aspects, and returns spiritIdsBySlug map</done>
</task>

</tasks>

<verification>
1. convex/seed-data/spirits.ts compiles without TypeScript errors
2. convex/seed.ts compiles without TypeScript errors
3. EXPANSIONS contains 7 expansion definitions
4. SPIRITS contains 37 spirit definitions
5. ASPECTS contains 31 aspect definitions
6. All aspects reference valid base spirit slugs
7. insertSeedData returns spiritIdsBySlug map
</verification>

<success_criteria>
- Seed data extracted to dedicated module for maintainability
- All 37 spirits and 31 aspects defined with complete metadata
- seed.ts refactored to use imported data
- insertSeedData returns spiritIdsBySlug map for Plan 08-05 opening preservation
- Ready for running reseedSpirits mutation
</success_criteria>

<output>
After completion, create `.planning/phases/08-spirit-aspect-data-scraping/08-04-SUMMARY.md`
</output>
