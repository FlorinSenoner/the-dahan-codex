# Phase 3.3: Spirit Board Final Polish - Research

**Researched:** 2026-01-27
**Domain:** React component styling, CSS hover interactions, presence track visualization
**Confidence:** HIGH

## Summary

This phase addresses two distinct areas: (1) cosmetic improvement of growth panel labels to show on hover only, and (2) visualization enhancements for complex presence track patterns. The growth label change is straightforward CSS using Tailwind's group-hover pattern. The presence track work requires visual indicators rather than actual branching graph rendering.

The research confirms that the existing codebase already has the schema infrastructure for complex spirits (connectsTo, connectionPoint, unlocksGrowth, presenceCap). The work focuses on:
1. Hover-reveal G1/G2/G3 labels with absolute positioning (pure CSS)
2. Visual indicators for branching/connected tracks (icon + tooltip)
3. Visual indicators for unlock-triggered tracks (already implemented with Sprout icon)
4. Visual rendering of presenceCap slots (showing cap values)

**Primary recommendation:** Use Tailwind group-hover pattern for labels; enhance existing indicator system rather than building complex branching visualization.

## Standard Stack

The established libraries/tools for this domain:

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| Tailwind CSS | v4 | Utility-first CSS | Already in project, group-hover pattern native |
| React | 19 | Component framework | Already in project |
| Lucide React | latest | Icon library | Already in project (GitBranch, Sprout icons) |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| @radix-ui/react-tooltip | latest | Accessible tooltips | Already via shadcn/ui |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| SVG connectors | Visual indicators | Connectors add complexity, indicators work for reference app |
| react-arborist | Custom rendering | Tree library overkill for static display |
| leader-line | Icon indicators | External lib unnecessary for simple visual hints |

**Installation:**
```bash
# No new dependencies required
```

## Architecture Patterns

### Recommended Component Structure
```
app/components/spirits/
  growth-panel.tsx      # Update: group hover pattern for labels
  presence-track.tsx    # Update: enhanced branching/cap indicators
  presence-slot.tsx     # Update: presenceCap display in slot
```

### Pattern 1: Group Hover for Hidden Elements
**What:** Parent element has `group` class, child toggles visibility with `group-hover:block`
**When to use:** Show element only on parent hover (G1/G2/G3 labels)
**Example:**
```tsx
// Source: Tailwind CSS official docs
<div className="relative group">
  {/* Card content */}
  <div className="...">
    <GrowthActionIcon action={action} />
  </div>

  {/* Label - hidden until hover */}
  <span className="absolute top-1 right-1 hidden group-hover:block
                   text-xs font-semibold text-muted-foreground
                   bg-muted/50 backdrop-blur-sm px-2 py-0.5 rounded">
    G1
  </span>
</div>
```

### Pattern 2: Track Connection Visual Indicator
**What:** Show icon + tooltip when track has connectsTo property
**When to use:** Finder's branching tracks, any spirit with connected tracks
**Example:**
```tsx
// Already implemented in presence-track.tsx
{track.connectsTo && (
  <span className="text-muted-foreground"
        title={`Connects to ${track.connectsTo} track at slot ${track.connectionPoint}`}>
    <GitBranch className="w-3.5 h-3.5" />
  </span>
)}
```

### Pattern 3: Presence Cap Display
**What:** Show presenceCap value in slot when present
**When to use:** Serpent's Deep Slumber track slots
**Example:**
```tsx
// In presence-slot.tsx
const displayValue = slot.presenceCap
  ? `${slot.presenceCap}` // Show cap limit (5, 6, 7, etc.)
  : (slot.reclaim ? "R" : slot.value);
```

### Anti-Patterns to Avoid
- **Building SVG connector library:** Overkill for reference display; visual indicators sufficient
- **Interactive drag-and-drop tracks:** Out of scope for read-only spirit reference
- **Complex tree rendering:** Simple visual indicators work; avoid react-arborist complexity

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Hover-reveal | JS state + onClick | Tailwind group-hover | Pure CSS, no re-renders |
| Tooltip positioning | Manual positioning | Radix Tooltip | Handles edge cases, accessibility |
| Icon system | Custom SVGs | Lucide React | Consistent, accessible, themed |

**Key insight:** This phase is cosmetic polish, not new architecture. Use existing patterns.

## Common Pitfalls

### Pitfall 1: Over-Engineering Branching Visualization
**What goes wrong:** Building complex SVG connector system for "accurate" track representation
**Why it happens:** Spirit Island tracks are visually complex; temptation to replicate exactly
**How to avoid:** Remember this is a reference app, not a game. Visual indicators + tooltips convey information adequately
**Warning signs:** Reaching for external libraries, calculating positions, SVG path math

### Pitfall 2: Breaking Touch Targets with Hover-Only Labels
**What goes wrong:** Labels become inaccessible on touch devices
**Why it happens:** Hover doesn't exist on touch; users never see the labels
**How to avoid:** Labels are supplementary info (G1/G2/G3), not essential. Growth options are distinguishable by content
**Warning signs:** Relying on hover for critical information

### Pitfall 3: Inconsistent Presence Slot Sizing with PresenceCap
**What goes wrong:** Cap numbers (5-13) are wider than energy values (0-7), breaking slot alignment
**Why it happens:** presenceCap values can be 2 digits
**How to avoid:** Fixed slot width (already 44px min), display fits within bounds
**Warning signs:** Slots expanding horizontally, breaking track alignment

### Pitfall 4: Z-Index Conflicts with Absolute Labels
**What goes wrong:** G1/G2/G3 labels appear behind other elements or overlap incorrectly
**Why it happens:** Stacking context issues with absolute positioning
**How to avoid:** Labels only need to be above their card (z-10), not above sticky header
**Warning signs:** Labels appearing above the header bar when scrolling

## Code Examples

Verified patterns from existing codebase and official sources:

### Growth Card with Hover-Reveal Label
```tsx
// Updated GrowthOptionCard in growth-panel.tsx
function GrowthOptionCard({ option }: { option: GrowthOption }) {
  return (
    <div className="bg-muted/30 rounded-lg p-3 relative group hover:bg-muted/50 transition-colors">
      {/* G1/G2/G3 label - hidden until hover, absolute top-right */}
      <span className="absolute top-1 right-1 z-10
                       hidden group-hover:inline-block
                       text-xs font-semibold text-muted-foreground
                       bg-muted/50 backdrop-blur-sm px-2 py-0.5 rounded
                       transition-opacity">
        {option.id}
      </span>

      {/* Cost badge (unchanged) */}
      {option.cost !== undefined && option.cost > 0 && (
        <div className="absolute -top-2 -right-2 z-10">
          <Badge variant="outline" className="text-xs text-amber-400 border-amber-400/50">
            {option.cost} Energy
          </Badge>
        </div>
      )}

      {/* Actions row - no longer includes inline G1 label */}
      <div className="flex flex-wrap items-center gap-3">
        {/* Repeat badge if present */}
        {option.repeat && option.repeat > 1 && (
          <Badge variant="secondary" className="text-xs">x{option.repeat}</Badge>
        )}

        {/* Regular actions */}
        {option.actions.map((action, idx) => {
          const actionKey = `${option.id}-${action.type}-${idx}`;
          return <GrowthActionIcon key={actionKey} action={action} />;
        })}

        {/* Or actions for complex spirits */}
        {option.orActions && option.orActions.length > 0 && (
          <OrActionsGroup orActions={option.orActions} />
        )}
      </div>
    </div>
  );
}
```

### Enhanced Presence Track with Connection Indicator
```tsx
// Updated track label area in presence-track.tsx
<div className="flex items-center gap-2 mb-2">
  <Text variant="small" className={cn("font-medium uppercase tracking-wider", labelColor)}>
    {track.label}
  </Text>

  {/* Branching track indicator (Finder) - enhanced with connection point */}
  {track.connectsTo && (
    <Tooltip>
      <TooltipTrigger asChild>
        <span className="text-muted-foreground cursor-help">
          <GitBranch className="w-3.5 h-3.5" />
        </span>
      </TooltipTrigger>
      <TooltipContent>
        <p className="text-xs">
          Connects to {track.connectsTo} track
          {track.connectionPoint !== undefined && ` at slot ${track.connectionPoint + 1}`}
        </p>
      </TooltipContent>
    </Tooltip>
  )}

  {/* Unlocks growth indicator (Starlight) - already implemented */}
  {track.unlocksGrowth && (
    <Tooltip>
      <TooltipTrigger asChild>
        <span className="text-emerald-400 cursor-help">
          <Sprout className="w-3.5 h-3.5" />
        </span>
      </TooltipTrigger>
      <TooltipContent>
        <p className="text-xs">Unlocks growth options when emptied</p>
      </TooltipContent>
    </Tooltip>
  )}
</div>
```

### Presence Slot with PresenceCap Display
```tsx
// Updated displayValue logic in presence-slot.tsx
const getDisplayValue = (slot: PresenceSlot, trackType?: string) => {
  // Reclaim takes precedence
  if (slot.reclaim) return "R";

  // For presenceLimit tracks, show the cap value prominently
  if (slot.presenceCap !== undefined) {
    return `${slot.presenceCap}`;
  }

  return slot.value;
};

// Enhanced tooltip for presenceCap
if (slot.presenceCap !== undefined) {
  tooltipLines.push(`Presence limit: ${slot.presenceCap}`);
}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Always-visible labels | Hover-reveal labels | Phase 3.3 | More compact cards |
| No connection indicators | Icon + tooltip | Phase 3.2 | Better complex spirit support |

**Deprecated/outdated:**
- None - this is polish work on recent implementation

## Open Questions

Things that couldn't be fully resolved:

1. **Touch Device Label Accessibility**
   - What we know: Touch devices don't have hover; G1/G2/G3 labels won't appear
   - What's unclear: Is this acceptable for reference info?
   - Recommendation: Accept - labels are supplementary, not essential. Growth options are distinguishable by their actions.

2. **Complex Track Visual Fidelity**
   - What we know: Finder, Starlight, Serpent have unique track layouts
   - What's unclear: How much visual accuracy is needed vs. functional display?
   - Recommendation: Icon indicators + tooltips sufficient for reference app. Full graphical representation would be Phase 5+ (opening scrubber).

## Sources

### Primary (HIGH confidence)
- Existing codebase analysis: presence-track.tsx, growth-panel.tsx, presence-slot.tsx
- Convex schema.ts: connectsTo, connectionPoint, unlocksGrowth, presenceCap fields
- Seed data: Complex spirits (Finder, Starlight, Serpent) already seeded with metadata

### Secondary (MEDIUM confidence)
- [Tailwind CSS Hover States](https://tailwindcss.com/docs/hover-focus-and-other-states) - group-hover pattern
- [Tailwind CSS Position](https://tailwindcss.com/docs/position) - absolute positioning

### Tertiary (LOW confidence)
- Web search results for SVG connectors - confirmed as overkill for this use case

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - using existing libraries only
- Architecture: HIGH - patterns already proven in codebase
- Pitfalls: HIGH - based on actual implementation experience in Phase 3.2

**Research date:** 2026-01-27
**Valid until:** 90 days (polish work, stable patterns)
