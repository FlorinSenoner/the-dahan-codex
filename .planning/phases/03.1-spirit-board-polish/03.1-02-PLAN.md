---
phase: 03.1-spirit-board-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/seed.ts
autonomous: true

must_haves:
  truths:
    - "Growth schema uses flat G1/G2/G3 array structure with typed actions"
    - "Presence tracks schema supports flexible array of tracks"
    - "River and Lightning have correct data from wiki"
    - "Innates and uniquePowers have range and target fields"
  artifacts:
    - path: "convex/schema.ts"
      provides: "Redesigned growth, presenceTracks, innates, uniquePowers schemas"
      contains: "growthOptions"
    - path: "convex/seed.ts"
      provides: "Correct Spirit Island data for River and Lightning"
      contains: "G1"
  key_links:
    - from: "convex/seed.ts"
      to: "convex/schema.ts"
      via: "Data matches schema validators"
      pattern: "v.object"
---

<objective>
Redesign the Convex schema for growth options and presence tracks to support correct game data, then update seed data with accurate information from Spirit Island wiki.

Purpose: Current schema uses incorrect "Top/Bottom" groupings instead of numbered G1/G2/G3 options. Presence tracks are hardcoded to exactly 2 tracks. This prevents accurate representation of Spirit Island mechanics.

Output:
- Redesigned schema with flexible, typed structures
- Correct seed data for River Surges in Sunlight and Lightning's Swift Strike
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03.1-spirit-board-polish/03.1-RESEARCH.md
@convex/schema.ts
@convex/seed.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Redesign Convex Schema</name>
  <files>convex/schema.ts</files>
  <action>
Update schema.ts with redesigned validators:

1. Growth schema - flat array of numbered options:
```typescript
growth: v.optional(
  v.object({
    type: v.optional(v.union(v.literal("pick-one"), v.literal("pick-two"))),
    options: v.array(
      v.object({
        id: v.string(), // "G1", "G2", "G3", etc.
        cost: v.optional(v.number()), // Energy cost for "Or" options
        actions: v.array(
          v.object({
            type: v.string(), // "reclaim", "gainEnergy", "gainPowerCard", "addPresence", "push", "damage", "gainElement"
            // Type-specific fields (all optional, used based on type):
            variant: v.optional(v.string()), // reclaim: "all" | "one"
            amount: v.optional(v.number()), // gainEnergy, damage
            cardType: v.optional(v.string()), // gainPowerCard: "minor" | "major"
            range: v.optional(v.number()), // addPresence
            terrain: v.optional(v.string()), // addPresence restriction
            count: v.optional(v.number()), // push count
            pieceType: v.optional(v.string()), // push piece type
            target: v.optional(v.string()), // damage/push target description
            element: v.optional(v.string()), // gainElement
          })
        ),
      })
    ),
  })
),
```

2. Presence tracks schema - flexible array:
```typescript
presenceTracks: v.optional(
  v.object({
    tracks: v.array(
      v.object({
        type: v.string(), // "energy", "cardPlays", "absorbed", "custom"
        label: v.string(),
        color: v.optional(v.string()), // "amber", "blue", "purple"
        slots: v.array(
          v.object({
            value: v.union(v.number(), v.string()),
            elements: v.optional(v.array(v.string())),
            reclaim: v.optional(v.boolean()),
            innateUnlock: v.optional(v.string()),
            specialAbility: v.optional(v.string()),
          })
        ),
      })
    ),
  })
),
```

3. Add range/target to innates (keep existing but add structured fields):
- Keep existing range: v.optional(v.string()) for display text
- Keep existing target: v.optional(v.string()) for display text
(The research shows we can use strings for now and parse for display)

4. Add range/target to uniquePowers:
```typescript
uniquePowers: v.optional(
  v.array(
    v.object({
      name: v.string(),
      cost: v.number(),
      speed: v.union(v.literal("Fast"), v.literal("Slow")),
      elements: v.array(v.string()),
      range: v.optional(v.string()), // ADD: "0", "1", "Sacred Site", etc.
      target: v.optional(v.string()), // ADD: "Any Land", "Land with Invaders", etc.
      description: v.optional(v.string()),
    })
  )
),
```
  </action>
  <verify>
Run `pnpm typecheck` - schema compiles without errors.
Run `npx convex dev` briefly to check schema validation.
  </verify>
  <done>
Schema supports flat growth options with typed actions, flexible presence track array, and range/target on uniquePowers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Seed Data with Correct Spirit Data</name>
  <files>convex/seed.ts</files>
  <action>
Update seed.ts with accurate Spirit Island data from wiki:

1. River Surges in Sunlight growth (3 options):
```typescript
growth: {
  type: "pick-one",
  options: [
    {
      id: "G1",
      actions: [
        { type: "reclaim", variant: "all" },
      ],
    },
    {
      id: "G2",
      actions: [
        { type: "addPresence", range: 1 },
        { type: "addPresence", range: 1 },
        { type: "gainPowerCard" },
      ],
    },
    {
      id: "G3",
      actions: [
        { type: "addPresence", range: 2, terrain: "Wetland" },
        { type: "gainEnergy", amount: 1 },
      ],
    },
  ],
},
```

2. River presence tracks (new format):
```typescript
presenceTracks: {
  tracks: [
    {
      type: "energy",
      label: "Energy/Turn",
      color: "amber",
      slots: [
        { value: 1 },
        { value: 2 },
        { value: 2 },
        { value: 3 },
        { value: 4 },
        { value: 4 },
        { value: 5 },
      ],
    },
    {
      type: "cardPlays",
      label: "Card Plays",
      color: "blue",
      slots: [
        { value: 1 },
        { value: 2 },
        { value: 2 },
        { value: 3 },
        { value: 3, reclaim: true },
        { value: 4 },
        { value: 5 },
      ],
    },
  ],
},
```

3. River innates - update with correct data from wiki:
- Massive Flooding: Slow (not Fast), Sacred Site range, correct thresholds
- Boon of Vigor: correct thresholds

4. River uniquePowers - add range/target:
```typescript
{
  name: "River's Bounty",
  cost: 0,
  speed: "Slow",
  elements: ["Sun", "Water"],
  range: "1",
  target: "Any Land",
  description: "Gather up to 2 Dahan. If there are now at least 2 Dahan, add 1 Fertility.",
},
// ... similar for other cards
```

5. Lightning's Swift Strike growth (3 options):
```typescript
growth: {
  type: "pick-one",
  options: [
    {
      id: "G1",
      actions: [
        { type: "reclaim", variant: "all" },
        { type: "gainPowerCard" },
      ],
    },
    {
      id: "G2",
      actions: [
        { type: "addPresence", range: 2 },
        { type: "gainPowerCard" },
      ],
    },
    {
      id: "G3",
      actions: [
        { type: "addPresence", range: 1 },
        { type: "gainEnergy", amount: 3 },
      ],
    },
  ],
},
```

6. Lightning presence tracks and uniquePowers with range/target.

7. Update reseedSpirits mutation with same changes (duplicate the data).
  </action>
  <verify>
Run `npx convex run seed:reseedSpirits` to verify data seeds correctly.
Check Convex dashboard that spirits have new data structure.
  </verify>
  <done>
River and Lightning have correct growth options (G1/G2/G3), presence tracks in new array format, and uniquePowers with range/target fields.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `npx convex dev` runs without schema errors
3. `npx convex run seed:reseedSpirits` succeeds
4. Convex dashboard shows spirits with new growth.options[].id format
</verification>

<success_criteria>
- Growth schema uses flat G1/G2/G3 array with typed action objects
- Presence tracks schema supports flexible track array
- River has 3 correct growth options matching wiki
- Lightning has 3 correct growth options matching wiki
- uniquePowers include range and target fields
- reseedSpirits mutation updated with same data
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-spirit-board-polish/03.1-02-SUMMARY.md`
</output>
