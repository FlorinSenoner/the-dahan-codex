# Phase 3.1: Spirit Board Polish - Research

**Researched:** 2026-01-26
**Domain:** UI/UX polish, Schema redesign, SVG icon system, DSL design
**Confidence:** HIGH

## Summary

This phase addresses 8 UAT gaps from Phase 3 Spirit Detail Board implementation. Research identified three major workstreams: (1) visual polish for existing components (tabs, radar chart, presence slots, external links), (2) schema and data redesign for growth options and presence tracks to support complex spirits, and (3) creation of a typed DSL and SVG icon system shared between innate powers and power cards.

The primary challenge is the growth panel and presence track schema which currently uses incorrect structures (Top/Bottom groupings vs numbered G1/G2/G3 options, hardcoded two tracks vs flexible array). Additionally, the current element display uses text badges rather than SVG icons matching the Spirit Island visual language.

**Primary recommendation:** Create a shared power DSL module (`power-dsl.ts`) with typed action/effect structures, implement 8 element SVG icons as React components, and redesign the growth/presence schema to support arbitrary complexity while maintaining type safety.

## Standard Stack

The established libraries/tools for this phase:

### Core (Already in Project)
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| Recharts | 2.x | Radar chart | Already integrated, `PolarGrid gridType` supports polygon/circle grids |
| Radix Collapsible | latest | Mobile overview collapse | Already in shadcn/ui stack |
| Tailwind v4 | 4.1.x | Styling with oklch | CSS-first config already set up |

### Supporting (No New Dependencies Needed)
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| React SVG components | native | Element icons | Inline SVG as TSX components |
| TypeScript discriminated unions | native | DSL type safety | Growth action types, effect types |
| Convex validators | native | Schema types | `v.union()` for typed actions |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Inline SVG components | External icon library | Custom Spirit Island icons not available elsewhere |
| Recharts PolarGrid | Custom SVG grid | Recharts already integrated, `gridType="polygon"` provides spider web |
| Convex schema redesign | JSON blob field | Lose type safety, harder to query/validate |

**Installation:**
```bash
# No new dependencies needed - everything uses existing stack
```

## Architecture Patterns

### Recommended Project Structure
```
app/
├── components/
│   ├── spirits/
│   │   ├── growth-panel.tsx        # Redesigned with typed actions
│   │   ├── presence-track.tsx      # Dynamic track support
│   │   ├── presence-slot.tsx       # Gradient backgrounds, cursor
│   │   ├── innate-powers.tsx       # Shared DSL, element icons
│   │   ├── card-hand.tsx           # Shared DSL, speed outlines
│   │   ├── power-radar-chart.tsx   # Dark mode optimized
│   │   ├── variant-tabs.tsx        # Polish fixes
│   │   ├── external-links.tsx      # Consistent styling
│   │   └── overview-section.tsx    # Responsive sidebar
│   └── icons/
│       ├── elements/               # 8 element SVG components
│       │   ├── index.ts            # Barrel export
│       │   ├── sun.tsx
│       │   ├── moon.tsx
│       │   ├── fire.tsx
│       │   ├── air.tsx
│       │   ├── water.tsx
│       │   ├── earth.tsx
│       │   ├── plant.tsx
│       │   └── animal.tsx
│       └── game-terms/             # Game term icons (optional Phase 3.1+)
│           ├── dahan.tsx
│           ├── explorer.tsx
│           ├── town.tsx
│           └── city.tsx
├── lib/
│   ├── power-dsl.ts               # Shared DSL types and utilities
│   └── spirit-colors.ts           # Existing element colors
convex/
├── schema.ts                      # Redesigned growth/presence/power schemas
└── seed.ts                        # Corrected Spirit Island data
```

### Pattern 1: Discriminated Union DSL for Growth Actions
**What:** Type-safe growth action representation using discriminated unions
**When to use:** Growth panel actions, any typed game mechanic
**Example:**
```typescript
// Source: TypeScript Discriminated Unions pattern
type GrowthAction =
  | { type: "reclaim"; variant: "all" | "one" }
  | { type: "gainEnergy"; amount: number }
  | { type: "gainPowerCard"; cardType?: "minor" | "major" }
  | { type: "addPresence"; range: number; restriction?: string }
  | { type: "damage"; amount: number; target: string }
  | { type: "push"; count: number; pieceType: string; from: string };

// Convex validator equivalent
const growthActionValidator = v.union(
  v.object({ type: v.literal("reclaim"), variant: v.union(v.literal("all"), v.literal("one")) }),
  v.object({ type: v.literal("gainEnergy"), amount: v.number() }),
  v.object({ type: v.literal("gainPowerCard"), cardType: v.optional(v.union(v.literal("minor"), v.literal("major"))) }),
  v.object({ type: v.literal("addPresence"), range: v.number(), restriction: v.optional(v.string()) }),
  // ...
);
```

### Pattern 2: SVG Icon Components with Element Colors
**What:** Typed React SVG components using existing element color tokens
**When to use:** Element icons, growth action icons
**Example:**
```typescript
// Source: React SVG best practices 2025/2026
import type { SVGProps } from "react";
import { cn } from "@/lib/utils";

interface ElementIconProps extends SVGProps<SVGSVGElement> {
  size?: number;
}

export function SunIcon({ size = 24, className, ...props }: ElementIconProps) {
  return (
    <svg
      width={size}
      height={size}
      viewBox="0 0 24 24"
      fill="currentColor"
      className={cn("text-element-sun", className)}
      {...props}
    >
      {/* Sun: circle with rays */}
      <circle cx="12" cy="12" r="5" />
      <path
        d="M12 2v3M12 19v3M2 12h3M19 12h3M4.93 4.93l2.12 2.12M16.95 16.95l2.12 2.12M4.93 19.07l2.12-2.12M16.95 7.05l2.12-2.12"
        stroke="currentColor"
        strokeWidth="2"
        strokeLinecap="round"
        fill="none"
      />
    </svg>
  );
}

// Barrel export with type-safe mapping
export const ElementIcon: Record<string, React.FC<ElementIconProps>> = {
  Sun: SunIcon,
  Moon: MoonIcon,
  Fire: FireIcon,
  Air: AirIcon,
  Water: WaterIcon,
  Earth: EarthIcon,
  Plant: PlantIcon,
  Animal: AnimalIcon,
};
```

### Pattern 3: Flexible Presence Track Schema
**What:** Array-based track structure supporting arbitrary track types
**When to use:** Presence tracks for all spirits including complex ones (Serpent)
**Example:**
```typescript
// Source: Spirit Island Wiki - Serpent Slumbering Beneath the Island
const presenceTrackValidator = v.object({
  tracks: v.array(
    v.object({
      type: v.union(
        v.literal("energy"),
        v.literal("cardPlays"),
        v.literal("absorbed"),  // Serpent's Deep Slumber track
        v.literal("custom")
      ),
      label: v.string(),
      color: v.optional(v.string()),  // Tailwind class: "amber", "blue", "purple"
      slots: v.array(
        v.object({
          value: v.union(v.number(), v.string()),
          elements: v.optional(v.array(v.string())),
          reclaim: v.optional(v.boolean()),
          innateUnlock: v.optional(v.string()),  // Name of innate power unlocked
          specialAbility: v.optional(v.string()),
        })
      ),
    })
  ),
});
```

### Pattern 4: Power Targeting DSL (Shared by Innates and Cards)
**What:** Structured range and target for powers
**When to use:** Innate powers, unique power cards
**Example:**
```typescript
// Source: Spirit Island Wiki - Targeting
interface PowerTargeting {
  speed: "Fast" | "Slow";
  range: {
    type: "numeric" | "spirit" | "any";
    value?: number;            // 0, 1, 2, etc.
    fromSacredSite?: boolean;  // Range measured from sacred site
    landType?: string;         // Additional terrain restriction
  };
  target: {
    type: "land" | "spirit" | "invaders" | "dahan";
    restrictions?: string[];   // "Coastal", "with Invaders", etc.
  };
}
```

### Anti-Patterns to Avoid
- **Hardcoded track count:** Don't assume exactly 2 tracks - some spirits have 3+ tracks
- **String-based actions:** Don't use plain strings for growth actions - use typed objects
- **Array index keys:** Don't use index as React key - use generated stable keys from content
- **CSS-in-JS for colors:** Don't inline oklch values - use Tailwind classes that reference CSS variables
- **Low opacity chart fills:** Don't use fillOpacity below 0.4 on dark backgrounds

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Radar chart spider web | Custom SVG grid | Recharts `PolarGrid gridType="polygon"` | Built-in support, handles scaling |
| Concentric grid rings | Manual circle drawing | Recharts `polarRadius` prop on PolarGrid | Recharts draws rings at specified radii |
| Collapsible sections | CSS-only accordion | Radix Collapsible (already installed) | Accessibility, animation, state management |
| Responsive sidebar | Media query + state | Tailwind responsive grid `lg:grid-cols-[1fr_320px]` | Simpler, no JS needed for layout |
| Tab highlight gradient | Complex gradient math | Tailwind gradient utilities `bg-gradient-to-b` | Consistent with design system |
| Icon system | Individual imports | Barrel export with Record mapping | Type-safe, tree-shakeable |

**Key insight:** The existing Tailwind and shadcn/ui stack already provides solutions for most visual polish. The main custom work is schema design and SVG icon creation.

## Common Pitfalls

### Pitfall 1: Recharts Dark Mode Visibility
**What goes wrong:** Chart elements invisible on dark backgrounds
**Why it happens:** Default colors use low-contrast CSS variables. `--primary` at oklch 0.55 with 30% opacity is nearly invisible on oklch 0.15 background.
**How to avoid:** Use explicit high-contrast colors for dark mode:
```typescript
// Bad
<Radar fill="hsl(var(--primary))" fillOpacity={0.3} />

// Good
<Radar
  fill="oklch(0.75 0.14 145)"  // Brighter green
  fillOpacity={0.5}            // Higher opacity
  stroke="oklch(0.85 0.14 145)"
  strokeWidth={2}
/>
<PolarGrid
  gridType="polygon"
  stroke="oklch(0.45 0.02 90)"  // Visible grey
  strokeOpacity={0.8}
/>
```
**Warning signs:** Chart appears empty but data is present

### Pitfall 2: Growth Schema Mismatch with Game Data
**What goes wrong:** Schema uses "Top/Bottom" groupings but game uses "G1/G2/G3" numbered options
**Why it happens:** Initial implementation assumed growth was organized by visual position, not by choice number
**How to avoid:** Use flat array of growth options with `id` field:
```typescript
// Bad - matches visual layout, not game mechanics
growth: [
  { title: "Top", options: [...] },
  { title: "Bottom", options: [...] }
]

// Good - matches game mechanics
growth: {
  pickCount: 1,  // or 2 for "Pick Two" spirits
  options: [
    { id: "G1", actions: [...] },
    { id: "G2", actions: [...] },
    { id: "G3", actions: [...] },
  ]
}
```
**Warning signs:** Growth data doesn't match wiki, "Top/Bottom" labels confuse users

### Pitfall 3: Presence Track Type Rigidity
**What goes wrong:** Cannot represent Serpent Slumbering Beneath the Island or other complex spirits
**Why it happens:** Schema hardcodes `energy` and `cardPlays` as only two tracks
**How to avoid:** Use flexible array structure:
```typescript
// Bad - hardcoded structure
presenceTracks: {
  energy: [...],
  cardPlays: [...]
}

// Good - flexible array
presenceTracks: {
  tracks: [
    { type: "energy", slots: [...] },
    { type: "cardPlays", slots: [...] },
    // Serpent can add:
    { type: "absorbed", label: "Deep Slumber", slots: [...] }
  ]
}
```
**Warning signs:** Adding new spirit requires schema migration

### Pitfall 4: Tabs Overflow with Vertical Scroll
**What goes wrong:** TabsList allows vertical scrolling, breaks horizontal scroll UX
**Why it happens:** No explicit `overflow-y-hidden` on TabsList
**How to avoid:** Always set both overflow directions:
```typescript
// Add to TabsList className
"overflow-x-auto overflow-y-hidden"
```
**Warning signs:** Two scroll directions on tab bar, jarring mobile experience

### Pitfall 5: Z-Index Stacking Conflict
**What goes wrong:** Variant tabs appear above sticky header when scrolling
**Why it happens:** Both elements have same z-index, position in DOM determines stacking
**How to avoid:** Header needs higher z-index than tabs:
```typescript
// Header: z-20
// Tabs: z-10
```
**Warning signs:** Tabs visually overlap header on scroll

## Code Examples

Verified patterns from official sources:

### Recharts Radar with Spider Web Grid (Dark Mode Optimized)
```typescript
// Source: Recharts API - https://recharts.github.io/en-US/api/PolarGrid/
// PolarGrid props: gridType ("polygon" | "circle"), polarRadius (number[])
<RadarChart cx="50%" cy="50%" outerRadius="70%" data={data}>
  <PolarGrid
    gridType="polygon"                     // Spider web shape (default)
    polarRadius={[20, 40, 60, 80, 100]}   // 5 concentric rings
    stroke="oklch(0.5 0.02 90)"           // Visible on dark bg
    strokeOpacity={0.8}
  />
  <PolarAngleAxis
    dataKey="axis"
    tick={{
      fill: "oklch(0.75 0.02 90)",  // Light text
      fontSize: 11,
    }}
  />
  <PolarRadiusAxis
    angle={90}
    domain={[0, 5]}
    tickCount={6}
    tick={{ fill: "oklch(0.6 0.02 90)" }}
  />
  <Radar
    dataKey="value"
    stroke="oklch(0.65 0.14 145)"   // Bright primary
    strokeWidth={2}
    fill="oklch(0.55 0.14 145)"
    fillOpacity={0.4}              // Visible fill
  />
</RadarChart>
```

### River Surges in Sunlight - Correct Growth Data
```typescript
// Source: Spirit Island Wiki - River Surges in Sunlight
// River has 3 growth options, not 2 groups
growth: {
  pickCount: 1,
  options: [
    {
      id: "G1",
      actions: [
        { type: "reclaim", variant: "all" }
      ]
    },
    {
      id: "G2",
      actions: [
        { type: "gainPowerCard" },
        { type: "addPresence", range: 1 },
        { type: "addPresence", range: 1 }  // Two presence placements
      ]
    },
    {
      id: "G3",
      actions: [
        { type: "gainEnergy", amount: 1 },
        { type: "addPresence", range: 1 },
        { type: "addPresence", range: 2 }
      ]
    }
  ]
}
```

### Presence Track with Correct River Data
```typescript
// Source: Spirit Island Wiki - River Surges in Sunlight
presenceTracks: {
  tracks: [
    {
      type: "energy",
      label: "Energy per Turn",
      color: "amber",
      slots: [
        { value: 1 },
        { value: 2 },
        { value: 2 },
        { value: 3 },
        { value: 4 },
        { value: 4 },
        { value: 5 }
      ]
    },
    {
      type: "cardPlays",
      label: "Card Plays per Turn",
      color: "blue",
      slots: [
        { value: 1 },
        { value: 2 },
        { value: 2 },
        { value: 3 },
        { value: 3, reclaim: true },  // Reclaim One slot
        { value: 4 },
        { value: 5 }
      ]
    }
  ]
}
```

### Massive Flooding Innate - Correct Data with Targeting
```typescript
// Source: Spirit Island Wiki - River Surges in Sunlight
{
  name: "Massive Flooding",
  speed: "Slow",
  range: { type: "numeric", value: 1, fromSacredSite: true },  // Sacred Site + 1
  target: { type: "land", restrictions: [] },  // Any Land
  thresholds: [
    {
      elements: { Sun: 1, Water: 2 },
      effect: "Push 1 Explorer/Town"
    },
    {
      elements: { Sun: 2, Water: 3 },
      effect: "2 Damage; Push up to 3 Explorers/Towns"
    },
    {
      elements: { Sun: 3, Water: 4, Earth: 1 },
      effect: "2 Damage to each Invader"
    }
  ]
}
```

### Responsive Sidebar Layout
```typescript
// Source: Tailwind responsive design patterns
<main className="p-4 lg:grid lg:grid-cols-[1fr_320px] lg:gap-6">
  {/* Main content - full width on mobile, left column on desktop */}
  <div className="space-y-6">
    <GrowthPanel growth={spirit.growth} />
    <PresenceTrack presenceTracks={spirit.presenceTracks} />
    <InnatePowers innates={spirit.innates} />
    <CardHand uniquePowers={spirit.uniquePowers} />
  </div>

  {/* Sidebar - collapsible on mobile, sticky on desktop */}
  <aside className="lg:sticky lg:top-20 lg:self-start">
    <Collapsible defaultOpen={false} className="lg:hidden">
      <CollapsibleTrigger className="w-full flex justify-between items-center py-2">
        <span>Overview</span>
        <ChevronDown className="h-4 w-4" />
      </CollapsibleTrigger>
      <CollapsibleContent>
        <OverviewSection spirit={spirit} />
      </CollapsibleContent>
    </Collapsible>
    {/* Desktop: always visible */}
    <div className="hidden lg:block">
      <OverviewSection spirit={spirit} />
    </div>
  </aside>
</main>
```

### Tab Gradient Highlight (No Rounded Corners)
```typescript
// Fix variant-tabs.tsx styling
<TabsTrigger
  className={cn(
    "min-w-fit min-h-[44px] shrink-0 cursor-pointer",
    "rounded-none",  // Remove shadcn default rounding
    "data-[state=active]:bg-gradient-to-b",
    "data-[state=active]:from-primary/20",
    "data-[state=active]:to-primary/5",
    "data-[state=active]:border-b-2",
    "data-[state=active]:border-primary"
  )}
>
  {/* "Base" for base spirit, aspect name for aspects */}
  {isBase ? "Base" : aspectName}
</TabsTrigger>
```

### Presence Slot Gradient Backgrounds
```typescript
// Source: Tailwind CSS gradient patterns
// Three variations for track backgrounds
const trackGradients = {
  amber: "bg-gradient-to-r from-amber-500/10 via-amber-500/5 to-transparent",
  blue: "bg-gradient-to-r from-blue-500/10 via-blue-500/5 to-transparent",
  purple: "bg-gradient-to-r from-purple-500/10 via-purple-500/5 to-transparent",
};

// Slot styling with pointer cursor
<button
  className={cn(
    "w-11 h-11 min-w-[44px] min-h-[44px] rounded-full",
    "border-2 flex items-center justify-center",
    "cursor-pointer",  // Changed from cursor-default
    "hover:bg-muted hover:border-primary/50",
    // ... other styles
  )}
>
```

### External Links Consistent with Credits Page
```typescript
// Match credits page SourceLink component styling
function ResourceLink({ href, label, description }: ResourceLinkProps) {
  return (
    <a
      href={href}
      target="_blank"
      rel="noopener noreferrer"
      className="flex items-start gap-3 p-3 rounded-lg bg-card border border-border hover:bg-muted/50 transition-colors"
    >
      <div className="flex-1">
        <div className="flex items-center gap-2">
          <span className="font-medium text-foreground">{label}</span>
          <ExternalLink className="h-3 w-3 text-muted-foreground" />
        </div>
        <p className="text-sm text-muted-foreground mt-0.5">{description}</p>
      </div>
    </a>
  );
}
// Remove "Links open in a new tab" hint text
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Text element badges | SVG icon components | Spirit Island digital (2020+) | Visual fidelity to board game |
| Flat string effects | Typed DSL with inline icons | Fan tool community (2022+) | Consistent parsing, better UX |
| Fixed 2-track presence | Dynamic track array | Branch & Claw expansion (2018) | Complex spirits require flexibility |
| CSS variable chart colors | Explicit oklch colors | Dark mode adoption | Chart visibility on all backgrounds |

**Deprecated/outdated:**
- Using `hsl(var(--primary))` in Recharts: Low contrast on dark mode, use explicit oklch values
- TabsTrigger `rounded-md` from shadcn defaults: Spirit Island tabs should have flat edges for tab bar feel
- Growth "Top/Bottom" grouping: Replace with flat G1/G2/G3 array matching game mechanics

## Open Questions

Things that couldn't be fully resolved:

1. **Element SVG Paths**
   - What we know: Official icons exist in wiki and fan templates, 8 elements needed
   - What's unclear: Exact SVG path data for each icon, licensing for official assets
   - Recommendation: Create simplified geometric icons inspired by official style, or extract from Gudradain/spirit-island-template (MIT licensed)

2. **Game Term Icons (Dahan, Explorer, Town, City)**
   - What we know: Would enhance effect text readability
   - What's unclear: Whether to include in Phase 3.1 or defer
   - Recommendation: Defer to Phase 3.2 - focus on element icons first, game terms are optional enhancement

3. **Innate Range DSL Complexity**
   - What we know: Range can be numeric, "Sacred Site", "Sacred Site + 1", "Any Spirit"
   - What's unclear: Full enumeration of all range types across all spirits
   - Recommendation: Start with union type, add variants as discovered during data entry

4. **Serpent Deep Slumber Track Visual**
   - What we know: Needs separate track with presence limit (5-13), uses Absorb Essence mechanic
   - What's unclear: Best visual treatment to distinguish from normal tracks
   - Recommendation: Use purple gradient, "Deep Slumber" label, implement when adding Serpent data

## Sources

### Primary (HIGH confidence)
- Recharts PolarGrid API: https://recharts.github.io/en-US/api/PolarGrid/
- Spirit Island Wiki - River Surges in Sunlight: https://spiritislandwiki.com/index.php?title=River_Surges_in_Sunlight
- Spirit Island Wiki - Serpent Slumbering Beneath the Island: https://spiritislandwiki.com/index.php?title=Serpent_Slumbering_Beneath_the_Island
- Spirit Island Wiki - Elements: https://spiritislandwiki.com/index.php?title=Elements
- Spirit Island Wiki - Targeting: https://spiritislandwiki.com/index.php?title=Targeting
- Existing codebase: `/Users/florin/personal/the-dahan-codex/convex/schema.ts`, `seed.ts`, component files

### Secondary (MEDIUM confidence)
- Recharts GitHub Issues #3745, #109 - PolarGrid customization
- Spirit Island template project (MIT): https://github.com/Gudradain/spirit-island-template
- DEV Community - React SVG best practices: https://dev.to/seanyasno/handling-icons-in-react-best-practices-22c5
- shadcn/ui Radar Charts: https://ui.shadcn.com/charts/radar

### Tertiary (LOW confidence)
- BoardGameGeek strategy threads - Growth option naming conventions
- Steam community guides for River/Lightning strategy

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - Using existing project libraries, no new dependencies
- Architecture: HIGH - Patterns well-established (discriminated unions, SVG components, Tailwind responsive)
- Schema redesign: MEDIUM - Based on wiki analysis, may discover edge cases during implementation
- Pitfalls: HIGH - Identified from UAT feedback and existing code analysis
- Recharts API: HIGH - Verified via official docs (PolarGrid gridType, polarRadius)

**Research date:** 2026-01-26
**Valid until:** 2026-02-26 (30 days - stable domain, game data doesn't change)
