---
phase: 04-pwa-offline
plan: 04
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - app/routes/__root.tsx
  - app/components/layout/bottom-nav.tsx
  - app/lib/sw-register.ts
autonomous: true

must_haves:
  truths:
    - "OfflineIndicator renders in root layout"
    - "UpdateBanner renders when SW update is waiting"
    - "InstallPrompt renders after app loads"
    - "Settings tab is enabled in bottom navigation"
    - "App uses workbox-window for SW registration"
  artifacts:
    - path: "app/routes/__root.tsx"
      provides: "Root layout with PWA components integrated"
      contains: "OfflineIndicator"
    - path: "app/components/layout/bottom-nav.tsx"
      provides: "Bottom navigation with Settings enabled"
      contains: "disabled: false"
  key_links:
    - from: "app/routes/__root.tsx"
      to: "app/components/pwa/"
      via: "component imports"
      pattern: "import.*pwa"
    - from: "app/routes/__root.tsx"
      to: "app/hooks/use-service-worker.ts"
      via: "useServiceWorker hook"
      pattern: "useServiceWorker"
---

<objective>
Integrate PWA components into the app root and enable Settings navigation.

Purpose: Wire up all PWA components so users see offline status, update prompts, and install banners. Enable the Settings tab in navigation so users can access cache management.

Output:
- PWA components integrated into __root.tsx
- Settings tab enabled in bottom-nav.tsx
- SW registration uses workbox-window via useServiceWorker hook
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-pwa-offline/04-CONTEXT.md
@.planning/phases/04-pwa-offline/04-01-SUMMARY.md
@.planning/phases/04-pwa-offline/04-02-SUMMARY.md
@.planning/phases/04-pwa-offline/04-03-SUMMARY.md
@app/routes/__root.tsx
@app/components/layout/bottom-nav.tsx
@app/lib/sw-register.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate PWA components into root layout</name>
  <files>
    app/routes/__root.tsx
    app/lib/sw-register.ts
  </files>
  <action>
    1. Update app/routes/__root.tsx:
       - Import PWA components:
         ```typescript
         import { OfflineIndicator } from "../components/pwa/offline-indicator";
         import { UpdateBanner } from "../components/pwa/update-banner";
         import { InstallPrompt } from "../components/pwa/install-prompt";
         import { useServiceWorker } from "../hooks/use-service-worker";
         ```
       - Remove old registerSW import and useEffect call (replaced by useServiceWorker)
       - Inside RootComponent, call useServiceWorker hook:
         ```typescript
         const { isUpdateAvailable, triggerUpdate } = useServiceWorker();
         ```
       - Add PWA components inside ConvexProviderWithClerk, before Outlet:
         ```tsx
         <ConvexProviderWithClerk client={convexClient} useAuth={useAuth}>
           <OfflineIndicator />
           {isUpdateAvailable && <UpdateBanner onReload={triggerUpdate} />}
           <InstallPrompt />
           <Outlet />
           <BottomNav />
         </ConvexProviderWithClerk>
         ```

    2. Keep sw-register.ts for now but mark as deprecated:
       - Add comment at top: // DEPRECATED: SW registration moved to useServiceWorker hook
       - File can be deleted in future cleanup
  </action>
  <verify>
    App loads with PWA components rendered, no console errors
  </verify>
  <done>
    PWA components visible in DOM, SW registration via useServiceWorker
  </done>
</task>

<task type="auto">
  <name>Task 2: Enable Settings tab in bottom navigation</name>
  <files>app/components/layout/bottom-nav.tsx</files>
  <action>
    Update app/components/layout/bottom-nav.tsx:

    1. Find the Settings tab definition in the tabs array
    2. Change disabled: true to disabled: false
    3. Update the to prop type assertion if needed (settings route now exists)

    Before:
    ```typescript
    {
      name: "Settings",
      href: "/settings",
      icon: Settings,
      matchPattern: /^\/settings/,
      disabled: true, // Future
    },
    ```

    After:
    ```typescript
    {
      name: "Settings",
      href: "/settings",
      icon: Settings,
      matchPattern: /^\/settings/,
      disabled: false,
    },
    ```

    4. Update the Link component's to prop type to include "/settings":
       ```typescript
       to={tab.href as "/spirits" | "/settings"}
       ```
  </action>
  <verify>
    Settings tab is clickable and navigates to /settings
  </verify>
  <done>
    Settings tab enabled, clicking navigates to settings page
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm dev` - app loads without errors
3. OfflineIndicator visible only when browser is offline (DevTools Network > Offline)
4. Settings tab clickable, navigates to /settings
5. Console shows service worker registration via workbox-window
</verification>

<success_criteria>
- OfflineIndicator, UpdateBanner (conditional), InstallPrompt integrated into root
- Settings tab enabled and navigates to settings page
- SW registration handled by useServiceWorker hook (not old registerSW)
- No TypeScript or runtime errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-pwa-offline/04-04-SUMMARY.md`
</output>
