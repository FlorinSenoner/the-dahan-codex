---
phase: 04-pwa-offline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - pnpm-lock.yaml
  - scripts/generate-sw.ts
  - app/hooks/use-online-status.ts
  - app/hooks/use-service-worker.ts
  - app/hooks/use-install-prompt.ts
autonomous: true

must_haves:
  truths:
    - "useOnlineStatus returns current navigator.onLine state"
    - "useServiceWorker detects when SW update is waiting"
    - "useInstallPrompt captures beforeinstallprompt event on Chromium"
    - "useInstallPrompt detects iOS for manual instructions"
    - "Service worker navigateFallback returns index.html for SPA routes"
  artifacts:
    - path: "app/hooks/use-online-status.ts"
      provides: "Online status hook using useSyncExternalStore"
      exports: ["useOnlineStatus"]
    - path: "app/hooks/use-service-worker.ts"
      provides: "Service worker update detection and control"
      exports: ["useServiceWorker"]
    - path: "app/hooks/use-install-prompt.ts"
      provides: "Install prompt handling with iOS detection"
      exports: ["useInstallPrompt"]
  key_links:
    - from: "scripts/generate-sw.ts"
      to: "dist/sw.js"
      via: "workbox-build generateSW"
      pattern: "navigateFallback.*index\\.html"
---

<objective>
Set up PWA hooks and enhance service worker configuration for offline support.

Purpose: Establish the foundation for offline status tracking, service worker update coordination, and install prompt handling. These hooks will be consumed by PWA UI components in subsequent plans.

Output:
- workbox-window installed
- generate-sw.ts enhanced with navigateFallback for SPA
- Three custom hooks: use-online-status, use-service-worker, use-install-prompt
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pwa-offline/04-RESEARCH.md
@scripts/generate-sw.ts
@app/lib/sw-register.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add workbox-window and enhance generate-sw.ts</name>
  <files>
    package.json
    pnpm-lock.yaml
    scripts/generate-sw.ts
  </files>
  <action>
    1. Install workbox-window:
       ```bash
       pnpm add workbox-window
       ```

    2. Update scripts/generate-sw.ts to add:
       - navigateFallback: "/index.html" for SPA client-side routing
       - navigateFallbackDenylist: [/^\/api\//, /\.[^/]+$/] to exclude API calls and files with extensions
       - Keep existing skipWaiting: false and clientsClaim: false settings
       - Keep existing runtimeCaching rules

    3. Verify generateSW configuration supports message handler for SKIP_WAITING (workbox-build adds this automatically when skipWaiting: false)
  </action>
  <verify>
    Run `pnpm build` and check dist/sw.js exists with navigateFallback reference
  </verify>
  <done>
    workbox-window in package.json, generate-sw.ts has navigateFallback configured
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PWA hooks</name>
  <files>
    app/hooks/use-online-status.ts
    app/hooks/use-service-worker.ts
    app/hooks/use-install-prompt.ts
  </files>
  <action>
    1. Create app/hooks/ directory if it doesn't exist

    2. Create app/hooks/use-online-status.ts:
       - Use useSyncExternalStore from React for concurrency-safe online status
       - Subscribe to window 'online' and 'offline' events
       - getSnapshot returns navigator.onLine
       - getServerSnapshot returns true (assume online during SSR)
       - Export useOnlineStatus hook returning boolean

    3. Create app/hooks/use-service-worker.ts:
       - Use workbox-window Workbox class for SW coordination
       - Manage state: isUpdateAvailable (boolean), registration (ServiceWorkerRegistration | null)
       - Listen for 'waiting' event to detect new SW ready
       - Listen for 'controlling' event to reload after update
       - Provide messageSkipWaiting function to trigger update
       - Handle dev mode (skip registration when import.meta.env.DEV)
       - Return { isUpdateAvailable, triggerUpdate }

    4. Create app/hooks/use-install-prompt.ts:
       - Define BeforeInstallPromptEvent interface with prompt() and userChoice
       - Track deferredPrompt, isInstallable, isIOS, isStandalone states
       - Detect iOS via /iPad|iPhone|iPod/.test(navigator.userAgent)
       - Detect standalone via matchMedia('(display-mode: standalone)') or navigator.standalone (iOS)
       - Listen for 'beforeinstallprompt' event and prevent default
       - Provide promptInstall async function that calls deferredPrompt.prompt()
       - Return { isInstallable, isIOS, isStandalone, promptInstall }
  </action>
  <verify>
    Run `pnpm typecheck` - no TypeScript errors in new hook files
  </verify>
  <done>
    Three hooks created with proper TypeScript types, useSyncExternalStore pattern for online status, workbox-window integration for SW updates
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds and dist/sw.js contains navigateFallback
2. `pnpm typecheck` passes with no errors
3. All three hooks export their intended functions
</verification>

<success_criteria>
- workbox-window installed as dependency
- generate-sw.ts has navigateFallback: "/index.html"
- useOnlineStatus hook uses useSyncExternalStore pattern
- useServiceWorker hook uses workbox-window Workbox class
- useInstallPrompt hook handles beforeinstallprompt and iOS detection
</success_criteria>

<output>
After completion, create `.planning/phases/04-pwa-offline/04-01-SUMMARY.md`
</output>
