---
phase: 04-pwa-offline
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - app/router.tsx
  - package.json
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "TanStack Query data persists across page reloads"
    - "IndexedDB stores cached query data"
    - "Downloaded data is available after browser restart"
  artifacts:
    - path: "app/router.tsx"
      provides: "Query persistence configuration"
      contains: "persistQueryClient"
    - path: "package.json"
      provides: "Persistence dependencies"
      contains: "idb-keyval"
  key_links:
    - from: "app/router.tsx"
      to: "idb-keyval"
      via: "IndexedDB storage adapter"
      pattern: "createIDBPersister"
---

<objective>
Add TanStack Query persistence to IndexedDB for offline data availability

Purpose: Currently, downloaded data only populates memory. When the user reloads or closes the browser, cached data is lost. IndexedDB persistence enables true offline access to previously synced data.

Output: Query data persists to IndexedDB and survives browser restarts
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@app/router.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install persistence dependencies</name>
  <files>package.json</files>
  <action>
Install the required packages for TanStack Query persistence:

```bash
pnpm add @tanstack/query-persist-client-core idb-keyval
```

These packages provide:
- `@tanstack/query-persist-client-core`: Core persistence utilities for TanStack Query
- `idb-keyval`: Simple IndexedDB wrapper for key-value storage

Note: Do NOT install `@tanstack/react-query-persist-client` - that's the React wrapper which uses `PersistQueryClientProvider`. We need the core package to work with Convex's setup pattern.
  </action>
  <verify>
Run `pnpm install` and verify packages are in node_modules.
Check package.json has the new dependencies.
  </verify>
  <done>
@tanstack/query-persist-client-core and idb-keyval are installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create IndexedDB persister and configure QueryClient</name>
  <files>app/router.tsx</files>
  <action>
Configure query persistence in router.tsx:

1. Add imports at top:
   ```tsx
   import { persistQueryClient } from "@tanstack/query-persist-client-core";
   import { get, set, del } from "idb-keyval";
   ```

2. Create IDB persister function (before createRouter):
   ```tsx
   // IndexedDB persister for TanStack Query
   function createIDBPersister(idbKey = "tanstack-query-cache") {
     return {
       persistClient: async (client: PersistedClient) => {
         await set(idbKey, client);
       },
       restoreClient: async () => {
         return await get<PersistedClient>(idbKey);
       },
       removeClient: async () => {
         await del(idbKey);
       },
     };
   }
   ```

3. Add type import for PersistedClient:
   ```tsx
   import type { PersistedClient } from "@tanstack/query-persist-client-core";
   ```

4. Update QueryClient configuration with longer cache times:
   ```tsx
   const queryClient = new QueryClient({
     defaultOptions: {
       queries: {
         queryKeyHashFn: convexQueryClient.hashFn(),
         queryFn: convexQueryClient.queryFn(),
         // Keep data fresh for 5 minutes
         staleTime: 1000 * 60 * 5,
         // Keep data in cache for 7 days (for offline access)
         gcTime: 1000 * 60 * 60 * 24 * 7,
       },
     },
   });
   ```

5. Setup persistence after creating queryClient (inside createRouter, after convexQueryClient.connect):
   ```tsx
   convexQueryClient.connect(queryClient);

   // Setup IndexedDB persistence for offline access
   const persister = createIDBPersister();
   persistQueryClient({
     queryClient,
     persister,
     // Max age matches gcTime (7 days)
     maxAge: 1000 * 60 * 60 * 24 * 7,
     // Dehydrate options to control what gets persisted
     dehydrateOptions: {
       shouldDehydrateQuery: (query) => {
         // Only persist successful queries
         return query.state.status === "success";
       },
     },
   });
   ```

6. The persistence setup is async but we don't need to await it - it will restore data in the background when the app loads.
  </action>
  <verify>
Run `pnpm typecheck` to verify no type errors.
Run `pnpm build` to verify build succeeds.
Manual test: Sync data in settings, close browser, reopen - data should load from IndexedDB.
  </verify>
  <done>
QueryClient is configured with 7-day gcTime and IndexedDB persistence via idb-keyval. Cached data survives browser restarts.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes
- `pnpm build` succeeds
- IndexedDB persister function compiles correctly
- QueryClient has staleTime and gcTime configured
</verification>

<success_criteria>
- @tanstack/query-persist-client-core and idb-keyval installed
- QueryClient gcTime set to 7 days
- IndexedDB persister created and connected
- persistQueryClient called with proper dehydration options
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-pwa-offline/04-08-SUMMARY.md`
</output>
