---
phase: 04-pwa-offline
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/routes/settings.tsx
autonomous: true

must_haves:
  truths:
    - "Settings page renders at /settings route"
    - "Settings page has Download for Offline button that fetches all spirits"
    - "Settings page has Refresh Data button that clears API cache"
    - "Settings page has Clear Cache button that clears all caches"
    - "Cache management buttons show feedback when clicked"
  artifacts:
    - path: "app/routes/settings.tsx"
      provides: "Settings page with cache management and offline download"
      exports: ["Route"]
  key_links:
    - from: "app/routes/settings.tsx"
      to: "caches API"
      via: "caches.delete calls"
      pattern: "caches\\.delete"
    - from: "app/routes/settings.tsx"
      to: "convex/spirits"
      via: "preloadQuery for offline precaching"
      pattern: "useQuery.*spirits"
---

<objective>
Create settings page with cache management and offline download functionality.

Purpose: Enable users to proactively download reference data for offline use (PWA-04), manually refresh data, or clear all cached content when troubleshooting offline issues. The settings page also serves as the home for future app configuration.

Output:
- Settings route at /settings with Download for Offline, Refresh Data, and Clear Cache buttons
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-pwa-offline/04-CONTEXT.md
@.planning/phases/04-pwa-offline/04-RESEARCH.md
@app/routes/__root.tsx
@app/routes/credits.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create settings route</name>
  <files>app/routes/settings.tsx</files>
  <action>
    Create app/routes/settings.tsx:

    1. Create route using createFileRoute("/settings"):
       ```typescript
       import { createFileRoute } from "@tanstack/react-router";
       export const Route = createFileRoute("/settings")({
         component: SettingsPage,
       });
       ```

    2. SettingsPage component structure:
       - Container: max-w-lg mx-auto p-4 pb-24 (room for bottom nav)
       - Title: "Settings" (h1, text-2xl font-bold)
       - Section: "Offline Access" (h2, text-lg font-semibold, mt-6)
       - Subsection: "Download for Offline" with description and button
       - Section: "Cache Management" (h2, text-lg font-semibold, mt-6)
       - Description: Explain what cache management does

    3. State management:
       - isDownloading: boolean for Download for Offline button loading state
       - downloadProgress: string for progress feedback (e.g., "Loading spirits...")
       - isRefreshing: boolean for Refresh Data button loading state
       - isClearing: boolean for Clear Cache button loading state

    4. Download for Offline function (PWA-04 - proactive precaching):
       ```typescript
       import { useConvex } from "convex/react";
       import { api } from "../../convex/_generated/api";

       const convex = useConvex();

       async function downloadForOffline() {
         setIsDownloading(true);
         try {
           // Fetch all spirits to populate Convex cache
           setDownloadProgress("Loading spirits...");
           const spirits = await convex.query(api.spirits.list);

           // Fetch each spirit's detail data (triggers cache population)
           setDownloadProgress(`Loading spirit details (0/${spirits.length})...`);
           for (let i = 0; i < spirits.length; i++) {
             await convex.query(api.spirits.getBySlug, { slug: spirits[i].slug });
             setDownloadProgress(`Loading spirit details (${i + 1}/${spirits.length})...`);
           }

           // Fetch all openings
           setDownloadProgress("Loading openings...");
           await convex.query(api.openings.list);

           setDownloadProgress("Download complete!");
           // Show success toast or message
         } catch (error) {
           console.error("Failed to download for offline:", error);
           setDownloadProgress("Download failed. Check your connection.");
         } finally {
           setIsDownloading(false);
         }
       }
       ```

       Note: Convex uses WebSocket and caches query results client-side. This user-initiated
       download triggers all queries to populate the local cache, enabling offline access.
       The service worker's stale-while-revalidate strategy will serve this cached data offline.

    5. Refresh Data function:
       ```typescript
       async function refreshData() {
         setIsRefreshing(true);
         try {
           await caches.delete("convex-api-cache");
           window.location.reload();
         } catch (error) {
           console.error("Failed to refresh data:", error);
           setIsRefreshing(false);
         }
       }
       ```

    6. Clear Cache function:
       ```typescript
       async function clearCache() {
         setIsClearing(true);
         try {
           const cacheNames = await caches.keys();
           await Promise.all(cacheNames.map(name => caches.delete(name)));
           // Unregister service worker to force full refresh
           const registration = await navigator.serviceWorker.getRegistration();
           if (registration) {
             await registration.unregister();
           }
           window.location.reload();
         } catch (error) {
           console.error("Failed to clear cache:", error);
           setIsClearing(false);
         }
       }
       ```

    7. Button styling:
       - Use existing Button component from @/components/ui/button if available, otherwise use styled button
       - Download for Offline: variant default/primary, shows progress text when loading
       - Refresh Data: variant outline, shows "Refreshing..." when loading
       - Clear Cache: variant destructive/red, shows "Clearing..." when loading
       - All buttons: w-full, disabled when loading

    8. Add description text explaining each action:
       - Download for Offline: "Download all spirit data and openings for offline use. Required for full offline access."
       - Refresh Data: "Fetch fresh data while keeping app files cached"
       - Clear Cache: "Remove all cached data and app files. Useful if something seems broken."
  </action>
  <verify>
    Route exists and renders at /settings, all three buttons trigger their operations
  </verify>
  <done>
    Settings page with working Download for Offline, Refresh Data, and Clear Cache buttons
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. Navigate to /settings in dev mode - page renders
3. Download for Offline button fetches all spirits and shows progress
4. Buttons show loading state when clicked
5. Clear Cache triggers SW unregister and reload
</verification>

<success_criteria>
- /settings route renders settings page
- Download for Offline button fetches all spirit data via Convex queries (PWA-04)
- Refresh Data button clears convex-api-cache and reloads
- Clear Cache button clears all caches, unregisters SW, and reloads
- Loading states prevent double-clicks
</success_criteria>

<output>
After completion, create `.planning/phases/04-pwa-offline/04-03-SUMMARY.md`
</output>
