---
phase: 04-pwa-offline
plan: 09
type: execute
wave: 2
depends_on:
  - "04-08"
files_modified:
  - scripts/generate-sw.ts
  - app/routes/spirits.$slug.tsx
  - app/routes/spirits.$slug.$aspect.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Spirit pages gracefully handle offline state with cached data"
    - "Service worker config has no dead code for WebSocket caching"
    - "Users can access previously synced spirits without network"
  artifacts:
    - path: "scripts/generate-sw.ts"
      provides: "Clean service worker config without ineffective Convex rule"
    - path: "app/routes/spirits.$slug.tsx"
      provides: "Offline-aware spirit page"
  key_links:
    - from: "app/routes/spirits.$slug.tsx"
      to: "TanStack Query cache"
      via: "useSuspenseQuery with cached data"
      pattern: "useSuspenseQuery"
---

<objective>
Remove ineffective service worker rules and ensure spirit pages work offline with cached data

Purpose: The convex-api-cache service worker rule is ineffective because Convex uses WebSockets, not HTTP. With TanStack Query persistence (04-08), offline data comes from IndexedDB. Clean up dead code and document the offline architecture.

Output: Clean service worker config, offline-resilient spirit pages
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@scripts/generate-sw.ts
@app/routes/spirits.$slug.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove ineffective Convex runtime caching rule from service worker</name>
  <files>scripts/generate-sw.ts</files>
  <action>
Clean up the service worker configuration:

1. Remove the convex-api-cache runtime caching rule:
   ```tsx
   // REMOVE this entire block - Convex uses WebSockets, not HTTP
   {
     urlPattern: /^https:\/\/.*\.convex\.cloud/,
     handler: "NetworkFirst",
     options: {
       cacheName: "convex-api-cache",
       expiration: {
         maxAgeSeconds: 60 * 60 * 24,
         maxEntries: 100,
       },
       networkTimeoutSeconds: 10,
     },
   },
   ```

2. Keep the external images caching rule - this is still useful:
   ```tsx
   {
     urlPattern: /^https:\/\/.*\.(png|jpg|jpeg|svg|gif|webp)$/,
     handler: "CacheFirst",
     options: {
       cacheName: "image-cache",
       expiration: {
         maxAgeSeconds: 60 * 60 * 24 * 30,
         maxEntries: 200,
       },
     },
   },
   ```

3. Add a comment explaining the offline architecture:
   ```tsx
   // Runtime caching rules
   // Note: Convex data is cached via TanStack Query persistence to IndexedDB,
   // not via service worker (Convex uses WebSockets, not HTTP)
   runtimeCaching: [
     {
       // Cache external images (spirit images are local in public/)
       urlPattern: /^https:\/\/.*\.(png|jpg|jpeg|svg|gif|webp)$/,
       handler: "CacheFirst",
       options: {
         cacheName: "image-cache",
         expiration: {
           maxAgeSeconds: 60 * 60 * 24 * 30, // 30 days
           maxEntries: 200,
         },
       },
     },
   ],
   ```
  </action>
  <verify>
Run `pnpm build` to regenerate the service worker.
Verify sw.js in dist/ does not contain convex-api-cache.
  </verify>
  <done>
Service worker config no longer contains ineffective Convex caching rule. Comment explains offline data comes from TanStack Query/IndexedDB.
  </done>
</task>

<task type="auto">
  <name>Task 2: Document offline behavior - no code changes needed for spirit pages</name>
  <files>app/routes/spirits.$slug.tsx</files>
  <action>
Review and document (no code changes required):

The spirit detail pages use `useSuspenseQuery` with TanStack Query. With the persistence added in 04-08:

1. **Online flow:**
   - useSuspenseQuery fetches from Convex WebSocket
   - Data is cached in TanStack Query
   - persistQueryClient saves to IndexedDB

2. **Offline flow with synced data:**
   - useSuspenseQuery finds data in TanStack Query cache (restored from IndexedDB)
   - Page renders immediately from cache
   - Convex WebSocket fails silently (query already has data)

3. **Offline flow WITHOUT synced data:**
   - useSuspenseQuery has no cached data
   - Query suspends waiting for Convex response
   - Convex WebSocket fails to connect
   - User sees loading state indefinitely (or error boundary if one exists)

For this plan, we are NOT adding offline error handling for unsynced data. The user must sync data first via Settings > Sync Data. This is documented behavior.

Add a comment at the top of the file documenting this:
```tsx
/**
 * Spirit detail page
 *
 * Offline behavior: This page works offline for spirits that have been
 * synced via Settings > Sync Data. Without prior sync, the page will
 * show a loading state while waiting for Convex connection.
 */
```

Also add same comment to spirits.$slug.$aspect.tsx.
  </action>
  <verify>
Run `pnpm typecheck` to verify no errors introduced.
  </verify>
  <done>
Spirit pages documented for offline behavior. No code changes needed - persistence from 04-08 handles offline data access automatically for synced spirits.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update settings page clearCache to also clear IndexedDB</name>
  <files>app/routes/settings.tsx</files>
  <action>
Update the clearCache function to also clear the IndexedDB persisted query cache:

1. Add import at top:
   ```tsx
   import { del } from "idb-keyval";
   ```

2. Update clearCache function to clear IndexedDB:
   ```tsx
   async function clearCache() {
     setIsClearing(true);
     try {
       // Delete TanStack Query IndexedDB cache
       await del("tanstack-query-cache");

       // Delete all service worker caches
       const cacheNames = await caches.keys();
       await Promise.all(cacheNames.map((name) => caches.delete(name)));

       // Unregister service worker to force full refresh
       const registration = await navigator.serviceWorker.getRegistration();
       if (registration) {
         await registration.unregister();
       }

       window.location.reload();
     } catch (error) {
       console.error("Failed to clear cache:", error);
       setIsClearing(false);
     }
   }
   ```

This ensures "Clear Cache" truly clears everything - both the service worker cache and the IndexedDB query persistence.
  </action>
  <verify>
Run `pnpm typecheck` and `pnpm build` to verify no errors.
Manual test: Sync data, verify it persists after reload, then Clear Cache - data should be gone.
  </verify>
  <done>
clearCache function now clears IndexedDB TanStack Query cache in addition to service worker caches.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes
- `pnpm build` succeeds
- Service worker no longer has convex-api-cache rule
- Spirit pages have offline behavior documented
- clearCache clears IndexedDB persistence
</verification>

<success_criteria>
- convex-api-cache runtime caching rule removed from generate-sw.ts
- Comment added explaining offline architecture (TanStack Query + IndexedDB)
- Spirit pages documented for offline behavior expectations
- clearCache includes IndexedDB deletion via idb-keyval del()
</success_criteria>

<output>
After completion, create `.planning/phases/04-pwa-offline/04-09-SUMMARY.md`
</output>
