---
phase: 04-pwa-offline
plan: 09
type: execute
wave: 2
depends_on:
  - "04-08"
files_modified:
  - scripts/generate-sw.ts
  - app/routes/spirits.$slug.tsx
  - app/routes/spirits.$slug.$aspect.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Spirit pages gracefully handle offline state with cached data"
    - "Service worker config has no dead code for WebSocket caching"
    - "Users can access previously synced spirits without network"
  artifacts:
    - path: "scripts/generate-sw.ts"
      provides: "Clean service worker config without ineffective Convex rule"
    - path: "app/routes/spirits.$slug.tsx"
      provides: "Offline-aware spirit page with documentation"
  key_links:
    - from: "app/routes/spirits.$slug.tsx"
      to: "TanStack Query cache"
      via: "useSuspenseQuery with cached data"
      pattern: "useSuspenseQuery"
---

<objective>
Remove ineffective service worker rules and document spirit page offline behavior

Purpose: The convex-api-cache service worker rule is ineffective because Convex uses WebSockets, not HTTP. With TanStack Query persistence (04-08), offline data comes from IndexedDB. Clean up dead code and document the offline architecture.

Output: Clean service worker config, documented offline-resilient spirit pages
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@scripts/generate-sw.ts
@app/routes/spirits.$slug.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove ineffective Convex runtime caching rule from service worker</name>
  <files>scripts/generate-sw.ts</files>
  <action>
Clean up the service worker configuration:

1. Remove the convex-api-cache runtime caching rule:
   ```tsx
   // REMOVE this entire block - Convex uses WebSockets, not HTTP
   {
     urlPattern: /^https:\/\/.*\.convex\.cloud/,
     handler: "NetworkFirst",
     options: {
       cacheName: "convex-api-cache",
       expiration: {
         maxAgeSeconds: 60 * 60 * 24,
         maxEntries: 100,
       },
       networkTimeoutSeconds: 10,
     },
   },
   ```

2. Keep the external images caching rule - this is still useful:
   ```tsx
   {
     urlPattern: /^https:\/\/.*\.(png|jpg|jpeg|svg|gif|webp)$/,
     handler: "CacheFirst",
     options: {
       cacheName: "image-cache",
       expiration: {
         maxAgeSeconds: 60 * 60 * 24 * 30,
         maxEntries: 200,
       },
     },
   },
   ```

3. Add a comment explaining the offline architecture:
   ```tsx
   // Runtime caching rules
   // Note: Convex data is cached via TanStack Query persistence to IndexedDB,
   // not via service worker (Convex uses WebSockets, not HTTP)
   runtimeCaching: [
     {
       // Cache external images (spirit images are local in public/)
       urlPattern: /^https:\/\/.*\.(png|jpg|jpeg|svg|gif|webp)$/,
       handler: "CacheFirst",
       options: {
         cacheName: "image-cache",
         expiration: {
           maxAgeSeconds: 60 * 60 * 24 * 30, // 30 days
           maxEntries: 200,
         },
       },
     },
   ],
   ```
  </action>
  <verify>
Run `pnpm build` to regenerate the service worker.
Verify sw.js in dist/ does not contain convex-api-cache.
  </verify>
  <done>
Service worker config no longer contains ineffective Convex caching rule. Comment explains offline data comes from TanStack Query/IndexedDB.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add offline behavior documentation to spirit pages</name>
  <files>app/routes/spirits.$slug.tsx, app/routes/spirits.$slug.$aspect.tsx</files>
  <action>
Add documentation comments to spirit detail pages explaining offline behavior:

1. Add a JSDoc comment at the top of spirits.$slug.tsx (after imports, before component):
   ```tsx
   /**
    * Spirit detail page
    *
    * Offline behavior: This page works offline for spirits that have been
    * synced via Settings > Sync Data. Without prior sync, the page will
    * show a loading state while waiting for Convex connection.
    */
   ```

2. Add the same JSDoc comment to spirits.$slug.$aspect.tsx.

These are documentation comments only - no functional code changes. The persistence from 04-08 handles offline data access automatically for synced spirits.

Note: This IS a code change (adding comments to source files), but no runtime behavior changes.
  </action>
  <verify>
Run `pnpm typecheck` to verify no errors introduced.
Run `pnpm build` to verify build succeeds.
  </verify>
  <done>
Spirit pages have JSDoc comments documenting offline behavior expectations.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes
- `pnpm build` succeeds
- Service worker no longer has convex-api-cache rule
- Spirit pages have offline behavior documented in JSDoc comments
</verification>

<success_criteria>
- convex-api-cache runtime caching rule removed from generate-sw.ts
- Comment added explaining offline architecture (TanStack Query + IndexedDB)
- Spirit pages have JSDoc documentation for offline behavior expectations
</success_criteria>

<output>
After completion, create `.planning/phases/04-pwa-offline/04-09-SUMMARY.md`
</output>
