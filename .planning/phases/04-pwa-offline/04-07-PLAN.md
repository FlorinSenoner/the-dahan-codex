---
phase: 04-pwa-offline
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - app/routes/settings.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Settings page has single Cache section with Sync Data button"
    - "Sync Data fetches all spirit data including aspects"
    - "Clear Cache remains as secondary/advanced option"
    - "Button styling is subtle (outline variant)"
  artifacts:
    - path: "app/routes/settings.tsx"
      provides: "Simplified settings page with Sync Data"
      contains: "syncData"
  key_links:
    - from: "app/routes/settings.tsx"
      to: "convex/spirits.ts"
      via: "getSpiritWithAspects query"
      pattern: "getSpiritWithAspects"
---

<objective>
Simplify Settings page cache management and fix aspect data fetching

Purpose: Three overlapping buttons (Download, Refresh, Clear) confuse users. The download function also misses aspect data. Consolidate to single "Sync Data" button.

Output: Simplified settings page with Sync Data button that fetches all data including aspects
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@app/routes/settings.tsx
@convex/spirits.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Consolidate sections and simplify button structure</name>
  <files>app/routes/settings.tsx</files>
  <action>
Restructure the settings page UI:

1. Remove the separate "Offline Access" section header

2. Keep single "Cache Management" section with:
   - Heading variant="h3": "Cache Management"
   - Description Text: "Sync spirit data for offline access or clear cached data if something seems broken."

3. Restructure buttons:
   - Primary: "Sync Data" button with RefreshCw icon (was Download + Refresh combined)
   - Secondary: "Clear Cache" button with Trash2 icon (keep as-is but use outline variant)

4. Change button variants:
   - Sync Data: `variant="outline"` (not default - more subtle)
   - Clear Cache: `variant="outline"` (not destructive - less alarming)

5. Remove Download icon import, keep RefreshCw and Trash2

6. Layout buttons side-by-side on larger screens:
   ```tsx
   <div className="mt-4 flex flex-col gap-3 sm:flex-row">
     <Button variant="outline" ...>Sync Data</Button>
     <Button variant="outline" ...>Clear Cache</Button>
   </div>
   ```

7. Update status text:
   - Remove text-green-500 coloring
   - Use text-muted-foreground for all status messages
  </action>
  <verify>
Visual check: Settings page shows single "Cache Management" section with two side-by-side buttons on desktop.
  </verify>
  <done>
Settings page has consolidated Cache Management section with Sync Data and Clear Cache buttons using outline variant styling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement syncData function that fetches all data including aspects</name>
  <files>app/routes/settings.tsx</files>
  <action>
Replace downloadForOffline and refreshData with single syncData function:

1. Remove state variables:
   - Remove `isDownloading` and `downloadProgress`
   - Remove `isRefreshing`
   - Keep `isClearing`
   - Add `isSyncing` and `syncStatus` for the new sync function

2. Create syncData async function:
   ```tsx
   async function syncData() {
     setIsSyncing(true);
     setSyncStatus("Loading spirits...");
     try {
       // Fetch all spirits
       const spirits = await convex.query(api.spirits.listSpirits, {});

       // Get unique base spirit slugs (filter out aspects)
       const baseSpiritSlugs = spirits
         .filter(s => !s.isAspect)
         .map(s => s.slug);

       // Fetch each base spirit AND its aspects via getSpiritWithAspects
       setSyncStatus(`Syncing spirits (0/${baseSpiritSlugs.length})...`);
       for (let i = 0; i < baseSpiritSlugs.length; i++) {
         // This fetches base spirit AND all its aspects in one query
         await convex.query(api.spirits.getSpiritWithAspects, {
           slug: baseSpiritSlugs[i],
         });
         setSyncStatus(`Syncing spirits (${i + 1}/${baseSpiritSlugs.length})...`);
       }

       // Also fetch individual spirit pages to cache getSpiritBySlug responses
       for (const spirit of spirits) {
         if (spirit.isAspect) {
           // For aspects, need to call with aspect parameter
           const baseSlug = spirits.find(s => s._id === spirit.baseSpirit)?.slug;
           if (baseSlug && spirit.aspectName) {
             await convex.query(api.spirits.getSpiritBySlug, {
               slug: baseSlug,
               aspect: spirit.aspectName,
             });
           }
         } else {
           await convex.query(api.spirits.getSpiritBySlug, {
             slug: spirit.slug,
           });
         }
       }

       // Fetch openings for each spirit
       setSyncStatus("Syncing openings...");
       for (const spirit of spirits) {
         await convex.query(api.openings.listBySpirit, { spiritId: spirit._id });
       }

       setSyncStatus("Sync complete!");
     } catch (error) {
       console.error("Failed to sync data:", error);
       setSyncStatus("Sync failed. Check your connection.");
     } finally {
       setIsSyncing(false);
     }
   }
   ```

3. Update button to use syncData:
   ```tsx
   <Button
     variant="outline"
     onClick={syncData}
     disabled={isSyncing || isClearing}
     className="flex-1"
   >
     <RefreshCw className={`h-4 w-4 ${isSyncing ? "animate-spin" : ""}`} />
     {isSyncing ? syncStatus || "Syncing..." : "Sync Data"}
   </Button>
   ```

4. Note on baseSpirit field: The listSpirits query returns items with `isAspect: boolean`. For aspects, `baseSpirit` is the ID reference. Need to find the base spirit's slug to call getSpiritBySlug with aspect parameter.
  </action>
  <verify>
Run `pnpm typecheck` to verify no type errors.
Test by clicking Sync Data - should show progress through all spirits including aspect queries.
  </verify>
  <done>
syncData function fetches all base spirits via getSpiritWithAspects (which includes aspects) and also caches individual getSpiritBySlug calls for both base spirits and aspects.
  </done>
</task>

<task type="auto">
  <name>Task 3: Clean up and finalize settings page</name>
  <files>app/routes/settings.tsx</files>
  <action>
Final cleanup:

1. Remove unused imports:
   - Remove `Download` from lucide-react imports

2. Ensure clearCache still works:
   - Keep existing clearCache function unchanged
   - Update disabled state: `disabled={isSyncing || isClearing}`

3. Status message display:
   - Show syncStatus below buttons when not null
   - Use text-muted-foreground for all status (no green/red coloring)
   - Clear status after 3 seconds on success:
   ```tsx
   // After "Sync complete!"
   setTimeout(() => setSyncStatus(null), 3000);
   ```

4. Final JSX structure:
   ```tsx
   <section className="mt-6">
     <Heading variant="h3" className="text-foreground">
       Cache Management
     </Heading>
     <Text variant="muted" className="mt-2">
       Sync spirit data for offline access or clear cached data if something seems broken.
     </Text>
     <div className="mt-4 flex flex-col gap-3 sm:flex-row">
       <Button variant="outline" onClick={syncData} disabled={isSyncing || isClearing} className="flex-1">
         <RefreshCw className={`h-4 w-4 ${isSyncing ? "animate-spin" : ""}`} />
         {isSyncing ? syncStatus || "Syncing..." : "Sync Data"}
       </Button>
       <Button variant="outline" onClick={clearCache} disabled={isSyncing || isClearing} className="flex-1">
         <Trash2 className="h-4 w-4" />
         {isClearing ? "Clearing..." : "Clear Cache"}
       </Button>
     </div>
     {syncStatus && !isSyncing && (
       <Text variant="small" className="mt-2 text-muted-foreground">
         {syncStatus}
       </Text>
     )}
   </section>
   ```
  </action>
  <verify>
Run `pnpm typecheck` and `pnpm build` to verify build succeeds.
E2E test: `pnpm test:e2e -- settings.spec.ts` should still pass.
  </verify>
  <done>
Settings page is simplified with single Cache Management section, Sync Data button that fetches all data including aspects, and subtle outline button styling.
  </done>
</task>

</tasks>

<verification>
- `pnpm typecheck` passes
- `pnpm build` succeeds
- `pnpm test:e2e -- settings.spec.ts` passes
- Settings page shows single section with two buttons
</verification>

<success_criteria>
- Single "Cache Management" section (no separate "Offline Access")
- Sync Data button fetches base spirits AND aspects via getSpiritWithAspects
- Both buttons use outline variant (subtle styling)
- Status messages use muted foreground color (no green/red)
- Buttons are side-by-side on desktop
</success_criteria>

<output>
After completion, create `.planning/phases/04-pwa-offline/04-07-SUMMARY.md`
</output>
