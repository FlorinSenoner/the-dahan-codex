---
phase: 04-pwa-offline
plan: 05
type: execute
wave: 4
depends_on: ["04-04"]
files_modified:
  - e2e/pwa.spec.ts
  - e2e/settings.spec.ts
autonomous: true

must_haves:
  truths:
    - "E2E test verifies offline indicator appears when network is offline"
    - "E2E test verifies settings page loads"
    - "E2E test verifies cache management buttons are present"
  artifacts:
    - path: "e2e/pwa.spec.ts"
      provides: "E2E tests for PWA offline behavior"
      contains: "offline"
    - path: "e2e/settings.spec.ts"
      provides: "E2E tests for settings page"
      contains: "cache"
  key_links:
    - from: "e2e/pwa.spec.ts"
      to: "app/components/pwa/offline-indicator.tsx"
      via: "test assertions"
      pattern: "offline"
---

<objective>
Add E2E tests for PWA functionality and settings page.

Purpose: Verify offline indicator behavior, settings page rendering, and cache management buttons work correctly. These tests ensure PWA features function in production.

Output:
- pwa.spec.ts with offline indicator test
- settings.spec.ts with settings page tests
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-pwa-offline/04-CONTEXT.md
@.planning/phases/04-pwa-offline/04-04-SUMMARY.md
@e2e/smoke.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PWA E2E tests</name>
  <files>e2e/pwa.spec.ts</files>
  <action>
    Create e2e/pwa.spec.ts:

    ```typescript
    import { test, expect } from "@playwright/test";

    test.describe("PWA Offline Indicator", () => {
      test("shows offline indicator when network is offline", async ({ page, context }) => {
        // Navigate to app first while online
        await page.goto("/spirits");
        await expect(page.getByRole("heading", { name: "Spirits" })).toBeVisible();

        // Verify offline indicator is NOT visible initially
        await expect(page.getByRole("status", { name: /offline/i })).not.toBeVisible();

        // Simulate offline mode
        await context.setOffline(true);

        // Verify offline indicator appears
        await expect(page.getByText("You're offline")).toBeVisible();

        // Go back online
        await context.setOffline(false);

        // Verify offline indicator disappears
        await expect(page.getByText("You're offline")).not.toBeVisible();
      });
    });

    test.describe("PWA Manifest", () => {
      test("has valid manifest.json", async ({ page }) => {
        const response = await page.goto("/manifest.json");
        expect(response?.ok()).toBeTruthy();

        const manifest = await response?.json();
        expect(manifest.name).toBe("The Dahan Codex");
        expect(manifest.display).toBe("standalone");
        expect(manifest.icons).toBeDefined();
        expect(manifest.icons.length).toBeGreaterThan(0);
      });
    });
    ```

    Note: Update banner and install prompt tests are harder to automate (require SW waiting state and beforeinstallprompt). Manual testing is more appropriate for those.
  </action>
  <verify>
    Run `pnpm test:e2e e2e/pwa.spec.ts` - tests pass
  </verify>
  <done>
    PWA tests verify offline indicator and manifest
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Settings E2E tests</name>
  <files>e2e/settings.spec.ts</files>
  <action>
    Create e2e/settings.spec.ts:

    ```typescript
    import { test, expect } from "@playwright/test";

    test.describe("Settings Page", () => {
      test("navigates to settings from bottom nav", async ({ page }) => {
        await page.goto("/spirits");

        // Click Settings tab
        await page.getByRole("link", { name: "Settings" }).click();

        // Verify settings page loads
        await expect(page.getByRole("heading", { name: "Settings" })).toBeVisible();
      });

      test("displays cache management section", async ({ page }) => {
        await page.goto("/settings");

        // Verify cache management section exists
        await expect(page.getByRole("heading", { name: /cache management/i })).toBeVisible();

        // Verify buttons are present
        await expect(page.getByRole("button", { name: /refresh data/i })).toBeVisible();
        await expect(page.getByRole("button", { name: /clear cache/i })).toBeVisible();
      });

      test("settings is accessible via URL", async ({ page }) => {
        await page.goto("/settings");
        await expect(page.getByRole("heading", { name: "Settings" })).toBeVisible();
      });
    });
    ```
  </action>
  <verify>
    Run `pnpm test:e2e e2e/settings.spec.ts` - tests pass
  </verify>
  <done>
    Settings tests verify navigation, cache management UI
  </done>
</task>

</tasks>

<verification>
1. `pnpm test:e2e` - all tests pass including new PWA and settings tests
2. Tests verify offline indicator appears/disappears
3. Tests verify settings page and cache buttons exist
4. No flaky tests
</verification>

<success_criteria>
- pwa.spec.ts tests offline indicator toggle and manifest validity
- settings.spec.ts tests navigation and cache management buttons
- All E2E tests pass in CI
</success_criteria>

<output>
After completion, create `.planning/phases/04-pwa-offline/04-05-SUMMARY.md`
</output>
