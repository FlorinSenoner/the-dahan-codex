---
phase: 04-pwa-offline
plan: 05
type: execute
wave: 4
depends_on: ["04-04"]
files_modified:
  - e2e/pwa.spec.ts
  - e2e/settings.spec.ts
  - e2e/MANUAL-TESTS.md
autonomous: true

must_haves:
  truths:
    - "E2E test verifies offline indicator appears when network is offline"
    - "E2E test verifies settings page loads"
    - "E2E test verifies Download for Offline button is present (PWA-04)"
    - "E2E test verifies cache management buttons are present"
    - "Manual test checklist documents cold-start offline verification"
  artifacts:
    - path: "e2e/pwa.spec.ts"
      provides: "E2E tests for PWA offline behavior"
      contains: "offline"
    - path: "e2e/settings.spec.ts"
      provides: "E2E tests for settings page"
      contains: "cache"
    - path: "e2e/MANUAL-TESTS.md"
      provides: "Manual test checklist for PWA cold-start offline"
      contains: "cold-start"
  key_links:
    - from: "e2e/pwa.spec.ts"
      to: "app/components/pwa/offline-indicator.tsx"
      via: "test assertions"
      pattern: "offline"
---

<objective>
Add E2E tests for PWA functionality and settings page.

Purpose: Verify offline indicator behavior, settings page rendering, and cache management buttons work correctly. These tests ensure PWA features function in production.

Output:
- pwa.spec.ts with offline indicator test
- settings.spec.ts with settings page tests
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-pwa-offline/04-CONTEXT.md
@.planning/phases/04-pwa-offline/04-04-SUMMARY.md
@e2e/smoke.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PWA E2E tests</name>
  <files>e2e/pwa.spec.ts</files>
  <action>
    Create e2e/pwa.spec.ts:

    ```typescript
    import { test, expect } from "@playwright/test";

    test.describe("PWA Offline Indicator", () => {
      test("shows offline indicator when network is offline", async ({ page, context }) => {
        // Navigate to app first while online
        await page.goto("/spirits");
        await expect(page.getByRole("heading", { name: "Spirits" })).toBeVisible();

        // Verify offline indicator is NOT visible initially
        await expect(page.getByRole("status", { name: /offline/i })).not.toBeVisible();

        // Simulate offline mode
        await context.setOffline(true);

        // Verify offline indicator appears
        await expect(page.getByText("You're offline")).toBeVisible();

        // Go back online
        await context.setOffline(false);

        // Verify offline indicator disappears
        await expect(page.getByText("You're offline")).not.toBeVisible();
      });
    });

    test.describe("PWA Manifest", () => {
      test("has valid manifest.json", async ({ page }) => {
        const response = await page.goto("/manifest.json");
        expect(response?.ok()).toBeTruthy();

        const manifest = await response?.json();
        expect(manifest.name).toBe("The Dahan Codex");
        expect(manifest.display).toBe("standalone");
        expect(manifest.icons).toBeDefined();
        expect(manifest.icons.length).toBeGreaterThan(0);
      });
    });
    ```

    Note: Update banner and install prompt tests are harder to automate (require SW waiting state and beforeinstallprompt). Manual testing is more appropriate for those.
  </action>
  <verify>
    Run `pnpm test:e2e e2e/pwa.spec.ts` - tests pass
  </verify>
  <done>
    PWA tests verify offline indicator and manifest
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Settings E2E tests</name>
  <files>e2e/settings.spec.ts</files>
  <action>
    Create e2e/settings.spec.ts:

    ```typescript
    import { test, expect } from "@playwright/test";

    test.describe("Settings Page", () => {
      test("navigates to settings from bottom nav", async ({ page }) => {
        await page.goto("/spirits");

        // Click Settings tab
        await page.getByRole("link", { name: "Settings" }).click();

        // Verify settings page loads
        await expect(page.getByRole("heading", { name: "Settings" })).toBeVisible();
      });

      test("displays offline access section with download button", async ({ page }) => {
        await page.goto("/settings");

        // Verify offline access section exists (PWA-04)
        await expect(page.getByRole("heading", { name: /offline access/i })).toBeVisible();

        // Verify Download for Offline button is present
        await expect(page.getByRole("button", { name: /download for offline/i })).toBeVisible();
      });

      test("displays cache management section", async ({ page }) => {
        await page.goto("/settings");

        // Verify cache management section exists
        await expect(page.getByRole("heading", { name: /cache management/i })).toBeVisible();

        // Verify buttons are present
        await expect(page.getByRole("button", { name: /refresh data/i })).toBeVisible();
        await expect(page.getByRole("button", { name: /clear cache/i })).toBeVisible();
      });

      test("settings is accessible via URL", async ({ page }) => {
        await page.goto("/settings");
        await expect(page.getByRole("heading", { name: "Settings" })).toBeVisible();
      });
    });
    ```
  </action>
  <verify>
    Run `pnpm test:e2e e2e/settings.spec.ts` - tests pass
  </verify>
  <done>
    Settings tests verify navigation, cache management UI
  </done>
</task>

<task type="auto">
  <name>Task 3: Create manual test checklist for PWA cold-start offline</name>
  <files>e2e/MANUAL-TESTS.md</files>
  <action>
    Create e2e/MANUAL-TESTS.md documenting manual verification for PWA cold-start offline (PWA-02).

    This is documented as a manual test because:
    1. Playwright E2E requires the service worker to be installed from a previous run
    2. Cold-start offline testing requires: install SW online -> close browser -> go offline -> reopen
    3. This cross-session state is complex to automate reliably in CI

    ```markdown
    # Manual Test Checklist

    ## PWA Cold-Start Offline (PWA-02)

    **Purpose**: Verify app loads and displays spirit library when completely offline (cold start).

    **Prerequisites**:
    - Chrome DevTools available
    - App deployed or running locally with `pnpm preview`

    **Steps**:
    1. Open app in Chrome, navigate to /spirits
    2. Wait for service worker to install (check DevTools > Application > Service Workers)
    3. Browse a few spirits to populate cache (view 2-3 spirit detail pages)
    4. Close all browser tabs with the app
    5. Open DevTools > Network tab, enable "Offline" checkbox
    6. Open a new tab and navigate to app URL
    7. Verify:
       - [ ] App shell loads (header, bottom nav visible)
       - [ ] Spirit list renders with names and images
       - [ ] Can navigate to spirit detail page
       - [ ] Offline indicator appears at top
    8. Disable "Offline" in DevTools
    9. Verify offline indicator disappears

    **Expected Result**: App renders cached spirit library data without network connection.

    **Notes**:
    - First visit must be online to install SW and cache data
    - Convex data caches on first view via stale-while-revalidate strategy
    - Images cache via Workbox CacheFirst strategy
    ```
  </action>
  <verify>
    File exists at e2e/MANUAL-TESTS.md with PWA cold-start instructions
  </verify>
  <done>
    Manual test checklist documents PWA-02 cold-start offline verification
  </done>
</task>

</tasks>

<verification>
1. `pnpm test:e2e` - all tests pass including new PWA and settings tests
2. Tests verify offline indicator appears/disappears
3. Tests verify settings page and cache buttons exist
4. No flaky tests
5. e2e/MANUAL-TESTS.md exists with PWA cold-start checklist
</verification>

<success_criteria>
- pwa.spec.ts tests offline indicator toggle and manifest validity
- settings.spec.ts tests navigation, Download for Offline button (PWA-04), and cache management buttons
- All E2E tests pass in CI
- Manual test checklist documents cold-start offline verification (PWA-02)
</success_criteria>

<output>
After completion, create `.planning/phases/04-pwa-offline/04-05-SUMMARY.md`
</output>
