# Phase 6.1: Cleanup TheDahanCodex - Research

**Researched:** 2026-02-01
**Domain:** Codebase cleanup - SSR removal, dead code, component consolidation
**Confidence:** HIGH

## Summary

This research phase investigates the cleanup tasks for The Dahan Codex codebase after the SSR-to-SPA migration and the Phase 3.4/3.6 board visualization pivot. The codebase has accumulated dead code from abandoned features (growth panels, presence tracks, power DSL) and SSR-related patterns that are no longer needed in a pure client-side SPA.

The cleanup scope includes: (1) removing SSR-related code patterns like `typeof window === "undefined"` checks and `"use client"` directives, (2) identifying and removing unused files like `power-dsl.ts` and parts of `spirit-colors.ts`, (3) auditing the element icons directory which appears unused, and (4) refactoring the update banner to match the offline indicator's subtle pill styling.

**Primary recommendation:** Remove dead code systematically (unused files, SSR patterns, unused exports), consolidate the update banner to match existing pill UI patterns, and update CLAUDE.md with client-only SPA guidelines.

## Standard Stack

This phase does not introduce new libraries. It focuses on cleanup and consolidation of existing code.

### Core (Unchanged)
| Library | Version | Purpose | Status |
|---------|---------|---------|--------|
| React | 19.2.3 | UI framework | Keep |
| TanStack Router | 1.157.9 | Client-side routing | Keep |
| Tailwind CSS | 4.1.18 | Styling | Keep |
| Radix UI | Various | Accessible components | Keep |

### Files to Remove
| File | Reason | Confidence |
|------|--------|------------|
| `app/lib/power-dsl.ts` | Abandoned Phase 3.4 - no imports | HIGH |
| `app/components/icons/elements/*.tsx` (all 10 files) | No external imports found | HIGH |
| `app/components/icons/elements/index.ts` | Barrel for unused icons | HIGH |

### Code to Clean in spirit-colors.ts
| Export | Status | Reason |
|--------|--------|--------|
| `complexityBadgeColors` | KEEP | Used in spirits.$slug.tsx, spirit-row.tsx |
| `elementBadgeColors` | KEEP | Used in spirits.$slug.tsx |
| `elementFilterColors` | KEEP | Used in filter-sheet.tsx, filter-chips.tsx |
| `complexityFilterColors` | KEEP | Used in filter-sheet.tsx |
| `modifierColors` | KEEP | Used in spirit-row.tsx |
| `PLACEHOLDER_GRADIENT` | KEEP | Used in spirits.$slug.tsx, spirit-row.tsx |
| `spiritTrackColors` | REMOVE | No external imports (presence tracks removed) |
| `trackGradientClasses` | REMOVE | No external imports (presence tracks removed) |
| `getSpiritTrackColors` | REMOVE | No external imports (presence tracks removed) |

## Architecture Patterns

### SSR Code Patterns to Remove

The app switched from TanStack Start SSR to pure client-side SPA in quick-010. Several SSR-related patterns remain that are no longer necessary.

#### Pattern 1: "use client" Directives
**What:** Next.js-style client component markers
**Where found:**
- `app/components/ui/drawer.tsx`
- `app/components/ui/radio-group.tsx`
- `app/components/ui/select.tsx`
- `app/components/ui/tooltip.tsx`
- `app/components/ui/popover.tsx`
- `app/components/ui/accordion.tsx`
- `app/components/ui/label.tsx`

**Action:** Remove "use client" directives - they have no effect in Vite + React client-side SPA
**Impact:** LOW - purely cosmetic cleanup

#### Pattern 2: typeof window Checks
**What:** Server/client environment detection
**Where found:**
- `app/hooks/use-install-prompt.ts` (line 40)
- `app/hooks/use-service-worker.ts` (line 28)
- `app/components/pwa/install-prompt.tsx` (line 22)

**Action:** KEEP - These are still useful for build-time checks and SSR-safe patterns even in SPA
**Reason:** While not strictly necessary for runtime, these guards:
1. Prevent build-time errors if code is ever analyzed in Node context
2. Are low-cost defensive programming
3. May be needed if PWA hooks are ever used in tests or scripts

#### Pattern 3: SSR Comment in useOnlineStatus
**What:** Comment "Assume online during SSR" in getServerSnapshot
**Where:** `app/hooks/use-online-status.ts` (line 17)

**Action:** Update comment to reflect SPA context, but KEEP getServerSnapshot
**Reason:** useSyncExternalStore requires getServerSnapshot for React 18+ concurrency safety

### Component Consolidation

#### Update Banner Refactor
**Current:** Full-width banner at top with primary background
**Target:** Subtle pill like offline indicator

Reference (offline-indicator.tsx):
```tsx
<output
  aria-live="polite"
  className="fixed bottom-20 right-4 z-40 inline-flex items-center gap-1.5 rounded-full border border-zinc-700 bg-zinc-800/90 px-3 py-1.5 text-sm text-zinc-300 animate-in fade-in"
>
  <WifiOff className="h-3.5 w-3.5" aria-hidden="true" />
  <span>Offline</span>
</output>
```

Target (update-banner.tsx should become):
```tsx
<output
  aria-live="polite"
  className="fixed top-4 right-4 z-50 inline-flex items-center gap-2 rounded-full border border-zinc-700 bg-zinc-800/90 px-3 py-1.5 text-sm text-zinc-300 animate-in fade-in"
>
  <span>Update available</span>
  <button
    type="button"
    onClick={onReload}
    className="rounded-full bg-primary px-2 py-0.5 text-xs font-medium text-primary-foreground"
  >
    Reload
  </button>
</output>
```

**Position:** top-4 right-4 (z-50 per decisions) to avoid overlap with offline indicator (bottom-20 right-4 z-40)

### CLAUDE.md Updates

Add to "Key Patterns" section:

```markdown
## Client-Only SPA Architecture

This app is a pure client-side SPA (switched from TanStack Start SSR in quick-010).

**Implications:**
- No server rendering - all code runs in browser
- Route loaders run client-side (use for prefetching, not data requirements)
- "use client" directives have no effect (Vite + React, not Next.js)
- useSyncExternalStore still needs getServerSnapshot for React 18+ concurrency

**PWA Notes:**
- Service worker manages static asset caching
- Convex data cached via TanStack Query + IndexedDB (not SW - WebSocket protocol)
- typeof window checks in PWA hooks are defensive programming, not SSR handling
```

Update "Project Map" to remove sw-register.ts reference:
```markdown
app/lib/             # Shared utilities (spirit-colors.ts, utils.ts)
```

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Pill/badge UI | Custom component | Existing Badge component or inline Tailwind | Consistency |
| Dead code detection | Manual grep | `pnpm knip` | Automated, accurate |
| Component cleanup | Manual deletion | `pnpm knip:fix` | Safe removal |

**Key insight:** The project already has knip configured for dead code detection. Use it rather than manual grep searches.

## Common Pitfalls

### Pitfall 1: Removing "Safe" Guards
**What goes wrong:** Removing typeof window checks breaks build or future SSR compatibility
**Why it happens:** They look like SSR artifacts but serve defensive programming purpose
**How to avoid:** Keep window/document checks in code that accesses browser APIs
**Warning signs:** Runtime errors in build scripts or potential SSR scenarios

### Pitfall 2: Breaking Export Dependencies
**What goes wrong:** Removing exports from spirit-colors.ts that are actually used
**Why it happens:** Grep may miss dynamic imports or re-exports
**How to avoid:** Run `pnpm knip` before deletion to verify unused exports
**Warning signs:** TypeScript errors after deletion

### Pitfall 3: Inconsistent z-index Layering
**What goes wrong:** Update banner overlaps or underlaps other UI elements
**Why it happens:** Not following established z-index hierarchy
**How to avoid:** Follow decisions: z-50 for update banner, z-40 for offline indicator
**Warning signs:** Visual overlap in UI testing

## Code Examples

### Removing "use client" Directive
```diff
// app/components/ui/accordion.tsx
- "use client";
-
  import * as AccordionPrimitive from "@radix-ui/react-accordion";
```

### Cleaning spirit-colors.ts
```diff
// Remove unused presence track exports (lines 127-175)
- /**
-  * Spirit-specific presence track color palettes
-  * Based on primary/secondary elements of each spirit
-  */
- export const spiritTrackColors: Record<...
-
- export const trackGradientClasses: Record<...
-
- export function getSpiritTrackColors(slug: string): ...
```

### Update Banner Pill Style
```tsx
// app/components/pwa/update-banner.tsx
import { RefreshCw } from "lucide-react";

interface UpdateBannerProps {
  onReload: () => void;
}

export function UpdateBanner({ onReload }: UpdateBannerProps) {
  return (
    <output
      aria-live="polite"
      className="fixed top-4 right-4 z-50 inline-flex items-center gap-2 rounded-full border border-zinc-700 bg-zinc-800/90 px-3 py-1.5 text-sm text-zinc-300 animate-in fade-in"
    >
      <RefreshCw className="h-3.5 w-3.5" aria-hidden="true" />
      <span>Update available</span>
      <button
        type="button"
        onClick={onReload}
        className="rounded-full bg-primary px-2 py-0.5 text-xs font-medium text-primary-foreground hover:bg-primary/90"
      >
        Reload
      </button>
    </output>
  );
}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| TanStack Start SSR | Vite + React SPA | quick-010 (2026-01-26) | SSR code is dead |
| Board visualization (growth, presence) | Text-based openings | Phase 3.6 (2026-01-28) | power-dsl.ts, element icons unused |
| Full-width update banner | Subtle pill (TBD) | This phase | UI consistency |

**Deprecated/outdated:**
- `power-dsl.ts`: Entire file from abandoned Phase 3.4
- Element icon components: Were for board visualization, now unused
- `spiritTrackColors`, `trackGradientClasses`, `getSpiritTrackColors`: Presence track colors no longer needed

## Open Questions

1. **Element Icons Future Use**
   - What we know: No current imports, were for board visualization
   - What's unclear: Could they be useful for future features (e.g., element badges)?
   - Recommendation: Remove now, can recreate if needed later (simple SVG components)

2. **CLAUDE.md sw-register.ts Reference**
   - What we know: File was deleted in Phase 4, reference still in CLAUDE.md
   - What's unclear: Was this intentional documentation or oversight?
   - Recommendation: Update CLAUDE.md to remove reference

## Sources

### Primary (HIGH confidence)
- Codebase analysis via Grep/Glob - direct file inspection
- STATE.md decisions log - verified project decisions
- ROADMAP.md - phase history and context

### Secondary (MEDIUM confidence)
- Phase 4 planning docs - offline architecture decisions

### Tertiary (LOW confidence)
- None - all findings verified against codebase

## Metadata

**Confidence breakdown:**
- Dead code identification: HIGH - verified via grep, no imports found
- SSR pattern removal: HIGH - project decisions documented
- Update banner refactor: HIGH - clear prior art in offline-indicator.tsx
- CLAUDE.md updates: HIGH - straightforward documentation

**Research date:** 2026-02-01
**Valid until:** Indefinite (cleanup phase, no external dependencies)
