---
phase: 03.2-spirit-board-refinements
plan: 04
type: execute
wave: 2
depends_on: ["03.2-01"]
files_modified:
  - app/components/spirits/presence-track.tsx
  - app/components/spirits/card-hand.tsx
autonomous: true

must_haves:
  truths:
    - "Presence tracks use spirit-specific gradient colors based on spirit slug"
    - "Presence track component supports 3+ tracks via flexible array rendering"
    - "Cards section has collapsible Hand and Discard subsections"
    - "Cards use border-only speed indicator (no badge)"
    - "Cards have equal width with ellipsis for long titles"
    - "Hand/Discard headers show card counts"
  artifacts:
    - path: "app/components/spirits/presence-track.tsx"
      provides: "Spirit-specific track colors"
      contains: "getSpiritTrackColors"
    - path: "app/components/spirits/card-hand.tsx"
      provides: "Hand/Discard collapsible sections"
      contains: "Collapsible"
  key_links:
    - from: "app/components/spirits/presence-track.tsx"
      to: "app/lib/spirit-colors.ts"
      via: "getSpiritTrackColors import"
      pattern: "import.*getSpiritTrackColors"
    - from: "app/components/spirits/card-hand.tsx"
      to: "@radix-ui/react-collapsible"
      via: "Collapsible component"
      pattern: "Collapsible.*CollapsibleTrigger"
---

<objective>
Update presence tracks to use spirit-specific gradient colors and support multi-track layouts. Redesign cards section with collapsible Hand/Discard subsections, border-only speed indicators, and equal-width cards.

Purpose: Spirit identity through color, support complex spirits with 3+ tracks, cleaner card organization, and consistent speed styling.
Output: Updated presence-track.tsx with spirit colors, updated card-hand.tsx with collapsible sections
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03.2-spirit-board-refinements/03.2-RESEARCH.md
@.planning/phases/03.2-spirit-board-refinements/03.2-01-SUMMARY.md
@app/components/spirits/presence-track.tsx
@app/components/spirits/card-hand.tsx
@app/lib/spirit-colors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update presence tracks with spirit-specific colors</name>
  <files>app/components/spirits/presence-track.tsx</files>
  <action>
1. Import getSpiritTrackColors and trackGradientClasses from spirit-colors:
   ```typescript
   import { getSpiritTrackColors, trackGradientClasses } from "@/lib/spirit-colors";
   ```

2. Add spiritSlug prop to PresenceTrack component:
   ```typescript
   interface PresenceTrackProps {
     spirit: Doc<"spirits">;
     spiritSlug?: string; // For getting spirit-specific colors
   }
   ```

3. Get spirit-specific colors:
   ```typescript
   const trackColors = getSpiritTrackColors(spiritSlug ?? spirit.slug);
   ```

4. Map track type to spirit color instead of hardcoded:
   - Replace hardcoded amber/blue with trackColors.energy and trackColors.cardPlays
   - Use trackGradientClasses[color] to get gradient class
   - For custom tracks, provide fallback logic based on track.color or index

5. Handle multi-track layouts (3+ tracks):
   - Existing array rendering should work
   - Ensure each track gets appropriate color from spiritTrackColors
   - For spirits without specific mappings, cycle through a color palette:
     ```typescript
     const fallbackColors = ["amber", "blue", "purple", "emerald", "indigo", "cyan"];
     const color = trackColors[track.type] ?? fallbackColors[index % fallbackColors.length];
     ```

6. Handle branching track layout (Finder) - add visual indicator:
   - If track.connectsTo exists, add a small connection indicator
   - For now, render linearly but add a subtle visual cue (badge or icon)
   - Full branching visualization deferred to future enhancement

7. Handle unlocksGrowth (Starlight):
   - If track.unlocksGrowth === true, add a growth icon or badge to track header
   - Indicates this track reveals growth choices when emptied
  </action>
  <verify>
   - `grep -q "getSpiritTrackColors" app/components/spirits/presence-track.tsx` returns 0
   - `grep -q "spiritSlug" app/components/spirits/presence-track.tsx` returns 0
   - `pnpm typecheck` passes
  </verify>
  <done>Presence tracks use spirit-specific gradient colors, support 3+ tracks, and handle connectsTo/unlocksGrowth fields</done>
</task>

<task type="auto">
  <name>Task 2: Add collapsible Hand/Discard sections to cards</name>
  <files>app/components/spirits/card-hand.tsx</files>
  <action>
1. Import Collapsible from shadcn/ui:
   ```typescript
   import { Collapsible, CollapsibleContent, CollapsibleTrigger } from "@/components/ui/collapsible";
   ```

   Note: If Collapsible not installed, install shadcn component:
   ```bash
   npx shadcn@latest add collapsible
   ```

2. Rename/restructure section:
   - Section title remains "Cards"
   - Split uniquePowers into hand (starting cards) and discard (if exists)
   - For now, all uniquePowers are "hand" cards (discardPile not in schema yet)

3. Create collapsible Hand section:
   ```typescript
   <Collapsible defaultOpen>
     <CollapsibleTrigger className="flex items-center gap-2 w-full py-2">
       <ChevronDown className="w-4 h-4 transition-transform data-[state=open]:rotate-0 data-[state=closed]:-rotate-90" />
       <span className="font-medium">Hand</span>
       <span className="text-xs text-muted-foreground">({cards.length})</span>
     </CollapsibleTrigger>
     <CollapsibleContent>
       {/* Card grid */}
     </CollapsibleContent>
   </Collapsible>
   ```

4. Update card styling for border-only speed:
   - Remove any Fast/Slow badge text
   - Use border-l-4 (left border) for speed indication:
     - Fast: `border-l-4 border-l-amber-500`
     - Slow: `border-l-4 border-l-blue-500`
   - Keep existing card layout otherwise

5. Ensure equal-width cards:
   - Use grid layout with fixed columns: `grid grid-cols-1 sm:grid-cols-2 gap-3`
   - Each card: `min-w-0` to allow flex shrink
   - Card title: `truncate` class for ellipsis on overflow

6. Title ellipsis for long names:
   ```typescript
   <h4 className="font-medium text-sm truncate" title={card.name}>
     {card.name}
   </h4>
   ```
   - `truncate` adds ellipsis
   - `title` attribute shows full name on hover

7. Placeholder for Discard section (future enhancement):
   - Add commented-out Discard Collapsible section
   - Will be populated when discardPile field added to schema
  </action>
  <verify>
   - `grep -q "Collapsible" app/components/spirits/card-hand.tsx` returns 0
   - `grep -q "border-l-amber" app/components/spirits/card-hand.tsx` returns 0
   - `grep -q "truncate" app/components/spirits/card-hand.tsx` returns 0
   - `pnpm typecheck` passes
  </verify>
  <done>Cards section has collapsible Hand subsection with count, border-only speed indicators, equal-width cards, and ellipsis for long titles</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` - No type errors
2. Visual inspection of presence tracks:
   - River: cyan energy track, amber card plays track
   - Lightning: orange energy track, violet card plays track
3. Visual inspection of cards:
   - Collapsible "Hand (N)" header
   - Cards show border-left for speed (amber/blue)
   - Long titles truncate with ellipsis
   - Equal width in 2-column grid
</verification>

<success_criteria>
- Presence tracks use spirit-specific colors (cyan/amber for River, orange/violet for Lightning)
- Unknown spirits fallback to amber/blue default
- Multi-track spirits (future) render with color cycling
- Cards section header "Hand" with count, collapsible
- Cards use border-l-4 for speed (amber=Fast, blue=Slow)
- Cards equal width with truncate/ellipsis on overflow
- Full card name visible on hover via title attribute
</success_criteria>

<output>
After completion, create `.planning/phases/03.2-spirit-board-refinements/03.2-04-SUMMARY.md`
</output>
