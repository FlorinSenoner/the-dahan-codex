---
phase: 03.2-spirit-board-refinements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - pnpm-lock.yaml
  - app/lib/spirit-colors.ts
  - convex/schema.ts
autonomous: true

must_haves:
  truths:
    - "react-intersection-observer is installed and available for import"
    - "Spirit slugs map to element-derived track color palettes"
    - "Schema supports orActions for Fractured Days choose-from-multiple growth"
    - "Schema supports connectsTo/connectionPoint for branching presence tracks"
    - "Schema supports layout field for multiple/branching track layouts"
  artifacts:
    - path: "package.json"
      provides: "react-intersection-observer dependency"
      contains: "react-intersection-observer"
    - path: "app/lib/spirit-colors.ts"
      provides: "spiritTrackColors mapping"
      exports: ["spiritTrackColors", "getSpiritTrackColors", "trackGradientClasses"]
    - path: "convex/schema.ts"
      provides: "Extended growth and presence track schema"
      contains: "orActions"
  key_links:
    - from: "app/lib/spirit-colors.ts"
      to: "presence-track.tsx"
      via: "spiritTrackColors import"
      pattern: "getSpiritTrackColors"
---

<objective>
Install react-intersection-observer for scroll detection, add spirit-specific presence track colors, and extend schema for complex spirit patterns (Fractured Days, Finder, Starlight, Serpent).

Purpose: Foundation layer enabling minimalist tabs with scroll awareness, spirit-identity-reinforcing track colors, and data model for complex spirits.
Output: New dependency, extended spirit-colors.ts, updated schema.ts
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03.2-spirit-board-refinements/03.2-RESEARCH.md
@app/lib/spirit-colors.ts
@convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-intersection-observer and add spirit track colors</name>
  <files>package.json, pnpm-lock.yaml, app/lib/spirit-colors.ts</files>
  <action>
1. Install react-intersection-observer:
   ```bash
   pnpm add react-intersection-observer
   ```

2. Add spirit-specific track colors to app/lib/spirit-colors.ts:
   - Add spiritTrackColors Record mapping spirit slugs to {energy: string, cardPlays: string} palettes
   - Add getSpiritTrackColors(slug: string) function with fallback to amber/blue defaults
   - Add trackGradientClasses Record mapping color names to Tailwind gradient classes
   - Colors based on primary/secondary elements:
     - river-surges-in-sunlight: cyan/amber (Water/Sun)
     - lightnings-swift-strike: orange/violet (Fire/Air)
     - fractured-days-split-the-sky: indigo/violet (Moon/Air)
     - starlight-seeks-its-form: indigo/amber (Moon/Sun)
     - finder-of-paths-unseen: violet/emerald (Air/Plant)
     - serpent-slumbering-beneath-the-island: orange/stone (Fire/Earth)
   - Gradient pattern: "bg-gradient-to-r from-{color}-500/15 via-{color}-500/5 to-transparent"
  </action>
  <verify>
   - `pnpm list react-intersection-observer` shows installed version
   - `grep -q "spiritTrackColors" app/lib/spirit-colors.ts` returns 0
   - `grep -q "getSpiritTrackColors" app/lib/spirit-colors.ts` returns 0
  </verify>
  <done>react-intersection-observer installed, spiritTrackColors and getSpiritTrackColors exported from spirit-colors.ts</done>
</task>

<task type="auto">
  <name>Task 2: Extend schema for complex spirit patterns</name>
  <files>convex/schema.ts</files>
  <action>
Extend the growth and presenceTracks schema to support complex spirits:

1. **Growth schema additions** (inside growth.options array items):
   - Add `orActions` field: `v.optional(v.array(v.object({ label: v.string(), actions: v.array(...same action schema...) })))` for Fractured Days' "gain 1 Time OR 2 Card Plays" style choices
   - Add `repeat` field: `v.optional(v.number())` for "do this N times" options
   - Add new growth type: update `type` union to include `v.literal("pick-any")` for Fractured Days choose-from-4

2. **Growth action type additions** (inside actions array):
   - Add "gainTime" to supported types in the type string comment
   - No schema change needed - type is already v.string()

3. **Presence track schema additions** (inside presenceTracks.tracks array):
   - Add `layout` field to presenceTracks object level: `v.optional(v.union(v.literal("linear"), v.literal("branching"), v.literal("multiple")))`
   - Add `connectsTo` field: `v.optional(v.string())` for track ID this track connects to
   - Add `connectionPoint` field: `v.optional(v.number())` for slot index where connection occurs
   - Add `unlocksGrowth` field: `v.optional(v.boolean())` for Starlight's growth-unlocking tracks

4. **Presence slot schema additions** (inside slots array):
   - Add `presenceCap` field: `v.optional(v.number())` for Serpent's Deep Slumber limit values

All fields are optional to maintain backward compatibility with existing spirit data.
  </action>
  <verify>
   - `pnpm typecheck` passes
   - `grep -q "orActions" convex/schema.ts` returns 0
   - `grep -q "connectsTo" convex/schema.ts` returns 0
   - `grep -q "layout.*branching" convex/schema.ts` returns 0
  </verify>
  <done>Schema extended with orActions, repeat, connectsTo, connectionPoint, unlocksGrowth, presenceCap, and layout fields - all optional for backward compatibility</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` - No type errors
2. `pnpm list react-intersection-observer` - Shows ^10.x.x
3. Import test: `import { spiritTrackColors } from '@/lib/spirit-colors'` compiles
4. Schema change: Existing seed data still validates (no breaking changes)
</verification>

<success_criteria>
- react-intersection-observer available for import in variant-tabs.tsx
- spiritTrackColors mapping returns color palettes for 6 spirits
- getSpiritTrackColors falls back to amber/blue for unknown spirits
- Schema accepts orActions array for growth options
- Schema accepts layout/connectsTo/connectionPoint for presence tracks
- All existing spirit data remains valid (backward compatible)
</success_criteria>

<output>
After completion, create `.planning/phases/03.2-spirit-board-refinements/03.2-01-SUMMARY.md`
</output>
