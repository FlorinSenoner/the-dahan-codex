---
phase: 03.6-simplify-spirit-board-text-openings
plan: 04
type: execute
wave: 2
depends_on: ["03.6-02"]
files_modified:
  - convex/schema.ts
  - convex/openings.ts
autonomous: true

must_haves:
  truths:
    - "Openings table exists in Convex schema"
    - "Openings can be queried by spirit ID"
    - "Openings can be queried by slug"
  artifacts:
    - path: "convex/schema.ts"
      provides: "Openings table definition"
      contains: "openings: defineTable"
    - path: "convex/openings.ts"
      provides: "Query functions for openings"
      exports: ["listBySpirit", "getBySlug"]
  key_links:
    - from: "convex/openings.ts"
      to: "convex/schema.ts"
      via: "table reference"
      pattern: '"openings"'
---

<objective>
Create the Convex openings table and query functions for text-based turn-by-turn opening guides.

Purpose: Data layer for the new simplified opening system
Output: Openings table schema and query functions ready for frontend integration
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.6-simplify-spirit-board-text-openings/03.6-RESEARCH.md
@convex/schema.ts
@convex/spirits.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add openings table to schema</name>
  <files>convex/schema.ts</files>
  <action>
Add the openings table to `convex/schema.ts` after the spirits table definition:

```typescript
// Openings table - text-based turn-by-turn opening guides
openings: defineTable({
  spiritId: v.id("spirits"),       // Link to spirit (base or aspect)
  slug: v.string(),                // URL-friendly identifier: "standard-opening"
  name: v.string(),                // Display name: "Standard Opening"
  description: v.optional(v.string()), // Brief summary of the strategy
  difficulty: v.optional(v.union(  // Optional difficulty rating
    v.literal("Beginner"),
    v.literal("Intermediate"),
    v.literal("Advanced"),
  )),
  turns: v.array(                  // Turn-by-turn text instructions
    v.object({
      turn: v.number(),            // Turn 1, 2, 3, etc.
      title: v.optional(v.string()), // "Setup" or "Turn 1: Establishing Presence"
      instructions: v.string(),    // Main text content for this turn
      notes: v.optional(v.string()), // Additional context/tips
    }),
  ),
  author: v.optional(v.string()),  // Attribution
  sourceUrl: v.optional(v.string()), // Link to original guide
})
  .index("by_spirit", ["spiritId"])
  .index("by_slug", ["slug"]),
```

Place this after the spirits table but before the closing of defineSchema().
  </action>
  <verify>Run `pnpm typecheck` - should pass</verify>
  <done>Openings table defined in schema with spiritId reference and indexes</done>
</task>

<task type="auto">
  <name>Task 2: Create openings query functions</name>
  <files>convex/openings.ts</files>
  <action>
Create new file `convex/openings.ts` with these query functions:

```typescript
import { v } from "convex/values";
import { query } from "./_generated/server";

// List all openings for a specific spirit
export const listBySpirit = query({
  args: { spiritId: v.id("spirits") },
  handler: async (ctx, args) => {
    return await ctx.db
      .query("openings")
      .withIndex("by_spirit", (q) => q.eq("spiritId", args.spiritId))
      .collect();
  },
});

// Get a single opening by slug
export const getBySlug = query({
  args: { slug: v.string() },
  handler: async (ctx, args) => {
    return await ctx.db
      .query("openings")
      .withIndex("by_slug", (q) => q.eq("slug", args.slug))
      .first();
  },
});
```
  </action>
  <verify>
Run `pnpm typecheck` - should pass
Run `npx convex dev --once` - should deploy successfully and generate types
Check that `convex/_generated/api.ts` includes `api.openings.listBySpirit` and `api.openings.getBySlug`
  </verify>
  <done>Openings queries created and Convex types generated</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. Convex schema deploys without errors
3. Generated types include openings queries
4. Schema has openings table with by_spirit and by_slug indexes
</verification>

<success_criteria>
- Openings table in schema with correct structure
- Query functions exported from convex/openings.ts
- Convex types generated and available
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03.6-simplify-spirit-board-text-openings/03.6-04-SUMMARY.md`
</output>
