---
phase: 03.6-simplify-spirit-board-text-openings
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - app/routes/spirits.$slug.tsx
  - app/components/spirits/special-rules.tsx
  - convex/schema.ts
  - convex/seed.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Spirit detail page does NOT render a Special Rules section"
    - "Opening source link points to working URL"
    - "Aspect pages show only openings seeded for that aspect, never inherited from base"
  artifacts:
    - path: "app/routes/spirits.$slug.tsx"
      provides: "Spirit detail without SpecialRules import or JSX"
      not_contains: "SpecialRules"
    - path: "convex/seed.ts"
      provides: "Fixed sourceUrl for openings"
      contains: "https://querki.net/u/darker/spirit-island-faq"
      not_contains: "#!.7w4g8aw"
  key_links:
    - from: "app/components/spirits/opening-section.tsx"
      to: "convex/openings.ts"
      via: "spiritId exact match query"
      pattern: "listBySpirit.*spiritId"
---

<objective>
Close 3 UAT gaps from Phase 3.6 user acceptance testing.

Purpose: Fix issues found during UAT before marking Phase 3.6 complete.
Output: Clean spirit detail page (no special rules), working source URL, verified aspect openings isolation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.6-simplify-spirit-board-text-openings/3.6-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove SpecialRules component and clean up schema/seed</name>
  <files>
    app/routes/spirits.$slug.tsx
    app/components/spirits/special-rules.tsx
    convex/schema.ts
    convex/seed.ts
  </files>
  <action>
    1. In `app/routes/spirits.$slug.tsx`:
       - Remove the import line: `import { SpecialRules } from "@/components/spirits/special-rules";`
       - Remove the JSX block (around lines 286-288):
         ```
         {spirit.specialRules && spirit.specialRules.length > 0 && (
           <SpecialRules rules={spirit.specialRules} />
         )}
         ```

    2. Delete the file `app/components/spirits/special-rules.tsx` entirely.

    3. In `convex/schema.ts`, remove the `specialRules` field from the spirits table definition (lines 53-60):
       ```
       specialRules: v.optional(
         v.array(
           v.object({
             name: v.string(),
             description: v.string(),
           }),
         ),
       ),
       ```

    4. In `convex/seed.ts`, remove ALL `specialRules` properties from every spirit insert call. There are 12 occurrences across both `seedSpirits` and `reseedSpirits` mutations. Some have empty arrays `specialRules: []` and some have actual content. Remove them all since the schema field is being removed. The occurrences are at approximately lines: 59, 130, 220, 268, 316, 364, 492, 561, 650, 698, 746, 794.

    5. Also in `convex/seed.ts`, fix the sourceUrl for the opening in BOTH mutations:
       - Line 415: Change `"https://querki.net/u/darker/spirit-island-faq/#!.7w4g8aw"` to `"https://querki.net/u/darker/spirit-island-faq"`
       - Line 845: Change `"https://querki.net/u/darker/spirit-island-faq/#!.7w4g8aw"` to `"https://querki.net/u/darker/spirit-island-faq"`
  </action>
  <verify>
    Run `pnpm typecheck` - must pass with no errors (schema change propagates through Convex codegen).
    Run `pnpm build` - must succeed.
    Grep for "SpecialRules" and "special-rules" in app/ - zero matches.
    Grep for "specialRules" in convex/ - zero matches.
    Grep for "#!.7w4g8aw" in convex/seed.ts - zero matches.
  </verify>
  <done>
    SpecialRules component deleted, all imports/JSX removed, specialRules field removed from schema and all seed data, sourceUrl fixed to working querki.net root URL.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify aspect openings isolation and reseed</name>
  <files>
    app/routes/spirits.$slug.$aspect.tsx
    app/components/spirits/opening-section.tsx
    convex/openings.ts
  </files>
  <action>
    This task verifies the architecture is correct for Gap 3 (aspects only show their own openings). No code changes needed for the isolation logic -- the architecture is already correct:

    1. VERIFY the data flow:
       - `spirits.$slug.$aspect.tsx` loads the aspect spirit document via `getSpiritBySlug({ slug, aspect })` which returns the aspect's own document with its own `_id`
       - It renders `<SpiritDetailContent spirit={spirit} ...>` where `spirit` is the aspect document
       - `SpiritDetailContent` renders `<OpeningSection spiritId={spirit._id} />` passing the aspect's own `_id`
       - `OpeningSection` queries `openings.listBySpirit({ spiritId })` which does exact match on `spiritId`
       - Since no openings are seeded for aspects, the query returns empty array and the section is hidden

    2. Run `npx convex run seed:reseedSpirits` to apply the seed data changes from Task 1 (removed specialRules fields, fixed sourceUrl). This requires the Convex dev server to be running.

    3. After reseed completes, verify the spirit detail page loads without errors by running `pnpm build`.

    Document the design decision by adding a code comment in `opening-section.tsx` above the component:
    ```
    // Design: Each spirit (base or aspect) queries openings by its own _id.
    // Aspects never inherit openings from their base spirit.
    ```
  </action>
  <verify>
    `npx convex run seed:reseedSpirits` completes with success message.
    `pnpm build` passes.
    Comment exists in opening-section.tsx documenting the design decision.
  </verify>
  <done>
    Seed data updated in database with removed specialRules and fixed sourceUrl. Aspect openings isolation verified and documented. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes (schema changes propagated)
2. `pnpm build` succeeds
3. No references to SpecialRules or specialRules in app/ or convex/
4. No broken querki.net fragment URL in seed.ts
5. Opening section component has design decision comment about aspect isolation
</verification>

<success_criteria>
- Spirit detail page renders without SpecialRules section
- Opening sourceUrl in database points to https://querki.net/u/darker/spirit-island-faq (no fragment)
- Aspect pages correctly show only their own openings (empty for aspects with no seeded openings)
- TypeScript compilation and production build both pass
</success_criteria>

<output>
After completion, create `.planning/phases/03.6-simplify-spirit-board-text-openings/03.6-08-SUMMARY.md`
</output>
