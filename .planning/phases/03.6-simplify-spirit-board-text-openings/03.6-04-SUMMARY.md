---
phase: 03.6-simplify-spirit-board-text-openings
plan: 04
subsystem: database
tags: [convex, schema, openings, queries]

# Dependency graph
requires:
  - phase: 03.6-02
    provides: Cleaned spirit schema without deprecated board fields
provides:
  - Openings table schema with spiritId reference
  - Query functions for openings (listBySpirit, getBySlug)
  - Convex types generated for frontend integration
affects: [03.6-05, 03.6-06]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Openings table with text-based turn-by-turn instructions"
    - "spiritId reference for spirit-to-openings relationship"
    - "by_spirit and by_slug indexes for efficient queries"

key-files:
  created:
    - convex/openings.ts
  modified:
    - convex/schema.ts

key-decisions:
  - "Openings table uses spiritId to link to base spirits or aspects"
  - "Difficulty uses Beginner/Intermediate/Advanced literals"
  - "Turns array with structured turn/title/instructions/notes fields"

patterns-established:
  - "Text-based openings replace graphical board visualization"
  - "Opening queries indexed by spirit for list views and by slug for detail views"

# Metrics
duration: 4min
completed: 2026-01-28
---

# Phase 3.6 Plan 04: Openings Schema and Queries Summary

**Convex openings table with spiritId reference, text-based turn instructions, and listBySpirit/getBySlug query functions**

## Performance

- **Duration:** 4 min
- **Started:** 2026-01-28T12:55:38Z
- **Completed:** 2026-01-28T12:59:32Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments

- Added openings table to Convex schema with complete field structure
- Created query functions for listing openings by spirit and getting by slug
- Convex types generated and TypeScript compiles successfully

## Task Commits

Each task was committed atomically:

1. **Task 1: Add openings table to schema** - `d4b7cf7` (feat)
2. **Task 2: Create openings query functions** - `2ddb209` (feat)

## Files Created/Modified

- `convex/schema.ts` - Added openings table definition with indexes
- `convex/openings.ts` - Created listBySpirit and getBySlug query functions

## Decisions Made

- spiritId references base spirits or aspects (same table)
- difficulty field uses Beginner/Intermediate/Advanced literals (optional)
- turns array structure: turn number, optional title, instructions, optional notes
- author and sourceUrl fields for attribution (optional)

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Cleaned database with deprecated field data**
- **Found during:** Task 2 (Convex schema deployment)
- **Issue:** Existing database documents contained deprecated fields (growth, presenceTracks, innates, uniquePowers) from Phase 3.4, causing schema validation failure
- **Fix:** Temporarily removed schema for schemaless mode, ran reseedSpirits mutation to clean data, restored schema and deployed successfully
- **Files modified:** None (database cleanup only)
- **Verification:** Schema deployed successfully, typecheck passes
- **Committed in:** N/A (database operation, not code change)

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Database cleanup required due to stale data from abandoned Phase 3.4. No scope creep.

## Issues Encountered

- Convex schema validation is strict - cannot push schema when existing documents have fields not in the validator. Required schemaless deploy to run cleanup mutation first.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Openings table and queries ready for frontend integration
- Next: Create sample opening data for River/Lightning spirits
- Frontend can use `api.openings.listBySpirit` and `api.openings.getBySlug`

---
*Phase: 03.6-simplify-spirit-board-text-openings*
*Completed: 2026-01-28*
