# Phase 3.6: Simplify Spirit Board + Text Openings - Research

**Researched:** 2026-01-28
**Domain:** Frontend simplification, Convex schema design, Radix Accordion UI
**Confidence:** HIGH

## Summary

This phase involves two main workstreams: (1) removing complex board visualization components that proved overengineered (GrowthPanel, PresenceTrack, InnatePowers, CardHand), and (2) creating a new text-based opening guide system with a simple accordion UI.

The removal work is straightforward file deletion and schema cleanup. The new openings system follows existing Convex patterns (table with indexes, query functions) and uses the already-installed Radix Accordion primitive with shadcn/ui wrappers. URL state for multiple openings per spirit will follow the same pattern as variant tabs.

**Primary recommendation:** Use a phased approach: (1) remove unused components first, (2) clean schema fields, (3) create openings table, (4) build accordion UI, (5) wire up URL state for opening selection.

## Standard Stack

The project already has all required dependencies. No new packages needed.

### Core (Already Installed)

| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| `convex` | latest | Backend database and functions | Project's data layer |
| `@radix-ui/react-accordion` | latest | Accessible accordion primitive | Already in project via shadcn/ui |
| `@tanstack/react-router` | latest | URL state management | Project's routing solution |

### Supporting (Already Installed)

| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| `@radix-ui/react-tabs` | latest | Tab navigation for multiple openings | Already used for variant tabs |
| `@radix-ui/react-collapsible` | latest | Alternative to accordion | Already used for overview section |

### Alternatives Considered

| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Accordion | Collapsible | Accordion handles multiple items + default values better |
| URL params | React state | URL state allows sharing/bookmarking specific openings |

**Installation:** None required - all dependencies already present.

## Architecture Patterns

### Recommended Project Structure

```
convex/
├── schema.ts           # Add openings table, remove unused spirit fields
├── spirits.ts          # No changes needed
├── openings.ts         # NEW: queries for openings
├── seed.ts             # Remove board-related seed data, add sample openings

app/
├── routes/
│   ├── spirits.$slug.tsx         # Simplified spirit detail (remove board sections)
│   └── spirits.$slug.$aspect.tsx # Same changes, uses shared content component
├── components/
│   └── spirits/
│       ├── opening-list.tsx      # NEW: shows available openings
│       ├── opening-tabs.tsx      # NEW: tabs for multiple openings
│       └── turn-accordion.tsx    # NEW: accordion for turn-by-turn guide
│       # REMOVE: growth-panel.tsx, presence-track.tsx, innate-powers.tsx,
│       #         card-hand.tsx, graph-presence-track.tsx, presence-node.tsx,
│       #         edge-overlay.tsx
│   └── icons/
│       └── growth/               # REMOVE: entire folder (reclaim, energy, power-card, presence)
```

### Pattern 1: Convex Table with Spirit Reference

**What:** Create openings table with foreign key to spirits
**When to use:** When data relates to a specific spirit/variant
**Example:**

```typescript
// Source: Convex docs - https://docs.convex.dev/database/schemas
// convex/schema.ts
import { defineSchema, defineTable } from "convex/server";
import { v } from "convex/values";

export default defineSchema({
  openings: defineTable({
    spiritId: v.id("spirits"),       // Link to spirit (base or aspect)
    slug: v.string(),                // URL-friendly identifier: "standard-opening"
    name: v.string(),                // Display name: "Standard Opening"
    description: v.optional(v.string()), // Brief summary
    difficulty: v.optional(v.union(  // Optional difficulty rating
      v.literal("Beginner"),
      v.literal("Intermediate"),
      v.literal("Advanced"),
    )),
    turns: v.array(                  // Turn-by-turn text instructions
      v.object({
        turn: v.number(),            // Turn 1, 2, 3, etc.
        title: v.optional(v.string()), // "Setup" or "Turn 1: Establishing Presence"
        instructions: v.string(),    // Main text content for this turn
        notes: v.optional(v.string()), // Additional context/tips
      }),
    ),
    author: v.optional(v.string()),  // Attribution
    sourceUrl: v.optional(v.string()), // Link to original guide
  })
    .index("by_spirit", ["spiritId"])
    .index("by_slug", ["slug"]),
});
```

### Pattern 2: Radix Accordion with Default Open

**What:** Use Accordion with `type="multiple"` and `defaultValue` for turns
**When to use:** When displaying turn-by-turn content with all turns visible by default
**Example:**

```tsx
// Source: https://www.radix-ui.com/primitives/docs/components/accordion
import {
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger,
} from "@/components/ui/accordion";

interface Turn {
  turn: number;
  title?: string;
  instructions: string;
  notes?: string;
}

function TurnAccordion({ turns }: { turns: Turn[] }) {
  // Default all turns to open
  const defaultValues = turns.map((t) => `turn-${t.turn}`);

  return (
    <Accordion type="multiple" defaultValue={defaultValues}>
      {turns.map((turn) => (
        <AccordionItem key={turn.turn} value={`turn-${turn.turn}`}>
          <AccordionTrigger>
            {turn.title || `Turn ${turn.turn}`}
          </AccordionTrigger>
          <AccordionContent>
            <p>{turn.instructions}</p>
            {turn.notes && (
              <p className="text-sm text-muted-foreground mt-2">{turn.notes}</p>
            )}
          </AccordionContent>
        </AccordionItem>
      ))}
    </Accordion>
  );
}
```

### Pattern 3: URL State for Opening Selection

**What:** Store selected opening in URL for shareable links
**When to use:** When user selects from multiple openings
**Example:**

```tsx
// Source: https://tanstack.com/router/latest/docs/framework/react/guide/search-params
import { useNavigate, useSearch } from "@tanstack/react-router";

function OpeningTabs({ openings }: { openings: Opening[] }) {
  const navigate = useNavigate();
  const search = useSearch({ strict: false }) as { opening?: string };

  const currentOpening = search.opening || openings[0]?.slug;

  return (
    <Tabs
      value={currentOpening}
      onValueChange={(value) => {
        navigate({
          search: (prev) => ({ ...prev, opening: value }),
        });
      }}
    >
      {/* Tab content */}
    </Tabs>
  );
}
```

### Anti-Patterns to Avoid

- **Don't store opening selection in React state only:** Loses state on refresh, not shareable
- **Don't create deeply nested schema:** Keep turns as simple array, not separate table
- **Don't remove components before removing their imports:** Causes build failures
- **Don't forget to clean seed data:** Old spirit data with removed fields will cause validation errors

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Accordion animation | Custom CSS/JS | Radix Accordion | Handles height animation, accessibility |
| URL state sync | Manual query string parsing | TanStack Router search params | Type-safe, integrates with router |
| Multiple open sections | Custom state management | Accordion `type="multiple"` | Built-in support for multiple open |

**Key insight:** The project already has shadcn/ui accordion component at `app/components/ui/accordion.tsx` - use it directly.

## Common Pitfalls

### Pitfall 1: Build Failures from Import Errors

**What goes wrong:** Remove component files but forget to remove imports from route files
**Why it happens:** Route files import multiple components; easy to miss one
**How to avoid:** Run `pnpm typecheck` after each file deletion
**Warning signs:** TypeScript errors mentioning missing modules

### Pitfall 2: Convex Schema Migration Issues

**What goes wrong:** Removing fields from schema while data still has those fields
**Why it happens:** Convex validates existing data against schema
**How to avoid:** Clear/reseed data after schema changes, or make fields optional first
**Warning signs:** Convex deployment errors about schema validation

### Pitfall 3: E2E Test Failures

**What goes wrong:** Tests assert on removed headings like "Growth", "Presence Tracks"
**Why it happens:** Existing tests check for board section headings
**How to avoid:** Update `e2e/spirits.spec.ts` to remove board section assertions
**Warning signs:** Test failure: "Expected heading 'Growth' to be visible"

### Pitfall 4: Accordion Default State

**What goes wrong:** Accordion renders with all items collapsed
**Why it happens:** Missing `defaultValue` prop or wrong value format
**How to avoid:** Pass array of string values matching AccordionItem `value` props
**Warning signs:** User has to manually open each turn to see content

## Code Examples

Verified patterns from the project codebase:

### Query Openings by Spirit ID

```typescript
// convex/openings.ts
import { v } from "convex/values";
import { query } from "./_generated/server";

export const listBySpirit = query({
  args: { spiritId: v.id("spirits") },
  handler: async (ctx, args) => {
    return await ctx.db
      .query("openings")
      .withIndex("by_spirit", (q) => q.eq("spiritId", args.spiritId))
      .collect();
  },
});

export const getBySlug = query({
  args: { slug: v.string() },
  handler: async (ctx, args) => {
    return await ctx.db
      .query("openings")
      .withIndex("by_slug", (q) => q.eq("slug", args.slug))
      .first();
  },
});
```

### Simplified Spirit Detail Content

```tsx
// Pattern from existing spirits.$slug.tsx - simplified version
export function SpiritDetailContent({ spirit, slug }: SpiritDetailContentProps) {
  return (
    <main className="p-4 lg:grid lg:grid-cols-[1fr_340px] lg:gap-8 lg:max-w-6xl lg:mx-auto">
      <div className="space-y-6">
        {/* Image, name, badges - KEEP */}
        <SpiritHeader spirit={spirit} />

        {/* Overview section - KEEP */}
        <div className="lg:hidden">
          <OverviewSection spirit={spirit} description={spirit.description} />
        </div>

        {/* Special rules - KEEP */}
        {spirit.specialRules && spirit.specialRules.length > 0 && (
          <SpecialRules rules={spirit.specialRules} />
        )}

        {/* REMOVED: GrowthPanel, PresenceTrack, InnatePowers, CardHand */}

        {/* NEW: Openings section */}
        <OpeningsSection spiritId={spirit._id} />

        {/* External links - KEEP */}
        <ExternalLinks spiritName={spirit.name} wikiUrl={spirit.wikiUrl} />
      </div>

      {/* Desktop sidebar - KEEP */}
      <aside className="hidden lg:block lg:sticky lg:top-28 lg:self-start">
        <OverviewSection spirit={spirit} description={spirit.description} />
      </aside>
    </main>
  );
}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Complex board visualization | Simple text openings | Phase 3.6 | Much simpler to maintain |
| Node-Edge Graph DSL | N/A (removed) | Phase 3.6 | Reduces schema complexity |
| Growth icons/actions | N/A (removed) | Phase 3.6 | Fewer components to maintain |

**Deprecated/outdated:**
- `growth` schema field: Remove entirely
- `presenceTracks` schema field: Remove entirely
- `innates` schema field: Remove entirely
- `uniquePowers` schema field: Remove entirely

## Open Questions

No significant open questions. The approach is clear:

1. **Schema simplification:** Remove fields that are no longer needed, add openings table
2. **Component removal:** Delete unused component files, update imports
3. **New components:** Build simple accordion-based opening display
4. **URL state:** Follow existing variant tabs pattern for opening selection

## Sources

### Primary (HIGH confidence)

- Convex schema docs: https://docs.convex.dev/database/schemas - Table definition patterns
- Radix Accordion: https://www.radix-ui.com/primitives/docs/components/accordion - API reference
- TanStack Router search params: https://tanstack.com/router/latest/docs/framework/react/guide/search-params - URL state patterns

### Secondary (HIGH confidence - existing codebase)

- `/Users/florin/personal/the-dahan-codex/convex/schema.ts` - Current schema structure
- `/Users/florin/personal/the-dahan-codex/app/components/spirits/variant-tabs.tsx` - URL state pattern
- `/Users/florin/personal/the-dahan-codex/app/components/ui/accordion.tsx` - Existing accordion component

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - All dependencies already installed, patterns established
- Architecture: HIGH - Following existing project patterns
- Pitfalls: HIGH - Based on TypeScript, Convex, and test knowledge

**Research date:** 2026-01-28
**Valid until:** 2026-02-28 (30 days - stable domain)

---

## Appendix: Files to Remove

### Components to Delete

```
app/components/spirits/growth-panel.tsx
app/components/spirits/presence-track.tsx
app/components/spirits/graph-presence-track.tsx
app/components/spirits/presence-node.tsx
app/components/spirits/edge-overlay.tsx
app/components/spirits/innate-powers.tsx
app/components/spirits/card-hand.tsx
app/components/icons/growth/reclaim.tsx
app/components/icons/growth/energy.tsx
app/components/icons/growth/power-card.tsx
app/components/icons/growth/presence.tsx
app/components/icons/growth/index.ts (if exists)
```

### Schema Fields to Remove

From `spirits` table:
- `growth`
- `presenceTracks`
- `innates`
- `uniquePowers`

Also remove the `elementValidator` if only used by presenceTracks.

### E2E Tests to Update

`e2e/spirits.spec.ts`:
- Remove test: "spirit detail shows board sections"
- Update assertions that check for Growth, Presence Tracks, Innate Powers, Cards headings

### Seed Data to Clean

`convex/seed.ts`:
- Remove `growth`, `presenceTracks`, `innates`, `uniquePowers` from all spirit objects
- Add sample opening data for River Surges in Sunlight
