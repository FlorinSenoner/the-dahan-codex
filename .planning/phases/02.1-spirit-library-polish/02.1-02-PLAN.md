---
phase: 02.1-spirit-library-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/scrape-spirits.ts
  - package.json
  - public/spirits/
autonomous: true

must_haves:
  truths:
    - "Spirit images exist locally in public/spirits/"
    - "Images load correctly in the app"
  artifacts:
    - path: "scripts/scrape-spirits.ts"
      provides: "Wiki image scraping script"
      min_lines: 50
    - path: "public/spirits/river-surges-in-sunlight.webp"
      provides: "River spirit image"
    - path: "public/spirits/lightnings-swift-strike.webp"
      provides: "Lightning spirit image"
  key_links:
    - from: "convex/seed.ts"
      to: "public/spirits/"
      via: "imageUrl field"
      pattern: "/spirits/.*\\.webp"
---

<objective>
Create a script to scrape spirit images from the Spirit Island wiki and save them locally to public/spirits/.

Purpose: UAT identified broken/missing images. The current imageUrl values point to local paths that don't exist. Need to download actual spirit panel art from the wiki.

Output: Scraping script in scripts/, cheerio dev dependency, and actual spirit images in public/spirits/.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02.1-spirit-library-polish/02.1-RESEARCH.md

@convex/seed.ts (for imageUrl paths)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cheerio dev dependency</name>
  <files>package.json</files>
  <action>
Add cheerio as a dev dependency for HTML parsing:

```bash
pnpm add -D cheerio
```

Cheerio is only needed for the one-time scraping script, not runtime.
  </action>
  <verify>Run `pnpm install` and verify cheerio is in devDependencies in package.json.</verify>
  <done>cheerio is installed as dev dependency.</done>
</task>

<task type="auto">
  <name>Task 2: Create spirit image scraping script</name>
  <files>scripts/scrape-spirits.ts</files>
  <action>
Create a TypeScript script to download spirit images from the wiki:

```typescript
/**
 * One-time script to scrape spirit images from Spirit Island wiki
 * Run with: npx tsx scripts/scrape-spirits.ts
 */
import * as cheerio from "cheerio";
import * as fs from "node:fs";
import * as https from "node:https";
import * as path from "node:path";

const WIKI_BASE = "https://spiritislandwiki.com";
const OUTPUT_DIR = "public/spirits";

// Spirits to download (slug -> wiki page title)
const SPIRITS: Record<string, string> = {
  "river-surges-in-sunlight": "River_Surges_in_Sunlight",
  "lightnings-swift-strike": "Lightning%27s_Swift_Strike",
};

async function fetchPage(url: string): Promise<string> {
  return new Promise((resolve, reject) => {
    https.get(url, (res) => {
      // Handle redirects
      if (res.statusCode === 301 || res.statusCode === 302) {
        const redirectUrl = res.headers.location;
        if (redirectUrl) {
          fetchPage(redirectUrl.startsWith("http") ? redirectUrl : `${WIKI_BASE}${redirectUrl}`)
            .then(resolve)
            .catch(reject);
          return;
        }
      }
      let data = "";
      res.on("data", (chunk) => (data += chunk));
      res.on("end", () => resolve(data));
      res.on("error", reject);
    }).on("error", reject);
  });
}

async function downloadImage(url: string, dest: string): Promise<void> {
  return new Promise((resolve, reject) => {
    const fullUrl = url.startsWith("http") ? url : `https:${url}`;
    https.get(fullUrl, (res) => {
      // Handle redirects
      if (res.statusCode === 301 || res.statusCode === 302) {
        const redirectUrl = res.headers.location;
        if (redirectUrl) {
          downloadImage(redirectUrl, dest).then(resolve).catch(reject);
          return;
        }
      }
      const file = fs.createWriteStream(dest);
      res.pipe(file);
      file.on("finish", () => {
        file.close();
        resolve();
      });
    }).on("error", reject);
  });
}

async function scrapeSpirit(slug: string, wikiTitle: string): Promise<void> {
  const url = `${WIKI_BASE}/index.php?title=${wikiTitle}`;
  console.log(`Fetching ${url}...`);

  const html = await fetchPage(url);
  const $ = cheerio.load(html);

  // Find the spirit panel image (usually in infobox or main content)
  // Wiki structure: look for the main spirit image
  const imgSelectors = [
    ".infobox img",
    ".thumbinner img",
    'img[alt*="' + slug.replace(/-/g, " ") + '"]',
    ".mw-parser-output img",
  ];

  let imgSrc: string | undefined;
  for (const selector of imgSelectors) {
    const img = $(selector).first();
    const src = img.attr("src");
    if (src && !src.includes("thumb") && (src.includes("Spirit") || src.includes("panel"))) {
      imgSrc = src;
      break;
    }
    // Also try data-src for lazy-loaded images
    const dataSrc = img.attr("data-src");
    if (dataSrc) {
      imgSrc = dataSrc;
      break;
    }
  }

  // Fallback: just get the first large image
  if (!imgSrc) {
    $("img").each((_, el) => {
      const src = $(el).attr("src");
      if (src && !imgSrc && !src.includes("thumb") && !src.includes("logo")) {
        imgSrc = src;
      }
    });
  }

  if (!imgSrc) {
    console.error(`Could not find image for ${slug}`);
    return;
  }

  // Download the image
  const ext = path.extname(imgSrc).split("?")[0] || ".png";
  const destPath = path.join(OUTPUT_DIR, `${slug}${ext === ".webp" ? ext : ".webp"}`);

  console.log(`Downloading ${imgSrc} -> ${destPath}`);

  // For now, save as the original format then note to convert
  const actualDest = path.join(OUTPUT_DIR, `${slug}${ext}`);
  await downloadImage(imgSrc, actualDest);
  console.log(`Saved: ${actualDest}`);
}

async function main() {
  // Ensure output directory exists
  if (!fs.existsSync(OUTPUT_DIR)) {
    fs.mkdirSync(OUTPUT_DIR, { recursive: true });
  }

  for (const [slug, wikiTitle] of Object.entries(SPIRITS)) {
    try {
      await scrapeSpirit(slug, wikiTitle);
    } catch (error) {
      console.error(`Error scraping ${slug}:`, error);
    }
  }

  console.log("\nDone! Images saved to", OUTPUT_DIR);
  console.log("Note: You may need to convert images to webp format manually.");
}

main();
```

The script:
- Fetches wiki pages for each spirit
- Parses HTML with cheerio to find spirit panel images
- Downloads images to public/spirits/
- Handles redirects and various image source patterns
  </action>
  <verify>Run `npx tsx scripts/scrape-spirits.ts` and check that images are downloaded to public/spirits/.</verify>
  <done>Script created and downloads images successfully.</done>
</task>

<task type="auto">
  <name>Task 3: Run scraper and verify images</name>
  <files>public/spirits/</files>
  <action>
1. Run the scraping script:
   ```bash
   npx tsx scripts/scrape-spirits.ts
   ```

2. Verify images exist in public/spirits/:
   - river-surges-in-sunlight.webp (or .png/.jpg)
   - lightnings-swift-strike.webp (or .png/.jpg)

3. If images are not .webp format, convert them or update seed.ts imageUrl to match actual extension.

4. Test by running `pnpm dev` and navigating to /spirits to see images load.

**Alternative approach if wiki scraping is blocked:**
- Manually download spirit panel images from the wiki
- Save as public/spirits/river-surges-in-sunlight.webp
- Save as public/spirits/lightnings-swift-strike.webp

The wiki has these images at:
- https://spiritislandwiki.com/index.php?title=River_Surges_in_Sunlight
- https://spiritislandwiki.com/index.php?title=Lightning%27s_Swift_Strike
  </action>
  <verify>Images exist in public/spirits/ directory. Run `pnpm dev` and navigate to http://localhost:5173/spirits - images should load without 404 errors.</verify>
  <done>Spirit images are downloaded locally and display correctly in the app.</done>
</task>

</tasks>

<verification>
- cheerio is in package.json devDependencies
- scripts/scrape-spirits.ts exists and runs without errors
- public/spirits/ contains at least 2 spirit images
- Images load correctly when viewing /spirits in browser
- No 404 errors for image requests in network tab
</verification>

<success_criteria>
- Spirit images are stored locally in public/spirits/
- Images are referenced correctly by seed data imageUrl
- Images load in the spirit list and detail pages
- No external image hotlinking (all served from own domain)
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-spirit-library-polish/02.1-02-SUMMARY.md`
</output>
