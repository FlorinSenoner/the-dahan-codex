# Phase 2.1: Spirit Library Polish - Research

**Researched:** 2026-01-25
**Domain:** UI Polish, Data Gaps, SSR Patterns, View Transitions
**Confidence:** HIGH

## Summary

This phase addresses 9 UAT issues from Phase 2, spanning data gaps (missing Immense aspect, incorrect complexity values), UI polish (touch targets, pointer cursors, color coding), SSR errors (Convex queries outside provider during server render), and view transitions (not animating between list and detail).

The current implementation already has view transitions enabled via `defaultViewTransition: true` in the router and `view-transition-name` CSS properties on elements. The SSR pattern using `isClient` state with `useQuery(..., isClient ? args : "skip")` is the correct Convex pattern. The SSR errors are occurring because during server render, the `RootLayout` component returns `<Outlet />` before mounting, which means child components using `useQuery` don't have the ConvexProvider in their tree.

**Primary recommendation:** Fix SSR by making the isClient check at the root level consistent, add complexity modifiers to schema/data, scrape images from wiki, and ensure touch targets meet 44px minimum.

## Standard Stack

The established libraries/tools for this domain:

### Core (Already in Project)
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| TanStack Router | 1.157.9 | Routing with view transitions | Built-in `defaultViewTransition` support |
| Convex React | 1.31.6 | Data fetching with skip pattern | Native SSR-safe `"skip"` argument |
| Tailwind CSS | 4.1.18 | Styling with CSS-first config | Already configured with element colors |
| Lucide React | 0.563.0 | Icons | Already used for Filter, X, ArrowLeft |

### Supporting (For Scraping Script)
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| cheerio | 1.0.0 | HTML parsing | Static wiki page scraping |
| node:fs | built-in | File system | Saving downloaded images |
| node:https | built-in | HTTP requests | Fetching wiki pages and images |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| cheerio | puppeteer | Puppeteer is overkill for static MediaWiki pages |
| Manual script | MediaWiki API | API would be cleaner but wiki images are directly linkable |

**No new runtime dependencies needed** - all polish is CSS/data/component changes.

## Architecture Patterns

### Pattern 1: SSR-Safe Convex Queries

**What:** The current `isClient` state pattern is correct but needs to be applied consistently.

**Current Problem:** The `RootLayout` returns `<Outlet />` before `isMounted` is true, but child components still try to render and call `useQuery` before the provider is available.

**Solution:** The `useQuery(..., "skip")` pattern is already correct in `spirit-list.tsx` and `spirits.$slug.tsx`. The SSR error occurs because React attempts to render the component tree during SSR even though `RootLayout` early-returns. Ensure ALL components using `useQuery` follow the skip pattern.

```typescript
// Source: https://docs.convex.dev/client/react
// Correct pattern - already implemented
const [isClient, setIsClient] = useState(false);
useEffect(() => {
  setIsClient(true);
}, []);

const data = useQuery(
  api.spirits.listSpirits,
  isClient ? { complexity: filters.complexity } : "skip",
);
```

**Why it works:** The `"skip"` argument tells Convex to not execute the query at all, avoiding the provider lookup.

### Pattern 2: View Transition Element Matching

**What:** Elements with matching `view-transition-name` values animate between old and new states.

**Current Implementation:** Already set up correctly with:
- `spirit-image-{slug}` for base spirit images
- `spirit-name-{slug}` for base spirit names
- `spirit-aspect-{name}` for aspect images

**Why Not Working:** View transitions require the browser's View Transitions API to capture snapshots. TanStack Router's `defaultViewTransition: true` should trigger `document.startViewTransition()` automatically. Verify:
1. Browser supports View Transitions (Chrome 111+, Safari 18+, Firefox 144+)
2. The `view-transition-name` values match EXACTLY between list and detail views
3. No duplicate `view-transition-name` values on screen simultaneously

```css
/* Source: MDN - already in globals.css */
[style*="view-transition-name: spirit-image-"]::view-transition-old,
[style*="view-transition-name: spirit-image-"]::view-transition-new {
  animation-duration: 500ms;
}
```

**Issue:** The CSS selectors `[style*="view-transition-name:"]` won't work because `view-transition-name` needs to be a proper CSS property, not an inline style attribute selector for the pseudo-elements. The pseudo-elements use the NAME as an argument: `::view-transition-old(spirit-image-river)`.

### Pattern 3: Touch Target Sizing

**What:** Mobile touch targets must be at least 44x44 CSS pixels (WCAG 2.5.5 AAA) or 24x24 (WCAG 2.5.8 AA).

**UAT Requirement:** 42px minimum (between AA and AAA).

**Implementation:**
```typescript
// For icon buttons
<Button
  variant="outline"
  size="icon"
  className="min-w-[44px] min-h-[44px] cursor-pointer"
>
  <Filter className="h-5 w-5" />
</Button>

// For filter pills
<button
  className="min-h-[44px] px-4 py-2 cursor-pointer"
>
  {label}
</button>
```

### Pattern 4: Aspect Complexity Modifiers

**What:** Aspects show complexity relative to base spirit, not absolute complexity.

**Data Model Change:**
```typescript
// Current schema (convex/schema.ts)
complexity: v.union(
  v.literal("Low"),
  v.literal("Moderate"),
  v.literal("High"),
  v.literal("Very High"),
),

// Add for aspects
complexityModifier: v.optional(v.union(
  v.literal("easier"),
  v.literal("same"),
  v.literal("harder"),
)),
```

**Display Pattern:**
```typescript
// Modifier icons with colors
const modifierConfig = {
  easier: { icon: ArrowDown, color: "text-element-plant", label: "Easier" },
  same: { icon: Equal, color: "text-muted-foreground", label: "Same" },
  harder: { icon: ArrowUp, color: "text-element-fire", label: "Harder" },
};
```

### Recommended Project Structure

```
app/
├── components/
│   └── spirits/
│       ├── spirit-row.tsx       # Add complexity modifier display
│       ├── spirit-list.tsx      # Already has SSR-safe pattern
│       ├── filter-sheet.tsx     # Add element colors, touch targets
│       └── filter-chips.tsx     # Add touch targets, cursor
├── routes/
│   └── spirits.$slug.tsx        # Fix aspect title display
convex/
├── schema.ts                    # Add complexityModifier, description fields
├── seed.ts                      # Update with Immense, modifiers, descriptions
└── spirits.ts                   # No changes needed
scripts/
└── scrape-spirits.ts            # NEW: One-time image scraper
```

### Anti-Patterns to Avoid

- **Inline style selectors for view-transition pseudo-elements:** The CSS `[style*="view-transition-name:"]::view-transition-old` won't work. Use `::view-transition-old(name)` with the actual name.
- **Hardcoded px for touch targets:** Use `min-w-[44px]` not `w-[44px]` to allow growth.
- **Missing cursor-pointer:** All interactive elements must have `cursor-pointer` class.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Image scraping | Complex fetch + parse | cheerio + simple script | One-time operation, wiki is static HTML |
| Touch target enforcement | Per-component sizing | Tailwind utility classes | Consistent, reusable |
| View transitions | Custom animation library | Native View Transitions API | Browser-native, TanStack Router integrated |
| Element colors | New color definitions | Existing `--element-*` CSS variables | Already defined in globals.css |

**Key insight:** All required functionality exists in the current stack. This phase is polish, not new features.

## Common Pitfalls

### Pitfall 1: View Transition Name Uniqueness
**What goes wrong:** Two elements with same `view-transition-name` on screen simultaneously causes transition to skip.
**Why it happens:** List shows all spirits, each needs unique name.
**How to avoid:** Use `spirit-image-{slug}` pattern (already correct).
**Warning signs:** `ViewTransition.ready` rejects, no animation occurs.

### Pitfall 2: SSR Hydration Mismatch
**What goes wrong:** Server renders different content than client initial render.
**Why it happens:** `isClient` starts as `false`, query returns `undefined`, but server might render differently.
**How to avoid:** Render identical loading skeleton on both server and initial client render.
**Warning signs:** React hydration warnings in console.

### Pitfall 3: Wiki Image Hotlinking
**What goes wrong:** Images fail to load or get blocked.
**Why it happens:** Wiki might have hotlink protection or rate limiting.
**How to avoid:** Download images locally to `/public/spirits/`, serve from own domain.
**Warning signs:** 403 errors, broken images after initial load.

### Pitfall 4: Aspect Complexity Data Inconsistency
**What goes wrong:** Filtering by complexity shows unexpected results.
**Why it happens:** Aspects stored with absolute complexity but filtered by base spirit complexity.
**How to avoid:** Keep aspects' `complexity` field matching base spirit, use `complexityModifier` for display only.
**Warning signs:** "Sunshine" aspect (same complexity) not appearing when filtering "Low".

### Pitfall 5: Clear All Button Layout Shift
**What goes wrong:** Button appearing/disappearing shifts other elements.
**Why it happens:** Conditional rendering without reserved space.
**How to avoid:** Always render button, use `visibility: hidden` or `opacity: 0` when inactive, OR reserve fixed width.
**Warning signs:** Visual jank when adding first filter.

## Code Examples

### Verified: SSR-Safe Convex Query Pattern
```typescript
// Source: https://docs.convex.dev/client/react - "skip" pattern
const [isClient, setIsClient] = useState(false);
useEffect(() => {
  setIsClient(true);
}, []);

const spirits = useQuery(
  api.spirits.listSpirits,
  isClient
    ? { complexity: filters.complexity, elements: filters.elements }
    : "skip",
);
```

### Verified: View Transition CSS Pseudo-elements
```css
/* Source: MDN - view-transition-name */
/* Correct: Use the name as pseudo-element argument */
::view-transition-old(spirit-image-river) {
  animation-duration: 500ms;
}

::view-transition-new(spirit-image-river) {
  animation-duration: 500ms;
}

/* For dynamic names, use a class-based approach or :root selector */
::view-transition-group(*) {
  animation-duration: 400ms;
  animation-timing-function: ease-in-out;
}
```

### Verified: Touch Target with Cursor
```typescript
// Source: WCAG 2.5.5 (44px AAA target)
<Button
  variant="outline"
  size="icon"
  className="min-w-[44px] min-h-[44px] cursor-pointer"
  aria-label="Filter"
>
  <Filter className="h-5 w-5" />
</Button>
```

### Verified: Element Color Styling
```typescript
// Source: Project globals.css - already has element colors
const elementColors: Record<string, string> = {
  Sun: "bg-element-sun/20 text-element-sun border-element-sun/30",
  Moon: "bg-element-moon/20 text-element-moon border-element-moon/30",
  Fire: "bg-element-fire/20 text-element-fire border-element-fire/30",
  Air: "bg-element-air/20 text-element-air border-element-air/30",
  Water: "bg-element-water/20 text-element-water border-element-water/30",
  Earth: "bg-element-earth/20 text-element-earth border-element-earth/30",
  Plant: "bg-element-plant/20 text-element-plant border-element-plant/30",
  Animal: "bg-element-animal/20 text-element-animal border-element-animal/30",
};
```

### Example: Complexity Modifier Display
```typescript
// Pattern for aspect rows
import { ArrowUp, ArrowDown, Equal } from "lucide-react";

const modifierIcons = {
  easier: <ArrowDown className="h-4 w-4 text-element-plant" />,
  same: <Equal className="h-4 w-4 text-muted-foreground" />,
  harder: <ArrowUp className="h-4 w-4 text-element-fire" />,
};

// In aspect row
{isAspect && spirit.complexityModifier && (
  <span className="flex items-center gap-1 text-xs">
    {modifierIcons[spirit.complexityModifier]}
  </span>
)}
```

### Example: Wiki Image Scraping Script
```typescript
// scripts/scrape-spirits.ts - one-time script
import * as cheerio from "cheerio";
import * as fs from "node:fs";
import * as https from "node:https";
import * as path from "node:path";

const WIKI_BASE = "https://spiritislandwiki.com";
const SPIRITS_PAGE = `${WIKI_BASE}/index.php?title=List_of_Spirits`;

async function fetchPage(url: string): Promise<string> {
  return new Promise((resolve, reject) => {
    https.get(url, (res) => {
      let data = "";
      res.on("data", (chunk) => data += chunk);
      res.on("end", () => resolve(data));
      res.on("error", reject);
    });
  });
}

async function downloadImage(url: string, dest: string): Promise<void> {
  return new Promise((resolve, reject) => {
    const file = fs.createWriteStream(dest);
    https.get(url, (res) => {
      res.pipe(file);
      file.on("finish", () => {
        file.close();
        resolve();
      });
    }).on("error", reject);
  });
}

// Main scraping logic
async function scrapeSpirits() {
  const html = await fetchPage(SPIRITS_PAGE);
  const $ = cheerio.load(html);

  // Find spirit image links and download
  $("table.wikitable img").each(async (_, el) => {
    const src = $(el).attr("src");
    if (src) {
      const fullUrl = src.startsWith("http") ? src : `${WIKI_BASE}${src}`;
      const filename = path.basename(src).split("/").pop() || "spirit.png";
      await downloadImage(fullUrl, `public/spirits/${filename}`);
    }
  });
}
```

## Spirit Data Reference

### Lightning's Swift Strike Aspects
| Aspect | Complexity Modifier | Expansion |
|--------|-------------------|-----------|
| Immense | Harder | Promo Pack 2 / Feather and Flame |
| Pandemonium | Harder | Jagged Earth |
| Sparking | Harder | Nature Incarnate |
| Wind | Harder | Jagged Earth |

### River Surges in Sunlight Aspects
| Aspect | Complexity Modifier | Expansion |
|--------|-------------------|-----------|
| Sunshine | Harder | Jagged Earth |
| Travel | Harder | Promo Pack 2 / Feather and Flame |
| Haven | Harder | Nature Incarnate |

**Note:** All aspects researched show "Higher Complexity" on the wiki, meaning they all make the spirit harder to play.

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| JS animation libraries | View Transitions API | Chrome 111 (Mar 2023) | Native, performant, CSS-controlled |
| Complex SSR data loading | Convex "skip" pattern | Convex 1.0 | Simple conditional skip |
| 48dp Material / 44pt Apple | WCAG 2.5.8 24px AA / 2.5.5 44px AAA | WCAG 2.2 (Oct 2023) | Standardized accessibility |

**Deprecated/outdated:**
- React experimental startViewTransition: Native API is now stable
- Manual flushSync with View Transitions: TanStack Router handles this internally

## Open Questions

1. **Wiki Image Licensing**
   - What we know: Spirit Island wiki hosts images from Greater Than Games
   - What's unclear: Exact licensing terms for app usage
   - Recommendation: Download and self-host, include attribution in credits page

2. **View Transition Browser Support in Target Demographic**
   - What we know: Chrome 111+, Safari 18+, Firefox 144+ support it
   - What's unclear: What browsers Spirit Island players actually use
   - Recommendation: Implement with graceful degradation (transitions enhance, not required)

3. **Additional Spirits Beyond Seed Data**
   - What we know: Only 2 base spirits + 7 aspects currently seeded
   - What's unclear: Full spirit data entry scope for this phase
   - Recommendation: Focus on fixing the 2 spirits, defer full data entry to separate phase

## Sources

### Primary (HIGH confidence)
- [Convex React Docs](https://docs.convex.dev/client/react) - useQuery skip pattern
- [MDN View Transition API](https://developer.mozilla.org/en-US/docs/Web/API/View_Transition_API) - API reference
- [MDN view-transition-name](https://developer.mozilla.org/en-US/docs/Web/CSS/Reference/Properties/view-transition-name) - CSS property
- [WCAG 2.5.5](https://www.w3.org/WAI/WCAG22/Understanding/target-size-enhanced.html) - Touch target sizing
- [WCAG 2.5.8](https://www.w3.org/WAI/WCAG22/Understanding/target-size-minimum.html) - Minimum target size

### Secondary (MEDIUM confidence)
- [Spirit Island Wiki - List of Spirits](https://spiritislandwiki.com/index.php?title=List_of_Spirits) - Spirit data reference
- [Spirit Island Wiki - List of Aspect Cards](https://spiritislandwiki.com/index.php?title=List_of_Aspect_Cards) - Aspect data
- [Spirit Island Wiki - Immense](https://spiritislandwiki.com/index.php?title=Immense) - Immense aspect details
- [TanStack Router View Transitions](https://tanstack.com/router/v1/docs/framework/react/examples/view-transitions) - Router integration
- [Can I Use - View Transitions](https://caniuse.com/view-transitions) - Browser support

### Tertiary (LOW confidence)
- [Cheerio vs Puppeteer](https://brightdata.com/blog/web-data/cheerio-vs-puppeteer) - Scraping approach comparison

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - All libraries already in project, no new dependencies
- Architecture patterns: HIGH - Verified with official Convex and MDN docs
- Pitfalls: HIGH - Based on actual UAT feedback and standard web patterns
- Spirit data: MEDIUM - Wiki data verified but complexity modifiers need cross-reference

**Research date:** 2026-01-25
**Valid until:** 2026-02-25 (30 days - stable patterns, no fast-moving dependencies)
