---
phase: 02-spirit-library
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - app/routes/spirits.tsx
  - app/components/spirits/spirit-row.tsx
  - app/components/spirits/spirit-list.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to /spirits and see a list of spirits"
    - "Each spirit row shows image, name, summary, and complexity badge"
    - "Aspects appear indented under their base spirit"
    - "Tapping a row navigates to spirit detail URL"
  artifacts:
    - path: "app/routes/spirits.tsx"
      provides: "Spirit list route with Convex query"
      contains: "createFileRoute"
    - path: "app/components/spirits/spirit-row.tsx"
      provides: "Individual spirit row component"
      exports: ["SpiritRow"]
    - path: "app/components/spirits/spirit-list.tsx"
      provides: "Spirit list container component"
      exports: ["SpiritList"]
  key_links:
    - from: "app/routes/spirits.tsx"
      to: "convex/spirits.ts"
      via: "useQuery(api.spirits.listSpirits)"
      pattern: "useQuery.*listSpirits"
    - from: "app/components/spirits/spirit-row.tsx"
      to: "app/routes/spirits.$slug.tsx"
      via: "Link component navigation"
      pattern: 'to="/spirits/\\$slug"'
---

<objective>
Create the spirit list route and components that display all spirits with their aspects indented.

Purpose: Deliver the core browsing experience - users can see all spirits and tap to navigate.
Output: Working /spirits page showing River + Lightning with aspects, tappable to detail.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-spirit-library/02-CONTEXT.md
@.planning/phases/02-spirit-library/02-RESEARCH.md
@app/routes/__root.tsx
@convex/spirits.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create spirit list route with query integration</name>
  <files>
    app/routes/spirits.tsx
    app/components/spirits/spirit-list.tsx
  </files>
  <action>
**Step 1: Create the spirits route**

Create `app/routes/spirits.tsx`:

```typescript
import { createFileRoute } from "@tanstack/react-router";
import { z } from "zod";
import { SpiritList } from "@/components/spirits/spirit-list";

// Filter schema for URL search params (prepared for Plan 04)
const spiritFilterSchema = z.object({
  complexity: z.array(z.string()).optional().catch([]),
  expansion: z.array(z.string()).optional().catch([]),
  elements: z.array(z.string()).optional().catch([]),
  sort: z.enum(["alpha", "complexity"]).optional().catch("alpha"),
});

export const Route = createFileRoute("/spirits")({
  validateSearch: spiritFilterSchema,
  component: SpiritsPage,
});

function SpiritsPage() {
  const filters = Route.useSearch();

  return (
    <div className="min-h-screen bg-background">
      {/* Header */}
      <header className="sticky top-0 z-10 bg-background/95 backdrop-blur border-b border-border px-4 py-3">
        <div className="flex items-center justify-between">
          <h1 className="font-serif text-2xl font-semibold text-foreground">
            Spirits
          </h1>
          {/* Filter button placeholder - will be added in Plan 04 */}
        </div>
      </header>

      {/* Spirit list */}
      <main className="pb-20"> {/* pb-20 for bottom nav space */}
        <SpiritList filters={filters} />
      </main>
    </div>
  );
}
```

**Step 2: Create SpiritList component**

Create `app/components/spirits/spirit-list.tsx`:

```typescript
import { useQuery } from "convex/react";
import { api } from "convex/_generated/api";
import { SpiritRow } from "./spirit-row";

interface SpiritListProps {
  filters: {
    complexity?: string[];
    expansion?: string[];
    elements?: string[];
    sort?: "alpha" | "complexity";
  };
}

export function SpiritList({ filters }: SpiritListProps) {
  const spirits = useQuery(api.spirits.listSpirits, {
    complexity: filters.complexity,
    elements: filters.elements,
  });

  // Loading state - reserve space, no spinner per project requirements
  if (spirits === undefined) {
    return (
      <div className="p-4">
        <div className="animate-pulse space-y-4">
          {[1, 2, 3].map((i) => (
            <div key={i} className="flex gap-4">
              <div className="w-[100px] h-[100px] bg-muted rounded-lg" />
              <div className="flex-1 space-y-2">
                <div className="h-5 bg-muted rounded w-3/4" />
                <div className="h-4 bg-muted rounded w-full" />
                <div className="h-6 bg-muted rounded w-20" />
              </div>
            </div>
          ))}
        </div>
      </div>
    );
  }

  // Empty state
  if (spirits.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center p-8 text-center">
        <p className="text-muted-foreground text-lg">No spirits found</p>
        <p className="text-muted-foreground text-sm mt-2">
          Try adjusting your filters
        </p>
      </div>
    );
  }

  return (
    <div className="divide-y divide-border">
      {spirits.map((spirit) => (
        <SpiritRow
          key={spirit._id}
          spirit={spirit}
          isAspect={spirit.isAspect}
        />
      ))}
    </div>
  );
}
```

Note: Add `zod` as a dependency if not already installed:
```bash
pnpm add zod
```
  </action>
  <verify>
Run `pnpm typecheck` - should pass.
Run `pnpm dev` with `npx convex dev` - visit /spirits, should show loading then list.
  </verify>
  <done>
- /spirits route exists with search param validation
- SpiritList component queries Convex and renders spirits
- Loading state reserves space (animated placeholders)
- Empty state shows friendly message
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SpiritRow component with view transition names</name>
  <files>app/components/spirits/spirit-row.tsx</files>
  <action>
Create `app/components/spirits/spirit-row.tsx`:

```typescript
import { Link } from "@tanstack/react-router";
import { Badge } from "@/components/ui/badge";
import { cn } from "@/lib/utils";
import type { Doc } from "convex/_generated/dataModel";

interface SpiritRowProps {
  spirit: Doc<"spirits"> & { isAspect: boolean };
  isAspect: boolean;
}

// Map complexity to badge variant/color
const complexityColors: Record<string, string> = {
  Low: "bg-element-plant/20 text-element-plant border-element-plant/30",
  Moderate: "bg-element-sun/20 text-element-sun border-element-sun/30",
  High: "bg-element-fire/20 text-element-fire border-element-fire/30",
  "Very High": "bg-destructive/20 text-destructive border-destructive/30",
};

export function SpiritRow({ spirit, isAspect }: SpiritRowProps) {
  // Build the URL - aspects use query param
  const baseSlug = isAspect
    ? spirit.slug // Aspects share the base slug
    : spirit.slug;

  const href = isAspect
    ? `/spirits/${spirit.slug}?aspect=${spirit.aspectName?.toLowerCase()}`
    : `/spirits/${spirit.slug}`;

  // Display name includes aspect name if applicable
  const displayName = isAspect
    ? `${spirit.aspectName}`
    : spirit.name;

  return (
    <Link
      to={href}
      className={cn(
        "flex items-center gap-4 p-4",
        "active:bg-muted/50 transition-colors duration-150",
        isAspect && "pl-8 bg-muted/10" // Indent aspects
      )}
      viewTransition
    >
      {/* Spirit image */}
      <div
        className={cn(
          "relative flex-shrink-0",
          isAspect ? "w-[80px] h-[80px]" : "w-[100px] h-[100px]"
        )}
      >
        <img
          src={spirit.imageUrl}
          alt={spirit.name}
          className="w-full h-full object-cover rounded-lg"
          style={{
            viewTransitionName: isAspect
              ? `spirit-aspect-${spirit.aspectName?.toLowerCase()}`
              : `spirit-image-${spirit.slug}`,
          }}
        />
        {isAspect && (
          <div className="absolute -top-1 -right-1 w-4 h-4 bg-accent rounded-full flex items-center justify-center">
            <span className="text-[10px] text-background font-bold">A</span>
          </div>
        )}
      </div>

      {/* Spirit info */}
      <div className="flex-1 min-w-0">
        <h3
          className={cn(
            "font-serif font-semibold text-foreground truncate",
            isAspect ? "text-base" : "text-lg"
          )}
          style={{
            viewTransitionName: isAspect
              ? undefined
              : `spirit-name-${spirit.slug}`,
          }}
        >
          {displayName}
        </h3>

        <p className="text-sm text-muted-foreground line-clamp-2 mt-0.5">
          {spirit.summary}
        </p>

        {/* Complexity badge - only show for base spirits */}
        {!isAspect && (
          <Badge
            variant="outline"
            className={cn(
              "mt-2 text-xs",
              complexityColors[spirit.complexity] || ""
            )}
          >
            {spirit.complexity}
          </Badge>
        )}
      </div>
    </Link>
  );
}
```

**Note on aspect URLs:** The research shows aspects share the base spirit's slug (e.g., `/spirits/river-surges-in-sunlight?aspect=sunshine`). Update the seed data in convex/seed.ts if aspects have their own slugs - they should share the base spirit's slug.

**Update convex/seed.ts if needed:** Ensure aspect spirits use the SAME slug as their base spirit. The `aspectName` field differentiates them. For example:
- Base: `{ slug: "river-surges-in-sunlight", aspectName: undefined }`
- Aspect: `{ slug: "river-surges-in-sunlight", aspectName: "Sunshine" }`

**Update convex/spirits.ts getSpiritBySlug** to handle this properly:
- When querying by slug without aspect, return base spirit (where baseSpirit is undefined)
- When querying with aspect param, return the aspect (where slug matches AND aspectName matches)
  </action>
  <verify>
Run `pnpm typecheck` - should pass.
Visit /spirits - should see River and Lightning with their aspects indented below.
Aspect rows should have smaller image, "A" indicator badge, and indentation.
Tap a spirit - URL should update (detail page not built yet, will 404).
  </verify>
  <done>
- SpiritRow displays spirit image, name, summary, complexity badge
- Aspects are visually indented with smaller image and "A" indicator
- View transition names are applied for smooth navigation
- Tapping navigates to correct URL (/spirits/{slug} or /spirits/{slug}?aspect=xxx)
  </done>
</task>

</tasks>

<verification>
After completing both tasks:
1. `pnpm typecheck` passes
2. `pnpm dev` with `npx convex dev` - /spirits page loads
3. River Surges in Sunlight appears with 3 aspects below (indented)
4. Lightning's Swift Strike appears with 3 aspects below (indented)
5. Tapping any row updates the URL appropriately
6. Complexity badges show with color coding
</verification>

<success_criteria>
- /spirits route renders spirit list from Convex
- Spirits display with image, name, summary, complexity
- Aspects are indented under their base spirit
- Tapping navigates to detail URL
- View transition names are set for animation (Plan 05 enables)
</success_criteria>

<output>
After completion, create `.planning/phases/02-spirit-library/02-03-SUMMARY.md`
</output>
