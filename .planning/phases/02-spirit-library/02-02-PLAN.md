---
phase: 02-spirit-library
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/spirits.ts
  - convex/seed.ts
autonomous: true

must_haves:
  truths:
    - "Convex schema includes expansions and spirits tables"
    - "River Surges in Sunlight and aspects are queryable"
    - "Lightning's Swift Strike and aspects are queryable"
    - "Spirits are sorted alphabetically with aspects under base spirits"
  artifacts:
    - path: "convex/schema.ts"
      provides: "Database schema for spirits and expansions"
      contains: "spirits"
    - path: "convex/spirits.ts"
      provides: "Spirit query functions"
      exports: ["listSpirits", "getSpiritBySlug"]
    - path: "convex/seed.ts"
      provides: "Seed data function for initial spirits"
      exports: ["seedSpirits"]
  key_links:
    - from: "convex/spirits.ts"
      to: "convex/schema.ts"
      via: "query using spirits table"
      pattern: 'db.query\\("spirits"\\)'
---

<objective>
Define the Convex database schema for spirits and seed initial data for River Surges in Sunlight and Lightning's Swift Strike with all their aspects.

Purpose: Establish the data foundation that the spirit list and detail pages will query.
Output: Working Convex schema with seed data for 2 spirits + their aspects.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-spirit-library/02-RESEARCH.md
@convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define Convex schema for spirits and expansions</name>
  <files>convex/schema.ts</files>
  <action>
Update `convex/schema.ts` to add expansions and spirits tables while keeping the existing healthCheck table.

**Expansions table:**
```typescript
expansions: defineTable({
  name: v.string(),           // "Base Game", "Branch & Claw", etc.
  slug: v.string(),           // "base-game", "branch-and-claw"
  releaseYear: v.number(),    // 2017, 2018, etc.
}).index("by_slug", ["slug"]),
```

**Spirits table:**
```typescript
spirits: defineTable({
  name: v.string(),           // "River Surges in Sunlight"
  slug: v.string(),           // "river-surges-in-sunlight"
  complexity: v.union(
    v.literal("Low"),
    v.literal("Moderate"),
    v.literal("High"),
    v.literal("Very High")
  ),
  summary: v.string(),        // 1-line playstyle description
  imageUrl: v.string(),       // Path to spirit panel art
  expansionId: v.id("expansions"),
  elements: v.array(v.string()), // ["Sun", "Water", "River"] (primary elements)
  // For aspects: link to base spirit
  baseSpirit: v.optional(v.id("spirits")),
  aspectName: v.optional(v.string()), // "Sunshine", "Travel", etc.
})
  .index("by_slug", ["slug"])
  .index("by_expansion", ["expansionId"])
  .index("by_base_spirit", ["baseSpirit"])
  .index("by_complexity", ["complexity"]),
```

Keep the existing healthCheck table for backward compatibility.
  </action>
  <verify>
Run `npx convex dev` (or ensure it's running) - schema should sync without errors.
Check Convex dashboard - expansions and spirits tables should appear.
  </verify>
  <done>
Schema defines expansions and spirits tables with proper indexes.
Convex types are generated in convex/_generated/.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create seed data and spirit query functions</name>
  <files>
    convex/seed.ts
    convex/spirits.ts
  </files>
  <action>
**Step 1: Create convex/seed.ts**

Create a mutation that seeds the initial spirit data. This will be run manually via Convex dashboard or CLI.

Include the following spirits and aspects:

**Expansions to seed:**
1. Base Game (slug: "base-game", 2017)
2. Jagged Earth (slug: "jagged-earth", 2020) - for some aspects

**River Surges in Sunlight (Base Game, Low complexity):**
- Base spirit:
  - Elements: Sun, Water
  - Summary: "A flexible spirit of renewal and cleansing that pushes invaders away and heals the land."
  - imageUrl: "/spirits/river-surges-in-sunlight.webp" (placeholder path)
- Aspects:
  - **Sunshine** (Base Game): "Emphasizes Sun and energy income, with radiant presence."
  - **Travel** (Jagged Earth): "Mobile spirit that flows across the island to where it's needed."
  - **Haven** (Jagged Earth): "Protective spirit focused on defending sacred sites."

**Lightning's Swift Strike (Base Game, Low complexity):**
- Base spirit:
  - Elements: Fire, Air
  - Summary: "An aggressive spirit of speed and destruction, striking fast before invaders can build."
  - imageUrl: "/spirits/lightnings-swift-strike.webp" (placeholder path)
- Aspects:
  - **Pandemonium** (Jagged Earth): "Chaotic lightning that scatters invaders unpredictably."
  - **Wind** (Jagged Earth): "Swift spirit that prioritizes movement and flexibility over raw damage."
  - **Sparking** (Jagged Earth): "Focused on efficient, repeated small strikes."

The seed mutation should:
1. Check if data already exists (idempotent - skip if spirits already seeded)
2. Create expansions first
3. Create base spirits with expansion references
4. Create aspects with baseSpirit references

**Step 2: Create convex/spirits.ts**

Create query functions:

```typescript
import { query } from "./_generated/server";
import { v } from "convex/values";

// List all spirits with optional filtering
export const listSpirits = query({
  args: {
    complexity: v.optional(v.array(v.string())),
    expansionSlug: v.optional(v.array(v.string())),
    elements: v.optional(v.array(v.string())),
  },
  handler: async (ctx, args) => {
    let spirits = await ctx.db.query("spirits").collect();

    // Filter by complexity if specified
    if (args.complexity?.length) {
      spirits = spirits.filter((s) =>
        args.complexity!.includes(s.complexity)
      );
    }

    // Filter by elements (AND logic - spirit must have ALL specified elements)
    if (args.elements?.length) {
      spirits = spirits.filter((s) =>
        args.elements!.every((el) => s.elements.includes(el))
      );
    }

    // Sort alphabetically
    spirits.sort((a, b) => a.name.localeCompare(b.name));

    // Group: base spirits first, then aspects indented under them
    const baseSpirits = spirits.filter((s) => !s.baseSpirit);
    const aspectMap = new Map<string, typeof spirits>();

    for (const spirit of spirits.filter((s) => s.baseSpirit)) {
      const baseId = spirit.baseSpirit!.toString();
      if (!aspectMap.has(baseId)) aspectMap.set(baseId, []);
      aspectMap.get(baseId)!.push(spirit);
    }

    // Build result with aspects after their base
    const result: Array<(typeof spirits)[0] & { isAspect: boolean }> = [];
    for (const base of baseSpirits) {
      result.push({ ...base, isAspect: false });
      const aspects = aspectMap.get(base._id.toString()) || [];
      // Sort aspects alphabetically within base
      aspects.sort((a, b) => (a.aspectName || "").localeCompare(b.aspectName || ""));
      for (const aspect of aspects) {
        result.push({ ...aspect, isAspect: true });
      }
    }

    return result;
  },
});

// Get a single spirit by slug
export const getSpiritBySlug = query({
  args: {
    slug: v.string(),
    aspect: v.optional(v.string()),
  },
  handler: async (ctx, args) => {
    // First find the base spirit
    const baseSpirit = await ctx.db
      .query("spirits")
      .withIndex("by_slug", (q) => q.eq("slug", args.slug))
      .filter((q) => q.eq(q.field("baseSpirit"), undefined))
      .first();

    if (!baseSpirit) return null;

    // If aspect requested, find it
    if (args.aspect) {
      const aspect = await ctx.db
        .query("spirits")
        .withIndex("by_base_spirit", (q) => q.eq("baseSpirit", baseSpirit._id))
        .filter((q) =>
          q.eq(q.field("aspectName")?.toLowerCase(), args.aspect!.toLowerCase())
        )
        .first();
      return aspect || baseSpirit;
    }

    return baseSpirit;
  },
});
```
  </action>
  <verify>
Run `npx convex dev` - functions should sync.
In Convex dashboard, run the seedSpirits mutation.
Query listSpirits in dashboard - should return River + Lightning with aspects.
  </verify>
  <done>
- Seed mutation creates expansions + spirits + aspects
- listSpirits query returns spirits grouped with aspects
- getSpiritBySlug query retrieves individual spirits
- Data is seeded in Convex (run mutation manually)
  </done>
</task>

</tasks>

<verification>
After completing both tasks:
1. Convex schema syncs without errors
2. Seed mutation runs successfully
3. listSpirits returns 8 records (2 base + 6 aspects)
4. getSpiritBySlug("river-surges-in-sunlight") returns the base spirit
5. getSpiritBySlug("river-surges-in-sunlight", "sunshine") returns the aspect
</verification>

<success_criteria>
- Convex schema has expansions and spirits tables with proper indexes
- Seed data includes River, Lightning, and all their aspects
- Query functions work correctly
- Spirits are properly linked (aspects -> base spirit)
</success_criteria>

<output>
After completion, create `.planning/phases/02-spirit-library/02-02-SUMMARY.md`
</output>
