---
phase: 02-spirit-library
plan: 04
type: execute
wave: 3
depends_on: ["02-03"]
files_modified:
  - app/components/spirits/filter-sheet.tsx
  - app/components/spirits/filter-chips.tsx
  - app/routes/spirits.tsx
autonomous: true

must_haves:
  truths:
    - "User can tap filter button to open bottom sheet"
    - "Filter options include complexity and elements"
    - "Selecting filters updates URL search params"
    - "Active filters show as removable chips below header"
    - "Clear all button removes all active filters"
  artifacts:
    - path: "app/components/spirits/filter-sheet.tsx"
      provides: "Filter bottom sheet with options"
      exports: ["FilterSheet"]
    - path: "app/components/spirits/filter-chips.tsx"
      provides: "Active filter chip display"
      exports: ["FilterChips"]
  key_links:
    - from: "app/components/spirits/filter-sheet.tsx"
      to: "app/routes/spirits.tsx"
      via: "navigate to update search params"
      pattern: "navigate.*search"
    - from: "app/components/spirits/filter-chips.tsx"
      to: "app/routes/spirits.tsx"
      via: "navigate to remove filter"
      pattern: "navigate.*search"
---

<objective>
Implement the filter system with a bottom sheet for filter selection and chips for showing/removing active filters.

Purpose: Enable users to narrow down the spirit list by complexity and elements.
Output: Working filter UI that persists state in URL for shareable filtered views.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-spirit-library/02-CONTEXT.md
@.planning/phases/02-spirit-library/02-RESEARCH.md
@app/routes/spirits.tsx
@app/components/ui/drawer.tsx
@app/components/ui/badge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create filter bottom sheet component</name>
  <files>app/components/spirits/filter-sheet.tsx</files>
  <action>
Create `app/components/spirits/filter-sheet.tsx`:

```typescript
import { useState } from "react";
import { useNavigate } from "@tanstack/react-router";
import { Filter, X } from "lucide-react";
import {
  Drawer,
  DrawerClose,
  DrawerContent,
  DrawerHeader,
  DrawerTitle,
  DrawerTrigger,
  DrawerFooter,
} from "@/components/ui/drawer";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { cn } from "@/lib/utils";

// Filter options
const COMPLEXITY_OPTIONS = ["Low", "Moderate", "High", "Very High"] as const;
const ELEMENT_OPTIONS = [
  "Sun",
  "Moon",
  "Fire",
  "Air",
  "Water",
  "Earth",
  "Plant",
  "Animal",
] as const;

interface FilterSheetProps {
  currentFilters: {
    complexity?: string[];
    elements?: string[];
  };
  activeCount: number;
}

export function FilterSheet({ currentFilters, activeCount }: FilterSheetProps) {
  const navigate = useNavigate({ from: "/spirits" });
  const [open, setOpen] = useState(false);

  // Local state for pending filter changes
  const [pendingComplexity, setPendingComplexity] = useState<string[]>(
    currentFilters.complexity || []
  );
  const [pendingElements, setPendingElements] = useState<string[]>(
    currentFilters.elements || []
  );

  // Reset pending state when drawer opens
  const handleOpenChange = (isOpen: boolean) => {
    if (isOpen) {
      setPendingComplexity(currentFilters.complexity || []);
      setPendingElements(currentFilters.elements || []);
    }
    setOpen(isOpen);
  };

  // Toggle a filter option
  const toggleComplexity = (value: string) => {
    setPendingComplexity((prev) =>
      prev.includes(value)
        ? prev.filter((v) => v !== value)
        : [...prev, value]
    );
  };

  const toggleElement = (value: string) => {
    setPendingElements((prev) =>
      prev.includes(value)
        ? prev.filter((v) => v !== value)
        : [...prev, value]
    );
  };

  // Apply filters
  const applyFilters = () => {
    navigate({
      search: (prev) => ({
        ...prev,
        complexity: pendingComplexity.length > 0 ? pendingComplexity : undefined,
        elements: pendingElements.length > 0 ? pendingElements : undefined,
      }),
      replace: true,
    });
    setOpen(false);
  };

  // Clear all filters
  const clearAll = () => {
    setPendingComplexity([]);
    setPendingElements([]);
    navigate({
      search: (prev) => ({
        ...prev,
        complexity: undefined,
        elements: undefined,
      }),
      replace: true,
    });
    setOpen(false);
  };

  const pendingCount = pendingComplexity.length + pendingElements.length;

  return (
    <Drawer open={open} onOpenChange={handleOpenChange}>
      <DrawerTrigger asChild>
        <Button
          variant="outline"
          size="icon"
          className="relative"
        >
          <Filter className="h-4 w-4" />
          {activeCount > 0 && (
            <span className="absolute -top-1 -right-1 h-5 w-5 rounded-full bg-primary text-primary-foreground text-xs flex items-center justify-center font-medium">
              {activeCount}
            </span>
          )}
        </Button>
      </DrawerTrigger>
      <DrawerContent className="max-h-[85vh]">
        <DrawerHeader className="border-b border-border">
          <div className="flex items-center justify-between">
            <DrawerTitle className="font-serif">Filter Spirits</DrawerTitle>
            {pendingCount > 0 && (
              <Button
                variant="ghost"
                size="sm"
                onClick={() => {
                  setPendingComplexity([]);
                  setPendingElements([]);
                }}
                className="text-muted-foreground"
              >
                Clear all
              </Button>
            )}
          </div>
        </DrawerHeader>

        <div
          className="px-4 py-6 space-y-6 overflow-y-auto"
          data-vaul-no-drag
        >
          {/* Complexity filter */}
          <div>
            <h3 className="font-serif font-medium text-sm text-foreground mb-3">
              Complexity
            </h3>
            <div className="flex flex-wrap gap-2">
              {COMPLEXITY_OPTIONS.map((option) => (
                <FilterPill
                  key={option}
                  label={option}
                  selected={pendingComplexity.includes(option)}
                  onClick={() => toggleComplexity(option)}
                />
              ))}
            </div>
          </div>

          {/* Elements filter */}
          <div>
            <h3 className="font-serif font-medium text-sm text-foreground mb-3">
              Elements
            </h3>
            <p className="text-xs text-muted-foreground mb-3">
              Spirit must have ALL selected elements
            </p>
            <div className="flex flex-wrap gap-2">
              {ELEMENT_OPTIONS.map((option) => (
                <FilterPill
                  key={option}
                  label={option}
                  selected={pendingElements.includes(option)}
                  onClick={() => toggleElement(option)}
                />
              ))}
            </div>
          </div>
        </div>

        <DrawerFooter className="border-t border-border">
          <div className="flex gap-3">
            <DrawerClose asChild>
              <Button variant="outline" className="flex-1">
                Cancel
              </Button>
            </DrawerClose>
            <Button onClick={applyFilters} className="flex-1">
              Apply Filters
              {pendingCount > 0 && ` (${pendingCount})`}
            </Button>
          </div>
        </DrawerFooter>
      </DrawerContent>
    </Drawer>
  );
}

// Reusable filter pill component
function FilterPill({
  label,
  selected,
  onClick,
}: {
  label: string;
  selected: boolean;
  onClick: () => void;
}) {
  return (
    <button
      type="button"
      onClick={onClick}
      className={cn(
        "px-3 py-1.5 rounded-full text-sm font-medium transition-colors",
        "border",
        selected
          ? "bg-primary text-primary-foreground border-primary"
          : "bg-muted/30 text-foreground border-border hover:bg-muted/50"
      )}
    >
      {label}
    </button>
  );
}
```
  </action>
  <verify>
Run `pnpm typecheck` - should pass.
Import FilterSheet in spirits.tsx and render it - should show filter button.
Tap filter button - bottom sheet should open with options.
  </verify>
  <done>
- FilterSheet component with Drawer from shadcn/ui
- Complexity and Elements filter options
- Pending state before applying
- Apply and Cancel buttons
- Clear all functionality
  </done>
</task>

<task type="auto">
  <name>Task 2: Create filter chips and integrate into spirits route</name>
  <files>
    app/components/spirits/filter-chips.tsx
    app/routes/spirits.tsx
  </files>
  <action>
**Step 1: Create FilterChips component**

Create `app/components/spirits/filter-chips.tsx`:

```typescript
import { useNavigate } from "@tanstack/react-router";
import { X } from "lucide-react";
import { cn } from "@/lib/utils";

interface FilterChipsProps {
  filters: {
    complexity?: string[];
    elements?: string[];
  };
}

export function FilterChips({ filters }: FilterChipsProps) {
  const navigate = useNavigate({ from: "/spirits" });

  const allFilters: Array<{ type: "complexity" | "elements"; value: string }> =
    [
      ...(filters.complexity || []).map((v) => ({
        type: "complexity" as const,
        value: v,
      })),
      ...(filters.elements || []).map((v) => ({
        type: "elements" as const,
        value: v,
      })),
    ];

  if (allFilters.length === 0) return null;

  const removeFilter = (type: "complexity" | "elements", value: string) => {
    navigate({
      search: (prev) => {
        const current = prev[type] || [];
        const updated = current.filter((v) => v !== value);
        return {
          ...prev,
          [type]: updated.length > 0 ? updated : undefined,
        };
      },
      replace: true,
    });
  };

  const clearAll = () => {
    navigate({
      search: (prev) => ({
        ...prev,
        complexity: undefined,
        elements: undefined,
      }),
      replace: true,
    });
  };

  return (
    <div className="flex flex-wrap items-center gap-2 px-4 py-2 border-b border-border bg-muted/20">
      {allFilters.map(({ type, value }) => (
        <button
          key={`${type}-${value}`}
          type="button"
          onClick={() => removeFilter(type, value)}
          className={cn(
            "inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium",
            "bg-primary/10 text-primary border border-primary/20",
            "hover:bg-primary/20 transition-colors"
          )}
        >
          {value}
          <X className="h-3 w-3" />
        </button>
      ))}
      <button
        type="button"
        onClick={clearAll}
        className="text-xs text-muted-foreground hover:text-foreground transition-colors"
      >
        Clear all
      </button>
    </div>
  );
}
```

**Step 2: Update spirits.tsx to integrate filter components**

Update `app/routes/spirits.tsx`:

```typescript
import { createFileRoute } from "@tanstack/react-router";
import { z } from "zod";
import { SpiritList } from "@/components/spirits/spirit-list";
import { FilterSheet } from "@/components/spirits/filter-sheet";
import { FilterChips } from "@/components/spirits/filter-chips";

const spiritFilterSchema = z.object({
  complexity: z.array(z.string()).optional().catch([]),
  expansion: z.array(z.string()).optional().catch([]),
  elements: z.array(z.string()).optional().catch([]),
  sort: z.enum(["alpha", "complexity"]).optional().catch("alpha"),
});

export const Route = createFileRoute("/spirits")({
  validateSearch: spiritFilterSchema,
  component: SpiritsPage,
});

function SpiritsPage() {
  const filters = Route.useSearch();

  // Count active filters
  const activeCount =
    (filters.complexity?.length || 0) + (filters.elements?.length || 0);

  return (
    <div className="min-h-screen bg-background">
      {/* Header */}
      <header className="sticky top-0 z-10 bg-background/95 backdrop-blur border-b border-border px-4 py-3">
        <div className="flex items-center justify-between">
          <h1 className="font-serif text-2xl font-semibold text-foreground">
            Spirits
          </h1>
          <FilterSheet currentFilters={filters} activeCount={activeCount} />
        </div>
      </header>

      {/* Active filter chips */}
      <FilterChips filters={filters} />

      {/* Spirit list */}
      <main className="pb-20">
        <SpiritList filters={filters} />
      </main>
    </div>
  );
}
```
  </action>
  <verify>
Run `pnpm typecheck` - should pass.
Visit /spirits - filter button should appear in header.
Open filter sheet, select "Low" complexity, apply - URL should update to ?complexity=Low
Chip should appear below header with "Low" and X button.
Click X on chip - filter should be removed.
  </verify>
  <done>
- FilterChips shows active filters as removable pills
- Clear all button removes all filters
- Spirits route integrates FilterSheet and FilterChips
- Filter state persists in URL and is shareable
  </done>
</task>

</tasks>

<verification>
After completing both tasks:
1. `pnpm typecheck` passes
2. Filter button shows in header with badge count when filters active
3. Bottom sheet opens with Complexity and Elements options
4. Selecting options and Apply updates URL
5. Chips appear below header for active filters
6. Clicking chip X removes that filter
7. Clear all removes all filters
8. URL can be shared and filters restored on page load
</verification>

<success_criteria>
- Filter bottom sheet works with swipe gestures
- Filter state persists in URL search params
- Active filters shown as removable chips
- Spirit list updates based on filters
- Shareable filtered URLs work
</success_criteria>

<output>
After completion, create `.planning/phases/02-spirit-library/02-04-SUMMARY.md`
</output>
