---
phase: 03.4-presence-track-graph-dsl
plan: 01
subsystem: database
tags: [convex, schema, graph, presence-tracks, dsl]

# Dependency graph
requires:
  - phase: 03.3-spirit-board-final-polish
    provides: Linear presence track rendering with tracks/slots schema
provides:
  - Unified Node-Edge Graph schema for presenceTracks
  - nodes array with explicit (row, col) positioning
  - edges array for graph connections
  - trackType per node (energy, cardPlays, elements, special)
  - Grid dimensions (rows, cols) for CSS Grid layout
affects: [03.4-02, 03.4-03, 03.4-04, 03.4-05, 03.4-06, 03.4-07]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Node-Edge Graph DSL for presence track data modeling
    - Flat node array with row/col instead of nested tracks/slots

key-files:
  created: []
  modified:
    - convex/schema.ts
    - convex/seed.ts
    - app/components/spirits/presence-track.tsx

key-decisions:
  - "presenceTracks uses nodes + edges instead of tracks + slots"
  - "trackType is per-node, not per-track (enables mixed-type rows)"
  - "Grid dimensions (rows, cols) stored for CSS Grid layout"
  - "edges array supports bidirectional flag for Finder's track traversal"

patterns-established:
  - "Node-Edge Graph DSL: {rows, cols, nodes[], edges[]}"
  - "Node schema: {id, row, col, value, trackType, ...metadata}"
  - "Edge schema: {from, to, bidirectional?}"

# Metrics
duration: 12min
completed: 2026-01-27
---

# Phase 3.4 Plan 01: Node-Edge Graph Schema Summary

**Unified Node-Edge Graph schema for presenceTracks with explicit grid positioning and edges for complex spirits**

## Performance

- **Duration:** 12 min
- **Started:** 2026-01-27T12:30:00Z
- **Completed:** 2026-01-27T12:42:00Z
- **Tasks:** 1
- **Files modified:** 3

## Accomplishments
- Replaced linear tracks/slots schema with nodes/edges graph structure
- All 6 base spirits converted to new graph format in seed data
- Updated presence-track.tsx to render nodes grouped by row
- TypeScript types flow correctly from schema through Convex codegen

## Task Commits

Each task was committed atomically:

1. **Task 1: Replace presenceTracks schema with Node-Edge Graph model** - `e730cf8` (feat)

## Files Created/Modified
- `convex/schema.ts` - New presenceTracks validator with nodes, edges, rows, cols
- `convex/seed.ts` - All 12 spirit presenceTracks (6 in seedSpirits, 6 in reseedSpirits) converted to graph format
- `app/components/spirits/presence-track.tsx` - Updated to render nodes by row instead of tracks/slots

## Decisions Made
- **Node-Edge Graph over linear tracks:** Provides explicit graph structure for complex spirits (Finder's branching, Starlight's 6 tracks)
- **trackType per node:** Allows mixed-type rows and more flexible data modeling
- **edges array:** Explicit connections between nodes (e.g., Finder's energy->cardPlays at slot 3)
- **bidirectional flag:** Supports Finder's two-way track traversal

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Updated seed.ts and presence-track.tsx to match new schema**
- **Found during:** Task 1 (Schema replacement)
- **Issue:** Plan only specified schema.ts change, but typecheck failed due to seed.ts and component using old format
- **Fix:** Converted all 12 spirit presenceTracks in seed.ts to new format; updated presence-track.tsx to render nodes by row
- **Files modified:** convex/seed.ts, app/components/spirits/presence-track.tsx
- **Verification:** `pnpm typecheck` passes
- **Committed in:** e730cf8 (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (blocking)
**Impact on plan:** Necessary to make typecheck pass. Plan verification criteria could not be met without updating dependent files. This work was originally planned for 03.4-04 (component) and 03.4-05 (seed data), but was pulled forward to unblock.

## Issues Encountered
- Plan 01 verification required typecheck to pass, but seed.ts and presence-track.tsx still used old format - resolved by including those updates in this task

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- Schema is complete with unified Node-Edge Graph model
- Component renders basic graph structure (groups nodes by row)
- Plans 02-03 can now build GraphPresenceTrack and EdgeOverlay components
- Plans 04-05 may need reduced scope since component and seed data already updated

---
*Phase: 03.4-presence-track-graph-dsl*
*Completed: 2026-01-27*
