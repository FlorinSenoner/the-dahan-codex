---
phase: 03.4-presence-track-graph-dsl
plan: 03
type: execute
wave: 2
depends_on: ["03.4-01"]
files_modified:
  - app/components/spirits/connection-lines.tsx
autonomous: true

must_haves:
  truths:
    - "SVG lines connect non-adjacent cells visually"
    - "Connection lines respect bidirectional flag"
    - "Lines have appropriate styling (dashed, colored)"
  artifacts:
    - path: "app/components/spirits/connection-lines.tsx"
      provides: "SVG overlay for drawing connection lines"
      exports: ["ConnectionLines"]
  key_links:
    - from: "app/components/spirits/connection-lines.tsx"
      to: "app/components/spirits/presence-track-grid.tsx"
      via: "SVG overlay rendered within grid container"
      pattern: "ConnectionLines"
---

<objective>
Create ConnectionLines component to draw SVG lines between non-adjacent cells in grid presence tracks.

Purpose: Visually indicate connections that span across the grid (convergent/divergent paths) for complex spirits like Finder.

Output: ConnectionLines SVG component that overlays the grid and draws connection paths.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.4-presence-track-graph-dsl/03.4-01-SUMMARY.md

Reference existing components:
@app/components/spirits/presence-track-grid.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConnectionLines SVG component</name>
  <files>app/components/spirits/connection-lines.tsx</files>
  <action>
Create component that renders SVG lines for non-adjacent connections:

```typescript
import { cn } from "@/lib/utils";

interface Connection {
  from: number[] | string;  // [row, col] or node ID
  to: number[] | string;
  bidirectional?: boolean;
}

interface ConnectionLinesProps {
  connections: Connection[];
  gridRows: number;
  gridCols: number;
  cellSize?: number;  // Size of each cell in pixels
  gap?: number;       // Gap between cells in pixels
  defaultBidirectional?: boolean;
}

export function ConnectionLines({
  connections,
  gridRows,
  gridCols,
  cellSize = 48,
  gap = 8,
  defaultBidirectional = false,
}: ConnectionLinesProps) {
  if (!connections || connections.length === 0) return null;

  // Calculate SVG dimensions
  const svgWidth = gridCols * cellSize + (gridCols - 1) * gap;
  const svgHeight = gridRows * cellSize + (gridRows - 1) * gap;

  // Convert [row, col] to pixel coordinates (center of cell)
  const toPixels = (pos: number[] | string): { x: number; y: number } | null => {
    if (typeof pos === "string") {
      // Node ID - would need ID-to-position mapping, skip for now
      return null;
    }
    const [row, col] = pos;
    const x = col * (cellSize + gap) + cellSize / 2;
    const y = row * (cellSize + gap) + cellSize / 2;
    return { x, y };
  };

  return (
    <svg
      className="absolute inset-0 pointer-events-none z-10"
      width={svgWidth}
      height={svgHeight}
      viewBox={`0 0 ${svgWidth} ${svgHeight}`}
      aria-hidden="true"
    >
      <defs>
        {/* Arrowhead marker for directional connections */}
        <marker
          id="arrowhead"
          markerWidth="10"
          markerHeight="7"
          refX="9"
          refY="3.5"
          orient="auto"
        >
          <polygon
            points="0 0, 10 3.5, 0 7"
            fill="currentColor"
            className="text-primary/50"
          />
        </marker>
        {/* Double arrowhead for bidirectional */}
        <marker
          id="arrowhead-start"
          markerWidth="10"
          markerHeight="7"
          refX="1"
          refY="3.5"
          orient="auto-start-reverse"
        >
          <polygon
            points="10 0, 0 3.5, 10 7"
            fill="currentColor"
            className="text-primary/50"
          />
        </marker>
      </defs>

      {connections.map((conn, idx) => {
        const fromPos = toPixels(conn.from);
        const toPos = toPixels(conn.to);

        if (!fromPos || !toPos) return null;

        const isBidirectional = conn.bidirectional ?? defaultBidirectional;

        // Calculate control point for curved line (slight arc)
        const midX = (fromPos.x + toPos.x) / 2;
        const midY = (fromPos.y + toPos.y) / 2;
        const dx = toPos.x - fromPos.x;
        const dy = toPos.y - fromPos.y;
        // Perpendicular offset for curve
        const offset = 15;
        const controlX = midX - (dy / Math.sqrt(dx * dx + dy * dy)) * offset;
        const controlY = midY + (dx / Math.sqrt(dx * dx + dy * dy)) * offset;

        return (
          <path
            key={`conn-${idx}`}
            d={`M ${fromPos.x} ${fromPos.y} Q ${controlX} ${controlY} ${toPos.x} ${toPos.y}`}
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeDasharray="4 4"
            className="text-primary/40"
            markerEnd={!isBidirectional ? "url(#arrowhead)" : undefined}
            markerStart={isBidirectional ? "url(#arrowhead-start)" : undefined}
            markerMid={isBidirectional ? "url(#arrowhead)" : undefined}
          />
        );
      })}
    </svg>
  );
}
```

Key features:
1. SVG overlay positioned absolutely over the grid
2. Calculates pixel positions from [row, col] grid coordinates
3. Draws curved paths with slight arc for visual clarity
4. Supports bidirectional indicators (arrows both ends)
5. Dashed lines to distinguish from grid structure
6. pointer-events-none to allow clicking through to cells
  </action>
  <verify>
Run `pnpm typecheck` - should pass without errors.
  </verify>
  <done>
ConnectionLines component renders SVG connection indicators.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate ConnectionLines into PresenceTrackGrid</name>
  <files>app/components/spirits/presence-track-grid.tsx</files>
  <action>
Update PresenceTrackGrid to render ConnectionLines overlay:

1. Import ConnectionLines component
2. Wrap grid in relative container for absolute SVG positioning
3. Render ConnectionLines with calculated dimensions

```typescript
import { ConnectionLines } from "./connection-lines";

// Inside PresenceTrackGrid, after grid div:
{connections && connections.length > 0 && (
  <ConnectionLines
    connections={connections}
    gridRows={numRows}
    gridCols={numCols}
    cellSize={48}
    gap={8}
    defaultBidirectional={bidirectional}
  />
)}
```

Ensure the grid container has `position: relative` so SVG overlay positions correctly.
  </action>
  <verify>
Run `pnpm typecheck` - should pass without errors.
  </verify>
  <done>
PresenceTrackGrid renders connection lines for non-adjacent connections.
  </done>
</task>

</tasks>

<verification>
1. Run `pnpm typecheck` - no type errors
2. Run `pnpm dev` - dev server starts
3. Component renders without errors (will be tested with real data in Plan 04)
</verification>

<success_criteria>
- ConnectionLines component exists and compiles
- SVG paths are generated for connections array
- Lines have visual styling (dashed, colored)
- Bidirectional connections show arrows both ways
</success_criteria>

<output>
After completion, create `.planning/phases/03.4-presence-track-graph-dsl/03.4-03-SUMMARY.md`
</output>
