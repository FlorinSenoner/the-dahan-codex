---
phase: 03.4-presence-track-graph-dsl
plan: 03
type: execute
wave: 2
depends_on: ["03.4-01"]
files_modified:
  - app/components/spirits/edge-overlay.tsx
autonomous: true

must_haves:
  truths:
    - "Non-adjacent edges render as SVG lines between nodes"
    - "Adjacent horizontal edges are implicit (no visual line needed)"
    - "Bidirectional edges show appropriate styling"
  artifacts:
    - path: "app/components/spirits/edge-overlay.tsx"
      provides: "SVG overlay for presence track graph edges"
      exports: ["EdgeOverlay"]
      min_lines: 50
  key_links:
    - from: "app/components/spirits/edge-overlay.tsx"
      to: "app/components/spirits/graph-presence-track.tsx"
      via: "component import"
      pattern: "EdgeOverlay"
---

<objective>
Create the EdgeOverlay component that renders SVG lines for non-adjacent connections in presence track graphs.

Purpose: Complex spirits like Finder have connections between non-adjacent nodes (cross-row, diagonal, or multi-column jumps). These need visual indicators so users understand the graph topology.

Output: EdgeOverlay.tsx component with SVG line rendering
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.4-presence-track-graph-dsl/03.4-RESEARCH.md
@.planning/phases/03.4-presence-track-graph-dsl/03.4-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EdgeOverlay component</name>
  <files>app/components/spirits/edge-overlay.tsx</files>
  <action>
Create EdgeOverlay component that renders SVG lines for non-adjacent edges.

Key design decisions:
1. Filter edges to show only NON-ADJACENT connections
   - Adjacent = same row AND col difference of exactly 1
   - All other edges get visual lines
2. Calculate line positions based on node grid positions
   - Use percentage-based positioning (works with any grid cell size)
   - Each node is at (col + 0.5) / cols and (row + 0.5) / rows for center
3. Style lines to be visible but not overwhelming
   - Dashed line for visual distinction from grid
   - Arrow marker for unidirectional edges (optional)
   - Lower opacity for subtlety

```tsx
import { useMemo } from "react";

interface PresenceNodeData {
  id: string;
  row: number;
  col: number;
}

interface EdgeData {
  from: string;
  to: string;
  bidirectional?: boolean;
}

interface EdgeOverlayProps {
  edges: EdgeData[];
  nodes: PresenceNodeData[];
  rows: number;
  cols: number;
  globalBidirectional?: boolean;
}

export function EdgeOverlay({
  edges,
  nodes,
  rows,
  cols,
  globalBidirectional = true,
}: EdgeOverlayProps) {
  // Create node lookup map for fast access
  const nodeMap = useMemo(() => {
    const map = new Map<string, PresenceNodeData>();
    for (const node of nodes) {
      map.set(node.id, node);
    }
    return map;
  }, [nodes]);

  // Filter to non-adjacent edges only
  const nonAdjacentEdges = useMemo(() => {
    return edges.filter((edge) => {
      const fromNode = nodeMap.get(edge.from);
      const toNode = nodeMap.get(edge.to);
      if (!fromNode || !toNode) return false;

      // Adjacent = same row, col diff of 1
      const sameRow = fromNode.row === toNode.row;
      const colDiff = Math.abs(fromNode.col - toNode.col);
      const isHorizontalAdjacent = sameRow && colDiff === 1;

      return !isHorizontalAdjacent;
    });
  }, [edges, nodeMap]);

  if (nonAdjacentEdges.length === 0) {
    return null;
  }

  // Calculate node center position as percentage
  const getNodeCenter = (node: PresenceNodeData) => ({
    x: ((node.col + 0.5) / cols) * 100,
    y: ((node.row + 0.5) / rows) * 100,
  });

  return (
    <svg
      className="absolute inset-0 pointer-events-none overflow-visible"
      viewBox="0 0 100 100"
      preserveAspectRatio="none"
    >
      {/* Optional: Arrow marker for unidirectional edges */}
      <defs>
        <marker
          id="arrowhead"
          markerWidth="10"
          markerHeight="7"
          refX="9"
          refY="3.5"
          orient="auto"
        >
          <polygon
            points="0 0, 10 3.5, 0 7"
            fill="currentColor"
            className="text-muted-foreground/50"
          />
        </marker>
      </defs>

      {nonAdjacentEdges.map((edge) => {
        const fromNode = nodeMap.get(edge.from);
        const toNode = nodeMap.get(edge.to);
        if (!fromNode || !toNode) return null;

        const from = getNodeCenter(fromNode);
        const to = getNodeCenter(toNode);
        const isBidirectional = edge.bidirectional ?? globalBidirectional;

        return (
          <line
            key={`${edge.from}-${edge.to}`}
            x1={`${from.x}%`}
            y1={`${from.y}%`}
            x2={`${to.x}%`}
            y2={`${to.y}%`}
            className="stroke-muted-foreground/40"
            strokeWidth="1"
            strokeDasharray="4 2"
            markerEnd={!isBidirectional ? "url(#arrowhead)" : undefined}
          />
        );
      })}
    </svg>
  );
}
```

Key implementation notes:
- Uses viewBox="0 0 100 100" with percentage positioning for responsive scaling
- preserveAspectRatio="none" ensures SVG stretches to match grid
- pointer-events-none keeps nodes clickable
- Dashed lines (strokeDasharray) distinguish connections from grid structure
- Arrow marker shows direction for unidirectional edges
  </action>
  <verify>
File exists at app/components/spirits/edge-overlay.tsx
Contains export function EdgeOverlay
Includes SVG with viewBox and line elements
No TypeScript errors
  </verify>
  <done>
EdgeOverlay component renders SVG lines for non-adjacent edges between presence nodes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate EdgeOverlay into GraphPresenceTrack</name>
  <files>app/components/spirits/graph-presence-track.tsx</files>
  <action>
Update GraphPresenceTrack to include EdgeOverlay.

Add import:
```tsx
import { EdgeOverlay } from "./edge-overlay";
```

Update the return JSX to include EdgeOverlay inside the relative container:
```tsx
<div className="relative">
  {/* Grid container for nodes */}
  <div
    className="grid gap-2"
    style={{
      gridTemplateRows: `repeat(${rows}, minmax(44px, auto))`,
      gridTemplateColumns: `repeat(${cols}, minmax(44px, 1fr))`,
    }}
  >
    {nodes.map((node) => (
      <PresenceNode
        key={node.id}
        node={node}
        color={getNodeColor(node)}
        style={{
          gridRow: node.row + 1,
          gridColumn: node.col + 1,
        }}
      />
    ))}
  </div>

  {/* Edge overlay for non-adjacent connections */}
  {edges && edges.length > 0 && (
    <EdgeOverlay
      edges={edges}
      nodes={nodes}
      rows={rows}
      cols={cols}
      globalBidirectional={presenceTracks.bidirectional ?? true}
    />
  )}
</div>
```

The EdgeOverlay is absolutely positioned within the relative container, overlaying the grid.
  </action>
  <verify>
GraphPresenceTrack imports EdgeOverlay
EdgeOverlay is rendered when edges array has items
`pnpm typecheck` passes
  </verify>
  <done>
GraphPresenceTrack includes EdgeOverlay for visualizing non-adjacent connections.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. EdgeOverlay exports function EdgeOverlay
3. GraphPresenceTrack imports and renders EdgeOverlay
4. SVG uses percentage-based positioning
</verification>

<success_criteria>
- EdgeOverlay renders SVG lines for non-adjacent edges
- Adjacent horizontal edges are excluded (implicit in grid layout)
- GraphPresenceTrack integrates EdgeOverlay
</success_criteria>

<output>
After completion, create `.planning/phases/03.4-presence-track-graph-dsl/03.4-03-SUMMARY.md`
</output>
