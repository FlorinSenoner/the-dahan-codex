---
phase: 03.4-presence-track-graph-dsl
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
autonomous: true

must_haves:
  truths:
    - "Convex schema accepts presenceTracks with nodes and edges arrays"
    - "TypeScript types flow from schema through Convex codegen"
    - "Old linear track format is completely removed from schema"
  artifacts:
    - path: "convex/schema.ts"
      provides: "Unified Node-Edge Graph presenceTracks validator"
      contains: "nodes: v.array"
    - path: "convex/schema.ts"
      provides: "Edge validator with bidirectional flag"
      contains: "edges: v.array"
  key_links:
    - from: "convex/schema.ts"
      to: "convex/_generated/dataModel.d.ts"
      via: "Convex codegen on save"
      pattern: "presenceTracks"
---

<objective>
Replace the existing linear track schema with the unified Node-Edge Graph model for presence tracks.

Purpose: The new schema eliminates the legacy linear format entirely, providing a clean graph-based structure that supports both simple spirits (River) and complex spirits (Finder, Starlight, Serpent).

Output: Updated convex/schema.ts with presenceTracks using nodes + edges arrays
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.4-presence-track-graph-dsl/03.4-RESEARCH.md
@convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace presenceTracks schema with Node-Edge Graph model</name>
  <files>convex/schema.ts</files>
  <action>
Replace the entire presenceTracks field definition (lines ~117-150) with the new unified Node-Edge Graph schema:

```typescript
presenceTracks: v.optional(
  v.object({
    // Grid dimensions for CSS Grid layout
    rows: v.number(),
    cols: v.number(),

    // Whether all edges are bidirectional by default (default: true)
    bidirectional: v.optional(v.boolean()),

    // Nodes represent presence slots with explicit positioning
    nodes: v.array(
      v.object({
        // Unique node identifier (required)
        id: v.string(),

        // Grid position for rendering (0-indexed)
        row: v.number(),
        col: v.number(),

        // Node content
        value: v.optional(v.union(v.number(), v.string())), // 1, 2, "+1", "+2", etc.

        // What type of bonus this provides
        trackType: v.optional(
          v.union(
            v.literal("energy"),        // Base energy value
            v.literal("cardPlays"),     // Base card plays value
            v.literal("energyMod"),     // +N Energy modifier
            v.literal("cardPlaysMod"),  // +N Card Plays modifier
            v.literal("elements"),      // Element only (value 0)
            v.literal("special"),       // Special ability text
            v.literal("start"),         // Starting position marker
          )
        ),

        // Optional metadata
        elements: v.optional(v.array(v.string())),  // ["Moon", "Air"]
        reclaim: v.optional(v.boolean()),           // Reclaim One icon
        specialAbility: v.optional(v.string()),     // Custom text
        presenceCap: v.optional(v.number()),        // Serpent's limit track
        unlocksGrowth: v.optional(v.boolean()),     // Starlight's growth unlock
      })
    ),

    // Edges connect nodes (explicit graph structure)
    edges: v.array(
      v.object({
        from: v.string(),  // Source node ID
        to: v.string(),    // Target node ID
        // Override global bidirectional setting for this edge
        bidirectional: v.optional(v.boolean()),
      })
    ),
  })
),
```

Key changes from old schema:
- REMOVED: `layout`, `tracks` array with nested `slots`
- REMOVED: `connectsTo`, `connectionPoint` (replaced by explicit edges)
- ADDED: `rows`, `cols` for CSS Grid sizing
- ADDED: `nodes` array with explicit (row, col) positioning
- ADDED: `edges` array for explicit graph connections
- ADDED: `trackType` on each node (was `type` on track level)
- PRESERVED: All node metadata (elements, reclaim, presenceCap, unlocksGrowth, specialAbility)
  </action>
  <verify>
Run `pnpm typecheck` - should pass with no type errors related to presenceTracks.
The Convex dev server (if running) will regenerate types automatically.
  </verify>
  <done>
convex/schema.ts contains presenceTracks with nodes array, edges array, rows/cols dimensions.
Old linear track format (tracks/slots/connectsTo/connectionPoint) is completely removed.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. Schema file contains `nodes: v.array(` and `edges: v.array(`
3. Schema file does NOT contain `tracks: v.array(` or `slots: v.array(`
</verification>

<success_criteria>
- convex/schema.ts has unified Node-Edge Graph presenceTracks structure
- No traces of old linear format remain in schema
- TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/03.4-presence-track-graph-dsl/03.4-01-SUMMARY.md`
</output>
