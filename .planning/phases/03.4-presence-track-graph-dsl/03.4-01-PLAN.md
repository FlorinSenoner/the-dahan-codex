---
phase: 03.4-presence-track-graph-dsl
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
autonomous: true

must_haves:
  truths:
    - "Schema accepts both legacy linear format and new grid format"
    - "Type guards distinguish between linear and grid formats"
    - "Convex dev server compiles schema without errors"
  artifacts:
    - path: "convex/schema.ts"
      provides: "v.union schema for presenceTracks with legacy + grid formats"
      contains: "v.union"
  key_links:
    - from: "convex/schema.ts"
      to: "convex/_generated"
      via: "Convex code generation"
      pattern: "presenceTracks.*v\\.union"
---

<objective>
Extend the Convex schema to support both legacy linear presence track format AND new grid-based graph format.

Purpose: Enable complex spirits (Finder, Starlight, Serpent) to use 2D grid layouts with non-adjacent connections while maintaining backward compatibility for simple spirits.

Output: Updated schema.ts with v.union supporting both formats, type-safe for downstream consumers.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/debug/presence-track-graph-dsl.md

Reference current schema:
@convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add grid-based presence track schema</name>
  <files>convex/schema.ts</files>
  <action>
Update the presenceTracks field in the spirits table to use v.union supporting both formats:

1. Keep the existing linear format as-is (tracks array with slots)
2. Add new grid format with:
   - `layout: v.literal("grid")` discriminator
   - `bidirectional: v.optional(v.boolean())` - default false, all connections bidirectional if true
   - `rows: v.array(v.array(v.union(v.null(), gridCellSchema)))` - 2D array, null for empty cells
   - `connections: v.optional(v.array(connectionSchema))` - non-adjacent connections only

Grid cell schema (similar to existing slot but with position metadata):
```typescript
v.object({
  id: v.optional(v.string()),  // for connections reference
  isStart: v.optional(v.boolean()),  // starting presence position
  value: v.optional(v.union(v.number(), v.string())),  // 1, 2, "+1", etc.
  trackType: v.optional(v.string()),  // "energy", "cardPlays"
  modifier: v.optional(v.string()),  // "energy" for +Energy modifiers
  elements: v.optional(v.array(v.string())),
  reclaim: v.optional(v.boolean()),
  specialAbility: v.optional(v.string()),
  presenceCap: v.optional(v.number()),
})
```

Connection schema:
```typescript
v.object({
  from: v.union(v.array(v.number()), v.string()),  // [row, col] or node ID
  to: v.union(v.array(v.number()), v.string()),    // [row, col] or node ID
  bidirectional: v.optional(v.boolean()),  // override default
})
```

Use v.union at the top level to discriminate between formats based on layout field:
- Legacy: `layout` is undefined or "linear" or "branching" or "multiple"
- Grid: `layout` is "grid"
  </action>
  <verify>
Run `npx convex dev` in a separate terminal - should compile without errors.
Check that TypeScript types are generated in convex/_generated/dataModel.d.ts.
  </verify>
  <done>
Schema supports both legacy linear format AND new grid format.
Existing spirit data continues to work without modification.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add type guard helper for format detection</name>
  <files>app/lib/presence-track-utils.ts</files>
  <action>
Create a new utility file with type guards and helpers for presence track format detection:

```typescript
import type { Doc } from "convex/_generated/dataModel";

type PresenceTracks = NonNullable<Doc<"spirits">["presenceTracks"]>;

// Type guard to check if presence tracks use grid format
export function isGridFormat(tracks: PresenceTracks): tracks is PresenceTracks & { layout: "grid" } {
  return "layout" in tracks && tracks.layout === "grid";
}

// Type guard to check if presence tracks use legacy linear format
export function isLinearFormat(tracks: PresenceTracks): tracks is PresenceTracks & { tracks: Array<any> } {
  return "tracks" in tracks && Array.isArray(tracks.tracks);
}

// Helper to get grid dimensions
export function getGridDimensions(tracks: PresenceTracks & { layout: "grid" }) {
  const rows = tracks.rows?.length ?? 0;
  const cols = tracks.rows?.[0]?.length ?? 0;
  return { rows, cols };
}
```
  </action>
  <verify>
Run `pnpm typecheck` - should pass without errors.
  </verify>
  <done>
Type guards enable conditional rendering in components based on track format.
  </done>
</task>

</tasks>

<verification>
1. Run `npx convex dev` - schema compiles successfully
2. Run `pnpm typecheck` - no type errors
3. Verify existing spirits still load correctly in the app (no runtime errors)
</verification>

<success_criteria>
- Schema accepts v.union with both formats
- Convex generates valid TypeScript types
- Type guard helpers work correctly
- No breaking changes to existing data
</success_criteria>

<output>
After completion, create `.planning/phases/03.4-presence-track-graph-dsl/03.4-01-SUMMARY.md`
</output>
