---
phase: 03.4-presence-track-graph-dsl
plan: 02
type: execute
wave: 2
depends_on: ["03.4-01"]
files_modified:
  - app/components/spirits/presence-track-grid.tsx
  - app/components/spirits/presence-track.tsx
autonomous: true

must_haves:
  truths:
    - "Grid layout renders cells in 2D rows/columns"
    - "Empty cells (null) render as transparent spacers"
    - "Start positions are visually indicated"
    - "Component receives grid data and renders correctly"
  artifacts:
    - path: "app/components/spirits/presence-track-grid.tsx"
      provides: "Grid-based presence track renderer"
      exports: ["PresenceTrackGrid"]
    - path: "app/components/spirits/presence-track.tsx"
      provides: "Updated to delegate to grid renderer"
      contains: "isGridFormat"
  key_links:
    - from: "app/components/spirits/presence-track.tsx"
      to: "app/components/spirits/presence-track-grid.tsx"
      via: "conditional import based on format"
      pattern: "isGridFormat.*PresenceTrackGrid"
---

<objective>
Create new PresenceTrackGrid component to render 2D grid-based presence tracks.

Purpose: Accurately visualize complex spirits (Finder, Starlight, Serpent) whose presence tracks form graph structures rather than simple linear rows.

Output: New PresenceTrackGrid component and updated PresenceTrack that delegates based on format.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.4-presence-track-graph-dsl/03.4-01-SUMMARY.md

Reference current components:
@app/components/spirits/presence-track.tsx
@app/components/spirits/presence-slot.tsx
@app/lib/spirit-colors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PresenceTrackGrid component</name>
  <files>app/components/spirits/presence-track-grid.tsx</files>
  <action>
Create new component that renders grid-based presence tracks:

```typescript
import type { Doc } from "convex/_generated/dataModel";
import { Heading, Text } from "@/components/ui/typography";
import { getSpiritTrackColors, trackGradientClasses } from "@/lib/spirit-colors";
import { cn } from "@/lib/utils";
import { PresenceSlot } from "./presence-slot";

// Extract grid format type from schema
type GridPresenceTracks = NonNullable<Doc<"spirits">["presenceTracks"]> & {
  layout: "grid";
};

interface PresenceTrackGridProps {
  presenceTracks: GridPresenceTracks;
  spiritSlug?: string;
}

export function PresenceTrackGrid({ presenceTracks, spiritSlug }: PresenceTrackGridProps) {
  const { rows, bidirectional, connections } = presenceTracks;
  const spiritColors = spiritSlug
    ? getSpiritTrackColors(spiritSlug)
    : { energy: "amber", cardPlays: "blue" };

  if (!rows || rows.length === 0) {
    return (
      <section className="space-y-4 mt-6">
        <Heading variant="h3" as="h2">Presence Tracks</Heading>
        <Text variant="muted">Presence track data coming soon.</Text>
      </section>
    );
  }

  // Determine grid dimensions for CSS grid
  const numRows = rows.length;
  const numCols = Math.max(...rows.map(row => row?.length ?? 0));

  // Get color for a cell based on trackType
  const getCellColor = (cell: NonNullable<GridPresenceTracks["rows"]>[number][number]) => {
    if (!cell) return "stone";
    if (cell.trackType === "energy") return spiritColors.energy;
    if (cell.trackType === "cardPlays") return spiritColors.cardPlays;
    if (cell.modifier) return "emerald"; // modifier tracks
    return "stone"; // default
  };

  return (
    <section className="space-y-4 mt-6">
      <Heading variant="h3" as="h2">Presence Tracks</Heading>

      {/* Grid container with CSS grid */}
      <div
        className="relative rounded-lg p-3 bg-muted/20"
        style={{
          display: "grid",
          gridTemplateColumns: `repeat(${numCols}, minmax(48px, 1fr))`,
          gridTemplateRows: `repeat(${numRows}, auto)`,
          gap: "0.5rem",
        }}
      >
        {rows.map((row, rowIndex) =>
          row?.map((cell, colIndex) => {
            const cellKey = `${rowIndex}-${colIndex}`;

            // Empty cell - render transparent spacer
            if (cell === null) {
              return (
                <div
                  key={cellKey}
                  className="w-11 h-11 min-w-[44px] min-h-[44px]"
                  aria-hidden="true"
                />
              );
            }

            // Determine slot type for PresenceSlot
            const trackType = cell.trackType ?? (cell.modifier ? "modifier" : "custom");
            const color = getCellColor(cell);

            return (
              <div key={cellKey} className="flex items-center justify-center">
                <PresenceSlot
                  slot={{
                    value: cell.value ?? 0,
                    elements: cell.elements,
                    reclaim: cell.reclaim,
                    specialAbility: cell.specialAbility,
                    presenceCap: cell.presenceCap,
                  }}
                  index={colIndex}
                  trackColor={color as any}
                  trackType={trackType}
                  isStart={cell.isStart}
                />
              </div>
            );
          })
        )}
      </div>

      {/* Bidirectional indicator if applicable */}
      {bidirectional && (
        <Text variant="small" className="text-muted-foreground italic">
          Presence can move in either direction along tracks
        </Text>
      )}
    </section>
  );
}
```

Key features:
1. CSS Grid layout with dynamic columns based on data
2. Empty cells render as transparent spacers (maintain grid structure)
3. Reuses existing PresenceSlot component for cell rendering
4. Color coding based on trackType (energy, cardPlays, modifier)
5. Start positions indicated via isStart prop (passed to PresenceSlot)
  </action>
  <verify>
Run `pnpm typecheck` - should pass without errors.
  </verify>
  <done>
PresenceTrackGrid component renders 2D grid-based presence tracks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update PresenceSlot to handle isStart</name>
  <files>app/components/spirits/presence-slot.tsx</files>
  <action>
Update PresenceSlot to accept and display start position indicator:

1. Add `isStart?: boolean` to PresenceSlotProps interface
2. When isStart is true, add visual indicator (gold ring or star icon)
3. Add tooltip text explaining "Starting presence position"

```typescript
// Add to props interface
isStart?: boolean;

// In component, add to tooltip if isStart:
if (isStart) {
  tooltipLines.push("Starting presence position");
}

// Add visual styling for start positions (gold border):
isStart && "ring-2 ring-amber-400 ring-offset-2 ring-offset-background"
```
  </action>
  <verify>
Run `pnpm typecheck` - should pass without errors.
  </verify>
  <done>
PresenceSlot displays start position indicator for grid cells marked as isStart.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update PresenceTrack to delegate based on format</name>
  <files>app/components/spirits/presence-track.tsx</files>
  <action>
Update the main PresenceTrack component to detect format and delegate:

1. Import the type guard from presence-track-utils.ts
2. Import PresenceTrackGrid component
3. At top of render, check format and delegate:

```typescript
import { isGridFormat } from "@/lib/presence-track-utils";
import { PresenceTrackGrid } from "./presence-track-grid";

export function PresenceTrack({ presenceTracks, spiritSlug }: PresenceTrackProps) {
  // Delegate to grid renderer for grid format
  if (isGridFormat(presenceTracks)) {
    return <PresenceTrackGrid presenceTracks={presenceTracks} spiritSlug={spiritSlug} />;
  }

  // Existing linear track rendering continues below...
  const { tracks } = presenceTracks;
  // ... rest of existing code
}
```
  </action>
  <verify>
Run `pnpm typecheck` - should pass without errors.
Run `pnpm dev` and view spirits - existing spirits should still render correctly.
  </verify>
  <done>
PresenceTrack delegates to appropriate renderer based on data format.
  </done>
</task>

</tasks>

<verification>
1. Run `pnpm typecheck` - no type errors
2. Run `pnpm dev` - dev server starts
3. Visit /spirits/river-surges-in-sunlight - presence tracks render correctly (legacy format)
4. Visit /spirits/lightnings-swift-strike - presence tracks render correctly (legacy format)
</verification>

<success_criteria>
- PresenceTrackGrid component exists and renders grid layouts
- PresenceSlot shows start position indicators
- PresenceTrack delegates based on format type
- Existing linear spirits continue to work
</success_criteria>

<output>
After completion, create `.planning/phases/03.4-presence-track-graph-dsl/03.4-02-SUMMARY.md`
</output>
