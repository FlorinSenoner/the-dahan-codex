---
phase: 03.4-presence-track-graph-dsl
plan: 02
type: execute
wave: 2
depends_on: ["03.4-01"]
files_modified:
  - app/components/spirits/graph-presence-track.tsx
  - app/components/spirits/presence-node.tsx
autonomous: true

must_haves:
  truths:
    - "GraphPresenceTrack renders nodes in CSS Grid layout"
    - "Each node displays at correct grid position using row/col"
    - "Node tooltips show appropriate content based on trackType"
  artifacts:
    - path: "app/components/spirits/graph-presence-track.tsx"
      provides: "CSS Grid-based presence track renderer"
      exports: ["GraphPresenceTrack"]
      min_lines: 60
    - path: "app/components/spirits/presence-node.tsx"
      provides: "Individual presence node/slot component"
      exports: ["PresenceNode"]
      min_lines: 80
  key_links:
    - from: "app/components/spirits/graph-presence-track.tsx"
      to: "app/components/spirits/presence-node.tsx"
      via: "import and render"
      pattern: "PresenceNode"
---

<objective>
Create the GraphPresenceTrack component that renders presence tracks using CSS Grid with explicit node positioning.

Purpose: Replace the linear track renderer with a grid-based renderer that positions nodes at explicit (row, col) coordinates, enabling complex graph layouts for spirits like Finder and Starlight.

Output: GraphPresenceTrack.tsx and PresenceNode.tsx components
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.4-presence-track-graph-dsl/03.4-RESEARCH.md
@.planning/phases/03.4-presence-track-graph-dsl/03.4-01-SUMMARY.md
@app/components/spirits/presence-track.tsx
@app/components/spirits/presence-slot.tsx
@app/lib/spirit-colors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PresenceNode component</name>
  <files>app/components/spirits/presence-node.tsx</files>
  <action>
Create a new PresenceNode component based on the existing PresenceSlot but adapted for graph nodes.

Key differences from PresenceSlot:
- Receives full node object from graph schema (id, row, col, value, trackType, etc.)
- Generates tooltip content based on trackType ("energy", "cardPlays", "elements", etc.)
- Accepts style prop for grid positioning
- Uses consistent border/hover colors from spirit-colors.ts

Structure:
```tsx
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import { cn } from "@/lib/utils";

// Type from schema (derive from Doc<"spirits"> or define inline)
interface PresenceNodeData {
  id: string;
  row: number;
  col: number;
  value?: number | string;
  trackType?: "energy" | "cardPlays" | "energyMod" | "cardPlaysMod" | "elements" | "special" | "start";
  elements?: string[];
  reclaim?: boolean;
  specialAbility?: string;
  presenceCap?: number;
  unlocksGrowth?: boolean;
}

interface PresenceNodeProps {
  node: PresenceNodeData;
  style?: React.CSSProperties;
  color?: TrackColor;
}

export function PresenceNode({ node, style, color = "amber" }: PresenceNodeProps) {
  // Build tooltip based on trackType
  const tooltipLines: string[] = [];

  switch (node.trackType) {
    case "energy":
      tooltipLines.push(`Gain ${node.value} Energy per turn`);
      break;
    case "cardPlays":
      tooltipLines.push(`Play ${node.value} Card${node.value !== 1 ? "s" : ""} per turn`);
      break;
    case "energyMod":
    case "cardPlaysMod":
      tooltipLines.push(`${node.value} (modifier)`);
      break;
    case "elements":
      // Elements-only slot
      break;
    case "special":
      if (node.specialAbility) tooltipLines.push(node.specialAbility);
      break;
    case "start":
      tooltipLines.push("Starting position");
      break;
  }

  // Add elements, reclaim, presenceCap, unlocksGrowth to tooltip
  // ...

  // Determine display value
  const displayValue = node.reclaim
    ? "R"
    : node.presenceCap !== undefined
      ? node.presenceCap
      : node.value ?? (node.elements?.length ? "+" : "");

  return (
    <TooltipProvider delayDuration={100}>
      <Tooltip>
        <TooltipTrigger asChild>
          <button
            type="button"
            className={cn(
              "w-11 h-11 min-w-[44px] min-h-[44px] rounded-full",
              "border-2 flex items-center justify-center",
              "text-sm font-medium transition-colors cursor-pointer",
              "bg-muted/50 text-foreground hover:bg-muted/80",
              // Apply color-based border classes
              borderColors[color],
              hoverBorderColors[color],
              // Special styling for reclaim, elements, presenceCap
              node.reclaim && "border-amber-500 bg-amber-500/20 text-amber-300",
              node.elements?.length && !node.reclaim && "border-primary/70",
              node.presenceCap !== undefined && "border-stone-500/70 bg-stone-500/10 text-stone-300",
            )}
            style={style}
            aria-label={tooltipLines.join(". ")}
          >
            {displayValue}
          </button>
        </TooltipTrigger>
        <TooltipContent side="top" className="max-w-[200px]">
          {/* Render tooltip lines */}
        </TooltipContent>
      </Tooltip>
    </TooltipProvider>
  );
}
```

Include all border/hover color maps from presence-slot.tsx.
Include TrackColor type definition.
  </action>
  <verify>
File exists at app/components/spirits/presence-node.tsx
Contains export function PresenceNode
No TypeScript errors
  </verify>
  <done>
PresenceNode component created with tooltip support for all trackTypes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GraphPresenceTrack component</name>
  <files>app/components/spirits/graph-presence-track.tsx</files>
  <action>
Create GraphPresenceTrack component that renders the entire presence track grid.

Key features:
- CSS Grid with dynamic rows/cols from presenceTracks data
- Position each PresenceNode using gridRow/gridColumn style
- Determine node colors based on trackType (energy=amber, cardPlays=blue, etc.)
- Accept spiritSlug for spirit-specific color overrides
- Prepare for edge rendering (next plan) by wrapping in relative container

Structure:
```tsx
import type { Doc } from "convex/_generated/dataModel";
import { Heading, Text } from "@/components/ui/typography";
import { getSpiritTrackColors } from "@/lib/spirit-colors";
import { PresenceNode } from "./presence-node";

type TrackColor = "amber" | "blue" | "purple" | "emerald" | "cyan" | "orange" | "violet" | "indigo" | "stone";

interface GraphPresenceTrackProps {
  presenceTracks: NonNullable<Doc<"spirits">["presenceTracks"]>;
  spiritSlug?: string;
}

export function GraphPresenceTrack({ presenceTracks, spiritSlug }: GraphPresenceTrackProps) {
  const { rows, cols, nodes, edges } = presenceTracks;

  // Get spirit-specific colors
  const spiritColors = spiritSlug
    ? getSpiritTrackColors(spiritSlug)
    : { energy: "amber", cardPlays: "blue" };

  if (!nodes || nodes.length === 0) {
    return (
      <section className="space-y-4 mt-6">
        <Heading variant="h3" as="h2">Presence Tracks</Heading>
        <Text variant="muted">Presence track data coming soon.</Text>
      </section>
    );
  }

  // Determine color for each node based on trackType
  const getNodeColor = (node: typeof nodes[number]): TrackColor => {
    switch (node.trackType) {
      case "energy":
      case "energyMod":
        return spiritColors.energy as TrackColor;
      case "cardPlays":
      case "cardPlaysMod":
        return spiritColors.cardPlays as TrackColor;
      case "elements":
        return "purple";
      case "special":
        return "stone";
      default:
        return "amber";
    }
  };

  return (
    <section className="space-y-4 mt-6">
      <Heading variant="h3" as="h2">Presence Tracks</Heading>

      <div className="relative">
        {/* Grid container for nodes */}
        <div
          className="grid gap-2"
          style={{
            gridTemplateRows: `repeat(${rows}, minmax(44px, auto))`,
            gridTemplateColumns: `repeat(${cols}, minmax(44px, 1fr))`,
          }}
        >
          {nodes.map((node) => (
            <PresenceNode
              key={node.id}
              node={node}
              color={getNodeColor(node)}
              style={{
                gridRow: node.row + 1,  // CSS Grid is 1-indexed
                gridColumn: node.col + 1,
              }}
            />
          ))}
        </div>

        {/* Edge overlay will be added in Plan 03 */}
      </div>
    </section>
  );
}
```

Note: The relative container is for the SVG edge overlay that will be added in Plan 03.
  </action>
  <verify>
File exists at app/components/spirits/graph-presence-track.tsx
Contains export function GraphPresenceTrack
Imports PresenceNode from ./presence-node
No TypeScript errors: `pnpm typecheck`
  </verify>
  <done>
GraphPresenceTrack component renders nodes in CSS Grid layout with proper positioning.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. Both components export their functions
3. GraphPresenceTrack imports and uses PresenceNode
4. Grid styling uses dynamic rows/cols from presenceTracks
</verification>

<success_criteria>
- GraphPresenceTrack.tsx renders nodes in CSS Grid using row/col positioning
- PresenceNode.tsx displays node content with appropriate tooltips
- Components are ready for edge overlay integration
</success_criteria>

<output>
After completion, create `.planning/phases/03.4-presence-track-graph-dsl/03.4-02-SUMMARY.md`
</output>
