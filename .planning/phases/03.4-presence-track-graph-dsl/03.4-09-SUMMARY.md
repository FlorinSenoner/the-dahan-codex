---
phase: 03.4-presence-track-graph-dsl
plan: 09
subsystem: database, ui
tags: [convex, schema, presence-tracks, serpent, trackLabel]

# Dependency graph
requires:
  - phase: 03.4-01
    provides: Node-Edge Graph schema for presence tracks
provides:
  - trackLabel field for custom row labels
  - Serpent Deep Slumber track correctly modeled
  - "Requires Both Preceding Spaces" condition on first Deep Slumber node
affects: [03.4-10, 03.4-UAT]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - trackLabel field overrides derived labels from trackType

key-files:
  created: []
  modified:
    - convex/schema.ts
    - app/components/spirits/graph-presence-track.tsx
    - convex/seed.ts

key-decisions:
  - "trackLabel is optional and overrides derived label from trackType"
  - "All Deep Slumber nodes get trackLabel for consistent row labeling"
  - "specialAbility on first node for Requires Both Preceding Spaces condition"

patterns-established:
  - "trackLabel: custom row labels for special tracks (Deep Slumber, Absorbed Essence)"
  - "specialAbility: node-level tooltip text for special conditions"

# Metrics
duration: 8min
completed: 2026-01-27
---

# Plan 03.4-09: Serpent Deep Slumber Fix Summary

**trackLabel schema field enables custom row labels, fixing Serpent Deep Slumber display as "Deep Slumber" instead of generic "Special"**

## Performance

- **Duration:** 8 min
- **Started:** 2026-01-27T15:05:00Z
- **Completed:** 2026-01-27T15:15:09Z
- **Tasks:** 3
- **Files modified:** 3

## Accomplishments

- Added `trackLabel` field to presence track node schema
- Updated `getRowLabel` to prefer `trackLabel` over derived labels
- Fixed Serpent Deep Slumber nodes with `trackLabel: "Deep Slumber"`
- Added `specialAbility: "Requires Both Preceding Spaces"` to first Deep Slumber node
- Changes applied to both seedSpirits and reseedSpirits functions

## Task Commits

All 3 tasks were committed as a single atomic commit:

1. **Task 1: Add trackLabel to schema** - `feba14d` (fix)
2. **Task 2: Update graph-presence-track to render trackLabel** - `feba14d` (fix)
3. **Task 3: Fix Serpent seed data structure** - `feba14d` (fix)

## Files Created/Modified

- `convex/schema.ts` - Added trackLabel field to node schema
- `app/components/spirits/graph-presence-track.tsx` - Updated getRowLabel to check trackLabel first
- `convex/seed.ts` - Added trackLabel to all Deep Slumber nodes in both seed functions

## Decisions Made

- **trackLabel is per-node, not per-row:** Allows mixed labels within a row if needed
- **All Deep Slumber nodes get trackLabel:** Ensures consistent row label regardless of which node is first
- **specialAbility for condition:** "Requires Both Preceding Spaces" shows in tooltip on d0 node

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

- **Type guard needed:** The schema union type (Node-Edge Graph vs Legacy) required updating the existing `isGraphFormat` type guard to include the new `trackLabel` field. This was necessary for TypeScript compilation.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Serpent Deep Slumber track now displays correctly with "Deep Slumber" label
- `specialAbility` tooltip shows "Requires Both Preceding Spaces" on first slot
- Database reseed required to apply changes to production data

---
*Phase: 03.4-presence-track-graph-dsl*
*Plan: 09*
*Completed: 2026-01-27*
