---
phase: 03.4-presence-track-graph-dsl
plan: 09
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/seed.ts
  - app/components/spirits/graph-presence-track.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Serpent has 2 standard presence tracks (Energy/CardPlays)"
    - "Deep Slumber is a separate mechanic with custom label"
    - "Presence tracks can show custom track labels"
    - "Requires Both Preceding Spaces condition is displayed"
  artifacts:
    - path: "convex/schema.ts"
      provides: "trackLabel field for custom row labels"
      contains: "trackLabel"
    - path: "convex/seed.ts"
      provides: "Corrected Serpent presence track data"
      contains: "serpent-slumbering"
    - path: "app/components/spirits/graph-presence-track.tsx"
      provides: "Custom trackLabel rendering"
      contains: "trackLabel"
  key_links:
    - from: "app/components/spirits/graph-presence-track.tsx"
      to: "convex/schema.ts"
      via: "trackLabel field"
      pattern: "trackLabel"
---

<objective>
Fix Serpent Slumbering Beneath the Island's presence track modeling. Deep Slumber is NOT a 3rd presence track row - it's a separate mechanic that determines presence CAP on the island.

Purpose: Current model incorrectly treats Deep Slumber as a track you place presence on. In reality, Serpent has 2 tracks (Energy, Absorbed Essence) and a separate Deep Slumber track that shows your presence LIMIT.

Output: Correct schema with trackLabel support and accurate Serpent data
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.4-presence-track-graph-dsl/03.4-01-SUMMARY.md
@convex/schema.ts
@convex/seed.ts (search: serpent-slumbering)
@app/components/spirits/graph-presence-track.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add trackLabel to schema</name>
  <files>convex/schema.ts</files>
  <action>
Add a `trackLabel` field to presence track nodes. This allows custom labels like "Deep Slumber", "Absorbed Essence" instead of deriving from trackType.

In the presenceTracks node schema (around line 132-163), add:

```typescript
// Unique node identifier (required)
id: v.string(),

// Grid position for rendering (0-indexed)
row: v.number(),
col: v.number(),

// Optional custom track label (overrides derived label)
trackLabel: v.optional(v.string()),  // ADD THIS LINE

// Node content
value: v.optional(v.union(v.number(), v.string())),
```

This is additive - no breaking changes to existing spirits.
  </action>
  <verify>
`pnpm typecheck` passes
trackLabel field exists in schema
  </verify>
  <done>
Schema supports custom track labels.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update graph-presence-track to render trackLabel</name>
  <files>app/components/spirits/graph-presence-track.tsx</files>
  <action>
Update the `getRowLabel` function to prefer `trackLabel` over derived labels.

Current getRowLabel function (around line 105-126):
```typescript
const getRowLabel = (rowNodes: typeof nodes): string => {
  const firstNode = rowNodes[0];
  if (!firstNode?.trackType) return "Track";
  switch (firstNode.trackType) {
    // ...
  }
};
```

Update to check trackLabel first:
```typescript
const getRowLabel = (rowNodes: typeof nodes): string => {
  const firstNode = rowNodes[0];

  // Prefer explicit trackLabel over derived label
  if (firstNode?.trackLabel) {
    return firstNode.trackLabel;
  }

  if (!firstNode?.trackType) return "Track";
  switch (firstNode.trackType) {
    case "energy":
      return "Energy/Turn";
    case "cardPlays":
      return "Card Plays";
    // ... rest of cases
  }
};
```

This preserves backward compatibility - spirits without trackLabel keep derived labels.
  </action>
  <verify>
`pnpm typecheck` passes
getRowLabel checks for trackLabel first
  </verify>
  <done>
Custom track labels render correctly.
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix Serpent seed data structure</name>
  <files>convex/seed.ts</files>
  <action>
Update Serpent's presenceTracks in BOTH locations in seed.ts.

Current (INCORRECT) structure:
- Row 0: Energy (7 slots)
- Row 1: Absorbed Essence (6 slots)
- Row 2: Deep Slumber with presenceCap (treated as regular track)

Corrected structure based on actual Serpent panel:

**Row 0: Energy Track**
- Values: 1, 2, 3, 4+Fire, 5, 6+Fire, 7
- trackType: "energy"

**Row 1: Card Plays Track**
- Values: 1, 2, 2+Moon, 3+Earth, 3+Moon+Earth, 4+Fire
- trackType: "cardPlays"
- Note: Track label should show "CARD PLAYS"

**Row 2: Absorbed Essence (elements only)**
- trackLabel: "Absorbed Essence"
- trackType: "elements" (no base value, just elements)
- Elements only: no value, just Moon, Earth, Fire combinations
- Note: This is where Serpent "absorbs" presence

**Deep Slumber: Separate mechanic**
The Deep Slumber presence cap (5-13) should be modeled in a different way:
- Option A: Keep as row 3 with trackLabel: "Deep Slumber" and trackType: "special"
- Option B: Use specialRules to explain the mechanic

Choose Option A for visual representation. Update:

```typescript
presenceTracks: {
  rows: 3,  // Energy, CardPlays/Elements, Deep Slumber
  cols: 9,
  nodes: [
    // Row 0: Energy Track
    { id: "e0", row: 0, col: 0, value: 1, trackType: "energy" },
    { id: "e1", row: 0, col: 1, value: 2, trackType: "energy" },
    { id: "e2", row: 0, col: 2, value: 3, trackType: "energy" },
    { id: "e3", row: 0, col: 3, value: 4, trackType: "energy", elements: ["Fire"] },
    { id: "e4", row: 0, col: 4, value: 5, trackType: "energy" },
    { id: "e5", row: 0, col: 5, value: 6, trackType: "energy", elements: ["Fire"] },
    { id: "e6", row: 0, col: 6, value: 7, trackType: "energy" },

    // Row 1: Card Plays with Absorbed Essence elements
    { id: "c0", row: 1, col: 0, value: 1, trackType: "cardPlays" },
    { id: "c1", row: 1, col: 1, value: 2, trackType: "cardPlays", elements: ["Moon"] },
    { id: "c2", row: 1, col: 2, value: 2, trackType: "cardPlays", elements: ["Earth"] },
    { id: "c3", row: 1, col: 3, value: 3, trackType: "cardPlays", elements: ["Moon", "Earth"] },
    { id: "c4", row: 1, col: 4, value: 3, trackType: "cardPlays", elements: ["Fire"] },
    { id: "c5", row: 1, col: 5, value: 4, trackType: "cardPlays", elements: ["Moon", "Earth", "Fire"] },

    // Row 2: Deep Slumber (presence cap, special mechanic)
    { id: "d0", row: 2, col: 0, value: 5, trackType: "special", trackLabel: "Deep Slumber", presenceCap: 5, specialAbility: "Requires Both Preceding Spaces" },
    { id: "d1", row: 2, col: 1, value: 6, trackType: "special", trackLabel: "Deep Slumber", presenceCap: 6 },
    { id: "d2", row: 2, col: 2, value: 7, trackType: "special", trackLabel: "Deep Slumber", presenceCap: 7 },
    { id: "d3", row: 2, col: 3, value: 8, trackType: "special", trackLabel: "Deep Slumber", presenceCap: 8 },
    { id: "d4", row: 2, col: 4, value: 9, trackType: "special", trackLabel: "Deep Slumber", presenceCap: 9 },
    { id: "d5", row: 2, col: 5, value: 10, trackType: "special", trackLabel: "Deep Slumber", presenceCap: 10 },
    { id: "d6", row: 2, col: 6, value: 11, trackType: "special", trackLabel: "Deep Slumber", presenceCap: 11 },
    { id: "d7", row: 2, col: 7, value: 12, trackType: "special", trackLabel: "Deep Slumber", presenceCap: 12 },
    { id: "d8", row: 2, col: 8, value: 13, trackType: "special", trackLabel: "Deep Slumber", presenceCap: 13 },
  ],
  edges: [],  // Linear tracks, no cross connections
}
```

IMPORTANT: Update in BOTH seedSpirits (~line 1243) and reseedSpirits (~line 2722).

Note: The actual Serpent panel may differ - cross-reference with wiki or game panel. Key corrections:
1. Energy and Card Plays are standard tracks
2. Absorbed Essence provides elements when presence is placed there (absorbed)
3. Deep Slumber shows LIMIT, not a track you progress
  </action>
  <verify>
`pnpm typecheck` passes
Serpent has trackLabel on Deep Slumber nodes
Both seedSpirits and reseedSpirits match
  </verify>
  <done>
Serpent's presence tracks accurately model the mechanic.
  </done>
</task>

</tasks>

<verification>
1. Schema has trackLabel field
2. GraphPresenceTrack renders trackLabel
3. Serpent seed data has correct structure
4. `pnpm typecheck` passes
</verification>

<success_criteria>
- trackLabel schema field added
- GraphPresenceTrack renders custom labels
- Serpent has 2 standard tracks + Deep Slumber with correct modeling
- "Requires Both Preceding Spaces" condition visible in tooltip
</success_criteria>

<output>
After completion, create `.planning/phases/03.4-presence-track-graph-dsl/03.4-09-SUMMARY.md`
</output>
